<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.78.2"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Dubbo's Load Balance | Apache Dubbo</title><meta property="og:title" content="Dubbo's Load Balance"><meta property="og:description" content="This article introduces you what is load balance and how load balance strategy is implemented in Dubbo."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2018/08/10/dubbos-load-balance/"><meta property="article:published_time" content="2018-08-10T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-16T19:43:34+08:00"><meta property="og:site_name" content="Apache Dubbo"><meta itemprop=name content="Dubbo's Load Balance"><meta itemprop=description content="This article introduces you what is load balance and how load balance strategy is implemented in Dubbo."><meta itemprop=datePublished content="2018-08-10T00:00:00+00:00"><meta itemprop=dateModified content="2020-11-16T19:43:34+08:00"><meta itemprop=wordCount content="2074"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Dubbo's Load Balance"><meta name=twitter:description content="This article introduces you what is load balance and how load balance strategy is implemented in Dubbo."><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-112489517-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preload href=/scss/main.min.b8ee4a8008ba3340c2f9a4386c269cfd0c363b329f020f483656c1193857d326.css as=style><link href=/scss/main.min.b8ee4a8008ba3340c2f9a4386c269cfd0c363b329f020f483656c1193857d326.css rel=stylesheet integrity><script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">Apache Dubbo</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2018/08/10/dubbo%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2018/08/10/dubbo%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Blog</a></li><ul><li class="collapse show" id=blog><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/news/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Articles</a></li><ul><li class="collapse show" id=blognews><a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190826dubbo-admin-service-test href=/blog/2019/08/26/dubbo-admin-service-test/>Service test in dubbo admin</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190811tracing-dubbo-service-with-apache-skywalking href=/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/>Use apache skywalking in dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190502dubbo-extensible-mechanism-source-code-analysis-part-2 href=/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/>Dubbo extensible mechanism - part 2</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190425dubbo-extensible-mechanism-source-code-analysis-part-1 href=/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/>Dubbo extensible mechanism - part 1</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface href=/blog/2019/02/20/implementation-background-and-practice-of-dubbo-client-asynchronous-interface/>Dubbo Async Client</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface href=/blog/2019/02/20/implementation-background-and-practice-of-dubbo-server-asynchronous-interface/>Dubbo Async Server</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190117how-to-use-fescar-to-ensure-consistency-between-dubbo-microservices href=/blog/2019/01/17/how-to-use-fescar-to-ensure-consistency-between-dubbo-microservices/>Use Fescar in Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou href=/blog/2018/12/10/the-fifth-dubbo-meetup-has-been-held-in-hangzhou/>The fifth Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181107dubbo-integrates-with-nacos-to-become-a-registry href=/blog/2018/11/07/dubbo-integrates-with-nacos-to-become-a-registry/>Use Dubbo with Nacos</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181005introduction-to-the-dubbo-protocol href=/blog/2018/10/05/introduction-to-the-dubbo-protocol/>Introduction to the Dubbo protocol</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180930integrate-dubbo-with-kubernetes href=/blog/2018/09/30/integrate-dubbo-with-kubernetes/>Integrate Dubbo with Kubernetes</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180902how-to-prepare-an-apache-release href=/blog/2018/09/02/how-to-prepare-an-apache-release/>How to prepare an Apache Release</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo href=/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/>New Async Call</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu href=/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/>The fourth Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-basic-usage-dubbo-consumer-configuration href=/blog/2018/08/14/dubbo-basic-usage-dubbo-consumer-configuration/>Dubbo Consumer Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-several-ways-about-synchronousasynchronous-invoke href=/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/>Dubbo Invoke</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-basic-usage-dubbo-provider-configuration href=/blog/2018/08/14/dubbo-basic-usage-dubbo-provider-configuration/>Dubbo Provider Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814manipulating-services-dynamically-via-qos href=/blog/2018/08/14/manipulating-services-dynamically-via-qos/>Dubbo QoS Introduction</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop href=/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/>Dubbo start/stop in spring boot</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814implementation-of-cross-language-calls-by-dubbo2js href=/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/>dubbo2.js introduction</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814generic-invoke-of-dubbo href=/blog/2018/08/14/generic-invoke-of-dubbo/>Generic invoke</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-blog20180810dubbos-load-balance href=/blog/2018/08/10/dubbos-load-balance/>Dubbo's Load Balance</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807use-annotations-in-dubbo href=/blog/2018/08/07/use-annotations-in-dubbo/>Use Annotations In Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807using-zookeeper-in-dubbo href=/blog/2018/08/07/using-zookeeper-in-dubbo/>Using Zookeeper in Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807your-first-dubbo-demo href=/blog/2018/08/07/your-first-dubbo-demo/>Your First Dubbo Demo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen href=/blog/2018/07/30/the-third-dubbo-meetup-has-been-held-in-shenzhen/>The third Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180727sentinel-the-flow-sentinel-of-dubbo-services href=/blog/2018/07/27/sentinel-the-flow-sentinel-of-dubbo-services/>Introduce sentinel</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180712tracking-with-pinpoint href=/blog/2018/07/12/tracking-with-pinpoint/>Tracking with Pinpoint</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180701your-first-dubbo-filter href=/blog/2018/07/01/your-first-dubbo-filter/>Your First Dubbo Filter</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully href=/blog/2018/06/23/the-second-dubbo-shanghai-meetup-has-been-held-successfully/>The second Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180512the-first-dubbo-meetup-has-been-held-in-beijing href=/blog/2018/05/12/the-first-dubbo-meetup-has-been-held-in-beijing/>The first Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180502the-apachecon-na-schedule-has-been-announced href=/blog/2018/05/02/the-apachecon-na-schedule-has-been-announced/>ApacheCon NA</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180425the-gsocgoogle-summer-of-code-2018 href=/blog/2018/04/25/the-gsocgoogle-summer-of-code-2018/>GSoC 2018</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018 href=/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/>QCon Beijing 2018</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Releases</a></li><ul><li class=collapse id=blogreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-blog20200518past-releases href=/blog/2020/05/18/past-releases/>Past Releases</a></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/dubbo-website/edit/master/content/en/blog/news/dubbo-loadbalance.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/apache/dubbo-website/new/master/content/en/blog/news/dubbo-loadbalance.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i>Create child page</a>
<a href="https://github.com/apache/dubbo-website/issues/new?title=Dubbo&amp;#39;s%20Load%20Balance" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/apache/dubbo/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#concepts>Concepts</a></li><li><a href=#dubbos-internal-load-balancing-strategy>Dubbo&rsquo;s Internal Load Balancing Strategy</a><ul><li><a href=#1-random-load-balancing>1. Random Load Balancing</a></li><li><a href=#2-round-robin-load-balancing>2. Round Robin Load Balancing</a></li><li><a href=#3-minimum-active-call-load-balancing>3. Minimum Active Call Load Balancing</a></li><li><a href=#4-consistent-hash-algorithm>4. Consistent Hash Algorithm</a></li></ul></li><li><a href=#load-balancing-configuration>Load Balancing Configuration</a><ul><li><a href=#server-side-service-level>Server Side Service Level</a></li><li><a href=#client-side-service-level>Client Side Service Level</a></li><li><a href=#server-side-method-level>Server Side Method Level</a></li><li><a href=#client-side-method-level>Client Side Method Level</a></li></ul></li><li><a href=#extended-load-balancing>Extended Load Balancing</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=/blog/news/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>Dubbo's Load Balance</h1><div class=lead>This article introduces you what is load balance and how load balance strategy is implemented in Dubbo.</div><div class="td-byline mb-4"><time datetime=2018-08-10 class=text-muted>Friday, August 10, 2018</time></div><h2 id=background>Background</h2><p>Dubbo is a distributed service framework that avoids single point of failure and horizontal expansion of support services. A service typically deploys multiple instances. How to select a call from a cluster of multiple service providers involves a load balancing strategy.</p><h2 id=concepts>Concepts</h2><p>Before discussing load balancing, I will explain these three concepts first.</p><ol><li>Load Balancing</li><li>Fault-tolerant Cluster</li><li>Service Route</li></ol><p>These three concepts are confusing. They all describe how to choose from multiple Providers to make calls. So what is the difference between them? Let me give a simple example and explain these concepts clearly.</p><p>There is a Dubbo user service, 10 deployed in Beijing and 20 deployed in Shanghai. A service consumer in Hangzhou initiated a call and then the following steps executed:</p><ol><li>According to the configured routing rule, if the call is initiated by Hangzhou, it will be routed to the nearest 20 Providers in Shanghai.</li><li>According to the configured random load balancing strategy, one of the 20 Providers is randomly selected to be called, assuming that the 7th Provider is randomly selected.</li><li>As a result, calling the 7th Provider failed.</li><li>Retried other servers according to the configured Fault-tolerant Cluster mode.</li><li>The call to the 13th Provider was successful.</li></ol><p>Steps 1, 2, and 4 above correspond to routing, load balancing, and fault-tolerant cluster. In Dubbo, a subset is selected by routing from multiple Providers according to routing rules, then a Provider selected from the subset according to load balancing to make this call. If the call fails, Dubbo retry or schedule retransmission or fail-fast according to the Fault-tolerant Cluster policy. You can see the routes in Dubbo, load balancing and Fault-tolerant Cluster exectute at different stages of an RPC call. The first stage is routing, then load balancing, and finally cluster fault tolerance. This document only discusses load balancing, routing and cluster fault tolerance are described in other documents.</p><h2 id=dubbos-internal-load-balancing-strategy>Dubbo&rsquo;s Internal Load Balancing Strategy</h2><p>Dubbo has four Internal Load Balancing Strategies:</p><ol><li>RandomLoadBalance: Random load balancing. Choose a Provider randomly. It is Dubbo&rsquo;s default load balancing strategy.</li><li>Round Robin Load Balancing: Polling load balancing, then chooses one Provider.</li><li>LeastActiveLoadBalance: The minimum number of active calls, the random number of the same active number. The active number refers to the difference before and after the call. Make slow providers receive fewer requests, because the slower Provider before and after the difference of calls will be larger.</li><li>ConsistentHashLoadBalance: Consistent hash load balancing. Requests with the same parameters always fall on the same machine.</li></ol><h3 id=1-random-load-balancing>1. Random Load Balancing</h3><p>As the name implies, the random load balancing strategy is to select one from multiple Providers randomly. However, random load balancing in Dubbo has a weighting concept that sets the random probability according to the weight. For example, there are 10 Providers, it&rsquo;s not to say that the probability of each Provider is the same, but to assign the probability by combining the weights of these 10 providers.</p><p>In Dubbo, you can set weights on the Provider. For example, if the performance of the machine is better, you can set a larger weight. If the performance is poorer, you can set a smaller weight. Weights have an impact on load balancing. The weight of provider can be set in Dubbo Admin.</p><h4 id=weight-based-load-balancing-algorithm>Weight-based Load Balancing Algorithm</h4><p>The stochastic strategy will determine whether the weights of all the invokers are the same at first. If they are all the same, then the processing is relatively simple. Using <code>random.nexInt(length)</code>, you can randomly generate an invoker serial number, and select the corresponding invoker according to the serial number. If the service provider not set weight in Dubbo Admin, then all the invokers have the same weight, the default is 100. If the weights are different, then you need to combine the weights to set the random probability. The algorithm is probably as follows: If there are 4 invokers</p><table><thead><tr><th>Invoker</th><th>Weight</th></tr></thead><tbody><tr><td>A</td><td>10</td></tr><tr><td>B</td><td>20</td></tr><tr><td>C</td><td>20</td></tr><tr><td>D</td><td>30</td></tr></tbody></table><p>The total weight of A, B, C and D is 10 + 20 + 20 + 30 = 80. Spread 80 numbers in the following diagram:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>+-----------------------------------------------------------------------------------+
|          |                    |                    |                              |
+-----------------------------------------------------------------------------------+
1          10                   30                   50                             80

|-----A----|---------B----------|----------C---------|---------------D--------------|


---------------------15

-------------------------------------------37

-----------------------------------------------------------54
</code></pre></div><p>There are four areas in the above picture, and the lengths are the weights of A, B, C and D, respectively. Use <code>random.nextInt(10 + 20 + 20 + 30)</code> to randomly select one of the 80 numbers. Then determine which area the number is distributed in. For example, if random to 37, 37 is distributed in the C region, then select inboker C. 15 is in the B area, 54 is in the D area.</p><h4 id=random-load-balancing-source-code>Random load balancing Source code</h4><p>Below is the source code for random load balancing. For ease of reading and understanding, I removed the extraneous parts.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>public class RandomLoadBalance extends AbstractLoadBalance {

    private final Random random = new Random();

    protected &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) {
        int length = invokers.size();      // total invoker
        int totalWeight = 0;               // Sum of invokers&#39; weights

        // Determine if all the invokers have the same weight
        // If the weights are the same, it is simple to generate an index directly from Random.
        boolean sameWeight = true;
        for (int i = 0; i &lt; length; i++) {
            int weight = getWeight(invokers.get(i), invocation);
            totalWeight += weight; // Sum
            if (sameWeight &amp;&amp; i &gt; 0 &amp;&amp; weight != getWeight(invokers.get(i - 1), invocation)) {
                sameWeight = false;
            }
        }

        if (totalWeight &gt; 0 &amp;&amp; !sameWeight) {
            // If not all of the invoker weights are the same, load balancer will randomly choose invoker based on its weight. The greater the weight, the greater the probability of being selected
            int offset = random.nextInt(totalWeight);
            for (int i = 0; i &lt; length; i++) {
                offset -= getWeight(invokers.get(i), invocation);
                if (offset &lt; 0) {
                    return invokers.get(i);
                }
            }
        }
        // If all invokers have the same weight
        return invokers.get(random.nextInt(length));
    }
}
</code></pre></div><h3 id=2-round-robin-load-balancing>2. Round Robin Load Balancing</h3><p>Round Robin Load Balancing, is to call all Providers in turn. As with random load balancing strategies, Round Robin Load Balancing policies also has a weighting concept. The Round Robin Load Balancing algorithm allows RPC calls to be allocated exactly as we set. Whether it is a small or large number of calls. However, there are also some shortcomings in the Round Robin Load Balancing algorithm. There is a problem that the slow provider accumulates the request. For example, the second machine is slow, but it is not crashed. When the request is transferred to the second machine, it is stuck. Over time, all The request get stuck on the second machine, causing the entire system to slow down.</p><h3 id=3-minimum-active-call-load-balancing>3. Minimum Active Call Load Balancing</h3><p>Official explanation:</p><blockquote><p>The active number refers to the difference between the counts before and after the call. Select the machine with the minimum number of active calls or choose a random one among machines with the same active number, so that the slower machine can receives less requests.</p></blockquote><p>This explanation seems to be ambigious. We know the purpose is to ensure the slower machine receive less requests, but it is not clear how to achieve it. An example is here: each service maintains an active number counter. When A machine starts processing the request, the counter is incremented by 1. At this time, A is still processing. If the processing is completed, the counter is decremented by 1. B machine processes very quickly after receiving the request. Then the active numbers of A and B are 1,0 respectively. When a new request is generated, the B machine is selected for execution (as B has the minimum active number), so that the slower machine A receives fewer requests.</p><p>When processing a new request, Consumer will check the active number of all Providers. If there is only one Invoker with the minimum active number, the Invoker is returned directly.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>if (leastCount == 1) {
    // if there is only one minimum value then return directly
    return invokers.get(leastIndexs[0]);
}
</code></pre></div><p>If there are multiple Invokers with the minimum active number, plus the weights are not equal and the total weight is greater than 0, then generate a random weight ranging from 0 to totalWeight. Finally, the Invoker is selected based on the randomly generated weights.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>if (! sameWeight &amp;&amp; totalWeight &gt; 0) {
    // if the weights are not equal and the toatl weight is greater than 0 then choose randomly according to total weight

    int offsetWeight = random.nextInt(totalWeight);

    // and determine which segment the random value falls on.

    for (int i = 0; i &lt; leastCount; i++) {
        int leastIndex = leastIndexs[i];
        offsetWeight -= getWeight(invokers.get(leastIndex), invocation);
        if (offsetWeight &lt;= 0)
            return invokers.get(leastIndex);
    }
}
</code></pre></div><h3 id=4-consistent-hash-algorithm>4. Consistent Hash Algorithm</h3><p>Use consistent hash algorithm to ensure that requests with same parameters are always sent to the same Provider. When a Provider crashes, requests originally sent to the Provider is spread evenly to other Providers based on the virtual node without causing drastic changes. The algorithm can be seen at: <a href=http://en.wikipedia.org/wiki/Consistent_hashing>http://en.wikipedia.org/wiki/Consistent_hashing</a></p><p>By default, only the first parameter is hashed. Configure if you would like to modify it:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;dubbo:parameter key=&#34;hash.arguments&#34; value=&#34;0,1&#34; /&gt;
</code></pre></div><p>By default, 160 virtual nodes are used. Configure if you would like to modify it:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;dubbo:parameter key=&#34;hash.nodes&#34; value=&#34;320&#34; /&gt;
</code></pre></div><p>Consistent hash algorithms can be used in conjunction with caching mechanisms. For example, there is a service getUserInfo(String userId). After the hash algorithm is set, the same userId call is sent to the same Provider. This Provider can cache user data in memory, reducing the number of accesses to the database or distributed cache. If this part of the data is allowed to be inconsistent for some time, this approach can be considered. The number of dependencies and accesses to middleware such as databases, caches, etc. and network IO operations is reduced, while the system performance is improved.</p><h2 id=load-balancing-configuration>Load Balancing Configuration</h2><p>If load balancing is not specified, random load balancing is used by default. Load balancing can also be explicitly specified based on our needs. Load balancing can be configured in multiple local classes, such as Provider Side, Consumer Side, Service Level, and Method Level.</p><h3 id=server-side-service-level>Server Side Service Level</h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;dubbo:service interface=&#34;...&#34; loadbalance=&#34;roundrobin&#34; /&gt;
</code></pre></div><p>All methods of the service use roundrobin load balancing.</p><h3 id=client-side-service-level>Client Side Service Level</h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;dubbo:reference interface=&#34;...&#34; loadbalance=&#34;roundrobin&#34; /&gt;
</code></pre></div><p>All methods of the service use roundrobin load balancing.</p><h3 id=server-side-method-level>Server Side Method Level</h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;dubbo:service interface=&#34;...&#34;&gt;
    &lt;dubbo:method name=&#34;hello&#34; loadbalance=&#34;roundrobin&#34;/&gt;
&lt;/dubbo:service&gt;
</code></pre></div><p>Only the hello method of the service uses roundrobin load balancing.</p><h3 id=client-side-method-level>Client Side Method Level</h3><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;dubbo:reference interface=&#34;...&#34;&gt;
    &lt;dubbo:method name=&#34;hello&#34; loadbalance=&#34;roundrobin&#34;/&gt;
&lt;/dubbo:reference&gt;
</code></pre></div><p>Only the hello method of the service uses roundrobin load balancing.</p><p>Similar to other Dubbo configurations, multiple configurations are covered:</p><ol><li>The method level takes precedence, the interface level is next, and the global configuration comes last.</li><li>If the level is the same, the Consumer is given priority and the Provider is next</li></ol><p>Therefore, the priority of the above four configurations is:</p><ol><li>Client side method level configuration.</li><li>Client side interface level configuration.</li><li>Server side method level configuration.</li><li>Server side interface level configuration.</li></ol><h2 id=extended-load-balancing>Extended Load Balancing</h2><p>Four load balancing implementations of Dubbo meet the requirements in most cases. Sometimes, we may need to implement our own load balancing strategy because of the needs of the business. This chapter only explains how to configure the load balancing algorithm. For more on the Dubbo extension mechanism, go to the Dubbo extension mechanism practice.</p><ol><li>Implementing the LoadBalance interface</li></ol><p>The following is Dubbo&rsquo;s LoadBalance interface:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>@SPI(RandomLoadBalance.NAME)
public interface LoadBalance {
    @Adaptive(&#34;loadbalance&#34;)
    &lt;T&gt; Invoker&lt;T&gt; select(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) throws RpcException;
}
</code></pre></div><p>This is the interface of the SPI. The parameters of the select method are as follows:</p><ul><li>invokers: A list of all service Providers.</li><li>url: Some configuration information, such as interface name, check or not, serialization.</li><li>invocation: Information called by the RPC, including the method name, method parameter type, and method parameters. Here is a LoadBalance implemented by us. The implementation is very simple - Choose the first Invoker:</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#719e07>package</span> com.demo.dubbo;
public class DemoLoadBalance implements LoadBalance {
    @Override
    public &lt;T&gt; Invoker&lt;T&gt; <span style=color:#719e07>select</span>(List&lt;Invoker&lt;T<span style=color:#719e07>&gt;&gt;</span> invokers, URL url, Invocation invocation) throws RpcException {
        System.out.<span style=color:#b58900>println</span>(<span style=color:#2aa198>&#34;[DemoLoadBalance]Select the first invoker...&#34;</span>);
        <span style=color:#719e07>return</span> invokers.<span style=color:#268bd2>get</span>(<span style=color:#2aa198>0</span>);
    }
}
</code></pre></div><ol start=2><li>Add a resource file</li></ol><p>Add a file:
<code>src/main/resource/META-INF/dubbo/com.alibaba.dubbo.rpc.cluster.LoadBalance</code>
This is a simple text file. The file contents are as follows:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>demo=my=com.demo.dubbo.DemoLoadBalance
</code></pre></div><ol start=3><li>Configure to use custom LoadBalance</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;dubbo:reference id=&#34;helloService&#34; interface=&#34;com.demo.dubbo.api.IHelloService&#34; loadbalance=&#34;demo&#34; /&gt;
</code></pre></div><p>Configure <code>&lt;loadbalance="demo"></code> in <code>dubbo:reference</code> at the Consumer side.</p><p>After 3 steps above, we wrote a custom LoadBalance and told Dubbo to use it. Start Dubbo and we can see that Dubbo has used a custom DemoLoadBalance.</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2018/08/07/use-annotations-in-dubbo/ class="btn btn-primary"><span class=mr-1>←</span> Previous</a></li><a href=/blog/2018/08/14/generic-invoke-of-dubbo/ class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dubbo mailing list archive" aria-label="Dubbo mailing list archive"><a class=text-white target=_blank rel="noopener noreferrer" href=https://lists.apache.org/list.html?dev@dubbo.apache.org><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/ApacheDubbo><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/apache/dubbo><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Subscribe to mailing list" aria-label="Subscribe to mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=mailto://dev-subscribe@dubbo.apache.org><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. All Rights Reserved</small></div></div></div></footer></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.b5fc1b29d2465835844254bd4d804738eaf24c0cec53009b4c6899989be55a47.js integrity="sha256-tfwbKdJGWDWEQlS9TYBHOOryTAzsUwCbTGiZmJvlWkc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:'38eff7758162fbf70f2b8484932e62ae',indexName:'apache_dubbo',inputSelector:'.td-search-input',debug:false,});</script></body></html>