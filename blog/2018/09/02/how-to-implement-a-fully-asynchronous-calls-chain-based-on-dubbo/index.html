<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.78.2"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>How to implement a fully asynchronous calls chain based on Dubbo | Apache Dubbo</title><meta property="og:title" content="How to implement a fully asynchronous calls chain based on Dubbo"><meta property="og:description" content="This article recalls how asynchronous call is implemented in Dubbo 2.6.x, and introduces the new way based on CompletableFuture in 2.7.0."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/"><meta property="article:published_time" content="2018-09-02T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-18T12:43:25+08:00"><meta property="og:site_name" content="Apache Dubbo"><meta itemprop=name content="How to implement a fully asynchronous calls chain based on Dubbo"><meta itemprop=description content="This article recalls how asynchronous call is implemented in Dubbo 2.6.x, and introduces the new way based on CompletableFuture in 2.7.0."><meta itemprop=datePublished content="2018-09-02T00:00:00+00:00"><meta itemprop=dateModified content="2020-11-18T12:43:25+08:00"><meta itemprop=wordCount content="1728"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="How to implement a fully asynchronous calls chain based on Dubbo"><meta name=twitter:description content="This article recalls how asynchronous call is implemented in Dubbo 2.6.x, and introduces the new way based on CompletableFuture in 2.7.0."><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-112489517-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preload href=/scss/main.min.7b6e720573a9e91e946ab0a302450a2e3baad4af648f63bdc75f35544f351ca8.css as=style><link href=/scss/main.min.7b6e720573a9e91e946ab0a302450a2e3baad4af648f63bdc75f35544f351ca8.css rel=stylesheet integrity><script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">Apache Dubbo</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2018/09/02/%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8Edubbo%E5%AE%9E%E7%8E%B0%E5%85%A8%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E9%93%BE/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2018/09/02/%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8Edubbo%E5%AE%9E%E7%8E%B0%E5%85%A8%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E9%93%BE/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Blog</a></li><ul><li class="collapse show" id=blog><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/news/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Articles</a></li><ul><li class="collapse show" id=blognews><a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190826service-test href=/blog/2019/08/26/service-test/>Service test in dubbo admin</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190811tracing-dubbo-service-with-apache-skywalking href=/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/>Use apache skywalking in dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190502dubbo-extensible-mechanism-source-code-analysis-part-2 href=/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/>Dubbo extensible mechanism - part 2</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190425dubbo-extensible-mechanism-source-code-analysis-part-1 href=/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/>Dubbo extensible mechanism - part 1</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface href=/blog/2019/02/20/implementation-background-and-practice-of-dubbo-client-asynchronous-interface/>Dubbo Async Client</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface href=/blog/2019/02/20/implementation-background-and-practice-of-dubbo-server-asynchronous-interface/>Dubbo Async Server</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190117how-to-use-fescar-to-ensure-consistency-between-dubbo-microservices href=/blog/2019/01/17/how-to-use-fescar-to-ensure-consistency-between-dubbo-microservices/>Use Fescar in Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou href=/blog/2018/12/10/the-fifth-dubbo-meetup-has-been-held-in-hangzhou/>The fifth Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181107dubbo-integrates-with-nacos-to-become-a-registry href=/blog/2018/11/07/dubbo-integrates-with-nacos-to-become-a-registry/>Use Dubbo with Nacos</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181005introduction-to-the-dubbo-protocol href=/blog/2018/10/05/introduction-to-the-dubbo-protocol/>Introduction to the Dubbo protocol</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180930integrate-dubbo-with-kubernetes href=/blog/2018/09/30/integrate-dubbo-with-kubernetes/>Integrate Dubbo with Kubernetes</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180902how-to-prepare-an-apache-release href=/blog/2018/09/02/how-to-prepare-an-apache-release/>How to prepare an Apache Release</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-blog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo href=/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/>New Async Call</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu href=/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/>The fourth Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-basic-usage-dubbo-consumer-configuration href=/blog/2018/08/14/dubbo-basic-usage-dubbo-consumer-configuration/>Dubbo Consumer Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-several-ways-about-synchronousasynchronous-invoke href=/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/>Dubbo Invoke</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-basic-usage-dubbo-provider-configuration href=/blog/2018/08/14/dubbo-basic-usage-dubbo-provider-configuration/>Dubbo Provider Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814manipulating-services-dynamically-via-qos href=/blog/2018/08/14/manipulating-services-dynamically-via-qos/>Dubbo QoS Introduction</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop href=/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/>Dubbo start/stop in spring boot</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814implementation-of-cross-language-calls-by-dubbo2js href=/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/>dubbo2.js introduction</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814generic-invoke-of-dubbo href=/blog/2018/08/14/generic-invoke-of-dubbo/>Generic invoke</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180810dubbos-load-balance href=/blog/2018/08/10/dubbos-load-balance/>Dubbo's Load Balance</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807use-annotations-in-dubbo href=/blog/2018/08/07/use-annotations-in-dubbo/>Use Annotations In Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807using-zookeeper-in-dubbo href=/blog/2018/08/07/using-zookeeper-in-dubbo/>Using Zookeeper in Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807dubbo-101 href=/blog/2018/08/07/dubbo-101/>Your First Dubbo Demo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen href=/blog/2018/07/30/the-third-dubbo-meetup-has-been-held-in-shenzhen/>The third Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180727sentinel-the-flow-sentinel-of-dubbo-services href=/blog/2018/07/27/sentinel-the-flow-sentinel-of-dubbo-services/>Introduce sentinel</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180712tracking-with-pinpoint href=/blog/2018/07/12/tracking-with-pinpoint/>Tracking with Pinpoint</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180701your-first-dubbo-filter href=/blog/2018/07/01/your-first-dubbo-filter/>Your First Dubbo Filter</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully href=/blog/2018/06/23/the-second-dubbo-shanghai-meetup-has-been-held-successfully/>The second Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180512the-first-dubbo-meetup-has-been-held-in-beijing href=/blog/2018/05/12/the-first-dubbo-meetup-has-been-held-in-beijing/>The first Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180502the-apachecon-na-schedule-has-been-announced href=/blog/2018/05/02/the-apachecon-na-schedule-has-been-announced/>ApacheCon NA</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180425the-gsocgoogle-summer-of-code-2018 href=/blog/2018/04/25/the-gsocgoogle-summer-of-code-2018/>GSoC 2018</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018 href=/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/>QCon Beijing 2018</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Releases</a></li><ul><li class=collapse id=blogreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-blog20200518past-releases href=/blog/2020/05/18/past-releases/>Past Releases</a></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/dubbo-website/edit/master/content/en/blog/news/dubbo-new-async.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/apache/dubbo-website/new/master/content/en/blog/news/dubbo-new-async.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i>Create child page</a>
<a href="https://github.com/apache/dubbo-website/issues/new?title=How%20to%20implement%20a%20fully%20asynchronous%20calls%20chain%20based%20on%20Dubbo" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/apache/dubbo/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#asynchronous-mode-before-version-26x>Asynchronous mode before version 2.6.x</a></li><li><a href=#enhancement-based-on-completablefuture-in-version-270>Enhancement based on CompletableFuture in version 2.7.0</a></li><li><a href=#example-1completablefuture-interface>example 1：CompletableFuture interface</a></li><li><a href=#example-2synchronous-interface-uses-annotation-processor>Example 2：Synchronous interface uses Annotation Processor</a></li><li><a href=#example-3use-asynccontext>Example 3：Use AsyncContext</a></li><li><a href=#new-problems-resulted-from-asynchronization>New problems resulted from asynchronization</a><ul><li><a href=#filter-chain>Filter Chain</a></li><li><a href=#context-passing>Context passing</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=/blog/news/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>How to implement a fully asynchronous calls chain based on Dubbo</h1><div class=lead>This article recalls how asynchronous call is implemented in Dubbo 2.6.x, and introduces the new way based on CompletableFuture in 2.7.0.</div><div class="td-byline mb-4"><time datetime=2018-09-02 class=text-muted>Sunday, September 02, 2018</time></div><p>Implementing the full asynchronous programming based on Dubbo, which is a new feature introduced in version 2.7.0 after the enhancement of the existing asynchronous mode.This article first reviews the supported functions and existing problems of asynchronization in 2.6.x and earlier versions, and introduces the targeted enhancements based on CompletableFuture in version 2.7.0. Then, the use of enhanced asynchronous programming is elaborated through several examples. Finally, it summarizes the new problems brought by the introduction of asynchronous mode and corresponding solutions from Dubbo. By reading this article, it is easy to implement a fully asynchronous remote service call chain based on Dubbo 2.7.0+.</p><h2 id=asynchronous-mode-before-version-26x>Asynchronous mode before version 2.6.x</h2><p>Dubbo Provides some asynchronous programming capabilities in 2.6.x and earlier versions, including <a href=http://dubbo.apache.org/zh-cn/docs/user/demos/async-call.html>Asynchronous Call</a>, <a href=http://dubbo.apache.org/zh-cn/docs/user/demos/callback-parameter.html>Parameter Callback</a> and <a href=http://dubbo.apache.org/zh-cn/docs/user/demos/events-notify.html>Event Notification</a> on Consumer side. There are some brief introductions to the usage and Demo in the above document links.</p><p>But the current asynchronous method has the following problems:</p><ul><li>Methods to access Future object are not direct enough.</li><li>Future interface cannot implement automatic callback. Customized ResponseFuture class could implement callback, however it only supports limited asynchronous scenes. For example, it does not support mutual coordination or combination between Future objects.</li><li>Asynchronization on Provider side is not supported.</li></ul><p>Take the asynchronous method of Consumer side as an example:</p><ol><li>Define a original synchronous interface and add the declaration to support asynchronous calls.</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>FooService</span> <span style=color:#719e07>{</span>
    String <span style=color:#268bd2>findFoo</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#268bd2>&lt;dubbo:reference</span> id=<span style=color:#2aa198>&#34;fooService&#34;</span> interface=<span style=color:#2aa198>&#34;com.alibaba.foo.FooService&#34;</span><span style=color:#268bd2>&gt;</span>
      <span style=color:#268bd2>&lt;dubbo:method</span> name=<span style=color:#2aa198>&#34;findFoo&#34;</span> async=<span style=color:#2aa198>&#34;true&#34;</span> <span style=color:#268bd2>/&gt;</span>
<span style=color:#268bd2>&lt;/dubbo:reference&gt;</span>
</code></pre></div><ol start=2><li>Obtain Future object through RpcContext.</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#586e75>// this call will return null immediately
</span><span style=color:#586e75></span>fooService<span style=color:#719e07>.</span>findFoo<span style=color:#719e07>(</span>fooId<span style=color:#719e07>);</span>
<span style=color:#586e75>// Obtain the Future instance. When the result is returned, Future instance will be notified and the result will be set to Future instance.
</span><span style=color:#586e75></span>Future<span style=color:#719e07>&lt;</span>Foo<span style=color:#719e07>&gt;</span> fooFuture <span style=color:#719e07>=</span> RpcContext<span style=color:#719e07>.</span>getContext<span style=color:#719e07>().</span>getFuture<span style=color:#719e07>();</span>
fooFuture<span style=color:#719e07>.</span>get<span style=color:#719e07>();</span>
</code></pre></div><p>or</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#586e75>// this call will return null immediately
</span><span style=color:#586e75></span>fooService<span style=color:#719e07>.</span>findFoo<span style=color:#719e07>(</span>fooId<span style=color:#719e07>);</span>
<span style=color:#586e75>// get Dubbo&#39;s built-in ResponseFuture, and set the callback
</span><span style=color:#586e75></span>ResponseFuture future <span style=color:#719e07>=</span> <span style=color:#719e07>((</span>FutureAdapter<span style=color:#719e07>)</span>RpcContext<span style=color:#719e07>.</span>getContext<span style=color:#719e07>().</span>getFuture<span style=color:#719e07>()).</span>getFuture<span style=color:#719e07>();</span>
future<span style=color:#719e07>.</span>setCallback<span style=color:#719e07>(</span><span style=color:#719e07>new</span> ResponseCallback<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
    <span style=color:#268bd2>@Override</span>
    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>done</span><span style=color:#719e07>(</span>Object response<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        System<span style=color:#719e07>.</span>out<span style=color:#719e07>.</span>print<span style=color:#719e07>(</span>response<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#268bd2>@Override</span>
    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>caught</span><span style=color:#719e07>(</span>Throwable exception<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        exception<span style=color:#719e07>.</span>printStackTrace<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>});</span>
</code></pre></div><p>From this simple example, we can see there are some inconveniences in use:</p><ol><li>The synchronization interface of findFoo cannot directly return a Future object representing the asynchronous result, which is further obtained through RpcContext.</li><li>Future object can only be obtained from get method that will block until getting the result.</li><li>Callback can be set by getting the built-in ResponseFuture interface. However, the API to obtain ResponseFuture is not convenient enough to support other asynchronous scenes except callback. For example, it does not support the scene where multiple Future objects work together.</li></ol><h2 id=enhancement-based-on-completablefuture-in-version-270>Enhancement based on CompletableFuture in version 2.7.0</h2><p>People who understand the evolution history of Future in Java should know that the Future used in Dubbo 2.6.x and earlier versions is introduced in Java 5, so there are some problems in function design.The CompletableFuture introduced in Java 8 further enriches the Future interface and solves these problems well.</p><p>Support for Java 8 has been upgraded in Dubbo 2.7.0, and Dubbo has enhanced the current asynchronous functionality based on CompletableFuture.</p><ol><li><p>Now it supports direct definition of service interfaces that return CompletableFuture. Through these interfaces, we can implement asynchronous programming on both Consumer side and Provider side more naturally.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>AsyncService</span> <span style=color:#719e07>{</span>
    CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div></li><li><p>If you don&rsquo;t want to define the return value of the interface as a Future object, or if there is a defined synchronization interface, you can additionally define an asynchronous interface and provide a method to return a Future object.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>AsyncService</span> <span style=color:#719e07>{</span>
    CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>@AsyncFor</span><span style=color:#719e07>(</span>AsyncService<span style=color:#719e07>.</span>class<span style=color:#719e07>)</span>
<span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>GrettingServiceAsync</span> <span style=color:#268bd2>extends</span> GreetingsService <span style=color:#719e07>{</span>
    CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>sayHiAsync</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>In this way, Provider can only implement the sayHi method. The Consumer can get a Future instance by directly calling sayHiAsync, and Dubbo framework will convert it to a call to the sayHi method on the Provider side automatically.</p><p>Providing an asynchronous method definition for each synchronization method can be inconvenient. Further, using <a href=https://github.com/dubbo/dubbo-async-processor>Annotation Processor implementation</a> in the Dubbo ecosystem can automatically generate asynchronous method definitions for us.</p></li><li><p>Similarly, if your original interface definition doesn&rsquo;t return a Future object, the Provider side also provides a programming interface similar to the Async Servlet in Servlet 3.0 to support asynchronization : <code>RpcContext.startAsync()</code>.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>AsyncService</span> <span style=color:#719e07>{</span>
    String <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>AsyncServiceImpl</span> <span style=color:#268bd2>implements</span> AsyncService <span style=color:#719e07>{</span>
    <span style=color:#268bd2>public</span> String <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>final</span> AsyncContext asyncContext <span style=color:#719e07>=</span> RpcContext<span style=color:#719e07>.</span>startAsync<span style=color:#719e07>();</span>
        <span style=color:#719e07>new</span> Thread<span style=color:#719e07>(()</span> <span style=color:#719e07>-&gt;</span> <span style=color:#719e07>{</span>
            asyncContext<span style=color:#719e07>.</span>write<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Hello &#34;</span> <span style=color:#719e07>+</span> name <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;, response from provider.&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}).</span>start<span style=color:#719e07>();</span>
        <span style=color:#719e07>return</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>At the beginning of the method body, it starts asynchronization by running <code>RpcContext.startAsync()</code> , and it starts a new thread to execute the business logic asynchronously. After the time-consuming operation is completed, the result is written back by <code>asyncContext.write</code>.</p></li><li><p>RpcContext returns CompletableFuture directly.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> f <span style=color:#719e07>=</span> RpcContext<span style=color:#719e07>.</span>getContext<span style=color:#719e07>().</span>getCompletableFuture<span style=color:#719e07>();</span>
</code></pre></div></li></ol><p>All of the above enhancements are based on the compatibility with existing asynchronous programming, so asynchronous programs written based on 2.6.x versions can be successfully compiled without any modification.</p><p>Next, let&rsquo;s illustrate how to implement a fully asynchronous Dubbo service call chain through a few examples.</p><h2 id=example-1completablefuture-interface>example 1：CompletableFuture interface</h2><p>CompletableFuture interface can be used both for a synchronous call and for an asynchronous call on Consumer or Provider side. This example implements asynchronous calls between Consumer and Provider sides. Code link <a href=https://github.com/apache/dubbo-samples/tree/master/dubbo-samples-async/dubbo-samples-async-original-future>dubbo-samples-async-original-future</a>.</p><ol><li><p>Interface definition</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>AsyncService</span> <span style=color:#719e07>{</span>
    CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>Note that the return type of this interface is <code>CompletableFuture&lt;String></code>.</p></li><li><p>Provider Side</p><ul><li><p>Implementation</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>AsyncServiceImpl</span> <span style=color:#268bd2>implements</span> AsyncService <span style=color:#719e07>{</span>
    <span style=color:#268bd2>public</span> CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>return</span> CompletableFuture<span style=color:#719e07>.</span>supplyAsync<span style=color:#719e07>(()</span> <span style=color:#719e07>-&gt;</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
                Thread<span style=color:#719e07>.</span>sleep<span style=color:#719e07>(</span>5000<span style=color:#719e07>);</span>
            <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>InterruptedException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                e<span style=color:#719e07>.</span>printStackTrace<span style=color:#719e07>();</span>
            <span style=color:#719e07>}</span>
            <span style=color:#719e07>return</span> <span style=color:#2aa198>&#34;async response from provider.&#34;</span><span style=color:#719e07>;</span>
        <span style=color:#719e07>});</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>We can see that the business code is switched to be executed in the new thread by supplyAsync, so the Provider side is asynchronous.</p></li><li><p>Config</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#268bd2>&lt;bean</span> id=<span style=color:#2aa198>&#34;asyncService&#34;</span> class=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.async.impl.AsyncServiceImpl&#34;</span><span style=color:#268bd2>/&gt;</span>
<span style=color:#268bd2>&lt;dubbo:service</span> interface=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span> ref=<span style=color:#2aa198>&#34;asyncService&#34;</span><span style=color:#268bd2>/&gt;</span>
</code></pre></div><p>The Config is the same as the original interface.</p></li></ul></li><li><p>Consumer Side</p><ul><li>Config</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#268bd2>&lt;dubbo:reference</span> id=<span style=color:#2aa198>&#34;asyncService&#34;</span> timeout=<span style=color:#2aa198>&#34;10000&#34;</span> interface=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span><span style=color:#268bd2>/&gt;</span>
</code></pre></div><p>The Config is the same as the original interface.</p><ul><li>Call remote service</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>main</span><span style=color:#719e07>(</span>String<span style=color:#719e07>[]</span> args<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> Exception <span style=color:#719e07>{</span>
        ClassPathXmlApplicationContext context <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ClassPathXmlApplicationContext<span style=color:#719e07>(</span><span style=color:#719e07>new</span> String<span style=color:#719e07>[]{</span><span style=color:#2aa198>&#34;META-INF/spring/async-consumer.xml&#34;</span><span style=color:#719e07>});</span>
        context<span style=color:#719e07>.</span>start<span style=color:#719e07>();</span>
        <span style=color:#268bd2>final</span> AsyncService asyncService <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>AsyncService<span style=color:#719e07>)</span> context<span style=color:#719e07>.</span>getBean<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;asyncService&#34;</span><span style=color:#719e07>);</span>
       
        CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> future <span style=color:#719e07>=</span> asyncService<span style=color:#719e07>.</span>sayHello<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;async call request&#34;</span><span style=color:#719e07>);</span>
        future<span style=color:#719e07>.</span>whenComplete<span style=color:#719e07>((</span>v<span style=color:#719e07>,</span> t<span style=color:#719e07>)</span> <span style=color:#719e07>-&gt;</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>t <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                t<span style=color:#719e07>.</span>printStackTrace<span style=color:#719e07>();</span>
            <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
                System<span style=color:#719e07>.</span>out<span style=color:#719e07>.</span>println<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Response: &#34;</span> <span style=color:#719e07>+</span> v<span style=color:#719e07>);</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>});</span>
        System<span style=color:#719e07>.</span>out<span style=color:#719e07>.</span>println<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Executed before response return.&#34;</span><span style=color:#719e07>);</span>
        System<span style=color:#719e07>.</span>in<span style=color:#719e07>.</span>read<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
</code></pre></div><p><code>CompletableFuture&lt;String> future = asyncService.sayHello("async call request");</code>It is convenient to return the Future instance, which implements the asynchronous service call on the Consumer side.</p></li></ol><h2 id=example-2synchronous-interface-uses-annotation-processor>Example 2：Synchronous interface uses Annotation Processor</h2><p>This example demonstrates how to implement the Consumer-side asynchronous service call using the Annotation Processor based on the original synchronous interface. Code link <a href=https://github.com/apache/dubbo-samples/tree/master/dubbo-samples-async/dubbo-samples-async-generated-future>dubbo-samples-async-generated-future</a>.</p><ol><li><p>Interface definition</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>@DubboAsync</span>
<span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>GreetingsService</span> <span style=color:#719e07>{</span>
    String <span style=color:#268bd2>sayHi</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>This is a generic definition of the Dubbo service interface. Note that add the @DubboAsync annotation when using Annotation Processor.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#268bd2>&lt;dependency&gt;</span>
    <span style=color:#268bd2>&lt;groupId&gt;</span>com.alibaba<span style=color:#268bd2>&lt;/groupId&gt;</span>
    <span style=color:#268bd2>&lt;artifactId&gt;</span>dubbo-async-processer<span style=color:#268bd2>&lt;/artifactId&gt;</span>
    <span style=color:#268bd2>&lt;version&gt;</span>1.0.0-SNAPSHOT<span style=color:#268bd2>&lt;/version&gt;</span>
<span style=color:#268bd2>&lt;/dependency&gt;</span>
<span style=color:#268bd2>&lt;plugin&gt;</span>
    <span style=color:#268bd2>&lt;groupId&gt;</span>org.apache.maven.plugins<span style=color:#268bd2>&lt;/groupId&gt;</span>
    <span style=color:#268bd2>&lt;artifactId&gt;</span>maven-compiler-plugin<span style=color:#268bd2>&lt;/artifactId&gt;</span>
    <span style=color:#268bd2>&lt;version&gt;</span>3.7.0<span style=color:#268bd2>&lt;/version&gt;</span>
    <span style=color:#268bd2>&lt;configuration&gt;</span>
        <span style=color:#268bd2>&lt;source&gt;</span>1.8<span style=color:#268bd2>&lt;/source&gt;</span>
        <span style=color:#268bd2>&lt;target&gt;</span>1.8<span style=color:#268bd2>&lt;/target&gt;</span>
        <span style=color:#268bd2>&lt;annotationProcessorPaths&gt;</span>
            <span style=color:#268bd2>&lt;path&gt;</span>
                <span style=color:#268bd2>&lt;groupId&gt;</span>com.alibaba<span style=color:#268bd2>&lt;/groupId&gt;</span>
                <span style=color:#268bd2>&lt;artifactId&gt;</span>dubbo-async-processer<span style=color:#268bd2>&lt;/artifactId&gt;</span>
                <span style=color:#268bd2>&lt;version&gt;</span>1.0.0-SNAPSHOT<span style=color:#268bd2>&lt;/version&gt;</span>
            <span style=color:#268bd2>&lt;/path&gt;</span>
        <span style=color:#268bd2>&lt;/annotationProcessorPaths&gt;</span>
    <span style=color:#268bd2>&lt;/configuration&gt;</span>
<span style=color:#268bd2>&lt;/plugin&gt;</span>
</code></pre></div><p>The above config is the Maven dependency that imports dubbo-async-processer processor. Developers who define interfaces (providing APIs) usually add the above dependencies to the project, so that when doing API packaging, the following interface definitions will be automatically generated in APIs:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#586e75>/**
</span><span style=color:#586e75>* Generated by dubbo-async-processer
</span><span style=color:#586e75>*/</span>
<span style=color:#719e07>package</span> com.alibaba.dubbo.samples.api<span style=color:#719e07>;</span>
<span style=color:#719e07>import</span> java.util.concurrent.CompletableFuture<span style=color:#719e07>;</span>
<span style=color:#268bd2>@javax.annotation.Generated</span><span style=color:#719e07>(</span><span style=color:#2aa198>&#34;com.alibaba.dubbo.async.processor.AsyncAnnotationProcessor&#34;</span><span style=color:#719e07>)</span>
<span style=color:#268bd2>@org.apache.dubbo.common.config.AsyncFor</span><span style=color:#719e07>(</span>com<span style=color:#719e07>.</span>alibaba<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>samples<span style=color:#719e07>.</span>api<span style=color:#719e07>.</span>GreetingsService<span style=color:#719e07>.</span>class<span style=color:#719e07>)</span>
<span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>GreetingsServiceAsync</span> <span style=color:#268bd2>extends</span> GreetingsService <span style=color:#719e07>{</span>
CompletableFuture<span style=color:#719e07>&lt;</span>java<span style=color:#719e07>.</span>lang<span style=color:#719e07>.</span>String<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>sayHiAsync</span><span style=color:#719e07>(</span>java<span style=color:#719e07>.</span>lang<span style=color:#719e07>.</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div></li><li><p>Provider side</p><ul><li>Config</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#268bd2>&lt;bean</span> id=<span style=color:#2aa198>&#34;greetingsService&#34;</span> class=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.async.impl.GreetingsServiceImpl&#34;</span><span style=color:#268bd2>/&gt;</span>
<span style=color:#268bd2>&lt;dubbo:service</span> interface=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.api.GreetingsService&#34;</span> ref=<span style=color:#2aa198>&#34;greetingsService&#34;</span><span style=color:#268bd2>/&gt;</span>
</code></pre></div><ul><li>Service implementation</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>GreetingsServiceImpl</span> <span style=color:#268bd2>implements</span> GreetingsService <span style=color:#719e07>{</span>
    <span style=color:#268bd2>@Override</span>
    <span style=color:#268bd2>public</span> String <span style=color:#268bd2>sayHi</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>return</span> <span style=color:#2aa198>&#34;hi, &#34;</span> <span style=color:#719e07>+</span> name<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div></li><li><p>Consumer side</p><ul><li>Config</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml> <span style=color:#268bd2>&lt;dubbo:reference</span> id=<span style=color:#2aa198>&#34;greetingsService&#34;</span> interface=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.api.GreetingsServiceAsync&#34;</span><span style=color:#268bd2>/&gt;</span>
</code></pre></div><p>Note that the service interface uses <strong>GreetingsServiceAsync</strong></p><ul><li>Service call</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>main</span><span style=color:#719e07>(</span>String<span style=color:#719e07>[]</span> args<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> Exception <span style=color:#719e07>{</span>
        ClassPathXmlApplicationContext context <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ClassPathXmlApplicationContext<span style=color:#719e07>(</span><span style=color:#719e07>new</span> String<span style=color:#719e07>[]{</span><span style=color:#2aa198>&#34;META-INF/spring/async-consumer.xml&#34;</span><span style=color:#719e07>});</span>
        context<span style=color:#719e07>.</span>start<span style=color:#719e07>();</span>
   
        GreetingsServiceAsync greetingsService <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>GreetingsServiceAsync<span style=color:#719e07>)</span> context<span style=color:#719e07>.</span>getBean<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;greetingsService&#34;</span><span style=color:#719e07>);</span>
        CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> future <span style=color:#719e07>=</span> greetingsService<span style=color:#719e07>.</span>sayHiAsync<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;async call reqeust&#34;</span><span style=color:#719e07>);</span>
        System<span style=color:#719e07>.</span>out<span style=color:#719e07>.</span>println<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;async call ret :&#34;</span> <span style=color:#719e07>+</span> future<span style=color:#719e07>.</span>get<span style=color:#719e07>());</span>
        
        System<span style=color:#719e07>.</span>in<span style=color:#719e07>.</span>read<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
</code></pre></div><p>In this way, we can use <code>CompletableFuture&lt;String> future = greetingsService.sayHiAsync("async call reqeust");</code> directly，and return CompletableFuture.</p></li></ol><h2 id=example-3use-asynccontext>Example 3：Use AsyncContext</h2><p>This example demonstrates how to implement the Provider-side asynchronous execution through AsyncContext based on the original synchronous interface. Code link <a href=https://github.com/apache/dubbo-samples/tree/master/dubbo-samples-async/dubbo-samples-async-provider>dubbo-samples-async-provider</a>.</p><ol><li><p>Interface definition</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>AsyncService</span> <span style=color:#719e07>{</span>
    String <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div></li><li><p>Provider side</p><ul><li>Config</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#268bd2>&lt;bean</span> id=<span style=color:#2aa198>&#34;asyncService&#34;</span> class=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.async.impl.AsyncServiceImpl&#34;</span><span style=color:#268bd2>/&gt;</span>
<span style=color:#268bd2>&lt;dubbo:service</span> async=<span style=color:#2aa198>&#34;true&#34;</span> interface=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span> ref=<span style=color:#2aa198>&#34;asyncService&#34;</span><span style=color:#268bd2>/&gt;</span>
</code></pre></div><p>Note that adding <code>async="true"</code> indicates that this is a service that starts the Provider-side execution asynchronously.</p><ul><li>Asynchronous execution implementation</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>AsyncServiceImpl</span> <span style=color:#268bd2>implements</span> AsyncService <span style=color:#719e07>{</span>
    <span style=color:#268bd2>public</span> String <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>final</span> AsyncContext asyncContext <span style=color:#719e07>=</span> RpcContext<span style=color:#719e07>.</span>startAsync<span style=color:#719e07>();</span>
        <span style=color:#719e07>new</span> Thread<span style=color:#719e07>(()</span> <span style=color:#719e07>-&gt;</span> <span style=color:#719e07>{</span>
            asyncContext<span style=color:#719e07>.</span>signalContextSwitch<span style=color:#719e07>();</span>
            <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
                Thread<span style=color:#719e07>.</span>sleep<span style=color:#719e07>(</span>500<span style=color:#719e07>);</span>
            <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>InterruptedException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                e<span style=color:#719e07>.</span>printStackTrace<span style=color:#719e07>();</span>
            <span style=color:#719e07>}</span>
            asyncContext<span style=color:#719e07>.</span>write<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Hello &#34;</span> <span style=color:#719e07>+</span> name <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;, response from provider.&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}).</span>start<span style=color:#719e07>();</span>
        <span style=color:#719e07>return</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div></li><li><p>Consumer side</p><ul><li>Config</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#268bd2>&lt;dubbo:reference</span> id=<span style=color:#2aa198>&#34;asyncService&#34;</span> interface=<span style=color:#2aa198>&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span><span style=color:#268bd2>/&gt;</span>
</code></pre></div><ul><li>Service call</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>main</span><span style=color:#719e07>(</span>String<span style=color:#719e07>[]</span> args<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> Exception <span style=color:#719e07>{</span>
        ClassPathXmlApplicationContext context <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ClassPathXmlApplicationContext<span style=color:#719e07>(</span><span style=color:#719e07>new</span> String<span style=color:#719e07>[]{</span><span style=color:#2aa198>&#34;META-INF/spring/async-consumer.xml&#34;</span><span style=color:#719e07>});</span>
        context<span style=color:#719e07>.</span>start<span style=color:#719e07>();</span>
   
        AsyncService asyncService <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>AsyncService<span style=color:#719e07>)</span> context<span style=color:#719e07>.</span>getBean<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;asyncService&#34;</span><span style=color:#719e07>);</span>
        System<span style=color:#719e07>.</span>out<span style=color:#719e07>.</span>println<span style=color:#719e07>(</span>asyncService<span style=color:#719e07>.</span>sayHello<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;async call request&#34;</span><span style=color:#719e07>));</span>
        
        System<span style=color:#719e07>.</span>in<span style=color:#719e07>.</span>read<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
</code></pre></div></li></ol><h2 id=new-problems-resulted-from-asynchronization>New problems resulted from asynchronization</h2><h3 id=filter-chain>Filter Chain</h3><p>The following is a complete Filter chain for a normal Dubbo call.</p><p>After using the asynchronous call, since the asynchronous result is executed separately in the asynchronous thread, the Result passed through the second half of the Filter chain is null, and the real result cannot be processed by the Filter chain when it is returned.</p><p>In order to solve this problem, PostProcessFilter and AbstractPostProcessFilter were introduced in Dubbo 2.7.0. The PostProcessFilter interface extends from the Filter interface, and AbstractPostProcessFilter is an abstract implementation of PostProcessFilter.</p><p>The following is an example of extending the Filter and supporting the asynchronous Filter chain.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>@Activate</span><span style=color:#719e07>(</span>group <span style=color:#719e07>=</span> <span style=color:#719e07>{</span>Constants<span style=color:#719e07>.</span>PROVIDER<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>CONSUMER<span style=color:#719e07>})</span>
<span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>AsyncPostprocessFilter</span> <span style=color:#268bd2>extends</span> AbstractPostProcessFilter <span style=color:#719e07>{</span>

    <span style=color:#268bd2>@Override</span>
    <span style=color:#268bd2>public</span> Result <span style=color:#268bd2>invoke</span><span style=color:#719e07>(</span>Invoker<span style=color:#719e07>&lt;?&gt;</span> invoker<span style=color:#719e07>,</span> Invocation invocation<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
        <span style=color:#719e07>return</span> postProcessResult<span style=color:#719e07>(</span>invoker<span style=color:#719e07>.</span>invoke<span style=color:#719e07>(</span>invocation<span style=color:#719e07>),</span> invoker<span style=color:#719e07>,</span> invocation<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#268bd2>@Override</span>
    <span style=color:#268bd2>protected</span> Result <span style=color:#268bd2>doPostProcess</span><span style=color:#719e07>(</span>Result result<span style=color:#719e07>,</span> Invoker<span style=color:#719e07>&lt;?&gt;</span> invoker<span style=color:#719e07>,</span> Invocation invocation<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        System<span style=color:#719e07>.</span>out<span style=color:#719e07>.</span>println<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Filter get the return value: &#34;</span> <span style=color:#719e07>+</span> result<span style=color:#719e07>.</span>getValue<span style=color:#719e07>());</span>
        <span style=color:#719e07>return</span> result<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><h3 id=context-passing>Context passing</h3><p>Currently, the context we are considering mainly refers to the data stored in the RpcContext. In most scenarios, the user needs to complete the passing of the Context before switching the service thread.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>AsyncServiceImpl</span> <span style=color:#268bd2>implements</span> AsyncService <span style=color:#719e07>{</span>
    <span style=color:#586e75>// Save the context of the current thread
</span><span style=color:#586e75></span>    RpcContext context <span style=color:#719e07>=</span> RpcContext<span style=color:#719e07>.</span>getContext<span style=color:#719e07>();</span>
    <span style=color:#268bd2>public</span> CompletableFuture<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>return</span> CompletableFuture<span style=color:#719e07>.</span>supplyAsync<span style=color:#719e07>(()</span> <span style=color:#719e07>-&gt;</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// Set context into new thread
</span><span style=color:#586e75></span>            RpcContext<span style=color:#719e07>.</span>setContext<span style=color:#719e07>(</span>context<span style=color:#719e07>);</span>
            <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
                Thread<span style=color:#719e07>.</span>sleep<span style=color:#719e07>(</span>5000<span style=color:#719e07>);</span>
            <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>InterruptedException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                e<span style=color:#719e07>.</span>printStackTrace<span style=color:#719e07>();</span>
            <span style=color:#719e07>}</span>
            <span style=color:#719e07>return</span> <span style=color:#2aa198>&#34;async response from provider.&#34;</span><span style=color:#719e07>;</span>
        <span style=color:#719e07>});</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>However, AsyncContext also provides the signalContextSwitch() method for a convenient Context switch.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>AsyncServiceImpl</span> <span style=color:#268bd2>implements</span> AsyncService <span style=color:#719e07>{</span>
    <span style=color:#268bd2>public</span> String <span style=color:#268bd2>sayHello</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>final</span> AsyncContext asyncContext <span style=color:#719e07>=</span> RpcContext<span style=color:#719e07>.</span>startAsync<span style=color:#719e07>();</span>
        <span style=color:#719e07>new</span> Thread<span style=color:#719e07>(()</span> <span style=color:#719e07>-&gt;</span> <span style=color:#719e07>{</span>
            asyncContext<span style=color:#719e07>.</span>signalContextSwitch<span style=color:#719e07>();</span>
            <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
                Thread<span style=color:#719e07>.</span>sleep<span style=color:#719e07>(</span>500<span style=color:#719e07>);</span>
            <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>InterruptedException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                e<span style=color:#719e07>.</span>printStackTrace<span style=color:#719e07>();</span>
            <span style=color:#719e07>}</span>
            asyncContext<span style=color:#719e07>.</span>write<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Hello &#34;</span> <span style=color:#719e07>+</span> name <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;, response from provider.&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}).</span>start<span style=color:#719e07>();</span>
        <span style=color:#719e07>return</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/ class="btn btn-primary"><span class=mr-1>←</span> Previous</a></li><a href=/blog/2018/09/02/how-to-prepare-an-apache-release/ class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dubbo mailing list archive" aria-label="Dubbo mailing list archive"><a class=text-white target=_blank rel="noopener noreferrer" href=https://lists.apache.org/list.html?dev@dubbo.apache.org><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/ApacheDubbo><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/apache/dubbo><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Subscribe to mailing list" aria-label="Subscribe to mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=mailto://dev-subscribe@dubbo.apache.org><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. All Rights Reserved</small></div></div></div></footer><div class="row pt-2 pb-2"><div class="container-fluid mx-sm-5"><div class=text-center id=my-footer><img style=float:left src=/imgs/apache_logo.png><ul><li><a href=http://www.apache.org>Foundation</a></li><li><a href=http://www.apache.org/licenses/>License</a></li><li><a href=https://www.apache.org/security/>Security</a></li><li><a href=http://www.apache.org/events/current-event>Events</a></li><li><a href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a href=http://www.apache.org/foundation/thanks.html>Thanks</a></li></ul></div></div></div></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.b5fc1b29d2465835844254bd4d804738eaf24c0cec53009b4c6899989be55a47.js integrity="sha256-tfwbKdJGWDWEQlS9TYBHOOryTAzsUwCbTGiZmJvlWkc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:'38eff7758162fbf70f2b8484932e62ae',indexName:'apache_dubbo',inputSelector:'.td-search-input',debug:false,});</script></body></html>