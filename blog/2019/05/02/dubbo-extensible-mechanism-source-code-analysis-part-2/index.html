<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.80.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Dubbo extensible mechanism source code analysis - part 2 | Apache Dubbo</title><meta property="og:title" content="Dubbo extensible mechanism source code analysis - part 2"><meta property="og:description" content="This article introduces the principles and details of Dubbo's SPI."><meta property="og:type" content="article"><meta property="og:url" content="/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/"><meta property="article:published_time" content="2019-05-02T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-22T23:58:51+08:00"><meta property="og:site_name" content="Apache Dubbo"><meta itemprop=name content="Dubbo extensible mechanism source code analysis - part 2"><meta itemprop=description content="This article introduces the principles and details of Dubbo's SPI."><meta itemprop=datePublished content="2019-05-02T00:00:00+00:00"><meta itemprop=dateModified content="2021-01-22T23:58:51+08:00"><meta itemprop=wordCount content="2629"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Dubbo extensible mechanism source code analysis - part 2"><meta name=twitter:description content="This article introduces the principles and details of Dubbo's SPI."><link rel=preload href=/scss/main.min.8b180b4f9c3e92478ac4794f7583d0b2a7c043e9717486d0407c2dfdf725043f.css as=style><link href=/scss/main.min.8b180b4f9c3e92478ac4794f7583d0b2a7c043e9717486d0407c2dfdf725043f.css rel=stylesheet integrity><script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">Apache Dubbo</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2019/05/02/dubbo%E5%8F%AF%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2019/05/02/dubbo%E5%8F%AF%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Blog</a></li><ul><li class="collapse show" id=blog><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/news/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Articles</a></li><ul><li class="collapse show" id=blognews><a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190826service-test href=/blog/2019/08/26/service-test/>Service test in dubbo admin</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190811tracing-dubbo-service-with-apache-skywalking href=/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/>Use apache skywalking in dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-blog20190502dubbo-extensible-mechanism-source-code-analysis-part-2 href=/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/>Dubbo extensible mechanism - part 2</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190425dubbo-extensible-mechanism-source-code-analysis-part-1 href=/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/>Dubbo extensible mechanism - part 1</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface href=/blog/2019/02/20/implementation-background-and-practice-of-dubbo-client-asynchronous-interface/>Dubbo Async Client</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface href=/blog/2019/02/20/implementation-background-and-practice-of-dubbo-server-asynchronous-interface/>Dubbo Async Server</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20190117how-to-use-seata-to-ensure-consistency-between-dubbo-microservices href=/blog/2019/01/17/how-to-use-seata-to-ensure-consistency-between-dubbo-microservices/>Use Seata in Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou href=/blog/2018/12/10/the-fifth-dubbo-meetup-has-been-held-in-hangzhou/>The fifth Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181107dubbo-integrates-with-nacos-to-become-a-registry href=/blog/2018/11/07/dubbo-integrates-with-nacos-to-become-a-registry/>Use Dubbo with Nacos</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20181005introduction-to-the-dubbo-protocol href=/blog/2018/10/05/introduction-to-the-dubbo-protocol/>Introduction to the Dubbo protocol</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180930integrate-dubbo-with-kubernetes href=/blog/2018/09/30/integrate-dubbo-with-kubernetes/>Integrate Dubbo with Kubernetes</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180902how-to-prepare-an-apache-release href=/blog/2018/09/02/how-to-prepare-an-apache-release/>How to prepare an Apache Release</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo href=/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/>New Async Call</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu href=/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/>The fourth Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-basic-usage-dubbo-consumer-configuration href=/blog/2018/08/14/dubbo-basic-usage-dubbo-consumer-configuration/>Dubbo Consumer Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-several-ways-about-synchronousasynchronous-invoke href=/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/>Dubbo Invoke</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814dubbo-basic-usage-dubbo-provider-configuration href=/blog/2018/08/14/dubbo-basic-usage-dubbo-provider-configuration/>Dubbo Provider Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814manipulating-services-dynamically-via-qos href=/blog/2018/08/14/manipulating-services-dynamically-via-qos/>Dubbo QoS Introduction</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop href=/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/>Dubbo start/stop in spring boot</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814implementation-of-cross-language-calls-by-dubbo2js href=/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/>dubbo2.js introduction</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180814generic-invoke-of-dubbo href=/blog/2018/08/14/generic-invoke-of-dubbo/>Generic invoke</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180810dubbos-load-balance href=/blog/2018/08/10/dubbos-load-balance/>Dubbo's Load Balance</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807use-annotations-in-dubbo href=/blog/2018/08/07/use-annotations-in-dubbo/>Use Annotations In Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807using-zookeeper-in-dubbo href=/blog/2018/08/07/using-zookeeper-in-dubbo/>Using Zookeeper in Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180807dubbo-101 href=/blog/2018/08/07/dubbo-101/>Your First Dubbo Demo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen href=/blog/2018/07/30/the-third-dubbo-meetup-has-been-held-in-shenzhen/>The third Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180727sentinel-the-flow-sentinel-of-dubbo-services href=/blog/2018/07/27/sentinel-the-flow-sentinel-of-dubbo-services/>Introduce sentinel</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180712tracking-with-pinpoint href=/blog/2018/07/12/tracking-with-pinpoint/>Tracking with Pinpoint</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180701your-first-dubbo-filter href=/blog/2018/07/01/your-first-dubbo-filter/>Your First Dubbo Filter</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully href=/blog/2018/06/23/the-second-dubbo-shanghai-meetup-has-been-held-successfully/>The second Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180512the-first-dubbo-meetup-has-been-held-in-beijing href=/blog/2018/05/12/the-first-dubbo-meetup-has-been-held-in-beijing/>The first Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180502the-apachecon-na-schedule-has-been-announced href=/blog/2018/05/02/the-apachecon-na-schedule-has-been-announced/>ApacheCon NA</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180425the-gsocgoogle-summer-of-code-2018 href=/blog/2018/04/25/the-gsocgoogle-summer-of-code-2018/>GSoC 2018</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-blog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018 href=/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/>QCon Beijing 2018</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Releases</a></li><ul><li class=collapse id=blogreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-blog20200518past-releases href=/blog/2020/05/18/past-releases/>Past Releases</a></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/dubbo-website/edit/master/content/en/blog/news/introduction-to-dubbo-spi-2.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/apache/dubbo-website/new/master/content/en/blog/news/introduction-to-dubbo-spi-2.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i>Create child page</a>
<a href="https://github.com/apache/dubbo-website/issues/new?title=Dubbo%20extensible%20mechanism%20source%20code%20analysis%20-%20part%202" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/apache/dubbo/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#extensionloader>ExtensionLoader</a></li><li><a href=#auto-assembly-of-dubbo-spi-advanced-usage>Auto-assembly of Dubbo SPI advanced usage</a></li><li><a href=#aop-of-dubbo-spi-advanced-usage>AOP of Dubbo SPI advanced usage</a><ul><li><a href=#what-is-the-wrapper-class>What is the Wrapper class</a></li><li><a href=#how-to-configure-the-wrapper-class>How to configure the Wrapper class</a></li></ul></li><li><a href=#extension-point-adaptive>Extension point adaptive</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=/blog/news/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>Dubbo extensible mechanism source code analysis - part 2</h1><div class=lead>This article introduces the principles and details of Dubbo&rsquo;s SPI.</div><div class="td-byline mb-4"><time datetime=2019-05-02 class=text-muted>Thursday, May 02, 2019</time></div><p>In the <a href=/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/>actual implementation of the Dubbo extensibility mechanism</a>, we learned some concepts of the Dubbo extension mechanism, explored the implementation of LoadBalance in Dubbo, and implemented a LoadBalance on our own. Do you think Dubbo&rsquo;s extension mechanism is great? Next, we will go deep into the source code of Dubbo and see what it is.</p><h2 id=extensionloader>ExtensionLoader</h2><p><code>ExtensionLoader</code> is the core class, which is responsible for the loading and lifecycle management of extension points. Let&rsquo;s start with this class. There are many methods of Extension, and the common methods include:</p><ul><li><code>public static &lt;T> ExtensionLoader&lt;T> getExtensionLoader(Class&lt;T> type)</code></li><li><code>public T getExtension(String name)</code></li><li><code>public T getAdaptiveExtension()</code></li></ul><p>The common usages are:</p><ul><li><code>LoadBalance lb = ExtensionLoader.getExtensionLoader(LoadBalance.class).getExtension(loadbalanceName)</code></li><li><code>RouterFactory routerFactory = ExtensionLoader.getExtensionLoader(RouterFactory.class).getAdaptiveExtension()</code></li></ul><p>Notice: In the source code shown below, I&rsquo;ll remove extraneous code (such as logging, exception catching, and so on) to make it easy to read and understand.</p><ol><li>getExtensionLoader
This is a static factory method that enters an extensible interface and returns an ExtensionLoader entity class for this interface. With this entity class, you can get not only a specific extension based on name, but also an adaptive extension.</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> ExtensionLoader<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>getExtensionLoader</span><span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> type<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// An extension point must be an interface
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>type<span style=color:#719e07>.</span>isInterface<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Extension type(&#34;</span> <span style=color:#719e07>+</span> type <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;) is not interface!&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#586e75>// @SPI annotations must be provided
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>withExtensionAnnotation<span style=color:#719e07>(</span>type<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Extension type without @SPI Annotation!&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#586e75>// Get the corresponding ExtensionLoader from the cache according to the interface
</span><span style=color:#586e75></span>        <span style=color:#586e75>// Each extension will only be loaded once
</span><span style=color:#586e75></span>        ExtensionLoader<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> loader <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>ExtensionLoader<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;)</span> EXTENSION_LOADERS<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>type<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>loader <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// Initialize extension
</span><span style=color:#586e75></span>            EXTENSION_LOADERS<span style=color:#719e07>.</span>putIfAbsent<span style=color:#719e07>(</span>type<span style=color:#719e07>,</span> <span style=color:#719e07>new</span> ExtensionLoader<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;(</span>type<span style=color:#719e07>));</span>
            loader <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>ExtensionLoader<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;)</span> EXTENSION_LOADERS<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>type<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> loader<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
    
<span style=color:#268bd2>private</span> <span style=color:#268bd2>ExtensionLoader</span><span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;?&gt;</span> type<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>this</span><span style=color:#719e07>.</span>type <span style=color:#719e07>=</span> type<span style=color:#719e07>;</span>
        objectFactory <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>type <span style=color:#719e07>==</span> ExtensionFactory<span style=color:#719e07>.</span>class <span style=color:#719e07>?</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>:</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>ExtensionFactory<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>getAdaptiveExtension<span style=color:#719e07>());</span>
<span style=color:#719e07>}</span>
</code></pre></div><ol start=2><li>getExtension</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> T <span style=color:#268bd2>getExtension</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        Holder<span style=color:#719e07>&lt;</span>Object<span style=color:#719e07>&gt;</span> holder <span style=color:#719e07>=</span> cachedInstances<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>name<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>holder <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            cachedInstances<span style=color:#719e07>.</span>putIfAbsent<span style=color:#719e07>(</span>name<span style=color:#719e07>,</span> <span style=color:#719e07>new</span> Holder<span style=color:#719e07>&lt;</span>Object<span style=color:#719e07>&gt;());</span>
            holder <span style=color:#719e07>=</span> cachedInstances<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>name<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        Object instance <span style=color:#719e07>=</span> holder<span style=color:#719e07>.</span>get<span style=color:#719e07>();</span>
        <span style=color:#586e75>// Get it from the cache. If it does not exist, create
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>instance <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#268bd2>synchronized</span> <span style=color:#719e07>(</span>holder<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                instance <span style=color:#719e07>=</span> holder<span style=color:#719e07>.</span>get<span style=color:#719e07>();</span>
                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>instance <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    instance <span style=color:#719e07>=</span> createExtension<span style=color:#719e07>(</span>name<span style=color:#719e07>);</span>
                    holder<span style=color:#719e07>.</span>set<span style=color:#719e07>(</span>instance<span style=color:#719e07>);</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> <span style=color:#719e07>(</span>T<span style=color:#719e07>)</span> instance<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>Some judgments and caching have been made in the getExtension method, and the main logic is in the createExtension method. Let&rsquo;s move on to the createExtension method.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> T <span style=color:#268bd2>createExtension</span><span style=color:#719e07>(</span>String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// Get the extension class according to the name of extension point. For example,  for LoadBalance, get the RandomLoadBalance class according to random
</span><span style=color:#586e75></span>        Class<span style=color:#719e07>&lt;?&gt;</span> clazz <span style=color:#719e07>=</span> getExtensionClasses<span style=color:#719e07>().</span>get<span style=color:#719e07>(</span>name<span style=color:#719e07>);</span>
        
        T instance <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>T<span style=color:#719e07>)</span> EXTENSION_INSTANCES<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>clazz<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>instance <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
              <span style=color:#586e75>// Use reflection to call newInstance to create an example of an extension class
</span><span style=color:#586e75></span>            EXTENSION_INSTANCES<span style=color:#719e07>.</span>putIfAbsent<span style=color:#719e07>(</span>clazz<span style=color:#719e07>,</span> <span style=color:#719e07>(</span>T<span style=color:#719e07>)</span> clazz<span style=color:#719e07>.</span>newInstance<span style=color:#719e07>());</span>
            instance <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>T<span style=color:#719e07>)</span> EXTENSION_INSTANCES<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>clazz<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#586e75>// Make dependency injection for the extended class samples
</span><span style=color:#586e75></span>        injectExtension<span style=color:#719e07>(</span>instance<span style=color:#719e07>);</span>
        <span style=color:#586e75>// If there is a wrapper, add the wrapper
</span><span style=color:#586e75></span>        Set<span style=color:#719e07>&lt;</span>Class<span style=color:#719e07>&lt;?&gt;&gt;</span> wrapperClasses <span style=color:#719e07>=</span> cachedWrapperClasses<span style=color:#719e07>;</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>wrapperClasses <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>wrapperClasses<span style=color:#719e07>.</span>isEmpty<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;?&gt;</span> wrapperClass <span style=color:#719e07>:</span> wrapperClasses<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                instance <span style=color:#719e07>=</span> injectExtension<span style=color:#719e07>((</span>T<span style=color:#719e07>)</span> wrapperClass<span style=color:#719e07>.</span>getConstructor<span style=color:#719e07>(</span>type<span style=color:#719e07>).</span>newInstance<span style=color:#719e07>(</span>instance<span style=color:#719e07>));</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> instance<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>The createExtension method has done the following:</p><ol><li>First, get the corresponding extension class according to name. Read the extension point configuration file from the <code>META-INF</code> folder under ClassPath.</li><li>Use reflection to create an instance of an extended class.</li><li>make dependency injection for the attributes of the extended class instance. That is, IoC.</li><li>If there is a wrapper, add the wrapper. That is, AOP.</li></ol><p>Let&rsquo;s focus on these four processes.</p><ol><li>Get the corresponding extension class according to name. Let’s read the code first:</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> Map<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Class<span style=color:#719e07>&lt;?&gt;&gt;</span> getExtensionClasses<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        Map<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Class<span style=color:#719e07>&lt;?&gt;&gt;</span> classes <span style=color:#719e07>=</span> cachedClasses<span style=color:#719e07>.</span>get<span style=color:#719e07>();</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>classes <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#268bd2>synchronized</span> <span style=color:#719e07>(</span>cachedClasses<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                classes <span style=color:#719e07>=</span> cachedClasses<span style=color:#719e07>.</span>get<span style=color:#719e07>();</span>
                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>classes <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    classes <span style=color:#719e07>=</span> loadExtensionClasses<span style=color:#719e07>();</span>
                    cachedClasses<span style=color:#719e07>.</span>set<span style=color:#719e07>(</span>classes<span style=color:#719e07>);</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> classes<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>

<span style=color:#586e75>// synchronized in getExtensionClasses
</span><span style=color:#586e75></span><span style=color:#268bd2>private</span> Map<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Class<span style=color:#719e07>&lt;?&gt;&gt;</span> loadExtensionClasses<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>final</span> SPI defaultAnnotation <span style=color:#719e07>=</span> type<span style=color:#719e07>.</span>getAnnotation<span style=color:#719e07>(</span>SPI<span style=color:#719e07>.</span>class<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>defaultAnnotation <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            String value <span style=color:#719e07>=</span> defaultAnnotation<span style=color:#719e07>.</span>value<span style=color:#719e07>();</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>value <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>(</span>value <span style=color:#719e07>=</span> value<span style=color:#719e07>.</span>trim<span style=color:#719e07>()).</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                String<span style=color:#719e07>[]</span> names <span style=color:#719e07>=</span> NAME_SEPARATOR<span style=color:#719e07>.</span>split<span style=color:#719e07>(</span>value<span style=color:#719e07>);</span>
                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>names<span style=color:#719e07>.</span>length <span style=color:#719e07>&gt;</span> 1<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;more than 1 default extension name on extension &#34;</span> <span style=color:#719e07>+</span> type<span style=color:#719e07>.</span>getName<span style=color:#719e07>());</span>
                <span style=color:#719e07>}</span>
                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>names<span style=color:#719e07>.</span>length <span style=color:#719e07>==</span> 1<span style=color:#719e07>)</span> cachedDefaultName <span style=color:#719e07>=</span> names<span style=color:#719e07>[</span>0<span style=color:#719e07>];</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>

        Map<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Class<span style=color:#719e07>&lt;?&gt;&gt;</span> extensionClasses <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> HashMap<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Class<span style=color:#719e07>&lt;?&gt;&gt;();</span>
        loadFile<span style=color:#719e07>(</span>extensionClasses<span style=color:#719e07>,</span> DUBBO_INTERNAL_DIRECTORY<span style=color:#719e07>);</span>
        loadFile<span style=color:#719e07>(</span>extensionClasses<span style=color:#719e07>,</span> DUBBO_DIRECTORY<span style=color:#719e07>);</span>
        loadFile<span style=color:#719e07>(</span>extensionClasses<span style=color:#719e07>,</span> SERVICES_DIRECTORY<span style=color:#719e07>);</span>
        <span style=color:#719e07>return</span> extensionClasses<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>This process is very simple. Get the extension class from the cache first, and if it does not exist, load it from the configuration file. The path of the configuration file has been mentioned before:</p><ul><li><code>META-INF/dubbo/internal</code></li><li><code>META-INF/dubbo</code></li><li><code>META-INF/services</code></li></ul><ol start=2><li>Use reflection to create an extended instance. This process is very simple. We can do this using <code>clazz.newInstance()</code>. The attributes of the extended instance created are all null values.</li><li>Extended instance is automatic assembly. In the actual scenario, there have dependencies between classes. Dependencies are also referenced in the extended instance, such as a simple Java class, an extension of another Dubbo, or a Spring Bean. The situation of dependencies is complex, and Dubbo&rsquo;s processing is relatively complicated. We will have a special chapter to explain it later. Now, we just need to know that Dubbo can correctly inject common dependencies in extension points, Dubbo extension dependencies or Spring dependencies, etc..</li><li>Extended instance is auto-wrapping. Auto-wrapping is about implementing Spring like AOP functionality. Dubbo uses it to implement some common functions internally, such as logging, monitoring, and so on. The contents of the extended instance auto-wrapper will also be explained separately later.</li></ol><p>After the above 4 steps, Dubbo creates and initializes an extended instance. The dependencies of this instance are injected and packaged as needed. At this point, this extended instance can be used.</p><h2 id=auto-assembly-of-dubbo-spi-advanced-usage>Auto-assembly of Dubbo SPI advanced usage</h2><p>The relevant code for auto-assembly is in the injectExtension method:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> T <span style=color:#268bd2>injectExtension</span><span style=color:#719e07>(</span>T instance<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>Method method <span style=color:#719e07>:</span> instance<span style=color:#719e07>.</span>getClass<span style=color:#719e07>().</span>getMethods<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>method<span style=color:#719e07>.</span>getName<span style=color:#719e07>().</span>startsWith<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;set&#34;</span><span style=color:#719e07>)</span>
                <span style=color:#719e07>&amp;&amp;</span> method<span style=color:#719e07>.</span>getParameterTypes<span style=color:#719e07>().</span>length <span style=color:#719e07>==</span> 1
                <span style=color:#719e07>&amp;&amp;</span> Modifier<span style=color:#719e07>.</span>isPublic<span style=color:#719e07>(</span>method<span style=color:#719e07>.</span>getModifiers<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
            Class<span style=color:#719e07>&lt;?&gt;</span> pt <span style=color:#719e07>=</span> method<span style=color:#719e07>.</span>getParameterTypes<span style=color:#719e07>()[</span>0<span style=color:#719e07>];</span>
          
            String property <span style=color:#719e07>=</span> method<span style=color:#719e07>.</span>getName<span style=color:#719e07>().</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 3 <span style=color:#719e07>?</span> method<span style=color:#719e07>.</span>getName<span style=color:#719e07>().</span>substring<span style=color:#719e07>(</span>3<span style=color:#719e07>,</span> 4<span style=color:#719e07>).</span>toLowerCase<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> method<span style=color:#719e07>.</span>getName<span style=color:#719e07>().</span>substring<span style=color:#719e07>(</span>4<span style=color:#719e07>)</span> <span style=color:#719e07>:</span> <span style=color:#2aa198>&#34;&#34;</span><span style=color:#719e07>;</span>
            Object object <span style=color:#719e07>=</span> objectFactory<span style=color:#719e07>.</span>getExtension<span style=color:#719e07>(</span>pt<span style=color:#719e07>,</span> property<span style=color:#719e07>);</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>object <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                method<span style=color:#719e07>.</span>invoke<span style=color:#719e07>(</span>instance<span style=color:#719e07>,</span> object<span style=color:#719e07>);</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>return</span> instance<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>To accomplish the automatic assembly of dependencies of the extended instances, you first need to know what the dependencies are and what the types of dependencies are. The solution of Dubbo is to find the Java standard setter method. That is, the method name starting with set has only one parameter. If such a set method exists in an extension class, Dubbo injects it into dependencies, which is similar to the injection of Spring&rsquo;s set method. However, dependency injection in Dubbo is more complicated than that in Spring, because all the methods injected into Spring are Spring beans and managed by the Spring container. In Dubbo&rsquo;s dependency injection, you may need to inject another extension of Dubbo, or a Spring Bean, or a component of Google guice, or a component in any other framework. Dubbo needs to be able to load extensions from any scenario. In the injectExtension method, it is implemented with <code>Object object = objectFactory. getExtension (pt, property)</code>. ObjectFactory is ExtensionFactory type and initialized when creating ExtensionLoader:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#268bd2>ExtensionLoader</span><span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;?&gt;</span> type<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>this</span><span style=color:#719e07>.</span>type <span style=color:#719e07>=</span> type<span style=color:#719e07>;</span>
        objectFactory <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>type <span style=color:#719e07>==</span> ExtensionFactory<span style=color:#719e07>.</span>class <span style=color:#719e07>?</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>:</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>ExtensionFactory<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>getAdaptiveExtension<span style=color:#719e07>());</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>ObjectFacore is also an extension, obtained through <code>ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension()</code>.</p><p><img src=/imgs/blog/dubbo-extensionfactory.png alt=Dubbo-ExtensionFactory></p><p>ExtensionFactory includes three implementations:</p><ol><li>SpiExtensionFactory: use Dubbo&rsquo;s Spi to load Extension.</li><li>SpringExtensionFactory: load Extension from the Spring container.</li><li>AdaptiveExtensionFactory: adaptive AdaptiveExtensionLoader</li></ol><p>Pay attention to the AdaptiveExtensionLoader here, the source code is as follows:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>@Adaptive</span>
<span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>AdaptiveExtensionFactory</span> <span style=color:#268bd2>implements</span> ExtensionFactory <span style=color:#719e07>{</span>

    <span style=color:#268bd2>private</span> <span style=color:#268bd2>final</span> List<span style=color:#719e07>&lt;</span>ExtensionFactory<span style=color:#719e07>&gt;</span> factories<span style=color:#719e07>;</span>

    <span style=color:#268bd2>public</span> <span style=color:#268bd2>AdaptiveExtensionFactory</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        ExtensionLoader<span style=color:#719e07>&lt;</span>ExtensionFactory<span style=color:#719e07>&gt;</span> loader <span style=color:#719e07>=</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>ExtensionFactory<span style=color:#719e07>.</span>class<span style=color:#719e07>);</span>
        List<span style=color:#719e07>&lt;</span>ExtensionFactory<span style=color:#719e07>&gt;</span> list <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ArrayList<span style=color:#719e07>&lt;</span>ExtensionFactory<span style=color:#719e07>&gt;();</span>
        <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>String name <span style=color:#719e07>:</span> loader<span style=color:#719e07>.</span>getSupportedExtensions<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
            list<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>loader<span style=color:#719e07>.</span>getExtension<span style=color:#719e07>(</span>name<span style=color:#719e07>));</span>
        <span style=color:#719e07>}</span>
        factories <span style=color:#719e07>=</span> Collections<span style=color:#719e07>.</span>unmodifiableList<span style=color:#719e07>(</span>list<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#268bd2>public</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> T <span style=color:#268bd2>getExtension</span><span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> type<span style=color:#719e07>,</span> String name<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>ExtensionFactory factory <span style=color:#719e07>:</span> factories<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            T extension <span style=color:#719e07>=</span> factory<span style=color:#719e07>.</span>getExtension<span style=color:#719e07>(</span>type<span style=color:#719e07>,</span> name<span style=color:#719e07>);</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>extension <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                <span style=color:#719e07>return</span> extension<span style=color:#719e07>;</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>The AdaptiveExtensionLoader class has @Adaptive annotations. As mentioned earlier, Dubbo creates an adaptive instance for each extension. If the extension class has @Adaptive annotations, it will use it as an adaptive class. If not, Dubbo will create one for us. So <code>ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension())</code> will return an AdaptiveExtensionLoader instance as an adaptive extension instance.
The AdaptiveExtensionLoader will iterate through all the ExtensionFactory implementations and try to load the extensions. If found, return. If not, continue to find it in the next ExtensionFactory. Dubbo has two ExtensionFactory built in, which are searched from Dubbo&rsquo;s own extension mechanism and Spring container. Since ExtensionFactory itself is also an extension point, we can implement our own ExtensionFactory to enable automatic assembly of Dubbo to support our custom components. For example, we used Google&rsquo;s guice as an IoC container in our project. We can implement our own GuiceExtensionFactory to enable Dubbo to load extensions from the guice container.</p><h2 id=aop-of-dubbo-spi-advanced-usage>AOP of Dubbo SPI advanced usage</h2><p>We often use AOP functionality when using Spring. Insert other logic before and after the method of the target class. For example, Spring AOP is usually used to implement logging, monitoring, and authentication, and so on.
Does Dubbo&rsquo;s extension mechanism also support similar features? The answer is yes. In Dubbo, there is a special class called the Wrapper class. It uses the wrapper class to wrap the original extension point instance through the decorator pattern, and then inserts additional logic before and after the original extension point implementation to implement AOP functionality.</p><h3 id=what-is-the-wrapper-class>What is the Wrapper class</h3><p>So what kind of class is the Wrapper class in the Dubbo extension mechanism? The Wrapper class is a class that has a replication constructor and also is a typical decorator pattern. Here&rsquo;s a Wrapper class:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>class</span> <span style=color:#268bd2>A</span><span style=color:#719e07>{</span>
    <span style=color:#268bd2>private</span> A a<span style=color:#719e07>;</span>
    <span style=color:#268bd2>public</span> <span style=color:#268bd2>A</span><span style=color:#719e07>(</span>A a<span style=color:#719e07>){</span>
        <span style=color:#719e07>this</span><span style=color:#719e07>.</span>a <span style=color:#719e07>=</span> a<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>Class A has a constructor <code>public A(A a)</code>, and the argument to the constructor is A itself. Such a class can be a Wrapper class in the Dubbo extension mechanism. Such Wrapper classes in Dubbo include ProtocolFilterWrapper, ProtocolListenerWrapper, and so on. You can check the source code to deepen your understanding.</p><h3 id=how-to-configure-the-wrapper-class>How to configure the Wrapper class</h3><p>The Wrapper class in Dubbo is also an extension point. Like other extension points, it is also configured in the <code>META-INF</code> folder. For example, the ProtocolFilterWrapper and ProtocolListenerWrapper in the previous example are configured in the path <code>dubbo-rpc/dubbo-rpc-api/src/main/resources/META-INF/dubbo/internal/org.apache.dubbo.rpc.Protocol</code>:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>filter=org.apache.dubbo.rpc.protocol.ProtocolFilterWrapper
listener=org.apache.dubbo.rpc.protocol.ProtocolListenerWrapper
mock=org.apache.dubbo.rpc.support.MockProtocol
</code></pre></div><p>When Dubbo loads the extension configuration file, there is a piece of code as follows:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#719e07>try</span> <span style=color:#719e07>{</span>  
  clazz<span style=color:#719e07>.</span>getConstructor<span style=color:#719e07>(</span>type<span style=color:#719e07>);</span>    
  Set<span style=color:#719e07>&lt;</span>Class<span style=color:#719e07>&lt;?&gt;&gt;</span> wrappers <span style=color:#719e07>=</span> cachedWrapperClasses<span style=color:#719e07>;</span>
  <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>wrappers <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    cachedWrapperClasses <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ConcurrentHashSet<span style=color:#719e07>&lt;</span>Class<span style=color:#719e07>&lt;?&gt;&gt;();</span>
    wrappers <span style=color:#719e07>=</span> cachedWrapperClasses<span style=color:#719e07>;</span>
  <span style=color:#719e07>}</span>
  wrappers<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>clazz<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>NoSuchMethodException e<span style=color:#719e07>)</span> <span style=color:#719e07>{}</span>
</code></pre></div><p>The meaning of this code is that if the extension class has a copy constructor, it will be saved for later use. The class that has the copy constructor is the Wrapper class. The parameter obtained by <code>clazz.getConstructor(type)</code> is the constructor of the extension point interface. Note that the parameter type of the constructor is an extension point interface, not an extension class.
Take Protocol as an example. The configuration file <code>dubbo-rpc/dubbo-rpc-api/src/main/resources/META-INF/dubbo/internal/org.apache.dubbo.rpc.Protocol defines filter=org.apache.dubbo.rpc.protocol. ProtocolFilterWrapper</code>.
The code of ProtocolFilterWrapper is as follows:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>ProtocolFilterWrapper</span> <span style=color:#268bd2>implements</span> Protocol <span style=color:#719e07>{</span>

    <span style=color:#268bd2>private</span> <span style=color:#268bd2>final</span> Protocol protocol<span style=color:#719e07>;</span>

    <span style=color:#586e75>// One parameter is the copy constructor of Protocol
</span><span style=color:#586e75></span>    <span style=color:#268bd2>public</span> <span style=color:#268bd2>ProtocolFilterWrapper</span><span style=color:#719e07>(</span>Protocol protocol<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>protocol <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;protocol == null&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>this</span><span style=color:#719e07>.</span>protocol <span style=color:#719e07>=</span> protocol<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>ProtocolFilterWrapper has a constructor <code>public ProtocolFilterWrapper(Protocol protocol)</code>, and the parameter is the extension point Protocol. So it is a Wrapper class in the Dubbo extension mechanism. The ExtensionLoader will cache it. When creating Extension instances later, the ExtensionLoader use these wrapper classes to wrap the original Extension point in turn.</p><h2 id=extension-point-adaptive>Extension point adaptive</h2><p>As mentioned earlier, Dubbo needs to determine which extension to use based on method parameters at runtime. So there is an extension point adaptive instance. In fact, it is an extension point proxy that delays the selection of extensions from starting Dubbo to calling RPC. Each extension point in Dubbo has an adaptive class. If it is not explicitly provided, Dubbo will automatically create one for us. By default, Javaassist is used.
Let&rsquo;s first look at the code to create an adaptive extension class:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> T <span style=color:#268bd2>getAdaptiveExtension</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
    Object instance <span style=color:#719e07>=</span> cachedAdaptiveInstance<span style=color:#719e07>.</span>get<span style=color:#719e07>();</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>instance <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#268bd2>synchronized</span> <span style=color:#719e07>(</span>cachedAdaptiveInstance<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                instance <span style=color:#719e07>=</span> cachedAdaptiveInstance<span style=color:#719e07>.</span>get<span style=color:#719e07>();</span>
                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>instance <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                      instance <span style=color:#719e07>=</span> createAdaptiveExtension<span style=color:#719e07>();</span>
                      cachedAdaptiveInstance<span style=color:#719e07>.</span>set<span style=color:#719e07>(</span>instance<span style=color:#719e07>);</span> 
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>        
    <span style=color:#719e07>}</span>

    <span style=color:#719e07>return</span> <span style=color:#719e07>(</span>T<span style=color:#719e07>)</span> instance<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>Continue to read the createAdaptiveExtension method:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> T <span style=color:#268bd2>createAdaptiveExtension</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>        
    <span style=color:#719e07>return</span> injectExtension<span style=color:#719e07>((</span>T<span style=color:#719e07>)</span> getAdaptiveExtensionClass<span style=color:#719e07>().</span>newInstance<span style=color:#719e07>());</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>Continue to read the getAdaptiveExtensionClass method:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> Class<span style=color:#719e07>&lt;?&gt;</span> getAdaptiveExtensionClass<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        getExtensionClasses<span style=color:#719e07>();</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>cachedAdaptiveClass <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>return</span> cachedAdaptiveClass<span style=color:#719e07>;</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> cachedAdaptiveClass <span style=color:#719e07>=</span> createAdaptiveExtensionClass<span style=color:#719e07>();</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>Continue to read the createAdaptiveExtensionClass method. After a long journey, we finally come to a concrete realization. Look at this createAdaptiveExtensionClass method, which first generates the Java source code for the adaptive class, and then compile the source code into Java bytecode and load it into the JVM.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> Class<span style=color:#719e07>&lt;?&gt;</span> createAdaptiveExtensionClass<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        String code <span style=color:#719e07>=</span> createAdaptiveExtensionClassCode<span style=color:#719e07>();</span>
        ClassLoader classLoader <span style=color:#719e07>=</span> findClassLoader<span style=color:#719e07>();</span>
        org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>common<span style=color:#719e07>.</span>compiler<span style=color:#719e07>.</span>Compiler compiler <span style=color:#719e07>=</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>common<span style=color:#719e07>.</span>compiler<span style=color:#719e07>.</span>Compiler<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>getAdaptiveExtension<span style=color:#719e07>();</span>
        <span style=color:#719e07>return</span> compiler<span style=color:#719e07>.</span>compile<span style=color:#719e07>(</span>code<span style=color:#719e07>,</span> classLoader<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>The default implementation of Compiler&rsquo;s code is javassist.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>@SPI</span><span style=color:#719e07>(</span><span style=color:#2aa198>&#34;javassist&#34;</span><span style=color:#719e07>)</span>
<span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>Compiler</span> <span style=color:#719e07>{</span>
    Class<span style=color:#719e07>&lt;?&gt;</span> compile<span style=color:#719e07>(</span>String code<span style=color:#719e07>,</span> ClassLoader classLoader<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>The createAdaptiveExtensionClassCode () method uses a StringBuilder to build Java source code for the adaptive class. The method implementation is relatively long, and the code is not posted here. The approach to bytecode generation is also interesting, first generating Java source code, then compiling it and loading it into the jvm. In this way, the generated Java class can be better controlled. And it doesn&rsquo;t have to care about the API of the bytecode generation framework. Because the xxx.java file is universal in Java, it is also the one we are most familiar with. However, the code is not very readable and you need to build xx. Java content bit by bit.
Below are the Java code example for Protocol adaptive class created by createAdaptiveExtensionClassCode method:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#719e07>package</span> org.apache.dubbo.rpc<span style=color:#719e07>;</span>

<span style=color:#719e07>import</span> org.apache.dubbo.common.extension.ExtensionLoader<span style=color:#719e07>;</span>

<span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>Protocol$Adaptive</span> <span style=color:#268bd2>implements</span> org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Protocol <span style=color:#719e07>{</span>
    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>destroy</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> UnsupportedOperationException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;method public abstract void org.apache.dubbo.rpc.Protocol.destroy() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#268bd2>public</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>getDefaultPort</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> UnsupportedOperationException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;method public abstract int org.apache.dubbo.rpc.Protocol.getDefaultPort() of interface org.apache.dubbo.rpc.Protocol is not adaptive method!&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#268bd2>public</span> org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Exporter <span style=color:#268bd2>export</span><span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Invoker arg0<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>RpcException <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>arg0 <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;org.apache.dubbo.rpc.Invoker argument == null&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>arg0<span style=color:#719e07>.</span>getUrl<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;org.apache.dubbo.rpc.Invoker argument getUrl() == null&#34;</span><span style=color:#719e07>);</span>
        org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>common<span style=color:#719e07>.</span>URL url <span style=color:#719e07>=</span> arg0<span style=color:#719e07>.</span>getUrl<span style=color:#719e07>();</span>
        String extName <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>?</span> <span style=color:#2aa198>&#34;dubbo&#34;</span> <span style=color:#719e07>:</span> url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>());</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>extName <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Fail to get extension(org.apache.dubbo.rpc.Protocol) name from url(&#34;</span> <span style=color:#719e07>+</span> url<span style=color:#719e07>.</span>toString<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;) use keys([protocol])&#34;</span><span style=color:#719e07>);</span>
        org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Protocol extension <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Protocol<span style=color:#719e07>)</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Protocol<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>getExtension<span style=color:#719e07>(</span>extName<span style=color:#719e07>);</span>
        <span style=color:#719e07>return</span> extension<span style=color:#719e07>.</span>export<span style=color:#719e07>(</span>arg0<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#268bd2>public</span> org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Invoker <span style=color:#268bd2>refer</span><span style=color:#719e07>(</span>java<span style=color:#719e07>.</span>lang<span style=color:#719e07>.</span>Class arg0<span style=color:#719e07>,</span> org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>common<span style=color:#719e07>.</span>URL arg1<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>RpcException <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>arg1 <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;url == null&#34;</span><span style=color:#719e07>);</span>
        org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>common<span style=color:#719e07>.</span>URL url <span style=color:#719e07>=</span> arg1<span style=color:#719e07>;</span>
        String extName <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>?</span> <span style=color:#2aa198>&#34;dubbo&#34;</span> <span style=color:#719e07>:</span> url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>());</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>extName <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Fail to get extension(org.apache.dubbo.rpc.Protocol) name from url(&#34;</span> <span style=color:#719e07>+</span> url<span style=color:#719e07>.</span>toString<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;) use keys([protocol])&#34;</span><span style=color:#719e07>);</span>
        org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Protocol extension <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Protocol<span style=color:#719e07>)</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>dubbo<span style=color:#719e07>.</span>rpc<span style=color:#719e07>.</span>Protocol<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>getExtension<span style=color:#719e07>(</span>extName<span style=color:#719e07>);</span>
        <span style=color:#719e07>return</span> extension<span style=color:#719e07>.</span>refer<span style=color:#719e07>(</span>arg0<span style=color:#719e07>,</span> arg1<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>The general logic is the same as at the beginning. The parameters are parsed through the url, and the parsed logic is controlled by the value parameter of @adaptive, and then the extension points implementation are obtained according to the name of the extension point. And then finally make the call. If you want to know the specific construction logic of .Java code, you can see the complete implementation of <code>createAdaptiveExtensionClassCode</code>.
In the generated Protocol$Adaptive, both the getDefaultPort and destroy methods are found to throw the exception directly. Why? Take a look at the source code of Protocol:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>@SPI</span><span style=color:#719e07>(</span><span style=color:#2aa198>&#34;dubbo&#34;</span><span style=color:#719e07>)</span>
<span style=color:#268bd2>public</span> <span style=color:#268bd2>interface</span> <span style=color:#268bd2>Protocol</span> <span style=color:#719e07>{</span>

    <span style=color:#dc322f>int</span> <span style=color:#268bd2>getDefaultPort</span><span style=color:#719e07>();</span>

    <span style=color:#268bd2>@Adaptive</span>
    <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Exporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>export</span><span style=color:#719e07>(</span>Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> invoker<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException<span style=color:#719e07>;</span>

    <span style=color:#268bd2>@Adaptive</span>
    <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>refer</span><span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> type<span style=color:#719e07>,</span> URL url<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException<span style=color:#719e07>;</span>

    <span style=color:#dc322f>void</span> <span style=color:#268bd2>destroy</span><span style=color:#719e07>();</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>As you can see, there are four methods in the Protocol interface, but only the methods of export and refer use the @Adaptive annotation. Dubbo automatically generates adaptive instances, and only the methods modified by @Adaptive has a specific implementation. Therefore, in the Protocol$Adaptive class, only the export and refer methods have specific implementations, and the rest of the methods throw exceptions.</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/ class="btn btn-primary"><span class=mr-1>←</span> Previous</a></li><a href=/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/ class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dubbo mailing list archive" aria-label="Dubbo mailing list archive"><a class=text-white target=_blank rel="noopener noreferrer" href=https://lists.apache.org/list.html?dev@dubbo.apache.org><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/ApacheDubbo><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/apache/dubbo><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Subscribe to mailing list" aria-label="Subscribe to mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=mailto://dev-subscribe@dubbo.apache.org><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. All Rights Reserved</small></div></div></div></footer><div class="row pt-2 pb-2"><div class="container-fluid mx-sm-5"><div class=text-center id=my-footer><img style=float:left src=/imgs/apache_logo.png><ul><li><a href=http://www.apache.org>Foundation</a></li><li><a href=http://www.apache.org/licenses/>License</a></li><li><a href=https://www.apache.org/security/>Security</a></li><li><a href=http://www.apache.org/events/current-event>Events</a></li><li><a href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a href=http://www.apache.org/foundation/thanks.html>Thanks</a></li></ul></div></div></div></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.b5fc1b29d2465835844254bd4d804738eaf24c0cec53009b4c6899989be55a47.js integrity="sha256-tfwbKdJGWDWEQlS9TYBHOOryTAzsUwCbTGiZmJvlWkc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:'38eff7758162fbf70f2b8484932e62ae',indexName:'apache_dubbo',inputSelector:'.td-search-input',debug:false,});</script></body></html>