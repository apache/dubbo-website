---
title: "Dynamically Control Services via QoS"
linkTitle: "Dynamically Control Services via QoS"
tags: ["Java"]
date: 2018-08-14
description: >
    This article explains how to dynamically configure services using Dubbo's QoS functionality, as well as the relevant parameters and configuration methods.
---


QoS, short for `Quality of Service`, is a term commonly found in network devices. For example, in routers, QoS can dynamically adjust and control the weights of certain ports, thereby prioritizing the quality of services running on those ports.

In Dubbo, the concept of QoS is used for dynamically querying and controlling services. For example, to obtain all currently provided and consumed services, and dynamically bring services online or offline from the registry.

## QoS Working Mechanism

Starting from Dubbo 2.5.8, QoS functionality is enabled by default. All QoS functions are abstracted into individual commands, and by executing these commands, QoS will return corresponding results.

> The QoS functionality is based on Netty 4. In versions prior to Dubbo 2.6.x, it depended on Netty 3 by default, so you need to explicitly add the Netty 4 dependency to ensure it works correctly. If you use the Dubbo application generated by http://start.dubbo.io, no extra configuration is needed, as the Netty 4 dependency is included by default.

The working mechanism of QoS is illustrated in the following diagram:

![undefined](/imgs/blog/qos-architecture.png)



1. Start and listen on a port, default port is 22222
2. Identify the protocol of the target request as either Http or Telnet, and dynamically add the corresponding handler based on the protocol
3. Decode for different protocols and parse out the command to be executed
4. Execute the command and return the result

## QoS Commands

The commands currently supported by QoS include:

* help: Help command, lists commands
* ls: Lists all currently provided and consumed services
* online: Dynamically registers a certain or all services to the registry
* offline: Dynamically removes a certain or all services from the registry (unregister)
* quit: Exits the current telnet session

Next, let's specifically operate on how to dynamically control services using QoS.

### Accessing QoS via Telnet

Assuming our Dubbo server is already running, we connect via Telnet:

```
$ telnet localhost 22222
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
  ?????????  ???    ??  ???????????  ???????????   ????????
  ???   ???? ???    ???   ???    ???   ???    ??? ???    ???
  ???    ??? ???    ???   ???    ???   ???    ??? ???    ???
  ???    ??? ???    ???  ??????????   ??????????  ???    ???
  ???    ??? ???    ??? ???????????  ???????????  ???    ???
  ???    ??? ???    ???   ???    ???   ???    ??? ???    ???
  ???   ???? ???    ???   ???    ???   ???    ??? ???    ???
  ?????????  ?????????  ???????????  ???????????   ????????


dubbo>
```

Upon successful connection, the `dubbo>` prompt appears, at which point we enter the `help` command.

```
dubbo>help
+---------+----------------------------------------------------------------------------------+
|    help | help command                                                                     |
+---------+----------------------------------------------------------------------------------+
|      ls | ls service                                                                       |
+---------+----------------------------------------------------------------------------------+
| offline | offline dubbo                                                                    |
+---------+----------------------------------------------------------------------------------+
|  online | online dubbo                                                                     |
+---------+----------------------------------------------------------------------------------+
|    quit | quit telnet console                                                              |
+---------+----------------------------------------------------------------------------------+

dubbo>
```

This will list all currently available commands and their descriptions.

We can also use the help operation on a single command to see examples for that command.

```
dubbo>help online
+--------------+----------------------------------------------------------------------------------+
| COMMAND NAME | online                                                                           |
+--------------+----------------------------------------------------------------------------------+
|      EXAMPLE | online dubbo                                                                     |
|              | online xx.xx.xxx.service                                                         |
+--------------+----------------------------------------------------------------------------------+
```

Using `ls` will show the current service status.

```
dubbo>ls
As Provider side:
+------------------------------------------+---+
|           Provider Service Name          |PUB|
+------------------------------------------+---+
|org.apache.dubbo.demo.provider.DemoService| Y |
+------------------------------------------+---+
As Consumer side:
+---------------------+---+
|Consumer Service Name|NUM|
+---------------------+---+
```

We can see that there is a service `org.apache.dubbo.demo.provider.DemoService` on the provider side, and the second column shows `PUB=Y`, indicating that the service has been published to the registry and is available for consumers.

Assuming we want to bring this service offline dynamically, we can do so using the `offline` command.

```
dubbo>offline org.apache.dubbo.demo.provider.DemoService
OK
```

The command returns OK, and we can check the current status using `ls`:

```
dubbo>ls
As Provider side:
+------------------------------------------+---+
|           Provider Service Name          |PUB|
+------------------------------------------+---+
|org.apache.dubbo.demo.provider.DemoService| N |
+------------------------------------------+---+
As Consumer side:
+---------------------+---+
|Consumer Service Name|NUM|
+---------------------+---+
```

We can see that the `PUB` status of `org.apache.dubbo.demo.provider.DemoService` has been set to `N`.

Using the `quit` command will exit the current telnet session:

```
dubbo>quit
BYE!
Connection closed by foreign host.
```



### Accessing QoS via HTTP

In the previous example, we took the `org.apache.dubbo.demo.provider.DemoService` offline, and now we will perform a registration operation on this service using HTTP:

```
$ curl -i http://localhost:22222/online?service=org.apache.dubbo.demo.provider.DemoService
HTTP/1.1 200 OK
Content-Type: text/plain
Content-Length: 2

OK%
```

> Note that the parameters for the online operation need to be provided in `key=value` format, but in practice, the key will be ignored.

Seeing that the operation returned OK, let’s check the current status using the `ls` command:

```
$ curl -i http://localhost:22222/ls
HTTP/1.1 200 OK
Content-Type: text/plain
Content-Length: 365

As Provider side:
+------------------------------------------+---+
|           Provider Service Name          |PUB|
+------------------------------------------+---+
|org.apache.dubbo.demo.provider.DemoService| Y |
+------------------------------------------+---+
As Consumer side:
+---------------------+---+
|Consumer Service Name|NUM|
+---------------------+---+
```

We can see that the `PUB` status of the service has changed back to `Y`.



## QoS Parameter Descriptions

QoS provides several startup parameters to configure startup, which mainly include:

| Parameter           | Description              | Default Value |
| ------------------ | ----------------- | ------ |
| qosEnable          | Whether to start QoS       | true   |
| qosPort            | Port bound for QoS | 22222  |
| qosAcceptForeignIp | Whether to allow remote access  | false  |

> Note that starting from 2.6.4/2.7.0, the default configuration for qosAcceptForeignIp is false. If qosAcceptForeignIp is set to true, it may pose security risks, so please evaluate carefully before enabling.

QoS parameters can be configured in the following ways:

* System properties
* dubbo.properties
* XML method
* Spring-boot auto-configuration

Among the above methods, the order of precedence is system properties > dubbo.properties > XML/Spring-boot auto-configuration.

### Configuring using System Properties

```
-Ddubbo.application.qos.enable=true
-Ddubbo.application.qos.port=33333
-Ddubbo.application.qos.accept.foreign.ip=false
```

### Configuring using dubbo.properties file

Create a `dubbo.properties` file under the project’s `src/main/resources` directory with the following content:
```
dubbo.application.qos.enable=true
dubbo.application.qos.port=33333
dubbo.application.qos.accept.foreign.ip=false
```

### Configuring using XML

To configure QoS-related parameters via XML, you can use the following configuration:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://dubbo.apache.org/schema/dubbo"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd">
  <dubbo:application name="demo-provider">
    <dubbo:parameter key="qos.enable" value="true"/>
    <dubbo:parameter key="qos.accept.foreign.ip" value="false"/>
    <dubbo:parameter key="qos.port" value="33333"/>
  </dubbo:application>
  <dubbo:registry address="multicast://224.5.6.7:1234"/>
  <dubbo:protocol name="dubbo" port="20880"/>
  <dubbo:service interface="org.apache.dubbo.demo.provider.DemoService" ref="demoService"/>
  <bean id="demoService" class="org.apache.dubbo.demo.provider.DemoServiceImpl"/>
</beans>
```

### Configuring using Spring-boot auto-configuration

For Spring-boot applications, you can configure in the `application.properties` or `application.yml`:

```
dubbo.application.qosEnable=true
dubbo.application.qosPort=33333
dubbo.application.qosAcceptForeignIp=false
```

