{
  "filename": "dubbo-zk.md",
  "__html": "<h1>Using Zookeeper in Dubbo</h1>\n<h2>Introduction of Zookeeper</h2>\n<h3>The basic concept</h3>\n<p>In the mordern distrbuted applications, there are multiple coordination problems between nodes and nodes, including: leader election, group service, locking, configuration management, naming and synchronization. Apache Zookeeper, as its name implied, is a distributed, open-source coordination service framwork to address these demand.</p>\n<p>In order to ensure the high performance, highly available and strictly ordered access, the performance aspects of ZooKeeper means it can be used in large, distributed systems and can also be deployed in cluster mode, which called 'ZooKeeper ensemble'. In ZooKeeper ensemble, all write requests from clients are forwarded to a single server, called the leader, through the ZAB(Zookeeper Atomic Broadcast Protocol) to make sure the message in each nodes are same. Clients can access any one of the clusters to read and write data without worrying about inconsistencies in the data.</p>\n<p><img src=\"../../img/blog/zk-emsemble.png\" alt=\"Diagram shows client-server architecture of ZooKeeper\">\n<em>Image Credit : ebook -Zookeeper-Distributed Process Coordination from O'Reilly</em></p>\n<p>The method to store the data in Zookeeper is similar as the standard UNIX file system, as a data model styled after the familiar directory tree structure of file systems. When we talking about ZooKeeper data nodes, we call it Znodes to clarify it.</p>\n<p><img src=\"../../img/blog/zk-tree.png\" alt=\"zk-tree\">\n<em>Image Credit : ebook -Zookeeper-Distributed Process Coordination from O'Reilly</em></p>\n<h3>Basic Implementation</h3>\n<p>You could donwload and install Zookeeper directly<sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup>.\nOr you could use Homebrew <sup class=\"footnote-ref\"><a href=\"#fn2\" id=\"fnref2\">[2]</a></sup> <code>brew install zookeeper</code> to install Zookeeper in Mac OS.\nConsidering the versatility, we run the Zookeeper by using docker in this blog. If you have not installed the docker yet, please prepare the docker environment first. <sup class=\"footnote-ref\"><a href=\"#fn3\" id=\"fnref3\">[3]</a></sup></p>\n<h4>1. Running the Zookeeper</h4>\n<p>Execute the command to run zookeeper in a docker container</p>\n<pre><code class=\"language-shell\">docker run --rm --name zookeeper -p 2181:2181 zookeeper\n</code></pre>\n<h4>2. Entering the zookeeper container</h4>\n<pre><code class=\"language-shell\">docker exec -it zookeeper bash\n</code></pre>\n<p>In the <code>bin</code> directory, there is a command to start zookeeper <code>zkServer</code> and the Management Console <code>zkCli</code></p>\n<pre><code class=\"language-shell\">bash-4.4# ls -l bin\ntotal 36\n-rwxr-xr-x    1 zookeepe zookeepe       232 Mar 27 04:32 README.txt\n-rwxr-xr-x    1 zookeepe zookeepe      1937 Mar 27 04:32 zkCleanup.sh\n-rwxr-xr-x    1 zookeepe zookeepe      1056 Mar 27 04:32 zkCli.cmd\n-rwxr-xr-x    1 zookeepe zookeepe      1534 Mar 27 04:32 zkCli.sh\n-rwxr-xr-x    1 zookeepe zookeepe      1759 Mar 27 04:32 zkEnv.cmd\n-rwxr-xr-x    1 zookeepe zookeepe      2696 Mar 27 04:32 zkEnv.sh\n-rwxr-xr-x    1 zookeepe zookeepe      1089 Mar 27 04:32 zkServer.cmd\n-rwxr-xr-x    1 zookeepe zookeepe      6773 Mar 27 04:32 zkServer.sh\n</code></pre>\n<h4>3. Entering the zookeeper management interface via zkCli</h4>\n<p>Since it was started through docker, the process of Zookeeper has been started and will provide the services to the public via port 2181.</p>\n<pre><code class=\"language-shell\">bash-4.4# ps\nPID   USER     TIME  COMMAND\n    1 zookeepe  0:02 /usr/lib/jvm/java-1.8-openjdk/jre/bin/java -Dzookeeper.log.dir=. -Dzookeeper.root\n   32 root      0:00 bash\n   42 root      0:00 ps\n</code></pre>\n<p>So, it allows you to access Zookeeper's console directly through <code>zkCli</code> for management.</p>\n<pre><code class=\"language-shell\">bash-4.4# bin/zkCli.sh -server 127.0.0.1:2181\nConnecting to 127.0.0.1:2181\n...\nWATCHER::\n\nWatchedEvent state:SyncConnected type:None path:null\n\n[zk: 127.0.0.1:2181(CONNECTED) 0] help\nZooKeeper -server host:port cmd args\n\tstat path [watch]\n\tset path data [version]\n\tls path [watch]\n\tdelquota [-n|-b] path\n\tls2 path [watch]\n\tsetAcl path acl\n\tsetquota -n|-b val path\n\thistory\n\tredo cmdno\n\tprintwatches on|off\n\tdelete path [version]\n\tsync path\n\tlistquota path\n\trmr path\n\tget path [watch]\n\tcreate [-s] [-e] path data acl\n\taddauth scheme auth\n\tquit\n\tgetAcl path\n\tclose\n\tconnect host:port\n</code></pre>\n<h4>4. Basic Examples on zkCli</h4>\n<p>Create <code>/hello-zone</code> node:</p>\n<pre><code class=\"language-shell\">[zk: 127.0.0.1:2181(CONNECTED) 19] create /hello-zone 'world'\nCreated /hello-zone\n</code></pre>\n<p>List the child nodes under <code>/</code> and confirm that <code>hello-zone</code> is created:</p>\n<pre><code class=\"language-shell\">[zk: 127.0.0.1:2181(CONNECTED) 20] ls /\n[zookeeper, hello-zone]\n</code></pre>\n<p>List the child nodes for <code>/hello-zone</code> and verify that it is empty:</p>\n<pre><code class=\"language-shell\">[zk: 127.0.0.1:2181(CONNECTED) 21] ls /hello-zone\n[]\n</code></pre>\n<p>Get the data stored on the <code>/hello-zone</code> node:</p>\n<pre><code class=\"language-shell\">[zk: 127.0.0.1:2181(CONNECTED) 22] get /hello-zone\nworld\n</code></pre>\n<h2>Using Zookeeper in Dubbo</h2>\n<p>Zookeeper is used for service registration discovery and configuration management in Dubbo, and the structure of data in Zookeeper is shown in the following figure:</p>\n<p><img src=\"../../img/blog/dubbo-in-zk.jpg\" alt=\"dubbo-in-zk\"></p>\n<p>First, all data related to Dubbo is organized under the root node of <code>/duboo</code>.</p>\n<p>The secondary directory is the service name like <code>com.foo.BarService</code>.</p>\n<p>The three-level directory has two child nodes, <code>providers</code> and <code>consumers</code>, representing the supplier and customers of the service.</p>\n<p>The URL information for each application instance associated with the service will be recorded by the Level 4 directory. The <code>providers</code> and <code>consumer</code> will stored the providers information and the consumers information of the services seperately.<br>\nFor example, the service provider of <code>com.foo.BarService</code>  will register its URL Information to <code>/dubbo/com.foo.BarService/providers</code>; Similarly, service consumers will register their information under the corresponding <code>consumer</code> node. At the same time, consumers will subscribe to the corresponding <code>providers</code> node to be able to detect the changes of the service provider address list.</p>\n<h3>Prepare the sample code</h3>\n<p>The code in this document can be found in <a href=\"https://github.com/dubbo/dubbo-samples/tree/master/dubbo-samples-zookeeper\">https://github.com/dubbo/dubbo-samples/tree/master/dubbo-samples-zookeeper</a>.</p>\n<h4>1. Interface definition</h4>\n<p>Define a simple <code>greetingservice</code> interface with only one simple method named <code>sayHello</code> to greet to the caller.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">GreetingService</span> </span>{\n    <span class=\"hljs-function\">String <span class=\"hljs-title\">sayHello</span><span class=\"hljs-params\">(String name)</span></span>;\n}\n</code></pre>\n<h4>2. Server: Implementation</h4>\n<p>Implement the <code>GreetingService</code>  interface and mark it as a service for Dubbo via <code>@Service</code>.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@Service</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AnnotatedGreetingService</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">GreetingService</span> </span>{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">sayHello</span><span class=\"hljs-params\">(String name)</span> </span>{\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"hello, \"</span> + name;\n    }\n}\n</code></pre>\n<h4>3. Server: Assembly</h4>\n<p>Define ProviderConfiguration to assemble Dubbo services.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@Configuration</span>\n<span class=\"hljs-meta\">@EnableDubbo</span>(scanBasePackages = <span class=\"hljs-string\">\"com.alibaba.dubbo.samples.impl\"</span>)\n<span class=\"hljs-meta\">@PropertySource</span>(<span class=\"hljs-string\">\"classpath:/spring/dubbo-provider.properties\"</span>)\n<span class=\"hljs-keyword\">static</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ProviderConfiguration</span> </span>{}\n</code></pre>\n<p>Dubbo-provider.properties is an external configuration in a spring application, as follows:</p>\n<pre><code class=\"language-properties\">dubbo.application.name=demo-provider\ndubbo.registry.address=zookeeper://$DOCKER_HOST:2181\ndubbo.protocol.name=dubbo\ndubbo.protocol.port=20880\n</code></pre>\n<p>Since zookeeper runs in a docker container, please be noted that:</p>\n<ul>\n<li>We assumes that Dubbo applications is running on the host machine (outside the docker container) in this document, and  needs to replace the PATH of Zookeeper with the IP address of the Environment Variable <em>${DOCKER_HOST}</em>. Please find more detail in the official Docker documentation.</li>\n<li>When the Dubbo application is a docker application, the container's name is equivalent to Zookeeper's. The container's name is ** zookeeper ** in this document.</li>\n<li>Of course, if you don't want to run the Zookeeper in a container mode, just simply replace <em>$DOCKER_HOST</em> with <strong>localhost</strong>.</li>\n</ul>\n<h4>4. Server: Starting Service</h4>\n<p>In the <code>main</code> method, you could provide the Dubbo service by running a Spring Context.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ProviderBootstrap</span> </span>{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{\n        AnnotationConfigApplicationContext context = <span class=\"hljs-keyword\">new</span> AnnotationConfigApplicationContext(ProviderConfiguration.class);\n        context.start();\n        System.in.read();\n    }\n}\n</code></pre>\n<p>Start the <code>main</code> method of server,  you will get the following output, which represents the success of the server's startup, and  the <code>GreetingService</code> service is registered on the ZookeeperRegistry:</p>\n<pre><code class=\"language-sh\">[03/08/18 10:50:33:033 CST] main  INFO zookeeper.ZookeeperRegistry:  [DUBBO] Register: dubbo://192.168.99.1:20880/com.alibaba.dubbo.samples.api.GreetingService?anyhost=<span class=\"hljs-literal\">true</span>&amp;application=demo-provider&amp;dubbo=2.6.2&amp;generic=<span class=\"hljs-literal\">false</span>&amp;interface=com.alibaba.dubbo.samples.api.GreetingService&amp;methods=sayHello&amp;pid=12938&amp;side=provider&amp;timestamp=1533264631849, dubbo version: 2.6.2, current host: 192.168.99.1\n</code></pre>\n<p>You could find the registration information of the service provider through the Zookeeper management terminal:</p>\n<pre><code class=\"language-sh\">$ docker <span class=\"hljs-built_in\">exec</span> -it zookeeper bash\nbash-4.4<span class=\"hljs-comment\"># bin/zkCli.sh -server localhost:218</span>\nConnecting to localhost:2181\n...\nWelcome to ZooKeeper!\nJLine support is enabled\n...\n[zk: localhost:2181(CONNECTED) 0] ls /dubbo/com.alibaba.dubbo.samples.api.GreetingService/providers\n[dubbo%3A%2F%2F192.168.99.1%3A20880%2Fcom.alibaba.dubbo.samples.api.GreetingService%3Fanyhost%3Dtrue%26application%3Ddemo-provider%26dubbo%3D2.6.2%26generic%3Dfalse%26interface%3Dcom.alibaba.dubbo.samples.api.GreetingService%26methods%3DsayHello%26pid%3D12938%26side%3Dprovider%26timestamp%3D1533264631849]\n</code></pre>\n<p>You could find that the Dubbo services just registered its URL address at the <code>providers</code> node as follows:\n<em>dubbo://192.168.99.1:20880/com.alibaba.dubbo.samples.api.GreetingService?anyhost=true&amp;application=demo-provider&amp;dubbo=2.6.2&amp;generic=false&amp;interface=com.alibaba.dubbo.samples.api.GreetingService&amp;methods=sayHello&amp;pid=12938&amp;side=provider&amp;timestamp=1533264631849</em></p>\n<h4>5. Client: Reference Service</h4>\n<p>You could declare the reference service by @Reference, while it will generate a full call. The target address of the service could be queried by the Zookeeper's <code>provider</code> node.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@Component</span>(<span class=\"hljs-string\">\"annotatedConsumer\"</span>)\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">GreetingServiceConsumer</span> </span>{\n    <span class=\"hljs-meta\">@Reference</span>\n    <span class=\"hljs-keyword\">private</span> GreetingService greetingService;\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">doSayHello</span><span class=\"hljs-params\">(String name)</span> </span>{\n        <span class=\"hljs-keyword\">return</span> greetingService.sayHello(name);\n    }\n}\n</code></pre>\n<h4>6. Client: Assembling</h4>\n<p>Define the ConsumerConfiguration to assemble Dubbo service.</p>\n<pre><code class=\"language-java\"><span class=\"hljs-meta\">@Configuration</span>\n<span class=\"hljs-meta\">@EnableDubbo</span>(scanBasePackages = <span class=\"hljs-string\">\"com.alibaba.dubbo.samples.action\"</span>)\n<span class=\"hljs-meta\">@PropertySource</span>(<span class=\"hljs-string\">\"classpath:/spring/dubbo-consumer.properties\"</span>)\n<span class=\"hljs-meta\">@ComponentScan</span>(value = {<span class=\"hljs-string\">\"com.alibaba.dubbo.samples.action\"</span>})\n<span class=\"hljs-keyword\">static</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConsumerConfiguration</span> </span>{}\n</code></pre>\n<p>&quot;dubbo-consumer.properties&quot; is a method of external configuration in a Spring application, as follows:</p>\n<pre><code class=\"language-properties\">dubbo.application.name=demo-consumer\ndubbo.registry.address=zookeeper://$DOCKER_HOST:2181\ndubbo.consumer.timeout=3000\n</code></pre>\n<p>Same as <strong>3. Server: Assembling</strong>, You need to modify <em>$DOCKER_HOST</em> defined in <em>dubbo.registry.address</em> according to your own  environment. You could find more instructions in step 3.</p>\n<h4>7. Client: Initiating A Remote Call</h4>\n<p>Run <code>main</code> to initiate a remote call from a existed service provider. Dubbo first subscribes to the zookeeper service address and then selects one from the list of returned addresses to invoke the client:</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConsumerBootstrap</span> </span>{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>{\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConsumerBootstrap</span> </span>{\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> <span class=\"hljs-keyword\">throws</span> IOException </span>{\n        AnnotationConfigApplicationContext context = <span class=\"hljs-keyword\">new</span> AnnotationConfigApplicationContext(ConsumerConfiguration.class);\n        context.start();\n        GreetingServiceConsumer greetingServiceConsumer = context.getBean(GreetingServiceConsumer.class);\n        String hello = greetingServiceConsumer.doSayHello(<span class=\"hljs-string\">\"zookeeper\"</span>);\n        System.out.println(<span class=\"hljs-string\">\"result: \"</span> + hello);\n        System.in.read();\n    }\n}\n</code></pre>\n<p>The output are as follows:</p>\n<pre><code class=\"language-shell\">[03/08/18 01:42:31:031 CST] main  INFO zookeeper.ZookeeperRegistry:  [DUBBO] Register: consumer://192.168.99.1/com.alibaba.dubbo.samples.api.GreetingService?application=demo-consumer&amp;category=consumers&amp;check=false&amp;default.timeout=3000&amp;dubbo=2.6.2&amp;interface=com.alibaba.dubbo.samples.api.GreetingService&amp;methods=sayHello&amp;pid=82406&amp;side=consumer&amp;timestamp=1533274951195, dubbo version: 2.6.2, current host: 192.168.99.1 #1\n[03/08/18 01:42:31:031 CST] main  INFO zookeeper.ZookeeperRegistry:  [DUBBO] Subscribe: consumer://192.168.99.1/com.alibaba.dubbo.samples.api.GreetingService?application=demo-consumer&amp;category=providers,configurators,routers&amp;default.timeout=3000&amp;dubbo=2.6.2&amp;interface=com.alibaba.dubbo.samples.api.GreetingService&amp;methods=sayHello&amp;pid=82406&amp;side=consumer&amp;timestamp=1533274951195, dubbo version: 2.6.2, current host: 192.168.99.1 #2\n...\nresult: hello, zookeeper\n</code></pre>\n<p>Description:</p>\n<ol>\n<li><strong>Register</strong>: consumer://192.168.99.1/...&amp;<strong>category=consumers</strong>&amp;： In Zookeeper, consumers could register their information and store it at the <code>consumers</code> node</li>\n<li><strong>Subscribe</strong>: consumer://192.168.99.1/...&amp;<strong>category=providers,configurators,routers</strong>&amp;：Consumers subscribe <code>providers</code>, <code>configurators</code>, <code>routers</code> from Zookeepers. The <code>configurations</code> is related to the Dubbo configuration, and <code>routers</code> is related to routing rules. The providers node subscription should be noted. When a new service provider to join, due to the relationship between the subscription, the new address list will be pushed to the subscriber. So service consumers also dynamically perceive changes in address lists.</li>\n</ol>\n<p>You could find the registration information of the service provider through the Zookeeper management terminal:</p>\n<pre><code class=\"language-sh\">$ docker <span class=\"hljs-built_in\">exec</span> -it zookeeper bash\nbash-4.4<span class=\"hljs-comment\"># bin/zkCli.sh -server localhost:218</span>\nConnecting to localhost:2181\n...\nWelcome to ZooKeeper!\nJLine support is enabled\n...\n[zk: localhost:2181(CONNECTED) 4] ls /dubbo/com.alibaba.dubbo.samples.api.GreetingService/consumers\n[consumer%3A%2F%2F192.168.99.1%2Fcom.alibaba.dubbo.samples.api.GreetingService%3Fapplication%3Ddemo-consumer%26category%3Dconsumers%26check%3Dfalse%26default.timeout%3D3000%26dubbo%3D2.6.2%26interface%3Dcom.alibaba.dubbo.samples.api.GreetingService%26methods%3DsayHello%26pid%3D82406%26side%3Dconsumer%26timestamp%3D1533274951195]\n</code></pre>\n<p>You could see that  consumers of Dubbo's servicehas registered its URL address at the <code>consumers</code> node:</p>\n<p><em>consumer://192.168.99.1/com.alibaba.dubbo.samples.api.GreetingService?application=demo-consumer&amp;category=providers,configurators,routers&amp;default.timeout=3000&amp;dubbo=2.6.2&amp;interface=com.alibaba.dubbo.samples.api.GreetingService&amp;methods=sayHello&amp;pid=82406&amp;side=consumer&amp;timestamp=1533274951195</em></p>\n<h2>Summary</h2>\n<p>This document focuses on how to use ZooKeeper as a registry in Dubbo. This document also mentioned that the Zookeeper could be a configuration center and a service management in Dubbo. Zookeeper is a single-node, standalone mode. However, developers always bulid a Zookeeper server cluster called * Zookeeper ensemble * in the real world.</p>\n<p>Through this document, readers can learn:</p>\n<ul>\n<li>Basic concepts and applications of ZooKeeper</li>\n<li>The function of Zookeeper in Dubbo application</li>\n<li>Learn about Zookeeper's interaction through practical sample codes</li>\n<li>The storage of service registration and consumption information of Dubbo with ZooKeeper</li>\n</ul>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p><a href=\"https://www.apache.org/dyn/closer.cgi/zookeeper/\">https://www.apache.org/dyn/closer.cgi/zookeeper/</a> <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn2\" class=\"footnote-item\"><p><a href=\"https://brew.sh\">https://brew.sh</a> <a href=\"#fnref2\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n<li id=\"fn3\" class=\"footnote-item\"><p><a href=\"https://www.docker.com/community-edition\">https://www.docker.com/community-edition</a> <a href=\"#fnref3\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n"
}