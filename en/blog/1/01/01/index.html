<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Apache Dubbo</title><meta property="og:title" content><meta property="og:description" content="Overview This document will show you how to access GraalVM with a dubbo project and how to compile the project to a binary executable using native-image. The document also introduces the efforts we made in achieving this.
GraalVM&rsquo;s essential is the Graal compiler, an excellent just-in-time (JIT) compiler. It can be used as both a JIT compiler and a static compiler for ahead-of-time compilation. Graal compiler completes the primary compilation work."><meta property="og:type" content="article"><meta property="og:url" content="https://dubbo.apache.org/en/blog/1/01/01/"><meta property="article:section" content="blog"><meta property="article:modified_time" content="2021-07-16T15:06:29+08:00"><meta property="og:site_name" content="Apache Dubbo"><meta itemprop=name content><meta itemprop=description content="Overview This document will show you how to access GraalVM with a dubbo project and how to compile the project to a binary executable using native-image. The document also introduces the efforts we made in achieving this.
GraalVM&rsquo;s essential is the Graal compiler, an excellent just-in-time (JIT) compiler. It can be used as both a JIT compiler and a static compiler for ahead-of-time compilation. Graal compiler completes the primary compilation work."><meta itemprop=dateModified content="2021-07-16T15:06:29+08:00"><meta itemprop=wordCount content="1364"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Overview This document will show you how to access GraalVM with a dubbo project and how to compile the project to a binary executable using native-image. The document also introduces the efforts we made in achieving this.
GraalVM&rsquo;s essential is the Graal compiler, an excellent just-in-time (JIT) compiler. It can be used as both a JIT compiler and a static compiler for ahead-of-time compilation. Graal compiler completes the primary compilation work."><link rel=preload href=/scss/main.min.4d2a11198108f72ac6d14967441006a13e5f60c35051427324c25c6644ae0ae3.css as=style><link href=/scss/main.min.4d2a11198108f72ac6d14967441006a13e5f60c35051427324c25c6644ae0ae3.css rel=stylesheet integrity><script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/en/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">Apache Dubbo</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/docs/><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/en/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/downloads/><span>Downloads</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/1/01/01/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/1/01/01/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/en/blog/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Blog</a></li><ul><li class="collapse show" id=enblog><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/en/blog/news/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Articles</a></li><ul><li class="collapse show" id=enblognews><a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20190826service-test href=/en/blog/2019/08/26/service-test/>Service test in dubbo admin</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20190811tracing-dubbo-service-with-apache-skywalking href=/en/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/>Use apache skywalking in dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20190502dubbo-extensible-mechanism-source-code-analysis-part-2 href=/en/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/>Dubbo extensible mechanism - part 2</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20190425dubbo-extensible-mechanism-source-code-analysis-part-1 href=/en/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/>Dubbo extensible mechanism - part 1</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface href=/en/blog/2019/02/20/implementation-background-and-practice-of-dubbo-client-asynchronous-interface/>Dubbo Async Client</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface href=/en/blog/2019/02/20/implementation-background-and-practice-of-dubbo-server-asynchronous-interface/>Dubbo Async Server</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20190117how-to-use-seata-to-ensure-consistency-between-dubbo-microservices href=/en/blog/2019/01/17/how-to-use-seata-to-ensure-consistency-between-dubbo-microservices/>Use Seata in Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou href=/en/blog/2018/12/10/the-fifth-dubbo-meetup-has-been-held-in-hangzhou/>The fifth Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20181107dubbo-integrates-with-nacos-to-become-a-registry href=/en/blog/2018/11/07/dubbo-integrates-with-nacos-to-become-a-registry/>Use Dubbo with Nacos</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20181005introduction-to-the-dubbo-protocol href=/en/blog/2018/10/05/introduction-to-the-dubbo-protocol/>Introduction to the Dubbo protocol</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180930integrate-dubbo-with-kubernetes href=/en/blog/2018/09/30/integrate-dubbo-with-kubernetes/>Integrate Dubbo with Kubernetes</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180902how-to-prepare-an-apache-release href=/en/blog/2018/09/02/how-to-prepare-an-apache-release/>How to prepare an Apache Release</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo href=/en/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/>New Async Call</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu href=/en/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/>The fourth Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180814dubbo-basic-usage-dubbo-consumer-configuration href=/en/blog/2018/08/14/dubbo-basic-usage-dubbo-consumer-configuration/>Dubbo Consumer Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180814dubbo-several-ways-about-synchronousasynchronous-invoke href=/en/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/>Dubbo Invoke</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180814dubbo-basic-usage-dubbo-provider-configuration href=/en/blog/2018/08/14/dubbo-basic-usage-dubbo-provider-configuration/>Dubbo Provider Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180814manipulating-services-dynamically-via-qos href=/en/blog/2018/08/14/manipulating-services-dynamically-via-qos/>Dubbo QoS Introduction</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop href=/en/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/>Dubbo start/stop in spring boot</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180814implementation-of-cross-language-calls-by-dubbo2js href=/en/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/>dubbo2.js introduction</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180814generic-invoke-of-dubbo href=/en/blog/2018/08/14/generic-invoke-of-dubbo/>Generic invoke</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180810dubbos-load-balance href=/en/blog/2018/08/10/dubbos-load-balance/>Dubbo's Load Balance</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180807use-annotations-in-dubbo href=/en/blog/2018/08/07/use-annotations-in-dubbo/>Use Annotations In Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180807using-zookeeper-in-dubbo href=/en/blog/2018/08/07/using-zookeeper-in-dubbo/>Using Zookeeper in Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180807dubbo-101 href=/en/blog/2018/08/07/dubbo-101/>Your First Dubbo Demo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen href=/en/blog/2018/07/30/the-third-dubbo-meetup-has-been-held-in-shenzhen/>The third Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180727sentinel-the-flow-sentinel-of-dubbo-services href=/en/blog/2018/07/27/sentinel-the-flow-sentinel-of-dubbo-services/>Introduce sentinel</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180712tracking-with-pinpoint href=/en/blog/2018/07/12/tracking-with-pinpoint/>Tracking with Pinpoint</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180701your-first-dubbo-filter href=/en/blog/2018/07/01/your-first-dubbo-filter/>Your First Dubbo Filter</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully href=/en/blog/2018/06/23/the-second-dubbo-shanghai-meetup-has-been-held-successfully/>The second Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180512the-first-dubbo-meetup-has-been-held-in-beijing href=/en/blog/2018/05/12/the-first-dubbo-meetup-has-been-held-in-beijing/>The first Dubbo meetup</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180502the-apachecon-na-schedule-has-been-announced href=/en/blog/2018/05/02/the-apachecon-na-schedule-has-been-announced/>ApacheCon NA</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180425the-gsocgoogle-summer-of-code-2018 href=/en/blog/2018/04/25/the-gsocgoogle-summer-of-code-2018/>GSoC 2018</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018 href=/en/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/>QCon Beijing 2018</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-enblog10101 href=/en/blog/1/01/01/></a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/en/blog/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Releases</a></li><ul><li class=collapse id=enblogreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20210702301-release-note href=/en/blog/2021/07/02/3.0.1-release-note/>3.0.1</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-enblog20200518past-releases href=/en/blog/2020/05/18/past-releases/>Past Releases</a></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/dubbo-website/edit/master/content/en/blog/news/dubbo-graalvm-support.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/apache/dubbo-website/new/master/content/en/blog/news/dubbo-graalvm-support.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/apache/dubbo-website/issues/new?title=" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/apache/dubbo/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#preparation>Preparation</a></li><li><a href=#get-started>Get Started</a></li><li><a href=#our-efforts>Our Efforts</a><ul><li><a href=#preparations>Preparations</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=https://dubbo.apache.org/en/blog/news/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1></h1><div class="td-byline mb-4"><time datetime=0001-01-01 class=text-muted>Monday, January 01, 0001</time></div><h2 id=overview>Overview</h2><p>This document will show you how to access GraalVM with a dubbo project and how to compile the project to a binary executable using native-image. The document also introduces the efforts we made in achieving this.</p><p>GraalVM&rsquo;s essential is the Graal compiler, an excellent just-in-time (JIT) compiler. It can be used as both a JIT compiler and a static compiler for ahead-of-time compilation. Graal compiler completes the primary compilation work.</p><p>For more information about GraalVM, read <a href=https://www.graalvm.org/docs/getting-started/container-images/>https://www.graalvm.org/docs/getting-started/container-images/</a>.</p><h2 id=preparation>Preparation</h2><p>Before compiling the dubbo project, make sure that we are programming based on the GraalVM environment.</p><p>GraalVM&rsquo;s installation process won&rsquo;t be introduced in this document. You can visit <a href=https://www.graalvm.org/>https://www.graalvm.org/</a> and select the latest version to install. After installation you will be able to see the following in local jdk:</p><p><img src=/imgs/blog/dubbo-graalvm-support/graalvm_env.png alt>
GraalVM we use here is based on jdk version 1.8.</p><h2 id=get-started>Get Started</h2><p>For user&rsquo;s convenience, we provide the following demo in the <a href=https://github.com/apache/dubbo/tree/2.7-native_image>apache:2.7-native_image</a> branch. In module dubbo-demo-native, dubbo&rsquo;s provider and consumer demos are given:</p><p><img src=/imgs/blog/dubbo-graalvm-support/demo_path.png alt></p><p>We used native-image&rsquo;s maven plug-in and customized several native-image starting parameters. Users only need to run maven&rsquo;s compile and package command in consumers' and providers' modules:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>mvn <span style=color:#719e07>-</span>U clean <span style=color:#719e07>package</span> <span style=color:#719e07>-</span>Dmaven.test.skip=<span style=color:#cb4b16>true</span>
</code></pre></div><p>You can see the following output after compilation:</p><p><img src=/imgs/blog/dubbo-graalvm-support/consumer_compiler.png alt><img src=/imgs/blog/dubbo-graalvm-support/provider_compiler.png alt></p><p>Binary executable file generated can be found in the target catalog:</p><p><img src=/imgs/blog/dubbo-graalvm-support/compile_result.png alt></p><p>Size of the binary executable file is around 40M:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>MacdeMacBook-pro-3:target mac$ du -m demo-native-provider 
40    demo-native-provider
</code></pre></div><p>Note: example above is the service registration and discovery based on zookeeper. Users have to launch a zk locally before executing the binary executable file.</p><p>Launch the binary executable file:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>MacdeMacBook-pro-3:target mac$ ./demo-native-provider
......
INFO:  [DUBBO] DubboBootstrap is ready., dubbo version: 2.7.12-SNAPSHOT, current host: 10.220.186.228
Jun 15, 2021 2:29:14 PM org.apache.dubbo.common.logger.jdk.JdkLogger info
INFO:  [DUBBO] DubboBootstrap has started., dubbo version: 2.7.12-SNAPSHOT, current host: 10.220.186.228
Jun 15, 2021 2:29:14 PM org.apache.dubbo.common.logger.jdk.JdkLogger info
INFO:  [DUBBO] DubboBootstrap awaiting ..., dubbo version: 2.7.12-SNAPSHOT, current host: 10.220.186.228
</code></pre></div><p>Enter consumer&rsquo;s target catalog and execute the binary executable file:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>MacdeMacBook-pro-3:target mac$ ./demo-native-consumer 
Hello dubbo, response from provider: 10.220.186.228:20880
</code></pre></div><p>All the launches and invokes above finish within one second.</p><h2 id=our-efforts>Our Efforts</h2><h3 id=preparations>Preparations</h3><h4 id=class-initializations-auxiliary-configurations>Class Initialization&rsquo;s Auxiliary Configurations</h4><p>Since native-image is constructed prior to runtime, its construction is dependent on the static analysis of which code is accessible. However, this analysis cannot always fully predict all usages of Java Native Interface (JNI) , reflection, dynamic proxy object or classpath resource. In the format of <code>native-image</code> configuration file, we need to provide the usages whose dynamic functions are not detected.</p><p>Here we add the following to the JVM parameter:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>-agentlib:native-image-agent=config-output-dir=/path/to/config-dir/
</code></pre></div><p>Parameter above will introduce agent and run the project in the conventional way. Agent will interact with JVM and intercept all invokes that look up classes, methods, fields, resources or request proxy access. Later agent will produce the following files in the specified catalog: <code>jni-config.json</code>, <code>reflect-config.json</code>, <code>proxy-config.json</code> and <code>resource-config.json</code>, etc.</p><p>Copy the files above into project&rsquo;s resource/META-INF/native-image folder. When native-image compiles, operations regarding JNI, reflection, dynamic proxy and resources will be loaded after finding class information from these json files.</p><p>Note: in reality, since agent detects operations while running and not all logic branches can be covered, some classes' json info won&rsquo;t be generated. However, native-image compiles all classes. This will lead to unexpected errors. Currently there&rsquo;s no way for users to distinguish which classes' information are lacking until the errors are reported. Lacked info has to be added to json files manually.</p><h4 id=import-native-image-plug-in>Import Native-Image Plug-In</h4><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;plugin&gt;
  &lt;groupId&gt;org.graalvm.nativeimage&lt;/groupId&gt;
  &lt;artifactId&gt;native-image-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;21.0.0.2&lt;/version&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;goals&gt;
        &lt;goal&gt;native-image&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;phase&gt;package&lt;/phase&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
  &lt;configuration&gt;
    &lt;skip&gt;false&lt;/skip&gt;
    &lt;imageName&gt;demo-native-provider&lt;/imageName&gt;
    &lt;mainClass&gt;org.apache.dubbo.demo.graalvm.provider.Application&lt;/mainClass&gt;
    &lt;buildArgs&gt;
      --no-fallback
      --initialize-at-build-time=org.slf4j.MDC
      --initialize-at-build-time=org.slf4j.LoggerFactory
      --initialize-at-build-time=org.slf4j.impl.StaticLoggerBinder
      --initialize-at-build-time=org.apache.log4j.helpers.Loader
      --initialize-at-build-time=org.apache.log4j.Logger
      --initialize-at-build-time=org.apache.log4j.helpers.LogLog
      --initialize-at-build-time=org.apache.log4j.LogManager
      --initialize-at-build-time=org.apache.log4j.spi.LoggingEvent
      --initialize-at-build-time=org.slf4j.impl.Log4jLoggerFactory
      --initialize-at-build-time=org.slf4j.impl.Log4jLoggerAdapter
      --initialize-at-run-time=io.netty.channel.epoll.Epoll
      --initialize-at-run-time=io.netty.channel.epoll.Native
      --initialize-at-run-time=io.netty.channel.epoll.EpollEventLoop
      --initialize-at-run-time=io.netty.channel.epoll.EpollEventArray
      --initialize-at-run-time=io.netty.channel.DefaultFileRegion
      --initialize-at-run-time=io.netty.channel.kqueue.KQueueEventArray
      --initialize-at-run-time=io.netty.channel.kqueue.KQueueEventLoop
      --initialize-at-run-time=io.netty.channel.kqueue.Native
      --initialize-at-run-time=io.netty.channel.unix.Errors
      --initialize-at-run-time=io.netty.channel.unix.IovArray
      --initialize-at-run-time=io.netty.channel.unix.Limits
      --initialize-at-run-time=io.netty.util.internal.logging.Log4JLogger
      --initialize-at-run-time=io.netty.channel.unix.Socket
      --initialize-at-run-time=io.netty.channel.ChannelHandlerMask
      --report-unsupported-elements-at-runtime
      --allow-incomplete-classpath
      --enable-url-protocols=http
      -H:+ReportExceptionStackTraces
    &lt;/buildArgs&gt;
</code></pre></div><p>After importing the plug-in, native-image command can be automatically executed when executing maven commands such as packaging.</p><h4 id=import-generated-spi-dependency-package>Import Generated SPI Dependency Package</h4><p>SPI mode of dubbo grants huge expandability. It depends on some generated code that are adaptive to extensions. These generated code are not supported by binary images. To deal with this problem, we did the following:</p><ul><li>Export generated code</li></ul><p>(Note: here we modified compiler&rsquo;s code in dubbo-common. Detailed explanations will be presented later on.)</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>public Class&lt;?&gt; doCompile(String name, String source) throws Throwable {
  System.*out*.println(&#34;---&gt;write code:&#34; + name);
  Files.*write*(Paths.*get*(&#34;/tmp/sources/&#34; + name), source.getBytes());
  ......
}
</code></pre></div><ul><li><p>Copy the exported code into dubbo-graalvm module
<img src=/imgs/blog/dubbo-graalvm-support/graalvm.png alt></p></li><li><p>Import module in new project</p></li></ul><p>pom dependency:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>&lt;dependency&gt;
  &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;
  &lt;artifactId&gt;dubbo-graalvm&lt;/artifactId&gt;
  &lt;version&gt;2.7.12-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></div><p>(Note: dubbo that depends on this branch can directly add dependency. Other versions with new SPI added needs to update by exporting the source code.)</p><p>After importing dependencies, we can directly find classes using class names during the process of doCompiler without dynamically generating code:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>@Override
public Class&lt;?&gt; doCompile(String name, String sourceCode) throws Throwable {
  try {
    Class&lt;?&gt; res = Class.*forName*(name);
    return res;
  } catch (Throwable ex) {
    //ignore
  }
  //......
}
</code></pre></div><p>At this point, all dependencies required for native-image compilation are completed. Packaging can generate binary executable file.</p><h4 id=modifications-to-dubbo-source-code>Modifications to Dubbo Source Code</h4><p>Branch is named native_dubbo_0611 and modified based on tag version <a href=https://github.com/apache/dubbo/releases/tag/dubbo-2.7.12>dubbo-2.7.12</a>. Here we will explain the major modifications.</p><ul><li>Avoid dynamically generated code</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>//dubbo-common/src/main/java/org/apache/dubbo/common/compiler/support/JavassistCompiler.java
@Override
public Class&lt;?&gt; doCompile(String name, String source) throws Throwable {
  try {
    Class&lt;?&gt; res = Class.*forName*(name);
    return res;
  } catch (Throwable ex) {
    //ignore
  }
    CtClassBuilder builder = new CtClassBuilder();
    builder.setClassName(name)
    //......
}
//dubbo-common/src/main/java/org/apache/dubbo/common/compiler/support/JdkCompiler.java
@Override
public Class&lt;?&gt; doCompile(String name, String sourceCode) throws Throwable {
  try {
    Class&lt;?&gt; res = Class.*forName*(name);
    return res;
  } catch (Throwable ex) {
    //ignore
  }
  int i = name.lastIndexOf(&#39;.&#39;);
  String packageName = i &lt; 0 ? &#34;&#34; : name.substring(0, i);
  //......
</code></pre></div><p>Here we modified dubbo&rsquo;s both compilation methods. When compiling source code, first determine if the class, which is, in fact, the generated code in dubbo-graalvm that we imported, is loaded locally based on all class name reflection. The loaded class will be returned after importing the package. No compilation required.</p><ul><li>Substitute code generation in ExtensionLoader</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>//dubbo-common/src/main/java/org/apache/dubbo/common/extension/ExtensionLoader.java
private Class&lt;?&gt; createAdaptiveExtensionClass() {
  try {
    Class c = Class.*forName*(generatePackageInfo() + &#34;.&#34; + type.getSimpleName() + &#34;$Adaptive&#34;);
    return c;
  } catch (Throwable e) {
    //ignore
  }
  String code = new AdaptiveClassCodeGenerator(type,cachedDefaultName).generate();
    //......
}
private static final String *CODE_PACKAGE* = &#34;%s&#34;;
private String generatePackageInfo() {
  return String.*format*(*CODE_PACKAGE*, type.getPackage().getName());
}
</code></pre></div><p>ExtensionLoader is the main logic class of the whole extension mechanism. Works such as loading configuration, extension class cache and generating self-adopting objects, are all done in the class.</p><p>getAdaptiveExtension() method automatically creates implementation class String for extension points interface.</p><p>Similar to the first modification mentioned above, since we imported the SPI package, code generation is no longer needed. Requesting local class based on class name will work. Return when the implementation class is found. Notice here that the generated extension class names all end with $Adaptive. When looking for classes, remember to add the suffix.</p><ul><li>Substitute Wrapper&rsquo;s usage in Reference/ServiceConfig</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>//dubbo-config/dubbo-config-api/src/main/java/org/apache/dubbo/config/ReferenceConfig.java
// String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();
  String[] methods = Arrays.*stream*(interfaceClass.getMethods()).map(it-&gt;it.getName()).toArray(String[]::new);
  if (methods.length == 0) {
   l*ogger*.warn(&#34;No method found in service interface &#34; + interfaceClass.getName());
    map.put(*METHODS_KEY*, *ANY_VALUE*);
  //......
}
//dubbo-config/dubbo-config-api/src/main/java/org/apache/dubbo/config/ServiceConfig.java
// String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();
  String[] methods = Arrays.*stream*(interfaceClass.getMethods()).map(it-&gt;it.getName()).toArray(String[]::new);
  if (methods.length == 0) {
   l*ogger*.warn(&#34;No method found in service interface &#34; + interfaceClass.getName());
    map.put(*METHODS_KEY*, *ANY_VALUE*);
  //......
</code></pre></div><p>Since Wrapper&rsquo;s getWrapper needs to be dynamically generated, here we substitute it by reflected getMethods.</p><ul><li>Add dubbo-graalvm module</li></ul><p>dubbo-graalvm&rsquo;s uses have been explained previously.</p><ul><li>Substitute fastjson by gson</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>//dubbo-registry/dubbo-registry-api/src/main/java/org/apache/dubbo/registry/client/metadata/store/InMemoryWritableMetadataService.java
@Override
public void publishServiceDefinition(URL providerUrl) {
  try {
    if (!ProtocolUtils.*isGeneric*(providerUrl.getParameter(*GENERIC_KEY*))) {
      String interfaceName = providerUrl.getParameter(*INTERFACE_KEY*);
      if (StringUtils.*isNotEmpty*(interfaceName)) {
        Class interfaceClass = Class.*forName*(interfaceName);
        ServiceDefinition serviceDefinition = ServiceDefinitionBuilder.*build*(interfaceClass);
        String data = new Gson().toJson(serviceDefinition);
        serviceDefinitions.put(providerUrl.getServiceKey(), data);
        return;
      }
  //......
}
</code></pre></div><p>cglib is used in fastjson for dynamic proxy, but native-image does not support cglib. So here we use gson instead.</p><ul><li>Substitute set by list for multiple interface proxy invoke</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>//dubbo-rpc/dubbo-rpc-api/src/main/java/org/apache/dubbo/rpc/proxy/AbstractProxyFactory.java
@Override
public &lt;T&gt; T getProxy(Invoker&lt;T&gt; invoker, boolean generic) throws RpcException {
  List&lt;Class&lt;?&gt;&gt; interfaces = new ArrayList&lt;&gt;();
  String config = invoker.getUrl().getParameter(*INTERFACES*);
  if (config != null &amp;&amp; config.length() &gt; 0) {
    String[] types = *COMMA_SPLIT_PATTERN*.split(config);
    for (String type : types) {
      // *TODO can we load successfully for a different classloader?.*
      interfaces.add(ReflectUtils.*forName*(type));
    }
  }
  //......
}
</code></pre></div><p>The service here has multiple interfaces which have to be in order when requesting proxy. Set does not fulfill the requirement so we use ArrayList instead.</p><p>Major modifications to dubbo source code are listed above.</p><p>Link to the branch: <a href=https://github.com/apache/dubbo/tree/2.7-native_image>https://github.com/apache/dubbo/tree/2.7-native_image</a></p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a class="btn btn-primary disabled"><span class=mr-1>←</span> Previous</a></li><a href=/en/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/ class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dubbo mailing list archive" aria-label="Dubbo mailing list archive"><a class=text-white target=_blank rel="noopener noreferrer" href=https://lists.apache.org/list.html?dev@dubbo.apache.org><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/ApacheDubbo><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/apache/dubbo><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Subscribe to mailing list" aria-label="Subscribe to mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=mailto://dev-subscribe@dubbo.apache.org><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. All Rights Reserved</small></div></div></div></footer><div class="row pt-2 pb-2"><div class="container-fluid mx-sm-5"><div class=text-center id=my-footer><img style=float:left src=/imgs/apache_logo.png><ul><li><a href=http://www.apache.org>Foundation</a></li><li><a href=http://www.apache.org/licenses/>License</a></li><li><a href=https://www.apache.org/security/>Security</a></li><li><a href=http://www.apache.org/events/current-event>Events</a></li><li><a href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a href=http://www.apache.org/foundation/thanks.html>Thanks</a></li></ul></div></div></div></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.b1204cf86e8e9a67512f5a2424ceff1cf41fa3fea170a94a53582b7226e2044e.js integrity="sha256-sSBM+G6OmmdRL1okJM7/HPQfo/6hcKlKU1grcibiBE4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:'38eff7758162fbf70f2b8484932e62ae',indexName:'apache_dubbo',inputSelector:'.td-search-input',debug:!1})</script></body></html>