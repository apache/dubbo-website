<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.109.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Source code analysis of spring-boot+Dubbo App start and stop | Apache Dubbo</title><meta property="og:title" content="Source code analysis of spring-boot+Dubbo App start and stop"><meta property="og:description" content="This article introduces the implementation details of app start and stop in `dubbo-spring-boot-project`.
"><meta property="og:type" content="article"><meta property="og:url" content="https://dubbo.apache.org/en/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2018-08-14T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-22T13:19:33+08:00"><meta property="og:site_name" content="Apache Dubbo"><meta itemprop=name content="Source code analysis of spring-boot+Dubbo App start and stop"><meta itemprop=description content="This article introduces the implementation details of app start and stop in `dubbo-spring-boot-project`.
"><meta itemprop=datePublished content="2018-08-14T00:00:00+00:00"><meta itemprop=dateModified content="2020-12-22T13:19:33+08:00"><meta itemprop=wordCount content="1337"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Source code analysis of spring-boot+Dubbo App start and stop"><meta name=twitter:description content="This article introduces the implementation details of app start and stop in `dubbo-spring-boot-project`.
"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-112489517-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.8637cb48af1c2672dbf22e4e83652c0cebe2d667477b88c8a046be155bcf7cfe.css as=style><link href=/scss/main.min.8637cb48af1c2672dbf22e4e83652c0cebe2d667477b88c8a046be155bcf7cfe.css rel=stylesheet integrity><script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/en/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">Apache Dubbo</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/overview/><span>Overview</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/docs3-v2/><span>SDK Manual</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/en/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/release/><span>Releases</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/users/><span>Users</span></a></li><li class="nav-item dropdown d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div id=docsearch></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div id=docsearch></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-enblog-li><a href=/en/blog/ title="Apache Dubbo Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-enblog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-enblognews-li><a href=/en/blog/news/ title="Articles About Apache Dubbo" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-enblognews><span>Articles</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20220504how-to-proxy-dubbo-service-in-apache-shenyu-gateway-li><a href=/en/blog/2022/05/04/how-to-proxy-dubbo-service-in-apache-shenyu-gateway/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20220504how-to-proxy-dubbo-service-in-apache-shenyu-gateway><span>How to proxy Dubbo service in Apache ShenYu Gateway</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20220118makes-it-more-convenient-for-you-to-proxy-dubbo-services-in-apache-apisix-li><a href=/en/blog/2022/01/18/makes-it-more-convenient-for-you-to-proxy-dubbo-services-in-apache-apisix/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20220118makes-it-more-convenient-for-you-to-proxy-dubbo-services-in-apache-apisix><span>Makes it More Convenient for You to Proxy Dubbo Services in Apache APISIX</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20190826service-test-li><a href=/en/blog/2019/08/26/service-test/ title="Dubbo Admin service test" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20190826service-test><span>Service test in dubbo admin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20190811tracing-dubbo-service-with-apache-skywalking-li><a href=/en/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/ title="Tracing Dubbo service with Apache Skywalking" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20190811tracing-dubbo-service-with-apache-skywalking><span>Use apache skywalking in dubbo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20190502dubbo-extensible-mechanism-source-code-analysis-part-2-li><a href=/en/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/ title="Dubbo extensible mechanism source code analysis - part 2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20190502dubbo-extensible-mechanism-source-code-analysis-part-2><span>Dubbo extensible mechanism - part 2</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20190425dubbo-extensible-mechanism-source-code-analysis-part-1-li><a href=/en/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/ title="Dubbo extensible mechanism source code analysis - part 1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20190425dubbo-extensible-mechanism-source-code-analysis-part-1><span>Dubbo extensible mechanism - part 1</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface-li><a href=/en/blog/2019/02/20/implementation-background-and-practice-of-dubbo-client-asynchronous-interface/ title="Implementation background and practice of Dubbo client asynchronous interface" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface><span>Dubbo Async Client</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface-li><a href=/en/blog/2019/02/20/implementation-background-and-practice-of-dubbo-server-asynchronous-interface/ title="Implementation background and practice of Dubbo server asynchronous interface" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface><span>Dubbo Async Server</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20190117how-to-use-seata-to-ensure-consistency-between-dubbo-microservices-li><a href=/en/blog/2019/01/17/how-to-use-seata-to-ensure-consistency-between-dubbo-microservices/ title="How to use Seata to ensure consistency between Dubbo Microservices" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20190117how-to-use-seata-to-ensure-consistency-between-dubbo-microservices><span>Use Seata in Dubbo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou-li><a href=/en/blog/2018/12/10/the-fifth-dubbo-meetup-has-been-held-in-hangzhou/ title="The fifth Dubbo meetup has been held in Hangzhou" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou><span>The fifth Dubbo meetup</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20181107dubbo-integrates-with-nacos-to-become-a-registry-li><a href=/en/blog/2018/11/07/dubbo-integrates-with-nacos-to-become-a-registry/ title="Dubbo Integrates with Nacos to Become a Registry" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20181107dubbo-integrates-with-nacos-to-become-a-registry><span>Use Dubbo with Nacos</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20181005introduction-to-the-dubbo-protocol-li><a href=/en/blog/2018/10/05/introduction-to-the-dubbo-protocol/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20181005introduction-to-the-dubbo-protocol><span>Introduction to the Dubbo protocol</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180930integrate-dubbo-with-kubernetes-li><a href=/en/blog/2018/09/30/integrate-dubbo-with-kubernetes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180930integrate-dubbo-with-kubernetes><span>Integrate Dubbo with Kubernetes</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180902how-to-prepare-an-apache-release-li><a href=/en/blog/2018/09/02/how-to-prepare-an-apache-release/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180902how-to-prepare-an-apache-release><span>How to prepare an Apache Release</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo-li><a href=/en/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/ title="How to implement a fully asynchronous calls chain based on Dubbo" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo><span>New Async Call</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu-li><a href=/en/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/ title="The fourth Dubbo meetup has been held in Chengdu" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu><span>The fourth Dubbo meetup</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180814dubbo-basic-usage-dubbo-consumer-configuration-li><a href=/en/blog/2018/08/14/dubbo-basic-usage-dubbo-consumer-configuration/ title=" Dubbo Basic Usage - Dubbo Consumer Configuration" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180814dubbo-basic-usage-dubbo-consumer-configuration><span>Dubbo Consumer Configuration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180814dubbo-several-ways-about-synchronousasynchronous-invoke-li><a href=/en/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/ title="Dubbo: Several ways about synchronous/asynchronous invoke" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180814dubbo-several-ways-about-synchronousasynchronous-invoke><span>Dubbo Invoke</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180814dubbo-basic-usage--dubbo-provider-configuration-li><a href=/en/blog/2018/08/14/dubbo-basic-usage--dubbo-provider-configuration/ title="Dubbo Basic Usage -- Dubbo Provider Configuration" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180814dubbo-basic-usage--dubbo-provider-configuration><span>Dubbo Provider Configuration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180814manipulating-services-dynamically-via-qos-li><a href=/en/blog/2018/08/14/manipulating-services-dynamically-via-qos/ title="Manipulating Services Dynamically via QoS" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180814manipulating-services-dynamically-via-qos><span>Dubbo QoS Introduction</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop-li><a href=/en/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/ title="Source code analysis of spring-boot+Dubbo App start and stop" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-enblog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop><span class=td-sidebar-nav-active-item>Dubbo start/stop in spring boot</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180814implementation-of-cross-language-calls-by-dubbo2js-li><a href=/en/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/ title="Implementation of cross-language calls by Dubbo2.js" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180814implementation-of-cross-language-calls-by-dubbo2js><span>dubbo2.js introduction</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180814generic-invoke-of-dubbo-li><a href=/en/blog/2018/08/14/generic-invoke-of-dubbo/ title="Generic invoke of Dubbo" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180814generic-invoke-of-dubbo><span>Generic invoke</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180814native-image-using-graalvm-li><a href=/en/blog/2018/08/14/native-image-using-graalvm/ title="Native Image using GraalVM" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180814native-image-using-graalvm><span>Native Image</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180810dubbos-load-balance-li><a href=/en/blog/2018/08/10/dubbos-load-balance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180810dubbos-load-balance><span>Dubbo's Load Balance</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180807use-annotations-in-dubbo-li><a href=/en/blog/2018/08/07/use-annotations-in-dubbo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180807use-annotations-in-dubbo><span>Use Annotations In Dubbo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180807using-zookeeper-in-dubbo-li><a href=/en/blog/2018/08/07/using-zookeeper-in-dubbo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180807using-zookeeper-in-dubbo><span>Using Zookeeper in Dubbo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180807dubbo-101-li><a href=/en/blog/2018/08/07/dubbo-101/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180807dubbo-101><span>Your First Dubbo Demo</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen-li><a href=/en/blog/2018/07/30/the-third-dubbo-meetup-has-been-held-in-shenzhen/ title="The third Dubbo meetup has been held in Shenzhen" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen><span>The third Dubbo meetup</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180727sentinel-the-flow-sentinel-of-dubbo-services-li><a href=/en/blog/2018/07/27/sentinel-the-flow-sentinel-of-dubbo-services/ title="Sentinel: The flow sentinel of Dubbo services" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180727sentinel-the-flow-sentinel-of-dubbo-services><span>Introduce sentinel</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180712tracking-with-pinpoint-li><a href=/en/blog/2018/07/12/tracking-with-pinpoint/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180712tracking-with-pinpoint><span>Tracking with Pinpoint</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180701your-first-dubbo-filter-li><a href=/en/blog/2018/07/01/your-first-dubbo-filter/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180701your-first-dubbo-filter><span>Your First Dubbo Filter</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully-li><a href=/en/blog/2018/06/23/the-second-dubbo-shanghai-meetup-has-been-held-successfully/ title="The second Dubbo Shanghai meetup has been held successfully" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully><span>The second Dubbo meetup</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180512the-first-dubbo-meetup-has-been-held-in-beijing-li><a href=/en/blog/2018/05/12/the-first-dubbo-meetup-has-been-held-in-beijing/ title="The first Dubbo meetup has been held in Beijing" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180512the-first-dubbo-meetup-has-been-held-in-beijing><span>The first Dubbo meetup</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180502the-apachecon-na-schedule-has-been-announced-li><a href=/en/blog/2018/05/02/the-apachecon-na-schedule-has-been-announced/ title="The ApacheCon NA schedule has been announced" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180502the-apachecon-na-schedule-has-been-announced><span>ApacheCon NA</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180425the-gsocgoogle-summer-of-code-2018-li><a href=/en/blog/2018/04/25/the-gsocgoogle-summer-of-code-2018/ title="The GSoC(Google Summer of Code) 2018" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180425the-gsocgoogle-summer-of-code-2018><span>GSoC 2018</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-enblog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018-li><a href=/en/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/ title="Dubbo roadmap is announced in QCon Beijing 2018" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018><span>QCon Beijing 2018</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-enblogreleases-li><a href=/en/blog/releases/ title="New Releases" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-enblogreleases><span>Releases</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-enblog202109202714-release-note-li><a href=/en/blog/2021/09/20/2.7.14-release-note/ title="2.7.14 Release Note" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog202109202714-release-note><span>2.7.14</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-enblog202108233021-release-note-li><a href=/en/blog/2021/08/23/3.0.2.1-release-note/ title="3.0.2.1 Release Note" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog202108233021-release-note><span>3.0.2.1</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-enblog20210818302-release-note-li><a href=/en/blog/2021/08/18/3.0.2-release-note/ title="3.0.2 Release Note" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20210818302-release-note><span>3.0.2</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-enblog20210702301-release-note-li><a href=/en/blog/2021/07/02/3.0.1-release-note/ title="3.0.1 Release Note" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20210702301-release-note><span>3.0.1</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-enblog20200518past-releases-li><a href=/en/blog/2020/05/18/past-releases/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-enblog20200518past-releases><span>Past Releases</span></a></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/dubbo-website/edit/master/content/en/blog/news/spring-boot-dubbo-start-stop-analysis.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/apache/dubbo-website/new/master/content/en/blog/news/spring-boot-dubbo-start-stop-analysis.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/apache/dubbo-website/issues/new?title=Source%20code%20analysis%20of%20spring-boot+Dubbo%20App%20start%20and%20stop" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/apache/dubbo/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#the-analysis-of-dubboconsumer-startup>The analysis of DubboConsumer startup</a></li><li><a href=#the-analysis-of-dubboconsumer-exit>The analysis of DubboConsumer exit</a></li><li><a href=#summary>Summary</a></li><li><a href=#problems>Problems</a><ul><li><a href=#notice>Notice</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=https://dubbo.apache.org/en/blog/news/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>Source code analysis of spring-boot+Dubbo App start and stop</h1><div class=lead>This article introduces the implementation details of app start and stop in <code>dubbo-spring-boot-project</code>.</div><div class="td-byline mb-4"><time datetime=2018-08-14 class=text-muted>Tuesday, August 14, 2018</time></div><header class=article-meta></header><h2 id=introduction>Introduction</h2><p><a href=https://github.com/apache/dubbo-spring-boot-project>Dubbo Spring Boot</a> project is dedicated to simplifying the development of the Dubbo RPC framework in the Spring Boot application. It also integrates the feature of Spring Boot:</p><ul><li><a href=https://github.com/apache/dubbo-spring-boot-project/blob/master/dubbo-spring-boot-autoconfigure>Autoconfigure</a> (ex: Annotation driver, Autoconfigure, etc.)</li><li><a href=https://github.com/apache/dubbo-spring-boot-project/blob/master/dubbo-spring-boot-actuator>Production-Ready</a> (ex: Security, Healthy check, Externalize configuration, etc.)</li></ul><h2 id=the-analysis-of-dubboconsumer-startup>The analysis of DubboConsumer startup</h2><p>Have you ever thought about this : since the <code>DubboConsumerDemo</code> application in <code>dubbo-spring-boot-project</code> has only one line of code, why not just exit directly when the <code>main</code> method is executed?</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#268bd2>@SpringBootApplication</span><span style=color:#719e07>(</span>scanBasePackages <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;com.alibaba.boot.dubbo.demo.consumer.controller&#34;</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>DubboConsumerDemo</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>main</span><span style=color:#719e07>(</span>String<span style=color:#719e07>[]</span> args<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>        SpringApplication<span style=color:#719e07>.</span>run<span style=color:#719e07>(</span>DubboConsumerDemo<span style=color:#719e07>.</span>class<span style=color:#719e07>,</span>args<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>}</span>
</span></span></code></pre></div><p>In fact, to answer this question, we need to abstract it first, that is, under what circumstances will a JVM process exit?</p><p>Take Java 8 as an example. By referring to the JVM language specification[1], there is a clear description in Section 12.8:</p><blockquote><p>A program terminates all its activity and <em>exits</em> when one of two things happens:</p><ul><li>All the threads that are not daemon threads terminate.</li><li>Some thread invokes the <code>exit</code> method of class <code>Runtime</code> or class <code>System</code>, and the <code>exit</code> operation is not forbidden by the security manager.</li></ul></blockquote><p>Therefore, in view of the above situation, we judge that there must be some non-daemon thread not exiting. All thread information can be seen by <code>jstack</code>, including whether they are daemon threads, and <code>jstack</code> can be used to find out which threads are non-daemon.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>➜  jstack <span style=color:#2aa198>57785</span> | grep tid | grep -v <span style=color:#2aa198>&#34;daemon&#34;</span>
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;container-0&#34;</span> <span style=color:#586e75>#37 prio=5 os_prio=31 tid=0x00007fbe312f5800 nid=0x7103 waiting on condition  [0x0000700010144000]</span>
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;container-1&#34;</span> <span style=color:#586e75>#49 prio=5 os_prio=31 tid=0x00007fbe3117f800 nid=0x7b03 waiting on condition  [0x0000700010859000]</span>
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;DestroyJavaVM&#34;</span> <span style=color:#586e75>#83 prio=5 os_prio=31 tid=0x00007fbe30011000 nid=0x2703 waiting on condition  [0x0000000000000000]</span>
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;VM Thread&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe3005e800 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x3703 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;GC Thread#0&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe30013800 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x5403 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;GC Thread#1&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe30021000 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x5303 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;GC Thread#2&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe30021800 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x2d03 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;GC Thread#3&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe30022000 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x2f03 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;G1 Main Marker&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe30040800 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x5203 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;G1 Conc#0&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe30041000 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x4f03 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;G1 Refine#0&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe31044800 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x4e03 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;G1 Refine#1&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe31045800 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x4d03 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;G1 Refine#2&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe31046000 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x4c03 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;G1 Refine#3&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe31047000 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x4b03 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;G1 Young RemSet Sampling&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe31047800 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x3603 runnable
</span></span><span style=display:flex><span><span style=color:#2aa198>&#34;VM Periodic Task Thread&#34;</span> <span style=color:#268bd2>os_prio</span><span style=color:#719e07>=</span><span style=color:#2aa198>31</span> <span style=color:#268bd2>tid</span><span style=color:#719e07>=</span>0x00007fbe31129000 <span style=color:#268bd2>nid</span><span style=color:#719e07>=</span>0x6703 waiting on condition
</span></span></code></pre></div><blockquote><p>We can find all the thread digests by <code>grep tid</code> here, and find the line that doesn&rsquo;t contain the daemon keyword by <code>grep -v</code> command.</p></blockquote><p>We can get some information from the above results:</p><ul><li>There are two &ldquo;suspicious&rdquo; threads : <code>container-0</code>, <code>container-1</code>. They are non-daemon thread in wait state.</li><li>There are alse some threads about GC, and threads that start with <code>VM</code>. They are also some non-daemon threads, but they are most likely the JVM&rsquo;s own threads, which we can ignore for now.</li></ul><p>In summary, we can infer that it is likely that the <code>container-0</code> and <code>container-1</code> cause the JVM to not exit. Now let&rsquo;s search through the source code to find out who created the two threads.</p><p>By the source code analysis of Spring-boot, we can find these code in the <code>startDaemonAwaitThread</code> method of <code>org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainer</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#268bd2>private</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>startDaemonAwaitThread</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>        Thread awaitThread <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> Thread<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;container-&#34;</span> <span style=color:#719e07>+</span> <span style=color:#719e07>(</span>containerCounter<span style=color:#719e07>.</span>get<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#268bd2>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>run</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                TomcatEmbeddedServletContainer<span style=color:#719e07>.</span>this<span style=color:#719e07>.</span>tomcat<span style=color:#719e07>.</span>getServer<span style=color:#719e07>().</span>await<span style=color:#719e07>();</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>};</span>
</span></span><span style=display:flex><span>        awaitThread<span style=color:#719e07>.</span>setContextClassLoader<span style=color:#719e07>(</span>getClass<span style=color:#719e07>().</span>getClassLoader<span style=color:#719e07>());</span>
</span></span><span style=display:flex><span>        awaitThread<span style=color:#719e07>.</span>setDaemon<span style=color:#719e07>(</span><span style=color:#cb4b16>false</span><span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        awaitThread<span style=color:#719e07>.</span>start<span style=color:#719e07>();</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>}</span>
</span></span></code></pre></div><p>Let&rsquo;s add a breakpoint in this method, and focus on the call stack:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>initialize:115, TomcatEmbeddedServletContainer (org.springframework.boot.context.embedded.tomcat)
</span></span><span style=display:flex><span>&lt;init&gt;:84, TomcatEmbeddedServletContainer (org.springframework.boot.context.embedded.tomcat)
</span></span><span style=display:flex><span>getTomcatEmbeddedServletContainer:554, TomcatEmbeddedServletContainerFactory (org.springframework.boot.context.embedded.tomcat)
</span></span><span style=display:flex><span>getEmbeddedServletContainer:179, TomcatEmbeddedServletContainerFactory (org.springframework.boot.context.embedded.tomcat)
</span></span><span style=display:flex><span>createEmbeddedServletContainer:164, EmbeddedWebApplicationContext (org.springframework.boot.context.embedded)
</span></span><span style=display:flex><span>onRefresh:134, EmbeddedWebApplicationContext (org.springframework.boot.context.embedded)
</span></span><span style=display:flex><span>refresh:537, AbstractApplicationContext (org.springframework.context.support)
</span></span><span style=display:flex><span>refresh:122, EmbeddedWebApplicationContext (org.springframework.boot.context.embedded)
</span></span><span style=display:flex><span>refresh:693, SpringApplication (org.springframework.boot)
</span></span><span style=display:flex><span>refreshContext:360, SpringApplication (org.springframework.boot)
</span></span><span style=display:flex><span>run:303, SpringApplication (org.springframework.boot)
</span></span><span style=display:flex><span>run:1118, SpringApplication (org.springframework.boot)
</span></span><span style=display:flex><span>run:1107, SpringApplication (org.springframework.boot)
</span></span><span style=display:flex><span>main:35, DubboConsumerDemo (com.alibaba.boot.dubbo.demo.consumer.bootstrap)
</span></span></code></pre></div><p>It can be seen that during the startup process of the Spring-boot application, the above method is executed since the execution of Tomcat exposes the HTTP service by default. Also, all threads started by Tomcat are daemon threads by default, such as the Acceptor of the listening request, threads in working threads, etc. Thus the JVM will also exit after the startup is complete in there is no extra control here. Therefore, it is necessary to explicitly start a thread and continue to wait under certain conditions, thereby avoid thread exit.</p><p>Let&rsquo;s dig deeper to find out how the thread stay alive in Tomcat&rsquo;s <code>this.tomcat.getServer().await()</code> method.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>await</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>        <span style=color:#586e75>// ...
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>        <span style=color:#719e07>if</span><span style=color:#719e07>(</span> port<span style=color:#719e07>==-</span><span style=color:#2aa198>1</span> <span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                awaitThread <span style=color:#719e07>=</span> Thread<span style=color:#719e07>.</span>currentThread<span style=color:#719e07>();</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>while</span><span style=color:#719e07>(!</span>stopAwait<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                        Thread<span style=color:#719e07>.</span>sleep<span style=color:#719e07>(</span> <span style=color:#2aa198>10000</span> <span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span><span style=color:#719e07>(</span> InterruptedException ex <span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#586e75>// continue and check the flag
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>                    <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>}</span> <span style=color:#719e07>finally</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                awaitThread <span style=color:#719e07>=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>;</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>return</span><span style=color:#719e07>;</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>        <span style=color:#586e75>// ...
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>}</span>
</span></span></code></pre></div><p>In the await method, the current thread checks the variable <code>stopAwait</code> every 10 seconds in a while loop. It is a <code>volatile</code> variable that is used to ensure that the current thread can see the change immediately after the variable being modified by another thread. If there is no change, it will stay in the loop. This is the reason why the thread does not exit, which is also the reason that the entire Spring-boot application doesn&rsquo;t exit.</p><p>Since Spring-boot application enables port 8080 and 8081(management port) at the same time, there are actually two Tomcats. So there are two threads named <code>container-0</code> and <code>container-1</code>.</p><p>Next, let&rsquo;s see how this Spring-boot application exits.</p><h2 id=the-analysis-of-dubboconsumer-exit>The analysis of DubboConsumer exit</h2><p>As mentioned in the previous description, there is a thread that checks the variable <code>stopAwait</code> continuously. So there must be a thread to modify <code>stopAwait</code> at Stop, thus break the while loop. But who is modifying this variable?</p><p>By analyzing the source code, we can see that there is only one method that modifies <code>stopAwait</code> : <code>org.apache.catalina.core.StandardServer#stopAwait</code>. To figure out who is calling this method, we add a breakpoint here.</p><blockquote><p>Note that after adding a breakpoint in Intellij IDEA&rsquo;s Debug mode, we also need to type <code>kill -s INT $PID</code> or <code>kill -s TERM $PID</code> in command line to trigger the breakpoint. Due to buggy IDEA, a single click to the stop button won&rsquo;t trigger the breakpoint.</p></blockquote><p>You can see the method is called by a thread called <code>Thread-3</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>stopAwait:<span style=color:#2aa198>390</span><span style=color:#719e07>,</span> StandardServer <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>catalina<span style=color:#719e07>.</span>core<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>stopInternal:<span style=color:#2aa198>819</span><span style=color:#719e07>,</span> StandardServer <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>catalina<span style=color:#719e07>.</span>core<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>stop:<span style=color:#2aa198>226</span><span style=color:#719e07>,</span> LifecycleBase <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>catalina<span style=color:#719e07>.</span>util<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>stop:<span style=color:#2aa198>377</span><span style=color:#719e07>,</span> Tomcat <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>apache<span style=color:#719e07>.</span>catalina<span style=color:#719e07>.</span>startup<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>stopTomcat:<span style=color:#2aa198>241</span><span style=color:#719e07>,</span> TomcatEmbeddedServletContainer <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>springframework<span style=color:#719e07>.</span>boot<span style=color:#719e07>.</span>context<span style=color:#719e07>.</span>embedded<span style=color:#719e07>.</span>tomcat<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>stop:<span style=color:#2aa198>295</span><span style=color:#719e07>,</span> TomcatEmbeddedServletContainer <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>springframework<span style=color:#719e07>.</span>boot<span style=color:#719e07>.</span>context<span style=color:#719e07>.</span>embedded<span style=color:#719e07>.</span>tomcat<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>stopAndReleaseEmbeddedServletContainer:<span style=color:#2aa198>306</span><span style=color:#719e07>,</span> EmbeddedWebApplicationContext <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>springframework<span style=color:#719e07>.</span>boot<span style=color:#719e07>.</span>context<span style=color:#719e07>.</span>embedded<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>onClose:<span style=color:#2aa198>155</span><span style=color:#719e07>,</span> EmbeddedWebApplicationContext <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>springframework<span style=color:#719e07>.</span>boot<span style=color:#719e07>.</span>context<span style=color:#719e07>.</span>embedded<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>doClose:<span style=color:#2aa198>1014</span><span style=color:#719e07>,</span> AbstractApplicationContext <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>springframework<span style=color:#719e07>.</span>context<span style=color:#719e07>.</span>support<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>run:<span style=color:#2aa198>929</span><span style=color:#719e07>,</span> AbstractApplicationContext$2 <span style=color:#719e07>(</span>org<span style=color:#719e07>.</span>springframework<span style=color:#719e07>.</span>context<span style=color:#719e07>.</span>support<span style=color:#719e07>)</span>
</span></span></code></pre></div><p>Through source code analysis, it was executed by Spring&rsquo;s registered <code>ShutdownHook</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#268bd2>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>registerShutdownHook</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span><span style=color:#719e07>this</span><span style=color:#719e07>.</span>shutdownHook <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>            <span style=color:#586e75>// No shutdown hook registered yet.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#719e07>this</span><span style=color:#719e07>.</span>shutdownHook <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> Thread<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                <span style=color:#268bd2>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>run</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#268bd2>synchronized</span> <span style=color:#719e07>(</span>startupShutdownMonitor<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                        doClose<span style=color:#719e07>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>};</span>
</span></span><span style=display:flex><span>            Runtime<span style=color:#719e07>.</span>getRuntime<span style=color:#719e07>().</span>addShutdownHook<span style=color:#719e07>(</span><span style=color:#719e07>this</span><span style=color:#719e07>.</span>shutdownHook<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>}</span>
</span></span></code></pre></div><p>By reffering the Java API documentation[2], we found that ShutdownHook will be executed under the following two cases.</p><blockquote><p>The Java virtual machine <em>shuts down</em> in response to two kinds of events:</p><ul><li>The program <em>exits</em> normally, when the last non-daemon thread exits or when the <code>exit</code> (equivalently, <a href=https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#exit-int-><code>System.exit</code></a>) method is invoked, or</li><li>The virtual machine is <em>terminated</em> in response to a user interrupt, such as typing <code>^C</code>, or a system-wide event, such as user logoff or system shutdown.</li></ul></blockquote><ol><li>So it&rsquo;s either a call of <code>System.exit()</code></li><li>Respond to external signals, such as Ctrl+C(actually sent as SIGINT signal), or <code>SIGTERM</code> signal (<code>kill $PID</code> will send <code>SIGTERM</code> signal by default)</li></ol><p>Therefore, the normal application will execute the above ShutdownHook during the stop process (except <code>kill -9 $PID</code>). Its function is not only to close the Tomcat, but also to perform other cleanup work. It is unnecessary to go into details.</p><h2 id=summary>Summary</h2><ol><li>During the startup of <code>DubboConsumer</code>, an independent non-daemon thread is launched to query the status of the variable continuously, thus the process can&rsquo;t exit.</li><li>To stop the <code>DubboConsumer</code>, one should call ShutdownHook to change the variable to let the thread break the loop.</li></ol><h2 id=problems>Problems</h2><p>In the example of DubboProvider, we see that Provider doesn&rsquo;t start Tomcat to provide HTTP service, then how does the program stays alive without exiting? We will answer this question in the next article.</p><h3 id=notice>Notice</h3><p>By running the following unit test which create a thread in <code>Intellij IDEA</code> , we are surprised to find that the program exits with less than 1000s. Why?(The thread being created is a non-daemon thread)</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#268bd2>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>test</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>new</span> Thread<span style=color:#719e07>(</span><span style=color:#719e07>new</span> Runnable<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>            <span style=color:#268bd2>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>run</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                    Thread<span style=color:#719e07>.</span>sleep<span style=color:#719e07>(</span><span style=color:#2aa198>1000000</span><span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>InterruptedException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                    e<span style=color:#719e07>.</span>printStackTrace<span style=color:#719e07>();</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>}).</span>start<span style=color:#719e07>();</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>}</span>
</span></span></code></pre></div><p>[1] <a href=https://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html#jls-12.8>https://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html#jls-12.8</a></p><p>[2] <a href=https://docs.oracle.com/javase/8/docs/api/java/lang/Runtime.html#addShutdownHook>https://docs.oracle.com/javase/8/docs/api/java/lang/Runtime.html#addShutdownHook</a></p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/en/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/ aria-label="Previous - Implementation of cross-language calls by Dubbo2.js" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><a href=/en/blog/2018/08/14/manipulating-services-dynamically-via-qos/ aria-label="Next - Manipulating Services Dynamically via QoS" class="btn btn-primary">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dubbo mailing list archive" aria-label="Dubbo mailing list archive"><a class=text-white target=_blank rel="noopener noreferrer" href=https://lists.apache.org/list.html?dev@dubbo.apache.org><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/apache/dubbo><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Subscribe to mailing list" aria-label="Subscribe to mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=mailto:dev-subscribe@dubbo.apache.org><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. All Rights Reserved</small></div></div></div></footer><div class="row pt-2 pb-2"><div class="container-fluid mx-sm-5"><div class=text-center id=my-footer><img style=float:left src=/imgs/apache_logo.png><ul><li><a href=https://www.apache.org>Foundation</a></li><li><a href=https://www.apache.org/licenses/>License</a></li><li><a href=https://www.apache.org/security/>Security</a></li><li><a href=https://www.apache.org/events/current-event>Events</a></li><li><a href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a href=https://privacy.apache.org/policies/privacy-policy-public.html>Privacy</a></li><li><a href=https://www.apache.org/foundation/thanks.html>Thanks</a></li></ul></div></div></div></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.9f304eb79b67eb331e2b22923c361575b563af25c0fd56279cf20f3a2417cff4.js integrity="sha256-nzBOt5tn6zMeKyKSPDYVdbVjryXA/VYnnPIPOiQXz/Q=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script>docsearch({appId:"L5F4T9F0I1",apiKey:"364ae307e1da9d02b2335675e9db1eb1",indexName:"apache_dubbo",container:"#docsearch",debug:!1}),docsearch({appId:"L5F4T9F0I1",apiKey:"364ae307e1da9d02b2335675e9db1eb1",indexName:"apache_dubbo",container:"#docsearch_zh_home",debug:!1})</script></body></html>