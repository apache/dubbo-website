{
  "filename": "Prepare-an-Apache-release.md",
  "__html": "<h2>理解Apache发布的内容和流程</h2>\n<p>总的来说，Source Release是Apache关注的重点，也是发布的必须内容；而Binary Release是可选项，Dubbo可以选择是否发布二进制包到Apache仓库或者发布到Maven中央仓库。</p>\n<p>请参考以下链接，找到更多关于ASF的发布指南:</p>\n<ul>\n<li><a href=\"http://www.apache.org/dev/release-publishing\">Apache Release Guide</a></li>\n<li><a href=\"http://www.apache.org/dev/release.html\">Apache Release Policy</a></li>\n<li><a href=\"http://www.apache.org/dev/publishing-maven-artifacts.html\">Maven Release Info</a></li>\n</ul>\n<h2>本地构建环境准备</h2>\n<p>主要包括签名工具、Maven仓库认证相关准备</p>\n<ol>\n<li>\n<p>安装GPG，参见 <a href=\"https://www.gnupg.org/download/index.html\">https://www.gnupg.org/download/index.html</a></p>\n<ul>\n<li>如Mac OS</li>\n</ul>\n<pre><code class=\"language-sh\">$ brew install gpg\n$ gpg --version <span class=\"hljs-comment\">#检查版本，应该为2.x</span>\n</code></pre>\n</li>\n<li>\n<p>用gpg生成key</p>\n<ul>\n<li>根据提示，生成key</li>\n</ul>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> gpg2 --full-gen-key</span>\ngpg (GnuPG) 2.0.12; Copyright (C) 2009 Free Software Foundation, Inc.\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\n\nPlease select what kind of key you want:\n  (1) RSA and RSA (default)\n  (2) DSA and Elgamal\n  (3) DSA (sign only)\n  (4) RSA (sign only)\nYour selection? 1\nRSA keys may be between 1024 and 4096 bits long.\nWhat keysize do you want? (2048) 4096\nRequested keysize is 4096 bits\nPlease specify how long the key should be valid.\n        0 = key does not expire\n     &lt;n&gt;  = key expires in n days\n     &lt;n&gt;w = key expires in n weeks\n     &lt;n&gt;m = key expires in n months\n     &lt;n&gt;y = key expires in n years\nKey is valid for? (0) \nKey does not expire at all\nIs this correct? (y/N) y\n\nGnuPG needs to construct a user ID to identify your key.\n\nReal name: Robert Burrell Donkin\nEmail address: rdonkin@apache.org\nComment: CODE SIGNING KEY\nYou selected this USER-ID:\n   \"Robert Burrell Donkin (CODE SIGNING KEY) &lt;rdonkin@apache.org&gt;\"\n\nChange (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O\nYou need a Passphrase to protect your secret key. # 填入密码，以后打包过程中会经常用到\n</code></pre>\n<ul>\n<li>查看key id</li>\n</ul>\n<pre><code class=\"language-sh\">$ gpg --list-keys\npub   rsa4096/28681CB1 2018-04-26 <span class=\"hljs-comment\"># 28681CB1就是key id</span>\nuid       [ultimate] liujun (apache-dubbo) &lt;liujun@apache.org&gt;\nsub   rsa4096/D3D6984B 2018-04-26\n\n<span class=\"hljs-comment\"># 通过key id发送public key到keyserver</span>\n$ gpg --keyserver pgpkeys.mit.edu --send-key 28681CB1\n<span class=\"hljs-comment\"># 其中，pgpkeys.mit.edu为随意挑选的keyserver，keyserver列表为：https://sks-keyservers.net/status/，因为相互之间是自动同步的，选任意一个都可以。</span>\n</code></pre>\n<ul>\n<li>如果有多个public key，设置默认key</li>\n</ul>\n<p>~/.gnupg/gpg.conf</p>\n<pre><code class=\"language-proper\"># If you have more than 1 secret key in your keyring, you may want to\n# uncomment the following option and set your preferred keyid.\n\ndefault-key 28681CB1\n</code></pre>\n</li>\n<li>\n<p>设置Apache中央仓库</p>\n<ul>\n<li>Dubbo项目的父pom为apache pom</li>\n</ul>\n<pre><code class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">parent</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.apache<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>apache<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>19<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">parent</span>&gt;</span>\n</code></pre>\n<ul>\n<li>\n<p>添加以下内容到.m2/settings.xml</p>\n<p>所有密码请使用<a href=\"http://maven.apache.org/guides/mini/guide-encryption.html\">maven-encryption-plugin</a>加密后再填入</p>\n</li>\n</ul>\n<pre><code class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">settings</span>&gt;</span>\n...\n <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">servers</span>&gt;</span>\n   <span class=\"hljs-comment\">&lt;!-- To publish a snapshot of some part of Maven --&gt;</span>\n   <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">server</span>&gt;</span>\n     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">id</span>&gt;</span>apache.snapshots.https<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">id</span>&gt;</span>\n     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">username</span>&gt;</span> <span class=\"hljs-comment\">&lt;!-- YOUR APACHE LDAP USERNAME --&gt;</span> <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">username</span>&gt;</span>\n     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">password</span>&gt;</span> <span class=\"hljs-comment\">&lt;!-- YOUR APACHE LDAP PASSWORD (encrypted) --&gt;</span> <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">password</span>&gt;</span>\n   <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">server</span>&gt;</span>\n   <span class=\"hljs-comment\">&lt;!-- To stage a release of some part of Maven --&gt;</span>\n   <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">server</span>&gt;</span>\n     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">id</span>&gt;</span>apache.releases.https<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">id</span>&gt;</span>\n     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">username</span>&gt;</span> <span class=\"hljs-comment\">&lt;!-- YOUR APACHE LDAP USERNAME --&gt;</span> <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">username</span>&gt;</span>\n     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">password</span>&gt;</span> <span class=\"hljs-comment\">&lt;!-- YOUR APACHE LDAP PASSWORD (encrypted) --&gt;</span> <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">password</span>&gt;</span>\n   <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">server</span>&gt;</span>\n  ...\n     <span class=\"hljs-comment\">&lt;!-- gpg passphrase used when generate key --&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">server</span>&gt;</span>\n     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">id</span>&gt;</span>gpg.passphrase<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">id</span>&gt;</span>\n     <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">passphrase</span>&gt;</span><span class=\"hljs-comment\">&lt;!-- yourKeyPassword --&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">passphrase</span>&gt;</span>\n   <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">server</span>&gt;</span>\n <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">servers</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">settings</span>&gt;</span>\n</code></pre>\n<p>​</p>\n</li>\n</ol>\n<h2>打包&amp;上传</h2>\n<ol>\n<li>\n<p>从主干分支拉取新分支作为发布分支，如现在要发布2.6.4版本，则从2.6.x拉出新分支2.6.4-release，此后2.6.4 Release Candidates涉及的修改及打标签等都在2.6.4-release分支进行，最终发布完成后合入主干分支。</p>\n</li>\n<li>\n<p>首先，在2.6.4-release分支验证maven组件打包、source源码打包、签名等是否都正常工作</p>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> mvn clean install -Papache-release</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> mvn deploy</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\"> 将snapshot包推送到maven中央仓库，处于staging状态</span>\n</code></pre>\n</li>\n<li>\n<p>用maven-release-plugin发布</p>\n<ul>\n<li>先用dryRun验证是否ok</li>\n</ul>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> mvn release:prepare -Papache-release -Darguments=<span class=\"hljs-string\">\"-DskipTests\"</span> -DautoVersionSubmodules=<span class=\"hljs-literal\">true</span> -Dusername=YOUR GITHUB ID -DdryRun=<span class=\"hljs-literal\">true</span></span>\n</code></pre>\n<ul>\n<li>验证通过后，执行release:prepare</li>\n</ul>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> mvn release:clean</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> mvn release:prepare -Papache-release -Darguments=<span class=\"hljs-string\">\"-DskipTests\"</span> -DautoVersionSubmodules=<span class=\"hljs-literal\">true</span> -Dusername=YOUR GITHUB ID</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\"> 执行完成后：1.生成source.zip包； 2.打出tag，并推送到github仓库； 3.分支版本自动升级为2.6.4-SNAPSHOT，并将修改推送到github仓库</span>\n</code></pre>\n<ul>\n<li>执行release:perform，做正式发布</li>\n</ul>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> mvn -Prelease release:perform -Darguments=<span class=\"hljs-string\">\"-DskipTests\"</span> -DautoVersionSubmodules=<span class=\"hljs-literal\">true</span> -Dusername=YOUR GITHUB ID</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\"> 所有artifacts发布到配置的远程maven中央仓库，处于staging状态</span>\n</code></pre>\n</li>\n</ol>\n<h2>准备Apache发布</h2>\n<ol>\n<li>\n<p>准备svn本机环境（Apache使用svn托管项目的发布内容）</p>\n</li>\n<li>\n<p>将dubbo checkout到本地目录</p>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> svn checkout https://dist.apache.org/repos/dist/dev/incubator/dubbo</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\"> 假定本地目录为 ~/apache/incubator/dubbo</span>\n</code></pre>\n</li>\n<li>\n<p>当前发布版本为2.6.4，新建目录</p>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> <span class=\"hljs-built_in\">cd</span> ~/apache/incubator/dubbo <span class=\"hljs-comment\"># dubbo svn根目录</span></span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> mkdir 2.6.4</span>\n</code></pre>\n</li>\n<li>\n<p>添加public key到<a href=\"https://dist.apache.org/repos/dist/dev/incubator/dubbo/KEYS\">KEYS</a>文件。KEYS主要是让参与投票的人在本地导入，用来校验sign的正确性</p>\n</li>\n<li>\n<p>拷贝Dubbo根目录下的source.zip包到svn本地仓库dubbo/2.6.4</p>\n</li>\n<li>\n<p>生成sha512签名</p>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> shasum -a 512 dubbo-incubating-2.6.4-source-release.zip &gt;&gt; dubbo-incubating-2.6.4-source-release.zip.sha512</span>\n</code></pre>\n</li>\n<li>\n<p>如果有binary release要同时发布</p>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">#</span><span class=\"bash\"> 到dubbo项目distribution的module下，执行：</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> mvn install</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\"> target目录下，拷贝bin-release.zip以及bin-release.zip.asc到svn本地仓库dubbo/2.6.4</span>\n<span class=\"hljs-meta\">#</span><span class=\"bash\"> 参考第6步，生成sha512签名</span>\n</code></pre>\n</li>\n<li>\n<p>提交到Apache svn</p>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">$</span><span class=\"bash\"> svn status</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> svn commit -m <span class=\"hljs-string\">'prepare for 2.6.4 RC1'</span></span>\n</code></pre>\n</li>\n</ol>\n<h2>验证Release Candidates</h2>\n<p>验证环节包含但不限于以下内容和形式：</p>\n<ol>\n<li>Check signatures and hashes are good</li>\n</ol>\n<pre><code class=\"language-sh\">sha512 dubbo-incubating-<span class=\"hljs-variable\">${release_version}</span>-bin-release.zip.sha512\nsha512 dubbo-incubating-<span class=\"hljs-variable\">${release_version}</span>-<span class=\"hljs-built_in\">source</span>-release.zip.sha512\n</code></pre>\n<ol start=\"2\">\n<li>Unzip dubbo-incubating-${release_version}-source-release.zip to the default directory and check the following:</li>\n</ol>\n<ul>\n<li>\n<p>Directory with 'incubating' in name\n<code>dubbo-incubating-${release_version}-bin-release</code></p>\n</li>\n<li>\n<p>DISCLAIMER exists</p>\n</li>\n<li>\n<p>LICENSE and NOTICE exists and contents are good</p>\n</li>\n<li>\n<p>All files and no binary files exist</p>\n</li>\n<li>\n<p>All files has standard ASF License header</p>\n</li>\n<li>\n<p>Can compile from source</p>\n</li>\n<li>\n<p>All unit tests can pass</p>\n<pre><code class=\"language-sh\">mvn clean <span class=\"hljs-built_in\">test</span> <span class=\"hljs-comment\"># This will run all unit tests</span>\n<span class=\"hljs-comment\"># you can also open rat and style plugin to check if every file meets requirements.</span>\nmvn clean install -Drat.skip=<span class=\"hljs-literal\">false</span> -Dcheckstyle.skip=<span class=\"hljs-literal\">false</span>\n</code></pre>\n</li>\n<li>\n<p>Release candidates match with corresponding tags, you can find tag link and hash in vote email.</p>\n</li>\n</ul>\n<h2>进入投票</h2>\n<p>投票分两个阶段：</p>\n<ol>\n<li>Dubbo社区投票，发起投票邮件到dev@dubbo.apache.org。在社区开发者Review，并统计到3个同意发版的binding票后，即可进入下一阶段的投票。</li>\n<li>Apache社区投票，发起投票邮件到general@apache.org。在Apache PMC Review，并统计到3个统一发版的binding票后，即可进行正式发布。</li>\n</ol>\n<p>邮件模板：</p>\n<pre><code class=\"language-tex\">Hello Dubbo Community,\n\nThis is a call for vote to release Apache Dubbo (Incubating) version 2.6.2.\n\nThe release candidates:\nhttps://dist.apache.org/repos/dist/dev/incubator/dubbo/2.6.2/\n\nGit tag for the release:\nhttps://github.com/apache/incubator-dubbo/tree/dubbo-2.6.2\n\nHash for the release tag:\nafab04c53edab38d52275d2a198ea1aff7a4f41e\n\nRelease Notes:\nhttps://github.com/apache/incubator-dubbo/releases/tag/untagged-4775c0a22c60fca55118\n\nThe artifacts have been signed with Key : 28681CB1, which can be found in the keys file:\nhttps://dist.apache.org/repos/dist/dev/incubator/dubbo/KEYS\n\nThe vote will be open for at least 72 hours or until necessary number of votes are reached.\n\nPlease vote accordingly:\n\n[ ] +1 approve \n[ ] +0 no opinion \n[ ] -1 disapprove with the reason\n\nThanks,\nThe Apache Dubbo (Incubating) Team\n</code></pre>\n<h2>正式发布</h2>\n<ol>\n<li>提交https://dist.apache.org/repos/dist/dev/incubator/dubbo目录下的发布包到https://dist.apache.org/repos/dist/release/incubator/dubbo/，完成正式发布。</li>\n<li>发邮件到dev@dubbo.apache.org和general@apache.org，通知社区发布完成。</li>\n</ol>\n<h2>完成Maven Convenient Binary发布（可选）</h2>\n<p><strong><a href=\"http://apache.repository.org\">apache.repository.org</a> nexus仓库的权限已经申请，参见<a href=\"https://issues.apache.org/jira/browse/INFRA-16451\">jira</a>。</strong></p>\n<p>之前发布到maven仓库的atifacts都处于staging状态，用Apache <a href=\"http://xn--idapache-zm2p156p.repository.org\">id登录apache.repository.org</a>，发布即可。</p>\n"
}