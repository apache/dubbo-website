<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>瓜子二手车 Dubbo 实践 | Apache Dubbo</title><meta property="og:title" content="瓜子二手车 Dubbo 实践"><meta property="og:description" content="前言 随着瓜子业务的不断发展，系统规模在逐渐扩大，目前在瓜子的私有云上已经运行着数百个dubbo应用，上千个dubbo实例。瓜子各部门业务迅速发展，版本没有来得及统一，各个部门都有自己的用法。随着第二机房的建设，dubbo版本统一的需求变得越发迫切。几个月前，公司发生了一次与dubbo相关的生产事故，成为了公司dubbo版本升级的诱因。
接下来，我会从这次事故开始，讲讲我们这段时间所做的dubbo版本升级的历程以及dubbo后续多机房的方案。
一、Ephermal节点未及时删除导致provider不能恢复注册的问题修复 事故背景 在生产环境，瓜子内部各业务线共用一套zookeeper集群作为dubbo的注册中心。2019年9月份，机房的一台交换机发生故障，导致zookeeper集群出现了几分钟的网络波动。在zookeeper集群恢复后，正常情况下dubbo的provider应该会很快重新注册到zookeeper上，但有一小部分的provider很长一段时间没有重新注册到zookeeper上，直到手动重启应用后才恢复注册。
排查过程 首先，我们统计了出现这种现象的dubbo服务的版本分布情况，发现在大多数的dubbo版本中都存在这种问题，且发生问题的服务比例相对较低，在github中我们也未找到相关问题的issues。因此，推断这是一个尚未修复的且在网络波动情况的场景下偶现的问题。
接着，我们便将出现问题的应用日志、zookeeper日志与dubbo代码逻辑进行相互印证。在应用日志中，应用重连zookeeper成功后provider立刻进行了重新注册，之后便没有任何日志打印。而在zookeeper日志中，注册节点被删除后，并没有重新创建注册节点。对应到dubbo的代码中，只有在FailbackRegistry.register(url)的doRegister(url)执行成功或线程被挂起的情况下，才能与日志中的情况相吻合。
public void register(URL url) { super.register(url); failedRegistered.remove(url); failedUnregistered.remove(url); try { // Sending a registration request to the server side doRegister(url); } catch (Exception e) { Throwable t = e; // If the startup detection is opened, the Exception is thrown directly. boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) && url.getParameter(Constants.CHECK_KEY, true) && !Constants.CONSUMER_PROTOCOL.equals(url.getProtocol()); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) { if (skipFailback) { t = t."><meta property="og:type" content="article"><meta property="og:url" content="https://dubbo.apache.org/zh-cn/users/guazi/"><meta property="article:section" content="users"><meta property="article:modified_time" content="2023-02-09T17:22:57+08:00"><meta property="og:site_name" content="Apache Dubbo"><meta itemprop=name content="瓜子二手车 Dubbo 实践"><meta itemprop=description content="前言 随着瓜子业务的不断发展，系统规模在逐渐扩大，目前在瓜子的私有云上已经运行着数百个dubbo应用，上千个dubbo实例。瓜子各部门业务迅速发展，版本没有来得及统一，各个部门都有自己的用法。随着第二机房的建设，dubbo版本统一的需求变得越发迫切。几个月前，公司发生了一次与dubbo相关的生产事故，成为了公司dubbo版本升级的诱因。
接下来，我会从这次事故开始，讲讲我们这段时间所做的dubbo版本升级的历程以及dubbo后续多机房的方案。
一、Ephermal节点未及时删除导致provider不能恢复注册的问题修复 事故背景 在生产环境，瓜子内部各业务线共用一套zookeeper集群作为dubbo的注册中心。2019年9月份，机房的一台交换机发生故障，导致zookeeper集群出现了几分钟的网络波动。在zookeeper集群恢复后，正常情况下dubbo的provider应该会很快重新注册到zookeeper上，但有一小部分的provider很长一段时间没有重新注册到zookeeper上，直到手动重启应用后才恢复注册。
排查过程 首先，我们统计了出现这种现象的dubbo服务的版本分布情况，发现在大多数的dubbo版本中都存在这种问题，且发生问题的服务比例相对较低，在github中我们也未找到相关问题的issues。因此，推断这是一个尚未修复的且在网络波动情况的场景下偶现的问题。
接着，我们便将出现问题的应用日志、zookeeper日志与dubbo代码逻辑进行相互印证。在应用日志中，应用重连zookeeper成功后provider立刻进行了重新注册，之后便没有任何日志打印。而在zookeeper日志中，注册节点被删除后，并没有重新创建注册节点。对应到dubbo的代码中，只有在FailbackRegistry.register(url)的doRegister(url)执行成功或线程被挂起的情况下，才能与日志中的情况相吻合。
public void register(URL url) { super.register(url); failedRegistered.remove(url); failedUnregistered.remove(url); try { // Sending a registration request to the server side doRegister(url); } catch (Exception e) { Throwable t = e; // If the startup detection is opened, the Exception is thrown directly. boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) && url.getParameter(Constants.CHECK_KEY, true) && !Constants.CONSUMER_PROTOCOL.equals(url.getProtocol()); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) { if (skipFailback) { t = t."><meta itemprop=dateModified content="2023-02-09T17:22:57+08:00"><meta itemprop=wordCount content="246"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="瓜子二手车 Dubbo 实践"><meta name=twitter:description content="前言 随着瓜子业务的不断发展，系统规模在逐渐扩大，目前在瓜子的私有云上已经运行着数百个dubbo应用，上千个dubbo实例。瓜子各部门业务迅速发展，版本没有来得及统一，各个部门都有自己的用法。随着第二机房的建设，dubbo版本统一的需求变得越发迫切。几个月前，公司发生了一次与dubbo相关的生产事故，成为了公司dubbo版本升级的诱因。
接下来，我会从这次事故开始，讲讲我们这段时间所做的dubbo版本升级的历程以及dubbo后续多机房的方案。
一、Ephermal节点未及时删除导致provider不能恢复注册的问题修复 事故背景 在生产环境，瓜子内部各业务线共用一套zookeeper集群作为dubbo的注册中心。2019年9月份，机房的一台交换机发生故障，导致zookeeper集群出现了几分钟的网络波动。在zookeeper集群恢复后，正常情况下dubbo的provider应该会很快重新注册到zookeeper上，但有一小部分的provider很长一段时间没有重新注册到zookeeper上，直到手动重启应用后才恢复注册。
排查过程 首先，我们统计了出现这种现象的dubbo服务的版本分布情况，发现在大多数的dubbo版本中都存在这种问题，且发生问题的服务比例相对较低，在github中我们也未找到相关问题的issues。因此，推断这是一个尚未修复的且在网络波动情况的场景下偶现的问题。
接着，我们便将出现问题的应用日志、zookeeper日志与dubbo代码逻辑进行相互印证。在应用日志中，应用重连zookeeper成功后provider立刻进行了重新注册，之后便没有任何日志打印。而在zookeeper日志中，注册节点被删除后，并没有重新创建注册节点。对应到dubbo的代码中，只有在FailbackRegistry.register(url)的doRegister(url)执行成功或线程被挂起的情况下，才能与日志中的情况相吻合。
public void register(URL url) { super.register(url); failedRegistered.remove(url); failedUnregistered.remove(url); try { // Sending a registration request to the server side doRegister(url); } catch (Exception e) { Throwable t = e; // If the startup detection is opened, the Exception is thrown directly. boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) && url.getParameter(Constants.CHECK_KEY, true) && !Constants.CONSUMER_PROTOCOL.equals(url.getProtocol()); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) { if (skipFailback) { t = t."><link rel=preload href=/scss/main.min.dc7554c0c41d7f631ecb7b0f13149f547e695b5cc4443b205c73ce7f3d17caaf.css as=style><link href=/scss/main.min.dc7554c0c41d7f631ecb7b0f13149f547e695b5cc4443b205c73ce7f3d17caaf.css rel=stylesheet integrity><script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@3></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/zh-cn/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">Apache Dubbo</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh-cn/overview/><span>入门文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh-cn/docs3-v2/><span>SDK 手册</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh-cn/users/><span class=active>用户案例</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh-cn/blog/><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh-cn/release/><span>版本发布</span></a></li><li class="nav-item dropdown d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div id=docsearch></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div id=docsearch></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zh-cnusers-li><a href=/zh-cn/users/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-zh-cnusers><span>用户案例</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-cnusersalibaba-li><a href=/zh-cn/users/alibaba/ title="阿里巴巴升级 Dubbo3 全面取代 HSF2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zh-cnusersalibaba><span>阿里巴巴</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-cnusersicbc-li><a href=/zh-cn/users/icbc/ title="工商银行 Dubbo3 应用级服务发现实践" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zh-cnusersicbc><span>工商银行</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-cnuserseleme-li><a href=/zh-cn/users/eleme/ title="饿了么全站成功升级 Dubbo3 " class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zh-cnuserseleme><span>饿了么</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-cnusersdianxiaomi-li><a href=/zh-cn/users/dianxiaomi/ title="店小蜜升级 Triple 协议" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zh-cnusersdianxiaomi><span>达摩院云小蜜</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-zh-cnusersguazi-li><a href=/zh-cn/users/guazi/ title="瓜子二手车 Dubbo 实践" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-zh-cnusersguazi><span class=td-sidebar-nav-active-item>瓜子二手车</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-cnusersxiaomi-li><a href=/zh-cn/users/xiaomi/ title="小米与 Dubbo 社区的合作" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zh-cnusersxiaomi><span>小米</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-cnuserszhonglunwangluo-li><a href=/zh-cn/users/zhonglunwangluo/ title="中伦网络 Dubbo3 升级实践" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zh-cnuserszhonglunwangluo><span>中伦网络</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-cnuserspingan-li><a href=/zh-cn/users/pingan/ title="平安健康的 Dubbo3 迁移历程" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zh-cnuserspingan><span>平安健康</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/dubbo-website/tree/master/content/zh-cn/users/guazi.md class=td-page-meta--view target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> 查看页面源码</a>
<a href=https://github.com/apache/dubbo-website/edit/master/content/zh-cn/users/guazi.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> 编辑此页</a>
<a href="https://github.com/apache/dubbo-website/new/master/content/zh-cn/users/guazi.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> 添加子页面</a>
<a href="https://github.com/apache/dubbo-website/issues/new?title=%e7%93%9c%e5%ad%90%e4%ba%8c%e6%89%8b%e8%bd%a6%20Dubbo%20%e5%ae%9e%e8%b7%b5" class=td-page-meta--issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> 提交文档问题</a>
<a href=https://github.com/apache/dubbo/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> 提交项目问题</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#一ephermal节点未及时删除导致provider不能恢复注册的问题修复>一、Ephermal节点未及时删除导致provider不能恢复注册的问题修复</a><ul><li><a href=#事故背景>事故背景</a></li><li><a href=#排查过程>排查过程</a></li><li><a href=#问题的复现与修复>问题的复现与修复</a></li></ul></li><li><a href=#二瓜子的dubbo升级历程>二、瓜子的dubbo升级历程</a><ul><li><a href=#为什么要统一dubbo版本>为什么要统一dubbo版本</a></li><li><a href=#为什么选择dubbo273>为什么选择dubbo2.7.3</a></li><li><a href=#内部版本定位>内部版本定位</a></li><li><a href=#兼容性验证与升级过程>兼容性验证与升级过程</a></li><li><a href=#兼容性问题汇总>兼容性问题汇总</a></li></ul></li><li><a href=#三dubbo多机房方案>三、dubbo多机房方案</a><ul><li><a href=#初步方案>初步方案</a></li><li><a href=#同机房优先调用>同机房优先调用</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=https://dubbo.apache.org/zh-cn/users/>用户案例</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://dubbo.apache.org/zh-cn/users/guazi/ aria-disabled=true class="btn-link disabled">瓜子二手车</a></li></ol></nav><div class=td-content><h1>瓜子二手车 Dubbo 实践</h1><header class=article-meta></header><h2 id=前言>前言</h2><p>  随着瓜子业务的不断发展，系统规模在逐渐扩大，目前在瓜子的私有云上已经运行着数百个dubbo应用，上千个dubbo实例。瓜子各部门业务迅速发展，版本没有来得及统一，各个部门都有自己的用法。随着第二机房的建设，dubbo版本统一的需求变得越发迫切。几个月前，公司发生了一次与dubbo相关的生产事故，成为了公司dubbo版本升级的诱因。</p><p>  接下来，我会从这次事故开始，讲讲我们这段时间所做的dubbo版本升级的历程以及dubbo后续多机房的方案。</p><h2 id=一ephermal节点未及时删除导致provider不能恢复注册的问题修复>一、Ephermal节点未及时删除导致provider不能恢复注册的问题修复</h2><h3 id=事故背景>事故背景</h3><p>  在生产环境，瓜子内部各业务线共用一套zookeeper集群作为dubbo的注册中心。2019年9月份，机房的一台交换机发生故障，导致zookeeper集群出现了几分钟的网络波动。在zookeeper集群恢复后，正常情况下dubbo的provider应该会很快重新注册到zookeeper上，但有一小部分的provider很长一段时间没有重新注册到zookeeper上，直到手动重启应用后才恢复注册。</p><h3 id=排查过程>排查过程</h3><p>  首先，我们统计了出现这种现象的dubbo服务的版本分布情况，发现在大多数的dubbo版本中都存在这种问题，且发生问题的服务比例相对较低，在github中我们也未找到相关问题的issues。因此，推断这是一个尚未修复的且在网络波动情况的场景下偶现的问题。</p><p>  接着，我们便将出现问题的应用日志、zookeeper日志与dubbo代码逻辑进行相互印证。在应用日志中，应用重连zookeeper成功后provider立刻进行了重新注册，之后便没有任何日志打印。而在zookeeper日志中，注册节点被删除后，并没有重新创建注册节点。对应到dubbo的代码中，只有在<code>FailbackRegistry.register(url)</code>的<code>doRegister(url)</code>执行成功或线程被挂起的情况下，才能与日志中的情况相吻合。</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>register</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>        <span style=color:#268bd2>super</span><span style=color:#719e07>.</span>register<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        failedRegistered<span style=color:#719e07>.</span>remove<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        failedUnregistered<span style=color:#719e07>.</span>remove<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>            <span style=color:#586e75>// Sending a registration request to the server side
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            doRegister<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Exception e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>            Throwable t <span style=color:#719e07>=</span> e<span style=color:#719e07>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#586e75>// If the startup detection is opened, the Exception is thrown directly.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            <span style=color:#dc322f>boolean</span> check <span style=color:#719e07>=</span> getUrl<span style=color:#719e07>().</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>CHECK_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#719e07>&amp;&amp;</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>CHECK_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>Constants<span style=color:#719e07>.</span>CONSUMER_PROTOCOL<span style=color:#719e07>.</span>equals<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>());</span>
</span></span><span style=display:flex><span>            <span style=color:#dc322f>boolean</span> skipFailback <span style=color:#719e07>=</span> t <span style=color:#719e07>instanceof</span> SkipFailbackWrapperException<span style=color:#719e07>;</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>check <span style=color:#719e07>||</span> skipFailback<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>skipFailback<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                    t <span style=color:#719e07>=</span> t<span style=color:#719e07>.</span>getCause<span style=color:#719e07>();</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>                <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Failed to register &#34;</span> <span style=color:#719e07>+</span> url <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34; to registry &#34;</span> <span style=color:#719e07>+</span> getUrl<span style=color:#719e07>().</span>getAddress<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;, cause: &#34;</span> <span style=color:#719e07>+</span> t<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> t<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>                logger<span style=color:#719e07>.</span>error<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Failed to register &#34;</span> <span style=color:#719e07>+</span> url <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;, waiting for retry, cause: &#34;</span> <span style=color:#719e07>+</span> t<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> t<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#586e75>// Record a failed registration request to a failed list, retry regularly
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            failedRegistered<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>}</span>
</span></span></code></pre></div><p>  在继续排查问题前，我们先普及下这些概念：dubbo默认使用curator作为zookeeper的客户端，curator与zookeeper是通过session维持连接的。当curator重连zookeeper时，若session未过期，则继续使用原session进行连接；若session已过期，则创建新session重新连接。而ephemeral节点与session是绑定的关系，在session过期后，会删除此session下的ephemeral节点。</p><p>  继续对<code>doRegister(url)</code>的代码进行进一步排查，我们发现在<code>CuratorZookeeperClient.createEphemeral(path)</code>方法中有这么一段逻辑：在<code>createEphemeral(path)</code>捕获了<code>NodeExistsException</code>，创建ephemeral节点时，若此节点已存在，则认为ephemeral节点创建成功。这段逻辑初看起来并没有什么问题，且在以下两种常见的场景下表现正常：</p><ol><li>Session未过期，创建Ephemeral节点时原节点仍存在,不需要重新创建</li><li>Session已过期，创建Ephemeral节点时原节点已被zookeeper删除，创建成功</li></ol><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>createEphemeral</span><span style=color:#719e07>(</span>String path<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>            client<span style=color:#719e07>.</span>create<span style=color:#719e07>().</span>withMode<span style=color:#719e07>(</span>CreateMode<span style=color:#719e07>.</span>EPHEMERAL<span style=color:#719e07>).</span>forPath<span style=color:#719e07>(</span>path<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>NodeExistsException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Exception e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
</span></span><span style=display:flex><span>            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span>e<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> e<span style=color:#719e07>);</span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>}</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>}</span>
</span></span></code></pre></div><p>  但是实际上还有一种极端场景，<strong>zookeeper的Session过期与删除Ephemeral节点不是原子性的</strong>，也就是说客户端在得到Session过期的消息时，Session对应的Ephemeral节点可能还未被zookeeper删除。此时dubbo去创建Ephemeral节点,发现原节点仍存在，故不重新创建。待Ephemeral节点被zookeeper删除后，便会出现dubbo认为重新注册成功，但实际未成功的情况，也就是我们在生产环境遇到的问题。</p><p>  此时，问题的根源已被定位。定位问题之后，我们与dubbo社区交流，发现考拉的同学也遇到过同样的问题，更确定了这个原因。</p><h3 id=问题的复现与修复>问题的复现与修复</h3><p>  定位到问题之后，我们便开始尝试本地复现。由于zookeeper的Session过期但Ephemeral节点未被删除的场景直接模拟比较困难，我们通过修改zookeeper源码，在Session过期与删除Ephemeral节点的逻辑中增加了一段休眠时间，间接模拟出这种极端场景，并在本地复现了此问题。</p><p>  在排查问题的过程中，我们发现kafka的旧版本在使用zookeeper时也遇到过类似的问题，并参考kafka关于此问题的修复方案，确定了dubbo的修复方案。在创建Ephemeral节点捕获到<code>NodeExistsException</code>时进行判断，若Ephemeral节点的SessionId与当前客户端的SessionId不同，则删除并重建Ephemeral节点。在内部修复并验证通过后，我们向社区提交了issues及pr。</p><p>  kafka类似问题issues：https://issues.apache.org/jira/browse/KAFKA-1387</p><p>  dubbo注册恢复问题issues：https://github.com/apache/dubbo/issues/5125</p><h2 id=二瓜子的dubbo升级历程>二、瓜子的dubbo升级历程</h2><p>  上文中的问题修复方案已经确定，但我们显然不可能在每一个dubbo版本上都进行修复。在咨询了社区dubbo的推荐版本后，我们决定在dubbo2.7.3版本的基础上，开发内部版本修复来这个问题。并借这个机会，开始推动公司dubbo版本的统一升级工作。</p><h3 id=为什么要统一dubbo版本>为什么要统一dubbo版本</h3><ol><li>统一dubbo版本后，我们可以在此版本上内部紧急修复一些dubbo问题（如上文的dubbo注册故障恢复失效问题）。</li><li>瓜子目前正在进行第二机房的建设，部分dubbo服务也在逐渐往第二机房迁移。统一dubbo版本，也是为dubbo的多机房做铺垫。</li><li>有利于我们后续对dubbo服务的统一管控。</li><li>dubbo社区目前的发展方向与我们公司现阶段对dubbo的一些诉求相吻合，如支持gRPC、云原生等。</li></ol><h3 id=为什么选择dubbo273>为什么选择dubbo2.7.3</h3><ol><li>在我们之前，携程与dubbo社区合作进行了携程dubbo内部版本的升级，并在社区2.7.3版本上修复了很多兼容性问题。感谢携程的同学帮我们踩坑～</li><li>dubbo2.7.3版本在当时虽然是最新的版本，但已经发布了2个月的时间，从社区issues反馈来看，dubbo2.7.3相对dubbo2.7之前的几个版本，在兼容性方面要好很多。</li><li>我们也咨询了dubbo社区的同学，推荐升级版本为2.7.3。</li></ol><h3 id=内部版本定位>内部版本定位</h3><p>  基于社区dubbo2.7.3版本开发的dubbo内部版本属于过渡性质的版本，目的是为了修复线上provider不能恢复注册的问题，以及一些社区dubbo2.7.3的兼容性问题。瓜子的dubbo最终还是要跟随社区的版本，而不是开发自已的内部功能。因此我们在dubbo内部版本中修复的所有问题均与社区保持了同步，以保证后续可以兼容升级到社区dubbo的更高版本。</p><h3 id=兼容性验证与升级过程>兼容性验证与升级过程</h3><p>  我们在向dubbo社区的同学咨询了版本升级方面的相关经验后，于9月下旬开始了dubbo版本的升级工作。</p><ol><li><strong>初步兼容性验证</strong>
首先,我们梳理了一些需要验证的兼容性case，针对公司内部使用较多的dubbo版本，与dubbo2.7.3一一进行了兼容性验证。经验证，除dubboX外，dubbo2.7.3与其他dubbo版本均兼容。dubboX由于对dubbo协议进行了更改，与dubbo2.7.3不兼容。</li><li><strong>生产环境兼容性验证</strong>
在初步验证兼容性通过后，我们与业务线合作，挑选了一些重要程度较低的项目，在生产环境对dubbo2.7.3与其他版本的兼容性进行了进一步验证。并在内部版本修复了一些兼容性问题。</li><li><strong>推动公司dubbo版本升级</strong>
在10月初，完成了dubbo兼容性验证后，我们开始在各个业务线推动dubbo的升级工作。截止到12月初,已经有30%的dubbo服务的完成了版本升级。按照排期，预计于2020年3月底前完成公司dubbo版本的统一升级。</li></ol><h3 id=兼容性问题汇总>兼容性问题汇总</h3><p>  在推动升级dubbo2.7.3版本的过程整体上比较顺利,当然也遇到了一些兼容性问题：</p><ul><li><p><strong>创建zookeeper节点时提示没有权限</strong>
dubbo配置文件中已经配置了zookeeper的用户名密码，但在创建zookeeper节点时却抛出<code>KeeperErrorCode = NoAuth</code>的异常，这种情况分别对应两个兼容性问题：</p><ul><li>issues:https://github.com/apache/dubbo/issues/5076
dubbo在未配置配置中心时，默认使用注册中心作为配置中心。通过注册中心的配置信息初始化配置中心配置时，由于遗漏了用户名密码，导致此问题。</li><li>issues:https://github.com/apache/dubbo/issues/4991
dubbo在建立与zookeeper的连接时会根据zookeeper的address复用之前已建立的连接。当多个注册中心使用同一个address，但权限不同时，就会出现<code>NoAuth</code>的问题。
参考社区的pr，我们在内部版本进行了修复。</li></ul></li><li><p><strong>curator版本兼容性问题</strong></p><ul><li>dubbo2.7.3与低版本的curator不兼容，因此我们默认将curator版本升级至4.2.0</li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;groupId&gt;</span>org.apache.curator<span style=color:#268bd2>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;artifactId&gt;</span>curator-framework<span style=color:#268bd2>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;version&gt;</span>4.2.0<span style=color:#268bd2>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;groupId&gt;</span>org.apache.curator<span style=color:#268bd2>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;artifactId&gt;</span>curator-recipes<span style=color:#268bd2>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;version&gt;</span>4.2.0<span style=color:#268bd2>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ul><li>分布式调度框架elastic-job-lite强依赖低版本的curator,与dubbo2.7.3使用的curator版本不兼容,这给dubbo版本升级工作带来了一定阻塞。考虑到elastic-job-lite已经很久没有人进行维护，目前一些业务线计划将elastic-job-lite替换为其他的调度框架。</li></ul></li><li><p><strong>openFeign与dubbo兼容性问题</strong>
issues: <a href=https://github.com/apache/dubbo/issues/3990>https://github.com/apache/dubbo/issues/3990</a>
dubbo的ServiceBean监听spring的ContextRefreshedEvent,进行服务暴露。openFeign提前触发了ContextRefreshedEvent，此时ServiceBean还未完成初始化，于是就导致了应用启动异常。
参考社区的pr，我们在内部版本修复了此问题。</p></li><li><p><strong>RpcException兼容性问题</strong>
dubbo低版本consumer不能识别dubbo2.7版本provider抛出的<code>org.apache.dubbo.rpc.RpcException</code>。因此，在consumer全部升级到2.7之前，不建议将provider的<code>com.alibaba.dubbo.rpc.RpcException</code>改为<code>org.apache.dubbo.rpc.RpcException</code></p></li><li><p><strong>qos端口占用</strong>
dubbo2.7.3默认开启qos功能，导致一些混部在物理机的dubbo服务升级时出现qos端口占用问题。关闭qos功能后恢复。</p></li><li><p><strong>自定义扩展兼容性问题</strong>
业务线对于dubbo的自定义扩展比较少，因此在自定义扩展的兼容性方面暂时还没有遇到比较难处理的问题，基本上都是变更package导致的问题，由业务线自行修复。</p></li><li><p><strong>skywalking agent兼容性问题</strong>
我们项目中一般使用skywalking进行链路追踪，由于skywalking agent6.0的plugin不支持dubbo2.7，因此统一升级skywalking agent到6.1。</p></li></ul><h2 id=三dubbo多机房方案>三、dubbo多机房方案</h2><p>  瓜子目前正在进行第二机房的建设工作，dubbo多机房是第二机房建设中比较重要的一个话题。在dubbo版本统一的前提下，我们就能够更顺利的开展dubbo多机房相关的调研与开发工作。</p><h3 id=初步方案>初步方案</h3><p>  我们咨询了dubbo社区的建议，并结合瓜子云平台的现状，初步确定了dubbo多机房的方案。</p><ol><li>在每个机房内，部署一套独立的zookeeper集群。集群间信息不同步。这样就没有了zookeeper集群跨机房延迟与数据不同步的问题。</li><li>dubbo服务注册时，仅注册到本机房的zookeeper集群；订阅时，同时订阅两个机房的zookeeper集群。</li><li>实现同机房优先调用的路由逻辑。以减少跨机房调用导致的不必要网络延迟。</li></ol><h3 id=同机房优先调用>同机房优先调用</h3><p>  dubbo同机房优先调用的实现比较简单，相关逻辑如下：</p><ol><li>瓜子云平台默认将机房的标志信息注入容器的环境变量中。</li><li>provider暴露服务时，读取环境变量中的机房标志信息，追加到待暴露服务的url中。</li><li>consumer调用provider时，读取环境变量中的机房标志信息，根据路由策略优先调用具有相同标志信息的provider。</li></ol><p>  针对以上逻辑，我们简单实现了dubbo通过环境变量进行路由的功能，并向社区提交了pr。
  dubbo通过环境变量路由pr: <a href=https://github.com/apache/dubbo/pull/5348>https://github.com/apache/dubbo/pull/5348</a></p><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/apache/dubbo-website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/apache/dubbo-website/issues/new>tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">最后修改 February 9, 2023: <a href=https://github.com/apache/dubbo-website/commit/2008157832676684a5a07173a4dcdebc52b9193c>Update docsy to 0.6.0 (#2141) (2008157832)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dubbo mailing list archive" aria-label="Dubbo mailing list archive"><a class=text-white target=_blank rel="noopener noreferrer" href=https://lists.apache.org/list.html?dev@dubbo.apache.org><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/apache/dubbo><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Subscribe to mailing list" aria-label="Subscribe to mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=mailto:dev-subscribe@dubbo.apache.org><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. 保留所有权利</small></div></div></div></footer><div class="row pt-2 pb-2"><div class="container-fluid mx-sm-5"><div class=text-center id=my-footer><img style=float:left src=/imgs/apache_logo.png><ul><li><a href=https://www.apache.org>Foundation</a></li><li><a href=https://www.apache.org/licenses/>License</a></li><li><a href=https://www.apache.org/security/>Security</a></li><li><a href=https://www.apache.org/events/current-event>Events</a></li><li><a href=https://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li><li><a href=https://privacy.apache.org/policies/privacy-policy-public.html>Privacy</a></li><li><a href=https://www.apache.org/foundation/thanks.html>Thanks</a></li></ul></div></div></div></div><script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.9ceec0d76295e936b6677f157698d4b09b8b402e8cc915989f8347d96c0f09e4.js integrity="sha256-nO7A12KV6Ta2Z38VdpjUsJuLQC6MyRWYn4NH2WwPCeQ=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@docsearch/js@3></script>
<script>docsearch({appId:"L5F4T9F0I1",apiKey:"364ae307e1da9d02b2335675e9db1eb1",indexName:"apache_dubbo",container:"#docsearch",debug:!1}),docsearch({appId:"L5F4T9F0I1",apiKey:"364ae307e1da9d02b2335675e9db1eb1",indexName:"apache_dubbo",container:"#docsearch_zh_home",debug:!1})</script></body></html>