<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.86.0">
<meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>服务导出 | Apache Dubbo</title><meta property="og:title" content="服务导出">
<meta property="og:description" content="本文介绍了 Dubbo 服务导出的过程和实现细节">
<meta property="og:type" content="article">
<meta property="og:url" content="https://dubbo.apache.org/zh/docs/v2.7/dev/source/export-service/"><meta property="article:section" content="docs">
<meta property="article:modified_time" content="2021-07-23T11:11:08+08:00"><meta property="og:site_name" content="Apache Dubbo">
<meta itemprop=name content="服务导出">
<meta itemprop=description content="本文介绍了 Dubbo 服务导出的过程和实现细节">
<meta itemprop=dateModified content="2021-07-23T11:11:08+08:00">
<meta itemprop=wordCount content="4706">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="服务导出">
<meta name=twitter:description content="本文介绍了 Dubbo 服务导出的过程和实现细节">
<link rel=preload href=/scss/main.min.4d2a11198108f72ac6d14967441006a13e5f60c35051427324c25c6644ae0ae3.css as=style>
<link href=/scss/main.min.4d2a11198108f72ac6d14967441006a13e5f60c35051427324c25c6644ae0ae3.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/zh/>
<span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 321.39 78.54"><title id="title19">DUBBO LOGO</title><path class="cls-1" d="M68.46 50.38c0 14.06 11.39 22.11 25.45 22.11s25.45-8.05 25.45-22.11V7.25H68.46zm21.24-28h8.6V31H89.7zm0 22.25h8.6v8.6H89.7zM33.24 7.25H4.06v64H33.24c10.95.0 19.3-7.18 23.29-17.15a45.12 45.12.0 002.38-14.87A45.12 45.12.0 0056.53 24.4C52.84 14.62 44.19 7.25 33.24 7.25zm.43 14.63H30.34a3.44 3.44.0 00-3.44 3.44V53.23a3.44 3.44.0 003.44 3.44h3.33v4.63h-8.3a6.87 6.87.0 01-6.87-6.87V24.12a6.87 6.87.0 016.87-6.87h8.3zM285.51 6.06c-17.05.0-30.88 10.28-30.88 33.21s13.83 33.21 30.88 33.21 30.88-10.28 30.88-33.21S302.56 6.06 285.51 6.06zm7.59 48.36a6.87 6.87.0 01-6.87 6.87h-8.3V56.67h3.33a3.44 3.44.0 003.44-3.44V25.31a3.44 3.44.0 00-3.44-3.44h-3.33V17.25h8.3a6.87 6.87.0 016.87 6.87zm-53.4-17.56A17.39 17.39.0 00227.31 7.25H195.1v64h32.21a19.44 19.44.0 0012.38-34.44zM211.63 61.29h-6.08l18.68-44h6.08zM177 36.85A17.39 17.39.0 00164.65 7.25H132.43v64h32.21A19.44 19.44.0 00177 36.85zM149 61.29h-6.08l18.68-44h6.08z" style="fill:#fff;fill-opacity:1"/></svg></span><span class="text-uppercase font-weight-bold">Apache Dubbo</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/zh/docs/><span class=active>文档</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/zh/blog/><span>博客</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/zh/community/><span>社区</span></a>
</li>
<li class="nav-item dropdown d-none d-lg-block">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中文
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/en/>English</a>
</div>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<div id=content-mobile>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002 站内搜索…" aria-label=站内搜索… autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
</div>
<div id=content-desktop></div>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<div class="nav-item dropdown d-block d-lg-none">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中文
</a>
<div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/en/>English</a>
</div>
</div>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a>
</li>
<ul>
<li class="collapse show" id=zhdocs>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Dubbo 2.7</a>
</li>
<ul>
<li class="collapse show" id=zhdocsv27>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">用户文档</a>
</li>
<ul>
<li class=collapse id=zhdocsv27user>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/preface/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">入门</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userpreface>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userprefacebackground href=/zh/docs/v2.7/user/preface/background/>背景</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userprefacerequirements href=/zh/docs/v2.7/user/preface/requirements/>需求</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userprefacearchitecture href=/zh/docs/v2.7/user/preface/architecture/>架构</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userprefaceusage href=/zh/docs/v2.7/user/preface/usage/>用法</a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userquick-start href=/zh/docs/v2.7/user/quick-start/>快速开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userdependencies href=/zh/docs/v2.7/user/dependencies/>依赖</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27usermaturity href=/zh/docs/v2.7/user/maturity/>成熟度</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/configuration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">配置</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userconfiguration>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userconfigurationxml href=/zh/docs/v2.7/user/configuration/xml/>XML 配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userconfigurationconfig-center href=/zh/docs/v2.7/user/configuration/config-center/>动态配置中心</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userconfigurationproperties href=/zh/docs/v2.7/user/configuration/properties/>属性配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userconfigurationenvironment-variables href=/zh/docs/v2.7/user/configuration/environment-variables/>自动加载环境变量</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userconfigurationapi href=/zh/docs/v2.7/user/configuration/api/>API 配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userconfigurationannotation href=/zh/docs/v2.7/user/configuration/annotation/>注解配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userconfigurationconfiguration-load-process href=/zh/docs/v2.7/user/configuration/configuration-load-process/>配置加载流程</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/examples/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">用法示例</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userexamples>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplespreflight-check href=/zh/docs/v2.7/user/examples/preflight-check/>启动时检查</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplese9878de8af95e6aca1e695b0e9858de7bdae href=/zh/docs/v2.7/user/examples/%E9%87%8D%E8%AF%95%E6%AC%A1%E6%95%B0%E9%85%8D%E7%BD%AE/>重试次数配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesfault-tolerent-strategy href=/zh/docs/v2.7/user/examples/fault-tolerent-strategy/>集群容错</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesloadbalance href=/zh/docs/v2.7/user/examples/loadbalance/>负载均衡</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesthread-model href=/zh/docs/v2.7/user/examples/thread-model/>线程模型</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesexplicit-target href=/zh/docs/v2.7/user/examples/explicit-target/>直连提供者</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplessubscribe-only href=/zh/docs/v2.7/user/examples/subscribe-only/>只订阅</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesmulti-protocols href=/zh/docs/v2.7/user/examples/multi-protocols/>多协议</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesmulti-registry href=/zh/docs/v2.7/user/examples/multi-registry/>多注册中心</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesservice-group href=/zh/docs/v2.7/user/examples/service-group/>服务分组</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesstatic-service href=/zh/docs/v2.7/user/examples/static-service/>静态服务</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesmulti-versions href=/zh/docs/v2.7/user/examples/multi-versions/>多版本</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesgroup-merger href=/zh/docs/v2.7/user/examples/group-merger/>分组聚合</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesparameter-validation href=/zh/docs/v2.7/user/examples/parameter-validation/>参数验证</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesgeneric-invoke-with-json href=/zh/docs/v2.7/user/examples/generic-invoke-with-json/>json泛化调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesmsgpack-serialization href=/zh/docs/v2.7/user/examples/msgpack-serialization/>msgpack序列化</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesprovider-timeout-release href=/zh/docs/v2.7/user/examples/provider-timeout-release/>provider超时打断</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesinvoke-with-specified-ip href=/zh/docs/v2.7/user/examples/invoke-with-specified-ip/>指定IP</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesbroadcast-resp-collect href=/zh/docs/v2.7/user/examples/broadcast-resp-collect/>收集广播响应</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesresult-cache href=/zh/docs/v2.7/user/examples/result-cache/>结果缓存</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesgeneric-reference href=/zh/docs/v2.7/user/examples/generic-reference/>使用泛化调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesprotobuf-idl href=/zh/docs/v2.7/user/examples/protobuf-idl/>Protobuf</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplespb-generic-reference href=/zh/docs/v2.7/user/examples/pb-generic-reference/>Protobuf 泛化调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesgeneric-service href=/zh/docs/v2.7/user/examples/generic-service/>实现泛化调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesecho-service href=/zh/docs/v2.7/user/examples/echo-service/>回声测试</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplescontext href=/zh/docs/v2.7/user/examples/context/>上下文信息</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesattachment href=/zh/docs/v2.7/user/examples/attachment/>隐式参数</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesasync-execute-on-provider href=/zh/docs/v2.7/user/examples/async-execute-on-provider/>异步执行</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesasync-call href=/zh/docs/v2.7/user/examples/async-call/>异步调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexampleslocal-call href=/zh/docs/v2.7/user/examples/local-call/>本地调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplescallback-parameter href=/zh/docs/v2.7/user/examples/callback-parameter/>参数回调</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesevents-notify href=/zh/docs/v2.7/user/examples/events-notify/>事件通知</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexampleslocal-stub href=/zh/docs/v2.7/user/examples/local-stub/>本地存根</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexampleslocal-mock href=/zh/docs/v2.7/user/examples/local-mock/>本地伪装</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesdelay-publish href=/zh/docs/v2.7/user/examples/delay-publish/>延迟暴露</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesconcurrency-control href=/zh/docs/v2.7/user/examples/concurrency-control/>并发控制</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesconfig-connections href=/zh/docs/v2.7/user/examples/config-connections/>连接控制</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexampleslazy-connect href=/zh/docs/v2.7/user/examples/lazy-connect/>延迟连接</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesstickiness href=/zh/docs/v2.7/user/examples/stickiness/>粘滞连接</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplestls href=/zh/docs/v2.7/user/examples/tls/>TLS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplestoken-authorization href=/zh/docs/v2.7/user/examples/token-authorization/>令牌验证</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesrouting-rule href=/zh/docs/v2.7/user/examples/routing-rule/>路由规则</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesrouting-rule-deprecated href=/zh/docs/v2.7/user/examples/routing-rule-deprecated/>旧路由规则</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesconfig-rule href=/zh/docs/v2.7/user/examples/config-rule/>配置规则</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesconfig-rule-deprecated href=/zh/docs/v2.7/user/examples/config-rule-deprecated/>旧配置规则</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesservice-downgrade href=/zh/docs/v2.7/user/examples/service-downgrade/>服务降级</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesconsumer-threadpool href=/zh/docs/v2.7/user/examples/consumer-threadpool/>消费端线程池模型</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesgraceful-shutdown href=/zh/docs/v2.7/user/examples/graceful-shutdown/>优雅停机</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexampleshostname-binding href=/zh/docs/v2.7/user/examples/hostname-binding/>主机绑定</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userexamplesset-host href=/zh/docs/v2.7/user/examples/set-host/>主机配置</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/references/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">参考手册</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userreferences>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/references/xml/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">XML 配置</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userreferencesxml>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-application href=/zh/docs/v2.7/user/references/xml/dubbo-application/>dubbo:application</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-argument href=/zh/docs/v2.7/user/references/xml/dubbo-argument/>dubbo:argument</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-config-center href=/zh/docs/v2.7/user/references/xml/dubbo-config-center/>dubbo:config-center</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-consumer href=/zh/docs/v2.7/user/references/xml/dubbo-consumer/>dubbo:consumer</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-method href=/zh/docs/v2.7/user/references/xml/dubbo-method/>dubbo:method</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-module href=/zh/docs/v2.7/user/references/xml/dubbo-module/>dubbo:module</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-monitor href=/zh/docs/v2.7/user/references/xml/dubbo-monitor/>dubbo:monitor</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-parameter href=/zh/docs/v2.7/user/references/xml/dubbo-parameter/>dubbo:parameter</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-protocol href=/zh/docs/v2.7/user/references/xml/dubbo-protocol/>dubbo:protocol</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-provider href=/zh/docs/v2.7/user/references/xml/dubbo-provider/>dubbo:provider</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-reference href=/zh/docs/v2.7/user/references/xml/dubbo-reference/>dubbo:reference</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-registry href=/zh/docs/v2.7/user/references/xml/dubbo-registry/>dubbo:registry</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesxmldubbo-service href=/zh/docs/v2.7/user/references/xml/dubbo-service/>dubbo:service</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/references/protocol/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">协议参考手册</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userreferencesprotocol>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocoldubbo href=/zh/docs/v2.7/user/references/protocol/dubbo/>dubbo://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolrest href=/zh/docs/v2.7/user/references/protocol/rest/>rest://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolhttp href=/zh/docs/v2.7/user/references/protocol/http/>http://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolhessian href=/zh/docs/v2.7/user/references/protocol/hessian/>hessian://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolredis href=/zh/docs/v2.7/user/references/protocol/redis/>redis://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolthrift href=/zh/docs/v2.7/user/references/protocol/thrift/>thrift://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolgrpc href=/zh/docs/v2.7/user/references/protocol/grpc/>grpc://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolmemcached href=/zh/docs/v2.7/user/references/protocol/memcached/>memcached://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolrmi href=/zh/docs/v2.7/user/references/protocol/rmi/>rmi://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesprotocolwebservice href=/zh/docs/v2.7/user/references/protocol/webservice/>webservice://</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/references/registry/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">注册中心参考手册</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userreferencesregistry>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesregistrynacos href=/zh/docs/v2.7/user/references/registry/nacos/>Nacos</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesregistryzookeeper href=/zh/docs/v2.7/user/references/registry/zookeeper/>Zookeeper</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesregistrymulticast href=/zh/docs/v2.7/user/references/registry/multicast/>Multicast</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesregistryredis href=/zh/docs/v2.7/user/references/registry/redis/>Redis</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesregistrysimple href=/zh/docs/v2.7/user/references/registry/simple/>Simple</a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesmetadata href=/zh/docs/v2.7/user/references/metadata/>元数据参考手册</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesapi href=/zh/docs/v2.7/user/references/api/>API 参考手册</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesqos href=/zh/docs/v2.7/user/references/qos/>QOS 手册</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencestelnet href=/zh/docs/v2.7/user/references/telnet/>Telnet 手册</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userreferencesmaven href=/zh/docs/v2.7/user/references/maven/>Maven 插件参考手册</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/versions/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">版本升级</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userversions>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userversionsversion-270 href=/zh/docs/v2.7/user/versions/version-270/>2.7.0</a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userbest-practice href=/zh/docs/v2.7/user/best-practice/>服务化最佳实践</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userrecommend href=/zh/docs/v2.7/user/recommend/>推荐用法</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27usercapacity-plan href=/zh/docs/v2.7/user/capacity-plan/>容量规划</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userperf-test href=/zh/docs/v2.7/user/perf-test/>性能测试报告</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27usercoveragence href=/zh/docs/v2.7/user/coveragence/>测试覆盖率报告</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userbenchmark-tool href=/zh/docs/v2.7/user/benchmark-tool/>基准测试</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userrest href=/zh/docs/v2.7/user/rest/>REST 支持</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27usersimple-monitor href=/zh/docs/v2.7/user/simple-monitor/>简单监控</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userserialization href=/zh/docs/v2.7/user/serialization/>Kryo 和 FST 序列化</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/languages/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">其他语言支持</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userlanguages>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/user/languages/erlang/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Erlang</a>
</li>
<ul>
<li class=collapse id=zhdocsv27userlanguageserlang>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userlanguageserlangquick-start href=/zh/docs/v2.7/user/languages/erlang/quick-start/>快速开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userlanguageserlangreference href=/zh/docs/v2.7/user/languages/erlang/reference/>消费者配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userlanguageserlangservice href=/zh/docs/v2.7/user/languages/erlang/service/>提供者配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27userlanguageserlangserialization href=/zh/docs/v2.7/user/languages/erlang/serialization/>序列化配置项</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27usernew-features-in-a-glance href=/zh/docs/v2.7/user/new-features-in-a-glance/></a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/dev/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">开发指南</a>
</li>
<ul>
<li class="collapse show" id=zhdocsv27dev>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devbuild href=/zh/docs/v2.7/dev/build/>源码构建</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devdesign href=/zh/docs/v2.7/dev/design/>框架设计</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devspi href=/zh/docs/v2.7/dev/spi/>扩展点加载</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplementation href=/zh/docs/v2.7/dev/implementation/>实现细节</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/dev/impls/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">SPI 扩展实现</a>
</li>
<ul>
<li class=collapse id=zhdocsv27devimpls>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsprotocol href=/zh/docs/v2.7/dev/impls/protocol/>协议扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsfilter href=/zh/docs/v2.7/dev/impls/filter/>调用拦截扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsinvoker-listener href=/zh/docs/v2.7/dev/impls/invoker-listener/>引用监听扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsexporter-listener href=/zh/docs/v2.7/dev/impls/exporter-listener/>暴露监听扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplscluster href=/zh/docs/v2.7/dev/impls/cluster/>集群扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsrouter href=/zh/docs/v2.7/dev/impls/router/>路由扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsload-balance href=/zh/docs/v2.7/dev/impls/load-balance/>负载均衡扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsmerger href=/zh/docs/v2.7/dev/impls/merger/>合并结果扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsregistry href=/zh/docs/v2.7/dev/impls/registry/>注册中心扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsmonitor href=/zh/docs/v2.7/dev/impls/monitor/>监控中心扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsextension-factory href=/zh/docs/v2.7/dev/impls/extension-factory/>扩展点加载扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsproxy-factory href=/zh/docs/v2.7/dev/impls/proxy-factory/>动态代理扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplscompiler href=/zh/docs/v2.7/dev/impls/compiler/>编译器扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsconfig-center href=/zh/docs/v2.7/dev/impls/config-center/>配置中心扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsdispatcher href=/zh/docs/v2.7/dev/impls/dispatcher/>消息派发扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsthreadpool href=/zh/docs/v2.7/dev/impls/threadpool/>线程池扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsserialize href=/zh/docs/v2.7/dev/impls/serialize/>序列化扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsremoting href=/zh/docs/v2.7/dev/impls/remoting/>网络传输扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsexchanger href=/zh/docs/v2.7/dev/impls/exchanger/>信息交换扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsnetworker href=/zh/docs/v2.7/dev/impls/networker/>组网扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplstelnet-handler href=/zh/docs/v2.7/dev/impls/telnet-handler/>Telnet 命令扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsstatus-checker href=/zh/docs/v2.7/dev/impls/status-checker/>状态检查扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplscontainer href=/zh/docs/v2.7/dev/impls/container/>容器扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplscache href=/zh/docs/v2.7/dev/impls/cache/>缓存扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplsvalidation href=/zh/docs/v2.7/dev/impls/validation/>验证扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplslogger-adapter href=/zh/docs/v2.7/dev/impls/logger-adapter/>日志适配扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devimplspage href=/zh/docs/v2.7/dev/impls/page/></a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/dev/principals/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">设计原则</a>
</li>
<ul>
<li class=collapse id=zhdocsv27devprincipals>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devprincipalscode-detail href=/zh/docs/v2.7/dev/principals/code-detail/>魔鬼在细节</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devprincipalsconfiguration href=/zh/docs/v2.7/dev/principals/configuration/>配置设计</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devprincipalsdummy href=/zh/docs/v2.7/dev/principals/dummy/>防痴呆设计</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devprincipalsexpansibility href=/zh/docs/v2.7/dev/principals/expansibility/>谈谈扩充式扩展与增量式扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devprincipalsextension href=/zh/docs/v2.7/dev/principals/extension/>扩展点重构</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devprincipalsgeneral-knowledge href=/zh/docs/v2.7/dev/principals/general-knowledge/>一些设计上的基本常识</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devprincipalsrobustness href=/zh/docs/v2.7/dev/principals/robustness/>设计实现的健壮性</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devprincipalsintroduction href=/zh/docs/v2.7/dev/principals/introduction/></a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devcontract href=/zh/docs/v2.7/dev/contract/>公共契约</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/dev/source/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">源代码</a>
</li>
<ul>
<li class="collapse show" id=zhdocsv27devsource>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devsourcedubbo-spi href=/zh/docs/v2.7/dev/source/dubbo-spi/>Dubbo SPI</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devsourcerouter href=/zh/docs/v2.7/dev/source/router/>服务路由</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devsourceadaptive-extension href=/zh/docs/v2.7/dev/source/adaptive-extension/>SPI 自适应拓展</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-zhdocsv27devsourceexport-service href=/zh/docs/v2.7/dev/source/export-service/>服务导出</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devsourcerefer-service href=/zh/docs/v2.7/dev/source/refer-service/>服务引用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devsourceservice-invoking-process href=/zh/docs/v2.7/dev/source/service-invoking-process/>服务调用过程</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devsourcedirectory href=/zh/docs/v2.7/dev/source/directory/>服务目录</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devsourcecluster href=/zh/docs/v2.7/dev/source/cluster/>集群</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devsourceloadbalance href=/zh/docs/v2.7/dev/source/loadbalance/>负载均衡</a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devrelease href=/zh/docs/v2.7/dev/release/>版本管理</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devchecklist href=/zh/docs/v2.7/dev/checklist/>检查列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devcode-smell href=/zh/docs/v2.7/dev/code-smell/>坏味道</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devcoding href=/zh/docs/v2.7/dev/coding/>编码约定</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27devtck href=/zh/docs/v2.7/dev/tck/>TCK</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/admin/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">运维管理指南</a>
</li>
<ul>
<li class=collapse id=zhdocsv27admin>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/admin/ops/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dubbo Admin 运维指南</a>
</li>
<ul>
<li class=collapse id=zhdocsv27adminops>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27adminopsfunctions href=/zh/docs/v2.7/admin/ops/functions/>管理控制台运维</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27adminopsintroduction href=/zh/docs/v2.7/admin/ops/introduction/>Dubbo 管理控制台介绍</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27adminopssearch href=/zh/docs/v2.7/admin/ops/search/>服务查询和详情展示</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27adminopstest href=/zh/docs/v2.7/admin/ops/test/>服务测试</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27adminopsapidocs href=/zh/docs/v2.7/admin/ops/apidocs/>API文档&测试</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27adminopsgovernance href=/zh/docs/v2.7/admin/ops/governance/>服务治理和配置管理</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27adminopsskywalking href=/zh/docs/v2.7/admin/ops/skywalking/>使用 Apache Skywalking 做分布式跟踪</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27adminopspinpoint href=/zh/docs/v2.7/admin/ops/pinpoint/>使用 Pinpoint 做分布式跟踪</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v2.7/admin/install/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">安装手册</a>
</li>
<ul>
<li class=collapse id=zhdocsv27admininstall>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27admininstalladmin-console href=/zh/docs/v2.7/admin/install/admin-console/>管理控制台安装</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27admininstallprovider-demo href=/zh/docs/v2.7/admin/install/provider-demo/>示例提供者安装</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27admininstallconsumer-demo href=/zh/docs/v2.7/admin/install/consumer-demo/>示例消费者安装</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27admininstallredis href=/zh/docs/v2.7/admin/install/redis/>Redis 注册中心安装</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27admininstallzookeeper href=/zh/docs/v2.7/admin/install/zookeeper/>Zookeeper 注册中心安装</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv27admininstallmonitor-center href=/zh/docs/v2.7/admin/install/monitor-center/>Simple 监控中心安装</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dubbo 3.0</a>
</li>
<ul>
<li class=collapse id=zhdocsv30>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30introduction href=/zh/docs/v3.0/introduction/>简介</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30new-in-dubbo3 href=/zh/docs/v3.0/new-in-dubbo3/>新版本特性速览</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/concepts/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">概念&架构</a>
</li>
<ul>
<li class=collapse id=zhdocsv30concepts>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30conceptsservice-discovery href=/zh/docs/v3.0/concepts/service-discovery/>服务发现</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30conceptsrpc-protocol href=/zh/docs/v3.0/concepts/rpc-protocol/>协议</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30conceptstraffic-management href=/zh/docs/v3.0/concepts/traffic-management/>流量管理</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30conceptsconfiguration href=/zh/docs/v3.0/concepts/configuration/>配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30conceptsregistry-configcenter-metadata href=/zh/docs/v3.0/concepts/registry-configcenter-metadata/>部署架构</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30conceptsextensibility href=/zh/docs/v3.0/concepts/extensibility/>扩展性</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/examples/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">介绍与示例</a>
</li>
<ul>
<li class=collapse id=zhdocsv30examples>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesquick-start href=/zh/docs/v3.0/examples/quick-start/>快速开始</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/examples/routing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">路由规则</a>
</li>
<ul>
<li class=collapse id=zhdocsv30examplesrouting>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesroutingdynamic-rule-deployment href=/zh/docs/v3.0/examples/routing/dynamic-rule-deployment/>动态路由</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesroutingweight-rule-deployment href=/zh/docs/v3.0/examples/routing/weight-rule-deployment/>权重路由</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesroutingdemo-rule-deployment href=/zh/docs/v3.0/examples/routing/demo-rule-deployment/>使用案例</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesroutingblue-green-deployment href=/zh/docs/v3.0/examples/routing/blue-green-deployment/>蓝绿部署</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesroutingab-testing-deployment href=/zh/docs/v3.0/examples/routing/ab-testing-deployment/>Ab测试</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesroutingcanary-deployment href=/zh/docs/v3.0/examples/routing/canary-deployment/>金丝雀部署</a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesservice-discovery href=/zh/docs/v3.0/examples/service-discovery/>服务发现</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30examplesconfiguration-override href=/zh/docs/v3.0/examples/configuration-override/>动态配置</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/advanced/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">高级用法</a>
</li>
<ul>
<li class=collapse id=zhdocsv30advanced>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30advancedprotobufinterface href=/zh/docs/v3.0/advanced/protobufinterface/>Protobuf vs Interface</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30advancedmigration-invoker href=/zh/docs/v3.0/advanced/migration-invoker/>地址迁移规则说明</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/migration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">升级与兼容性</a>
</li>
<ul>
<li class=collapse id=zhdocsv30migration>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30migrationmigration-and-compatibility-guide href=/zh/docs/v3.0/migration/migration-and-compatibility-guide/>总结</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30migrationmigration-service-discovery href=/zh/docs/v3.0/migration/migration-service-discovery/>应用级地址发现</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30migrationmigration-triple href=/zh/docs/v3.0/migration/migration-triple/>Triple</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30migrationmigration-routingrule href=/zh/docs/v3.0/migration/migration-routingrule/>路由规则</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/languages/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">多语言</a>
</li>
<ul>
<li class=collapse id=zhdocsv30languages>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/languages/erlang/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Erlang</a>
</li>
<ul>
<li class=collapse id=zhdocsv30languageserlang>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languageserlangquick-start href=/zh/docs/v3.0/languages/erlang/quick-start/>快速开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languageserlangreference href=/zh/docs/v3.0/languages/erlang/reference/>消费者配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languageserlangservice href=/zh/docs/v3.0/languages/erlang/service/>提供者配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languageserlangserialization href=/zh/docs/v3.0/languages/erlang/serialization/>序列化配置项</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/languages/golang/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">golang</a>
</li>
<ul>
<li class=collapse id=zhdocsv30languagesgolang>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesgolangquick-start href=/zh/docs/v3.0/languages/golang/quick-start/>Go 快速开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesgolanggo-specific href=/zh/docs/v3.0/languages/golang/go-specific/>Go 语言定义服务</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/languages/java/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">java</a>
</li>
<ul>
<li class=collapse id=zhdocsv30languagesjava>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesjavaconfigurationxml href=/zh/docs/v3.0/languages/java/configuration/xml/>XML 配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesjavaconfigurationconfig-center href=/zh/docs/v3.0/languages/java/configuration/config-center/>动态配置中心</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesjavaconfigurationproperties href=/zh/docs/v3.0/languages/java/configuration/properties/>属性配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesjavaconfigurationapi href=/zh/docs/v3.0/languages/java/configuration/api/>API 配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesjavaconfigurationannotation href=/zh/docs/v3.0/languages/java/configuration/annotation/>注解配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesjavajava-specific href=/zh/docs/v3.0/languages/java/java-specific/>Java 定义服务</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30languagesjavaquick-start href=/zh/docs/v3.0/languages/java/quick-start/>Java 快速开始</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">参考手册</a>
</li>
<ul>
<li class=collapse id=zhdocsv30references>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/protobuf/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">protobuf</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referencesprotobuf>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotobufidl href=/zh/docs/v3.0/references/protobuf/idl/>idl</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/xml/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">XML 配置</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referencesxml>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-application href=/zh/docs/v3.0/references/xml/dubbo-application/>dubbo:application</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-argument href=/zh/docs/v3.0/references/xml/dubbo-argument/>dubbo:argument</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-config-center href=/zh/docs/v3.0/references/xml/dubbo-config-center/>dubbo:config-center</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-consumer href=/zh/docs/v3.0/references/xml/dubbo-consumer/>dubbo:consumer</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-method href=/zh/docs/v3.0/references/xml/dubbo-method/>dubbo:method</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-module href=/zh/docs/v3.0/references/xml/dubbo-module/>dubbo:module</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-monitor href=/zh/docs/v3.0/references/xml/dubbo-monitor/>dubbo:monitor</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-parameter href=/zh/docs/v3.0/references/xml/dubbo-parameter/>dubbo:parameter</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-protocol href=/zh/docs/v3.0/references/xml/dubbo-protocol/>dubbo:protocol</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-provider href=/zh/docs/v3.0/references/xml/dubbo-provider/>dubbo:provider</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-reference href=/zh/docs/v3.0/references/xml/dubbo-reference/>dubbo:reference</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-registry href=/zh/docs/v3.0/references/xml/dubbo-registry/>dubbo:registry</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesxmldubbo-service href=/zh/docs/v3.0/references/xml/dubbo-service/>dubbo:service</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/registry/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">注册中心参考手册</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referencesregistry>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesregistrynacos href=/zh/docs/v3.0/references/registry/nacos/>Nacos</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesregistryzookeeper href=/zh/docs/v3.0/references/registry/zookeeper/>Zookeeper</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesregistrymulticast href=/zh/docs/v3.0/references/registry/multicast/>Multicast</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesregistryredis href=/zh/docs/v3.0/references/registry/redis/>Redis</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesregistrysimple href=/zh/docs/v3.0/references/registry/simple/>Simple</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/spis/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">SPI 扩展实现</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referencesspis>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisprotocol href=/zh/docs/v3.0/references/spis/protocol/>协议扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisfilter href=/zh/docs/v3.0/references/spis/filter/>调用拦截扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisinvoker-listener href=/zh/docs/v3.0/references/spis/invoker-listener/>引用监听扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisexporter-listener href=/zh/docs/v3.0/references/spis/exporter-listener/>暴露监听扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspiscluster href=/zh/docs/v3.0/references/spis/cluster/>集群扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisrouter href=/zh/docs/v3.0/references/spis/router/>路由扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisload-balance href=/zh/docs/v3.0/references/spis/load-balance/>负载均衡扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspismerger href=/zh/docs/v3.0/references/spis/merger/>合并结果扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisregistry href=/zh/docs/v3.0/references/spis/registry/>注册中心扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspismonitor href=/zh/docs/v3.0/references/spis/monitor/>监控中心扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisextension-factory href=/zh/docs/v3.0/references/spis/extension-factory/>扩展点加载扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisproxy-factory href=/zh/docs/v3.0/references/spis/proxy-factory/>动态代理扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspiscompiler href=/zh/docs/v3.0/references/spis/compiler/>编译器扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisconfig-center href=/zh/docs/v3.0/references/spis/config-center/>配置中心扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisdispatcher href=/zh/docs/v3.0/references/spis/dispatcher/>消息派发扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisthreadpool href=/zh/docs/v3.0/references/spis/threadpool/>线程池扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisserialize href=/zh/docs/v3.0/references/spis/serialize/>序列化扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisremoting href=/zh/docs/v3.0/references/spis/remoting/>网络传输扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisexchanger href=/zh/docs/v3.0/references/spis/exchanger/>信息交换扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisnetworker href=/zh/docs/v3.0/references/spis/networker/>组网扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspistelnet-handler href=/zh/docs/v3.0/references/spis/telnet-handler/>Telnet 命令扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisstatus-checker href=/zh/docs/v3.0/references/spis/status-checker/>状态检查扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspiscontainer href=/zh/docs/v3.0/references/spis/container/>容器扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspiscache href=/zh/docs/v3.0/references/spis/cache/>缓存扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisvalidation href=/zh/docs/v3.0/references/spis/validation/>验证扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspislogger-adapter href=/zh/docs/v3.0/references/spis/logger-adapter/>日志适配扩展</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspispage href=/zh/docs/v3.0/references/spis/page/></a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesspisdubbo-spi href=/zh/docs/v3.0/references/spis/dubbo-spi/>扩展点开发指南</a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesmetadata href=/zh/docs/v3.0/references/metadata/>元数据参考手册</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/configuration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">配置</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referencesconfiguration>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesconfigurationxml href=/zh/docs/v3.0/references/configuration/xml/>XML 配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesconfigurationconfig-center href=/zh/docs/v3.0/references/configuration/config-center/>动态配置中心</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesconfigurationproperties href=/zh/docs/v3.0/references/configuration/properties/>属性配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesconfigurationenvironment-variables href=/zh/docs/v3.0/references/configuration/environment-variables/>自动加载环境变量</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesconfigurationapi href=/zh/docs/v3.0/references/configuration/api/>API 配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesconfigurationannotation href=/zh/docs/v3.0/references/configuration/annotation/>注解配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesconfigurationconfiguration-load-process href=/zh/docs/v3.0/references/configuration/configuration-load-process/>配置加载流程</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/features/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">功能列表</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referencesfeatures>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturespreflight-check href=/zh/docs/v3.0/references/features/preflight-check/>启动时检查</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesfault-tolerent-strategy href=/zh/docs/v3.0/references/features/fault-tolerent-strategy/>集群容错</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesloadbalance href=/zh/docs/v3.0/references/features/loadbalance/>负载均衡</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesthread-model href=/zh/docs/v3.0/references/features/thread-model/>线程模型</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesexplicit-target href=/zh/docs/v3.0/references/features/explicit-target/>直连提供者</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturessubscribe-only href=/zh/docs/v3.0/references/features/subscribe-only/>只订阅</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesmulti-protocols href=/zh/docs/v3.0/references/features/multi-protocols/>多协议</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesmulti-registry href=/zh/docs/v3.0/references/features/multi-registry/>多注册中心</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesservice-group href=/zh/docs/v3.0/references/features/service-group/>服务分组</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesstatic-service href=/zh/docs/v3.0/references/features/static-service/>静态服务</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesmulti-versions href=/zh/docs/v3.0/references/features/multi-versions/>多版本</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesgroup-merger href=/zh/docs/v3.0/references/features/group-merger/>分组聚合</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesparameter-validation href=/zh/docs/v3.0/references/features/parameter-validation/>参数验证</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesresult-cache href=/zh/docs/v3.0/references/features/result-cache/>结果缓存</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesgeneric-reference href=/zh/docs/v3.0/references/features/generic-reference/>使用泛化调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesprotobuf-idl href=/zh/docs/v3.0/references/features/protobuf-idl/>Protobuf</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturespb-generic-reference href=/zh/docs/v3.0/references/features/pb-generic-reference/>Protobuf 泛化调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesgeneric-service href=/zh/docs/v3.0/references/features/generic-service/>实现泛化调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesecho-service href=/zh/docs/v3.0/references/features/echo-service/>回声测试</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturescontext href=/zh/docs/v3.0/references/features/context/>上下文信息</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesattachment href=/zh/docs/v3.0/references/features/attachment/>隐式参数</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesasync-execute-on-provider href=/zh/docs/v3.0/references/features/async-execute-on-provider/>异步执行</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesasync-call href=/zh/docs/v3.0/references/features/async-call/>异步调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeatureslocal-call href=/zh/docs/v3.0/references/features/local-call/>本地调用</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturescallback-parameter href=/zh/docs/v3.0/references/features/callback-parameter/>参数回调</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesevents-notify href=/zh/docs/v3.0/references/features/events-notify/>事件通知</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeatureslocal-stub href=/zh/docs/v3.0/references/features/local-stub/>本地存根</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeatureslocal-mock href=/zh/docs/v3.0/references/features/local-mock/>本地伪装</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesdelay-publish href=/zh/docs/v3.0/references/features/delay-publish/>延迟暴露</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesconcurrency-control href=/zh/docs/v3.0/references/features/concurrency-control/>并发控制</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesconfig-connections href=/zh/docs/v3.0/references/features/config-connections/>连接控制</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeatureslazy-connect href=/zh/docs/v3.0/references/features/lazy-connect/>延迟连接</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesstickiness href=/zh/docs/v3.0/references/features/stickiness/>粘滞连接</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturestls href=/zh/docs/v3.0/references/features/tls/>TLS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturestoken-authorization href=/zh/docs/v3.0/references/features/token-authorization/>令牌验证</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesrouting-rule href=/zh/docs/v3.0/references/features/routing-rule/>路由规则</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesrouting-rule-deprecated href=/zh/docs/v3.0/references/features/routing-rule-deprecated/>旧路由规则</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesconfig-rule href=/zh/docs/v3.0/references/features/config-rule/>配置规则</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesconfig-rule-deprecated href=/zh/docs/v3.0/references/features/config-rule-deprecated/>旧配置规则</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesservice-downgrade href=/zh/docs/v3.0/references/features/service-downgrade/>服务降级</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesconsumer-threadpool href=/zh/docs/v3.0/references/features/consumer-threadpool/>消费端线程池模型</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesgraceful-shutdown href=/zh/docs/v3.0/references/features/graceful-shutdown/>优雅停机</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeatureshostname-binding href=/zh/docs/v3.0/references/features/hostname-binding/>主机绑定</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesset-host href=/zh/docs/v3.0/references/features/set-host/>主机配置</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturessimplify-registry-data href=/zh/docs/v3.0/references/features/simplify-registry-data/>注册信息简化</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeatureslogger-strategy href=/zh/docs/v3.0/references/features/logger-strategy/>日志适配</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesaccesslog href=/zh/docs/v3.0/references/features/accesslog/>访问日志</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesservice-container href=/zh/docs/v3.0/references/features/service-container/>服务容器</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesreference-config-cache href=/zh/docs/v3.0/references/features/reference-config-cache/>ReferenceConfig 缓存</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesfeaturesregistry-only href=/zh/docs/v3.0/references/features/registry-only/>只注册</a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesapi href=/zh/docs/v3.0/references/api/>API 参考手册</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/lifecycle/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">探针</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referenceslifecycle>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referenceslifecyclebrief href=/zh/docs/v3.0/references/lifecycle/brief/>使用方法</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referenceslifecyclestartup href=/zh/docs/v3.0/references/lifecycle/startup/>启动探针</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referenceslifecycleliveness href=/zh/docs/v3.0/references/lifecycle/liveness/>存活探针</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referenceslifecyclereadiness href=/zh/docs/v3.0/references/lifecycle/readiness/>就绪探针</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referenceslifecyclerest href=/zh/docs/v3.0/references/lifecycle/rest/>REST 支持</a>
</li>
</ul>
</ul>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesqos href=/zh/docs/v3.0/references/qos/>QOS 手册</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencestelnet href=/zh/docs/v3.0/references/telnet/>Telnet 手册</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesmaven href=/zh/docs/v3.0/references/maven/>Maven 插件参考手册</a>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/protocols/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">RPC协议</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referencesprotocols>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolsdubbo href=/zh/docs/v3.0/references/protocols/dubbo/>dubbo://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolshttp href=/zh/docs/v3.0/references/protocols/http/>http://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolshessian href=/zh/docs/v3.0/references/protocols/hessian/>hessian://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolsredis href=/zh/docs/v3.0/references/protocols/redis/>redis://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolsthrift href=/zh/docs/v3.0/references/protocols/thrift/>thrift://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolsgrpc href=/zh/docs/v3.0/references/protocols/grpc/>grpc://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolsmemcached href=/zh/docs/v3.0/references/protocols/memcached/>memcached://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolsrmi href=/zh/docs/v3.0/references/protocols/rmi/>rmi://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolswebservice href=/zh/docs/v3.0/references/protocols/webservice/>webservice://</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolstri href=/zh/docs/v3.0/references/protocols/tri/>Triple 协议</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesprotocolsrest href=/zh/docs/v3.0/references/protocols/rest/>REST 支持</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/v3.0/references/routers/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">路由规则</a>
</li>
<ul>
<li class=collapse id=zhdocsv30referencesrouters>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesroutersvirtualservice href=/zh/docs/v3.0/references/routers/virtualservice/>VirtualService</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsv30referencesroutersdestination-rule href=/zh/docs/v3.0/references/routers/destination-rule/>DestinationRule</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/notices/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">公告栏</a>
</li>
<ul>
<li class=collapse id=zhdocsnotices>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsnoticessecurity href=/zh/docs/notices/security/>安全漏洞</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/contribution-guidelines/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">贡献指南</a>
</li>
<ul>
<li class=collapse id=zhdocscontribution-guidelines>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/contribution-guidelines/contributor/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contributor 指南</a>
</li>
<ul>
<li class=collapse id=zhdocscontribution-guidelinescontributor>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescontributorbecome-a-committer_dev href=/zh/docs/contribution-guidelines/contributor/become-a-committer_dev/>成为 Committer</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescontributorcla-signing-guide_dev href=/zh/docs/contribution-guidelines/contributor/cla-signing-guide_dev/>CLA 签署向导</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescontributornew-contributor-guide_dev href=/zh/docs/contribution-guidelines/contributor/new-contributor-guide_dev/>新手向导</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescontributormailing-list-subscription-guide_dev href=/zh/docs/contribution-guidelines/contributor/mailing-list-subscription-guide_dev/>邮件组向导</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescontributorreporting-security-issues_dev href=/zh/docs/contribution-guidelines/contributor/reporting-security-issues_dev/>反馈漏洞</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescontributorsoftware-donation-guide_dev href=/zh/docs/contribution-guidelines/contributor/software-donation-guide_dev/>捐献向导</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescontributordubbo-extension-guide_dev href=/zh/docs/contribution-guidelines/contributor/dubbo-extension-guide_dev/>扩展 Dubbo</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescontributortest-coverage-guide_dev href=/zh/docs/contribution-guidelines/contributor/test-coverage-guide_dev/>测试覆盖率向导</a>
</li>
</ul>
</ul>
<ul class="td-sidebar-nav__section pr-md-3">
<li class=td-sidebar-nav__section-title>
<a href=/zh/docs/contribution-guidelines/committer/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Committer 指南</a>
</li>
<ul>
<li class=collapse id=zhdocscontribution-guidelinescommitter>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescommitternew-committer-guide_dev href=/zh/docs/contribution-guidelines/committer/new-committer-guide_dev/>注册流程</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescommitterrelease-guide_dev href=/zh/docs/contribution-guidelines/committer/release-guide_dev/>发版准备</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescommitterwebsite-guide_dev href=/zh/docs/contribution-guidelines/committer/website-guide_dev/>网站向导</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescommitterlabel-an-issue-guide_dev href=/zh/docs/contribution-guidelines/committer/label-an-issue-guide_dev/>问题标签</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscontribution-guidelinescommitterapache-dubbo-page_dev href=/zh/docs/contribution-guidelines/committer/apache-dubbo-page_dev/>官方主页</a>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
</li>
</ul>
</ul>
</nav>
</div>
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/apache/dubbo-website/edit/master/content/zh/docs/v2.7/dev/source/export-service.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/apache/dubbo-website/new/master/content/zh/docs/v2.7/dev/source/export-service.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/apache/dubbo-website/issues/new?title=%e6%9c%8d%e5%8a%a1%e5%af%bc%e5%87%ba" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a href=https://github.com/apache/dubbo/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a>
</div>
<nav id=TableOfContents>
<ul>
<li><a href=#1简介>1.简介</a></li>
<li><a href=#2源码分析>2.源码分析</a>
<ul>
<li><a href=#21-前置工作>2.1 前置工作</a></li>
<li><a href=#22-导出-dubbo-服务>2.2 导出 Dubbo 服务</a></li>
<li><a href=#221-invoker-创建过程>2.2.1 Invoker 创建过程</a></li>
<li><a href=#222-导出服务到本地>2.2.2 导出服务到本地</a></li>
<li><a href=#223-导出服务到远程>2.2.3 导出服务到远程</a></li>
<li><a href=#224-服务注册>2.2.4 服务注册</a></li>
<li><a href=#225-订阅-override-数据>2.2.5 订阅 override 数据</a></li>
</ul>
</li>
<li><a href=#3总结>3.总结</a></li>
</ul>
</nav>
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=https://dubbo.apache.org/zh/docs/>文档</a>
</li>
<li class=breadcrumb-item>
<a href=https://dubbo.apache.org/zh/docs/v2.7/>Dubbo 2.7</a>
</li>
<li class=breadcrumb-item>
<a href=https://dubbo.apache.org/zh/docs/v2.7/dev/>开发指南</a>
</li>
<li class=breadcrumb-item>
<a href=https://dubbo.apache.org/zh/docs/v2.7/dev/source/>源代码</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=https://dubbo.apache.org/zh/docs/v2.7/dev/source/export-service/>服务导出</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>服务导出</h1>
<div class=lead>本文介绍了 Dubbo 服务导出的过程和实现细节</div>
<h2 id=1简介>1.简介</h2>
<p>本篇文章，我们来研究一下 Dubbo 导出服务的过程。Dubbo 服务导出过程始于 Spring 容器发布刷新事件，Dubbo 在接收到事件后，会立即执行服务导出逻辑。整个逻辑大致可分为三个部分，第一部分是前置工作，主要用于检查参数，组装 URL。第二部分是导出服务，包含导出服务到本地 (JVM)，和导出服务到远程两个过程。第三部分是向注册中心注册服务，用于服务发现。本篇文章将会对这三个部分代码进行详细的分析。</p>
<h2 id=2源码分析>2.源码分析</h2>
<p>服务导出的入口方法是 ServiceBean 的 onApplicationEvent。onApplicationEvent 是一个事件响应方法，该方法会在收到 Spring 上下文刷新事件后执行服务导出操作。方法代码如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>onApplicationEvent</span><span style=color:#719e07>(</span>ContextRefreshedEvent event<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 是否有延迟导出 &amp;&amp; 是否已导出 &amp;&amp; 是不是已被取消导出
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>isDelay<span style=color:#719e07>()</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>isExported<span style=color:#719e07>()</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>isUnexported<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 导出服务
</span><span style=color:#586e75></span>        export<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>这个方法首先会根据条件决定是否导出服务，比如有些服务设置了延时导出，那么此时就不应该在此处导出。还有一些服务已经被导出了，或者当前服务被取消导出了，此时也不能再次导出相关服务。注意这里的 isDelay 方法，这个方法字面意思是“是否延迟导出服务”，返回 true 表示延迟导出，false 表示不延迟导出。但是该方法真实意思却并非如此，当方法返回 true 时，表示无需延迟导出。返回 false 时，表示需要延迟导出。与字面意思恰恰相反，这个需要大家注意一下。下面我们来看一下这个方法的逻辑。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#586e75>// -☆- ServiceBean
</span><span style=color:#586e75></span><span style=color:#268bd2>private</span> <span style=color:#dc322f>boolean</span> <span style=color:#268bd2>isDelay</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 获取 delay
</span><span style=color:#586e75></span>    Integer delay <span style=color:#719e07>=</span> getDelay<span style=color:#719e07>();</span>
    ProviderConfig provider <span style=color:#719e07>=</span> getProvider<span style=color:#719e07>();</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>delay <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> provider <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 如果前面获取的 delay 为空，这里继续获取
</span><span style=color:#586e75></span>        delay <span style=color:#719e07>=</span> provider<span style=color:#719e07>.</span>getDelay<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
    <span style=color:#586e75>// 判断 delay 是否为空，或者等于 -1
</span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> supportedApplicationListener <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>(</span>delay <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> delay <span style=color:#719e07>==</span> <span style=color:#719e07>-</span>1<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>暂时忽略 supportedApplicationListener 这个条件，当 delay 为空，或者等于-1时，该方法返回 true，而不是 false。这个方法的返回值让人有点困惑。该方法目前已被重构，详细请参考 <a href=https://github.com/apache/dubbo/pull/2686>dubbo #2686</a>。</p>
<p>现在解释一下 supportedApplicationListener 变量含义，该变量用于表示当前的 Spring 容器是否支持 ApplicationListener，这个值初始为 false。在 Spring 容器将自己设置到 ServiceBean 中时，ServiceBean 的 setApplicationContext 方法会检测 Spring 容器是否支持 ApplicationListener。若支持，则将 supportedApplicationListener 置为 true。ServiceBean 是 Dubbo 与 Spring 框架进行整合的关键，可以看做是两个框架之间的桥梁。具有同样作用的类还有 ReferenceBean。</p>
<p>现在我们知道了 Dubbo 服务导出过程的起点，接下来对服务导出的前置逻辑进行分析。</p>
<h3 id=21-前置工作>2.1 前置工作</h3>
<p>前置工作主要包含两个部分，分别是配置检查，以及 URL 装配。在导出服务之前，Dubbo 需要检查用户的配置是否合理，或者为用户补充缺省配置。配置检查完成后，接下来需要根据这些配置组装 URL。在 Dubbo 中，URL 的作用十分重要。Dubbo 使用 URL 作为配置载体，所有的拓展点都是通过 URL 获取配置。这一点，官方文档中有所说明。</p>
<blockquote>
<p>采用 URL 作为配置信息的统一格式，所有扩展点都通过传递 URL 携带配置信息。</p>
</blockquote>
<p>接下来，我们先来分析配置检查部分的源码，随后再来分析 URL 组装部分的源码。</p>
<h4 id=211-检查配置>2.1.1 检查配置</h4>
<p>本节我们接着前面的源码向下分析，前面说过 onApplicationEvent 方法在经过一些判断后，会决定是否调用 export 方法导出服务。那么下面我们从 export 方法开始进行分析，如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>synchronized</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>export</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>provider <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 获取 export 和 delay 配置
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>export <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            export <span style=color:#719e07>=</span> provider<span style=color:#719e07>.</span>getExport<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>delay <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            delay <span style=color:#719e07>=</span> provider<span style=color:#719e07>.</span>getDelay<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#586e75>// 如果 export 为 false，则不导出服务
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>export <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>export<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>return</span><span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// delay &gt; 0，延时导出服务
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>delay <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> delay <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        delayExportExecutor<span style=color:#719e07>.</span>schedule<span style=color:#719e07>(</span><span style=color:#719e07>new</span> Runnable<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
            <span style=color:#268bd2>@Override</span>
            <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>run</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
                doExport<span style=color:#719e07>();</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>},</span> delay<span style=color:#719e07>,</span> TimeUnit<span style=color:#719e07>.</span>MILLISECONDS<span style=color:#719e07>);</span>
        
    <span style=color:#586e75>// 立即导出服务
</span><span style=color:#586e75></span>    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
        doExport<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>export 方法对两项配置进行了检查，并根据配置执行相应的动作。首先是 export 配置，这个配置决定了是否导出服务。有时候我们只是想本地启动服务进行一些调试工作，我们并不希望把本地启动的服务暴露出去给别人调用。此时，我们可通过配置 export 禁止服务导出，比如：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#268bd2>&lt;dubbo:provider</span> export=<span style=color:#2aa198>&#34;false&#34;</span> <span style=color:#268bd2>/&gt;</span>
</code></pre></div><p>delay 配置顾名思义，用于延迟导出服务，这个就不分析了。下面，我们继续分析源码，这次要分析的是 doExport 方法。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>protected</span> <span style=color:#268bd2>synchronized</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doExport</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>unexported<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Already unexported!&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>exported<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>return</span><span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
    exported <span style=color:#719e07>=</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>;</span>
    <span style=color:#586e75>// 检测 interfaceName 是否合法
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>interfaceName <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> interfaceName<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;interface not allow null!&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    <span style=color:#586e75>// 检测 provider 是否为空，为空则新建一个，并通过系统变量为其初始化
</span><span style=color:#586e75></span>    checkDefault<span style=color:#719e07>();</span>

    <span style=color:#586e75>// 下面几个 if 语句用于检测 provider、application 等核心配置类对象是否为空，
</span><span style=color:#586e75></span>    <span style=color:#586e75>// 若为空，则尝试从其他配置类对象中获取相应的实例。
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>provider <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>application <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            application <span style=color:#719e07>=</span> provider<span style=color:#719e07>.</span>getApplication<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>module <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            module <span style=color:#719e07>=</span> provider<span style=color:#719e07>.</span>getModule<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>registries <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{...}</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>monitor <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{...}</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>protocols <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{...}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>module <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>registries <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            registries <span style=color:#719e07>=</span> module<span style=color:#719e07>.</span>getRegistries<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>monitor <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{...}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>application <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>registries <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            registries <span style=color:#719e07>=</span> application<span style=color:#719e07>.</span>getRegistries<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>monitor <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{...}</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 检测 ref 是否为泛化服务类型
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ref <span style=color:#719e07>instanceof</span> GenericService<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 设置 interfaceClass 为 GenericService.class
</span><span style=color:#586e75></span>        interfaceClass <span style=color:#719e07>=</span> GenericService<span style=color:#719e07>.</span>class<span style=color:#719e07>;</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>StringUtils<span style=color:#719e07>.</span>isEmpty<span style=color:#719e07>(</span>generic<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 设置 generic = &#34;true&#34;
</span><span style=color:#586e75></span>            generic <span style=color:#719e07>=</span> Boolean<span style=color:#719e07>.</span>TRUE<span style=color:#719e07>.</span>toString<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span>
        
    <span style=color:#586e75>// ref 非 GenericService 类型
</span><span style=color:#586e75></span>    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
            interfaceClass <span style=color:#719e07>=</span> Class<span style=color:#719e07>.</span>forName<span style=color:#719e07>(</span>interfaceName<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>,</span> Thread<span style=color:#719e07>.</span>currentThread<span style=color:#719e07>()</span>
                    <span style=color:#719e07>.</span>getContextClassLoader<span style=color:#719e07>());</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>ClassNotFoundException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span>e<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> e<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#586e75>// 对 interfaceClass，以及 &lt;dubbo:method&gt; 标签中的必要字段进行检查
</span><span style=color:#586e75></span>        checkInterfaceAndMethods<span style=color:#719e07>(</span>interfaceClass<span style=color:#719e07>,</span> methods<span style=color:#719e07>);</span>
        <span style=color:#586e75>// 对 ref 合法性进行检测
</span><span style=color:#586e75></span>        checkRef<span style=color:#719e07>();</span>
        <span style=color:#586e75>// 设置 generic = &#34;false&#34;
</span><span style=color:#586e75></span>        generic <span style=color:#719e07>=</span> Boolean<span style=color:#719e07>.</span>FALSE<span style=color:#719e07>.</span>toString<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// local 和 stub 在功能应该是一致的，用于配置本地存根
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>local <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span><span style=color:#2aa198>&#34;true&#34;</span><span style=color:#719e07>.</span>equals<span style=color:#719e07>(</span>local<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            local <span style=color:#719e07>=</span> interfaceName <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;Local&#34;</span><span style=color:#719e07>;</span>
        <span style=color:#719e07>}</span>
        Class<span style=color:#719e07>&lt;?&gt;</span> localClass<span style=color:#719e07>;</span>
        <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 获取本地存根类
</span><span style=color:#586e75></span>            localClass <span style=color:#719e07>=</span> ClassHelper<span style=color:#719e07>.</span>forNameWithThreadContextClassLoader<span style=color:#719e07>(</span>local<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>ClassNotFoundException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span>e<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> e<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#586e75>// 检测本地存根类是否可赋值给接口类，若不可赋值则会抛出异常，提醒使用者本地存根类类型不合法
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>interfaceClass<span style=color:#719e07>.</span>isAssignableFrom<span style=color:#719e07>(</span>localClass<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;The local implementation class &#34;</span> <span style=color:#719e07>+</span> localClass<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34; not implement interface &#34;</span> <span style=color:#719e07>+</span> interfaceName<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>

    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>stub <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 此处的代码和上一个 if 分支的代码基本一致，这里省略
</span><span style=color:#586e75></span>    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 检测各种对象是否为空，为空则新建，或者抛出异常
</span><span style=color:#586e75></span>    checkApplication<span style=color:#719e07>();</span>
    checkRegistry<span style=color:#719e07>();</span>
    checkProtocol<span style=color:#719e07>();</span>
    appendProperties<span style=color:#719e07>(</span><span style=color:#719e07>this</span><span style=color:#719e07>);</span>
    checkStubAndMock<span style=color:#719e07>(</span>interfaceClass<span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>path <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> path<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        path <span style=color:#719e07>=</span> interfaceName<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 导出服务
</span><span style=color:#586e75></span>    doExportUrls<span style=color:#719e07>();</span>

    <span style=color:#586e75>// ProviderModel 表示服务提供者模型，此对象中存储了与服务提供者相关的信息。
</span><span style=color:#586e75></span>    <span style=color:#586e75>// 比如服务的配置信息，服务实例等。每个被导出的服务对应一个 ProviderModel。
</span><span style=color:#586e75></span>    <span style=color:#586e75>// ApplicationModel 持有所有的 ProviderModel。
</span><span style=color:#586e75></span>    ProviderModel providerModel <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ProviderModel<span style=color:#719e07>(</span>getUniqueServiceName<span style=color:#719e07>(),</span> <span style=color:#719e07>this</span><span style=color:#719e07>,</span> ref<span style=color:#719e07>);</span>
    ApplicationModel<span style=color:#719e07>.</span>initProviderModel<span style=color:#719e07>(</span>getUniqueServiceName<span style=color:#719e07>(),</span> providerModel<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>以上就是配置检查的相关分析，代码比较多，需要大家耐心看一下。下面对配置检查的逻辑进行简单的总结，如下：</p>
<ol>
<li>检测 &lt;dubbo:service> 标签的 interface 属性合法性，不合法则抛出异常</li>
<li>检测 ProviderConfig、ApplicationConfig 等核心配置类对象是否为空，若为空，则尝试从其他配置类对象中获取相应的实例。</li>
<li>检测并处理泛化服务和普通服务类</li>
<li>检测本地存根配置，并进行相应的处理</li>
<li>对 ApplicationConfig、RegistryConfig 等配置类进行检测，为空则尝试创建，若无法创建则抛出异常</li>
</ol>
<p>配置检查并非本文重点，因此这里不打算对 doExport 方法所调用的方法进行分析（doExportUrls 方法除外）。在这些方法中，除了 appendProperties 方法稍微复杂一些，其他方法逻辑不是很复杂。因此，大家可自行分析。</p>
<h4 id=212-多协议多注册中心导出服务>2.1.2 多协议多注册中心导出服务</h4>
<p>Dubbo 允许我们使用不同的协议导出服务，也允许我们向多个注册中心注册服务。Dubbo 在 doExportUrls 方法中对多协议，多注册中心进行了支持。相关代码如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doExportUrls</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 加载注册中心链接
</span><span style=color:#586e75></span>    List<span style=color:#719e07>&lt;</span>URL<span style=color:#719e07>&gt;</span> registryURLs <span style=color:#719e07>=</span> loadRegistries<span style=color:#719e07>(</span><span style=color:#cb4b16>true</span><span style=color:#719e07>);</span>
    <span style=color:#586e75>// 遍历 protocols，并在每个协议下导出服务
</span><span style=color:#586e75></span>    <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>ProtocolConfig protocolConfig <span style=color:#719e07>:</span> protocols<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        doExportUrlsFor1Protocol<span style=color:#719e07>(</span>protocolConfig<span style=color:#719e07>,</span> registryURLs<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>上面代码首先是通过 loadRegistries 加载注册中心链接，然后再遍历 ProtocolConfig 集合导出每个服务。并在导出服务的过程中，将服务注册到注册中心。下面，我们先来看一下 loadRegistries 方法的逻辑。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>protected</span> List<span style=color:#719e07>&lt;</span>URL<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>loadRegistries</span><span style=color:#719e07>(</span><span style=color:#dc322f>boolean</span> provider<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 检测是否存在注册中心配置类，不存在则抛出异常
</span><span style=color:#586e75></span>    checkRegistry<span style=color:#719e07>();</span>
    List<span style=color:#719e07>&lt;</span>URL<span style=color:#719e07>&gt;</span> registryList <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ArrayList<span style=color:#719e07>&lt;</span>URL<span style=color:#719e07>&gt;();</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>registries <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>registries<span style=color:#719e07>.</span>isEmpty<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>RegistryConfig config <span style=color:#719e07>:</span> registries<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            String address <span style=color:#719e07>=</span> config<span style=color:#719e07>.</span>getAddress<span style=color:#719e07>();</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>address <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> address<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                <span style=color:#586e75>// 若 address 为空，则将其设为 0.0.0.0
</span><span style=color:#586e75></span>                address <span style=color:#719e07>=</span> Constants<span style=color:#719e07>.</span>ANYHOST_VALUE<span style=color:#719e07>;</span>
            <span style=color:#719e07>}</span>

            <span style=color:#586e75>// 从系统属性中加载注册中心地址
</span><span style=color:#586e75></span>            String sysaddress <span style=color:#719e07>=</span> System<span style=color:#719e07>.</span>getProperty<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;dubbo.registry.address&#34;</span><span style=color:#719e07>);</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>sysaddress <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> sysaddress<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                address <span style=color:#719e07>=</span> sysaddress<span style=color:#719e07>;</span>
            <span style=color:#719e07>}</span>
            <span style=color:#586e75>// 检测 address 是否合法
</span><span style=color:#586e75></span>            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>address<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0 <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>RegistryConfig<span style=color:#719e07>.</span>NO_AVAILABLE<span style=color:#719e07>.</span>equalsIgnoreCase<span style=color:#719e07>(</span>address<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                Map<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> String<span style=color:#719e07>&gt;</span> map <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> HashMap<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> String<span style=color:#719e07>&gt;();</span>
                <span style=color:#586e75>// 添加 ApplicationConfig 中的字段信息到 map 中
</span><span style=color:#586e75></span>                appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> application<span style=color:#719e07>);</span>
                <span style=color:#586e75>// 添加 RegistryConfig 字段信息到 map 中
</span><span style=color:#586e75></span>                appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> config<span style=color:#719e07>);</span>
                
                <span style=color:#586e75>// 添加 path、pid，protocol 等信息到 map 中
</span><span style=color:#586e75></span>                map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;path&#34;</span><span style=color:#719e07>,</span> RegistryService<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>());</span>
                map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;dubbo&#34;</span><span style=color:#719e07>,</span> Version<span style=color:#719e07>.</span>getProtocolVersion<span style=color:#719e07>());</span>
                map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>TIMESTAMP_KEY<span style=color:#719e07>,</span> String<span style=color:#719e07>.</span>valueOf<span style=color:#719e07>(</span>System<span style=color:#719e07>.</span>currentTimeMillis<span style=color:#719e07>()));</span>
                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ConfigUtils<span style=color:#719e07>.</span>getPid<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>PID_KEY<span style=color:#719e07>,</span> String<span style=color:#719e07>.</span>valueOf<span style=color:#719e07>(</span>ConfigUtils<span style=color:#719e07>.</span>getPid<span style=color:#719e07>()));</span>
                <span style=color:#719e07>}</span>
                <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>map<span style=color:#719e07>.</span>containsKey<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;protocol&#34;</span><span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>RegistryFactory<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>hasExtension<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;remote&#34;</span><span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                        map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;protocol&#34;</span><span style=color:#719e07>,</span> <span style=color:#2aa198>&#34;remote&#34;</span><span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
                        map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;protocol&#34;</span><span style=color:#719e07>,</span> <span style=color:#2aa198>&#34;dubbo&#34;</span><span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span>
                <span style=color:#719e07>}</span>

                <span style=color:#586e75>// 解析得到 URL 列表，address 可能包含多个注册中心 ip，
</span><span style=color:#586e75></span>                <span style=color:#586e75>// 因此解析得到的是一个 URL 列表
</span><span style=color:#586e75></span>                List<span style=color:#719e07>&lt;</span>URL<span style=color:#719e07>&gt;</span> urls <span style=color:#719e07>=</span> UrlUtils<span style=color:#719e07>.</span>parseURLs<span style=color:#719e07>(</span>address<span style=color:#719e07>,</span> map<span style=color:#719e07>);</span>
                <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>URL url <span style=color:#719e07>:</span> urls<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>addParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>REGISTRY_KEY<span style=color:#719e07>,</span> url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>());</span>
                    <span style=color:#586e75>// 将 URL 协议头设置为 registry
</span><span style=color:#586e75></span>                    url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>setProtocol<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>REGISTRY_PROTOCOL<span style=color:#719e07>);</span>
                    <span style=color:#586e75>// 通过判断条件，决定是否添加 url 到 registryList 中，条件如下：
</span><span style=color:#586e75></span>                    <span style=color:#586e75>// (服务提供者 &amp;&amp; register = true 或 null) 
</span><span style=color:#586e75></span>                    <span style=color:#586e75>//    || (非服务提供者 &amp;&amp; subscribe = true 或 null)
</span><span style=color:#586e75></span>                    <span style=color:#719e07>if</span> <span style=color:#719e07>((</span>provider <span style=color:#719e07>&amp;&amp;</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>REGISTER_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>))</span>
                            <span style=color:#719e07>||</span> <span style=color:#719e07>(!</span>provider <span style=color:#719e07>&amp;&amp;</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>SUBSCRIBE_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>)))</span> <span style=color:#719e07>{</span>
                        registryList<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>return</span> registryList<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>loadRegistries 方法主要包含如下的逻辑：</p>
<ol>
<li>检测是否存在注册中心配置类，不存在则抛出异常</li>
<li>构建参数映射集合，也就是 map</li>
<li>构建注册中心链接列表</li>
<li>遍历链接列表，并根据条件决定是否将其添加到 registryList 中</li>
</ol>
<p>关于多协议多注册中心导出服务就先分析到这，代码不是很多，接下来分析 URL 组装过程。</p>
<h4 id=213-组装-url>2.1.3 组装 URL</h4>
<p>配置检查完毕后，紧接着要做的事情是根据配置，以及其他一些信息组装 URL。前面说过，URL 是 Dubbo 配置的载体，通过 URL 可让 Dubbo 的各种配置在各个模块之间传递。URL 之于 Dubbo，犹如水之于鱼，非常重要。大家在阅读 Dubbo 服务导出相关源码的过程中，要注意 URL 内容的变化。既然 URL 如此重要，那么下面我们来了解一下 URL 组装的过程。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doExportUrlsFor1Protocol</span><span style=color:#719e07>(</span>ProtocolConfig protocolConfig<span style=color:#719e07>,</span> List<span style=color:#719e07>&lt;</span>URL<span style=color:#719e07>&gt;</span> registryURLs<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    String name <span style=color:#719e07>=</span> protocolConfig<span style=color:#719e07>.</span>getName<span style=color:#719e07>();</span>
    <span style=color:#586e75>// 如果协议名为空，或空串，则将协议名变量设置为 dubbo
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>name <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> name<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        name <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;dubbo&#34;</span><span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>

    Map<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> String<span style=color:#719e07>&gt;</span> map <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> HashMap<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> String<span style=color:#719e07>&gt;();</span>
    <span style=color:#586e75>// 添加 side、版本、时间戳以及进程号等信息到 map 中
</span><span style=color:#586e75></span>    map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>SIDE_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>PROVIDER_SIDE<span style=color:#719e07>);</span>
    map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>DUBBO_VERSION_KEY<span style=color:#719e07>,</span> Version<span style=color:#719e07>.</span>getProtocolVersion<span style=color:#719e07>());</span>
    map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>TIMESTAMP_KEY<span style=color:#719e07>,</span> String<span style=color:#719e07>.</span>valueOf<span style=color:#719e07>(</span>System<span style=color:#719e07>.</span>currentTimeMillis<span style=color:#719e07>()));</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ConfigUtils<span style=color:#719e07>.</span>getPid<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>PID_KEY<span style=color:#719e07>,</span> String<span style=color:#719e07>.</span>valueOf<span style=color:#719e07>(</span>ConfigUtils<span style=color:#719e07>.</span>getPid<span style=color:#719e07>()));</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 通过反射将对象的字段信息添加到 map 中
</span><span style=color:#586e75></span>    appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> application<span style=color:#719e07>);</span>
    appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> module<span style=color:#719e07>);</span>
    appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> provider<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>DEFAULT_KEY<span style=color:#719e07>);</span>
    appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> protocolConfig<span style=color:#719e07>);</span>
    appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> <span style=color:#719e07>this</span><span style=color:#719e07>);</span>

    <span style=color:#586e75>// methods 为 MethodConfig 集合，MethodConfig 中存储了 &lt;dubbo:method&gt; 标签的配置信息
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>methods <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>methods<span style=color:#719e07>.</span>isEmpty<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 这段代码用于添加 Callback 配置到 map 中，代码太长，待会单独分析
</span><span style=color:#586e75></span>    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 检测 generic 是否为 &#34;true&#34;，并根据检测结果向 map 中添加不同的信息
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ProtocolUtils<span style=color:#719e07>.</span>isGeneric<span style=color:#719e07>(</span>generic<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
        map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>GENERIC_KEY<span style=color:#719e07>,</span> generic<span style=color:#719e07>);</span>
        map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>METHODS_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>ANY_VALUE<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
        String revision <span style=color:#719e07>=</span> Version<span style=color:#719e07>.</span>getVersion<span style=color:#719e07>(</span>interfaceClass<span style=color:#719e07>,</span> version<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>revision <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> revision<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;revision&#34;</span><span style=color:#719e07>,</span> revision<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>

        <span style=color:#586e75>// 为接口生成包裹类 Wrapper，Wrapper 中包含了接口的详细信息，比如接口方法名数组，字段信息等
</span><span style=color:#586e75></span>        String<span style=color:#719e07>[]</span> methods <span style=color:#719e07>=</span> Wrapper<span style=color:#719e07>.</span>getWrapper<span style=color:#719e07>(</span>interfaceClass<span style=color:#719e07>).</span>getMethodNames<span style=color:#719e07>();</span>
        <span style=color:#586e75>// 添加方法名到 map 中，如果包含多个方法名，则用逗号隔开，比如 method = init,destroy
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>methods<span style=color:#719e07>.</span>length <span style=color:#719e07>==</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            logger<span style=color:#719e07>.</span>warn<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;NO method found in service interface ...&#34;</span><span style=color:#719e07>);</span>
            map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>METHODS_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>ANY_VALUE<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 将逗号作为分隔符连接方法名，并将连接后的字符串放入 map 中
</span><span style=color:#586e75></span>            map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>METHODS_KEY<span style=color:#719e07>,</span> StringUtils<span style=color:#719e07>.</span>join<span style=color:#719e07>(</span><span style=color:#719e07>new</span> HashSet<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;(</span>Arrays<span style=color:#719e07>.</span>asList<span style=color:#719e07>(</span>methods<span style=color:#719e07>)),</span> <span style=color:#2aa198>&#34;,&#34;</span><span style=color:#719e07>));</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 添加 token 到 map 中
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>ConfigUtils<span style=color:#719e07>.</span>isEmpty<span style=color:#719e07>(</span>token<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ConfigUtils<span style=color:#719e07>.</span>isDefault<span style=color:#719e07>(</span>token<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 随机生成 token
</span><span style=color:#586e75></span>            map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>TOKEN_KEY<span style=color:#719e07>,</span> UUID<span style=color:#719e07>.</span>randomUUID<span style=color:#719e07>().</span>toString<span style=color:#719e07>());</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
            map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>TOKEN_KEY<span style=color:#719e07>,</span> token<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#586e75>// 判断协议名是否为 injvm
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>LOCAL_PROTOCOL<span style=color:#719e07>.</span>equals<span style=color:#719e07>(</span>protocolConfig<span style=color:#719e07>.</span>getName<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
        protocolConfig<span style=color:#719e07>.</span>setRegister<span style=color:#719e07>(</span><span style=color:#cb4b16>false</span><span style=color:#719e07>);</span>
        map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;notify&#34;</span><span style=color:#719e07>,</span> <span style=color:#2aa198>&#34;false&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 获取上下文路径
</span><span style=color:#586e75></span>    String contextPath <span style=color:#719e07>=</span> protocolConfig<span style=color:#719e07>.</span>getContextpath<span style=color:#719e07>();</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>((</span>contextPath <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> contextPath<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>&amp;&amp;</span> provider <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        contextPath <span style=color:#719e07>=</span> provider<span style=color:#719e07>.</span>getContextpath<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 获取 host 和 port
</span><span style=color:#586e75></span>    String host <span style=color:#719e07>=</span> <span style=color:#719e07>this</span><span style=color:#719e07>.</span>findConfigedHosts<span style=color:#719e07>(</span>protocolConfig<span style=color:#719e07>,</span> registryURLs<span style=color:#719e07>,</span> map<span style=color:#719e07>);</span>
    Integer port <span style=color:#719e07>=</span> <span style=color:#719e07>this</span><span style=color:#719e07>.</span>findConfigedPorts<span style=color:#719e07>(</span>protocolConfig<span style=color:#719e07>,</span> name<span style=color:#719e07>,</span> map<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 组装 URL
</span><span style=color:#586e75></span>    URL url <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> URL<span style=color:#719e07>(</span>name<span style=color:#719e07>,</span> host<span style=color:#719e07>,</span> port<span style=color:#719e07>,</span> <span style=color:#719e07>(</span>contextPath <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> contextPath<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> 0 <span style=color:#719e07>?</span> <span style=color:#2aa198>&#34;&#34;</span> <span style=color:#719e07>:</span> contextPath <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;/&#34;</span><span style=color:#719e07>)</span> <span style=color:#719e07>+</span> path<span style=color:#719e07>,</span> map<span style=color:#719e07>);</span>
    
    <span style=color:#586e75>// 省略无关代码
</span><span style=color:#586e75></span><span style=color:#719e07>}</span>
</code></pre></div><p>上面的代码首先是将一些信息，比如版本、时间戳、方法名以及各种配置对象的字段信息放入到 map 中，map 中的内容将作为 URL 的查询字符串。构建好 map 后，紧接着是获取上下文路径、主机名以及端口号等信息。最后将 map 和主机名等数据传给 URL 构造方法创建 URL 对象。需要注意的是，这里出现的 URL 并非 java.net.URL，而是 com.alibaba.dubbo.common.URL。</p>
<p>上面省略了一段代码，这里简单分析一下。这段代码用于检测 &lt;dubbo:method> 标签中的配置信息，并将相关配置添加到 map 中。代码如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doExportUrlsFor1Protocol</span><span style=color:#719e07>(</span>ProtocolConfig protocolConfig<span style=color:#719e07>,</span> List<span style=color:#719e07>&lt;</span>URL<span style=color:#719e07>&gt;</span> registryURLs<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// ...
</span><span style=color:#586e75></span>
    <span style=color:#586e75>// methods 为 MethodConfig 集合，MethodConfig 中存储了 &lt;dubbo:method&gt; 标签的配置信息
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>methods <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>methods<span style=color:#719e07>.</span>isEmpty<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>MethodConfig method <span style=color:#719e07>:</span> methods<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 添加 MethodConfig 对象的字段信息到 map 中，键 = 方法名.属性名。
</span><span style=color:#586e75></span>            <span style=color:#586e75>// 比如存储 &lt;dubbo:method name=&#34;sayHello&#34; retries=&#34;2&#34;&gt; 对应的 MethodConfig，
</span><span style=color:#586e75></span>            <span style=color:#586e75>// 键 = sayHello.retries，map = {&#34;sayHello.retries&#34;: 2, &#34;xxx&#34;: &#34;yyy&#34;}
</span><span style=color:#586e75></span>            appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> method<span style=color:#719e07>,</span> method<span style=color:#719e07>.</span>getName<span style=color:#719e07>());</span>

            String retryKey <span style=color:#719e07>=</span> method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.retry&#34;</span><span style=color:#719e07>;</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>map<span style=color:#719e07>.</span>containsKey<span style=color:#719e07>(</span>retryKey<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                String retryValue <span style=color:#719e07>=</span> map<span style=color:#719e07>.</span>remove<span style=color:#719e07>(</span>retryKey<span style=color:#719e07>);</span>
                <span style=color:#586e75>// 检测 MethodConfig retry 是否为 false，若是，则设置重试次数为0
</span><span style=color:#586e75></span>                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span><span style=color:#2aa198>&#34;false&#34;</span><span style=color:#719e07>.</span>equals<span style=color:#719e07>(</span>retryValue<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                    map<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.retries&#34;</span><span style=color:#719e07>,</span> <span style=color:#2aa198>&#34;0&#34;</span><span style=color:#719e07>);</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
            
            <span style=color:#586e75>// 获取 ArgumentConfig 列表
</span><span style=color:#586e75></span>            List<span style=color:#719e07>&lt;</span>ArgumentConfig<span style=color:#719e07>&gt;</span> arguments <span style=color:#719e07>=</span> method<span style=color:#719e07>.</span>getArguments<span style=color:#719e07>();</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>arguments <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>arguments<span style=color:#719e07>.</span>isEmpty<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
                <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>ArgumentConfig argument <span style=color:#719e07>:</span> arguments<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    <span style=color:#586e75>// 检测 type 属性是否为空，或者空串（分支1 ⭐️）
</span><span style=color:#586e75></span>                    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>argument<span style=color:#719e07>.</span>getType<span style=color:#719e07>()</span> <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> argument<span style=color:#719e07>.</span>getType<span style=color:#719e07>().</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                        Method<span style=color:#719e07>[]</span> methods <span style=color:#719e07>=</span> interfaceClass<span style=color:#719e07>.</span>getMethods<span style=color:#719e07>();</span>
                        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>methods <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> methods<span style=color:#719e07>.</span>length <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                            <span style=color:#719e07>for</span> <span style=color:#719e07>(</span><span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> 0<span style=color:#719e07>;</span> i <span style=color:#719e07>&lt;</span> methods<span style=color:#719e07>.</span>length<span style=color:#719e07>;</span> i<span style=color:#719e07>++)</span> <span style=color:#719e07>{</span>
                                String methodName <span style=color:#719e07>=</span> methods<span style=color:#719e07>[</span>i<span style=color:#719e07>].</span>getName<span style=color:#719e07>();</span>
                                <span style=color:#586e75>// 比对方法名，查找目标方法
</span><span style=color:#586e75></span>                                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>methodName<span style=color:#719e07>.</span>equals<span style=color:#719e07>(</span>method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
                                    Class<span style=color:#719e07>&lt;?&gt;[]</span> argtypes <span style=color:#719e07>=</span> methods<span style=color:#719e07>[</span>i<span style=color:#719e07>].</span>getParameterTypes<span style=color:#719e07>();</span>
                                    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>argument<span style=color:#719e07>.</span>getIndex<span style=color:#719e07>()</span> <span style=color:#719e07>!=</span> <span style=color:#719e07>-</span>1<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                                        <span style=color:#586e75>// 检测 ArgumentConfig 中的 type 属性与方法参数列表
</span><span style=color:#586e75></span>                                        <span style=color:#586e75>// 中的参数名称是否一致，不一致则抛出异常(分支2 ⭐️)
</span><span style=color:#586e75></span>                                        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>argtypes<span style=color:#719e07>[</span>argument<span style=color:#719e07>.</span>getIndex<span style=color:#719e07>()].</span>getName<span style=color:#719e07>().</span>equals<span style=color:#719e07>(</span>argument<span style=color:#719e07>.</span>getType<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
                                            <span style=color:#586e75>// 添加 ArgumentConfig 字段信息到 map 中，
</span><span style=color:#586e75></span>                                            <span style=color:#586e75>// 键前缀 = 方法名.index，比如:
</span><span style=color:#586e75></span>                                            <span style=color:#586e75>// map = {&#34;sayHello.3&#34;: true}
</span><span style=color:#586e75></span>                                            appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> argument<span style=color:#719e07>,</span> method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.&#34;</span> <span style=color:#719e07>+</span> argument<span style=color:#719e07>.</span>getIndex<span style=color:#719e07>());</span>
                                        <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
                                            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;argument config error: ...&#34;</span><span style=color:#719e07>);</span>
                                        <span style=color:#719e07>}</span>
                                    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>    <span style=color:#586e75>// 分支3 ⭐️
</span><span style=color:#586e75></span>                                        <span style=color:#719e07>for</span> <span style=color:#719e07>(</span><span style=color:#dc322f>int</span> j <span style=color:#719e07>=</span> 0<span style=color:#719e07>;</span> j <span style=color:#719e07>&lt;</span> argtypes<span style=color:#719e07>.</span>length<span style=color:#719e07>;</span> j<span style=color:#719e07>++)</span> <span style=color:#719e07>{</span>
                                            Class<span style=color:#719e07>&lt;?&gt;</span> argclazz <span style=color:#719e07>=</span> argtypes<span style=color:#719e07>[</span>j<span style=color:#719e07>];</span>
                                            <span style=color:#586e75>// 从参数类型列表中查找类型名称为 argument.type 的参数
</span><span style=color:#586e75></span>                                            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>argclazz<span style=color:#719e07>.</span>getName<span style=color:#719e07>().</span>equals<span style=color:#719e07>(</span>argument<span style=color:#719e07>.</span>getType<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
                                                appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> argument<span style=color:#719e07>,</span> method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.&#34;</span> <span style=color:#719e07>+</span> j<span style=color:#719e07>);</span>
                                                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>argument<span style=color:#719e07>.</span>getIndex<span style=color:#719e07>()</span> <span style=color:#719e07>!=</span> <span style=color:#719e07>-</span>1 <span style=color:#719e07>&amp;&amp;</span> argument<span style=color:#719e07>.</span>getIndex<span style=color:#719e07>()</span> <span style=color:#719e07>!=</span> j<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                                                    <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;argument config error: ...&#34;</span><span style=color:#719e07>);</span>
                                                <span style=color:#719e07>}</span>
                                            <span style=color:#719e07>}</span>
                                        <span style=color:#719e07>}</span>
                                    <span style=color:#719e07>}</span>
                                <span style=color:#719e07>}</span>
                            <span style=color:#719e07>}</span>
                        <span style=color:#719e07>}</span>

                    <span style=color:#586e75>// 用户未配置 type 属性，但配置了 index 属性，且 index != -1
</span><span style=color:#586e75></span>                    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>argument<span style=color:#719e07>.</span>getIndex<span style=color:#719e07>()</span> <span style=color:#719e07>!=</span> <span style=color:#719e07>-</span>1<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>    <span style=color:#586e75>// 分支4 ⭐️
</span><span style=color:#586e75></span>                        <span style=color:#586e75>// 添加 ArgumentConfig 字段信息到 map 中
</span><span style=color:#586e75></span>                        appendParameters<span style=color:#719e07>(</span>map<span style=color:#719e07>,</span> argument<span style=color:#719e07>,</span> method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.&#34;</span> <span style=color:#719e07>+</span> argument<span style=color:#719e07>.</span>getIndex<span style=color:#719e07>());</span>
                    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
                        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;argument config must set index or type&#34;</span><span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// ...
</span><span style=color:#586e75></span><span style=color:#719e07>}</span>
</code></pre></div><p>上面这段代码 for 循环和 if else 分支嵌套太多，导致层次太深，不利于阅读，需要耐心看一下。大家在看这段代码时，注意把几个重要的条件分支找出来。只要理解了这几个分支的意图，就可以弄懂这段代码。请注意上面代码中⭐️符号，这几个符号标识出了4个重要的分支，下面用伪代码解释一下这几个分支的含义。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#586e75>// 获取 ArgumentConfig 列表
</span><span style=color:#586e75></span><span style=color:#719e07>for</span> <span style=color:#719e07>(</span>遍历 ArgumentConfig 列表<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>type 不为 <span style=color:#cb4b16>null</span>，也不为空串<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>    <span style=color:#586e75>// 分支1
</span><span style=color:#586e75></span>        1<span style=color:#719e07>.</span> 通过反射获取 interfaceClass 的方法列表
        <span style=color:#268bd2>for</span> <span style=color:#719e07>(</span>遍历方法列表<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            1<span style=color:#719e07>.</span> 比对方法名，查找目标方法
        	2<span style=color:#719e07>.</span> 通过反射获取目标方法的参数类型数组 argtypes
            <span style=color:#268bd2>if</span> <span style=color:#719e07>(</span>index <span style=color:#719e07>!=</span> <span style=color:#719e07>-</span>1<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>    <span style=color:#586e75>// 分支2
</span><span style=color:#586e75></span>                1<span style=color:#719e07>.</span> 从 argtypes 数组中获取下标 index 处的元素 argType
                2<span style=color:#719e07>.</span> 检测 argType 的名称与 ArgumentConfig 中的 type 属性是否一致
                3<span style=color:#719e07>.</span> 添加 ArgumentConfig 字段信息到 map 中，或抛出异常
            <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>    <span style=color:#586e75>// 分支3
</span><span style=color:#586e75></span>                1<span style=color:#719e07>.</span> 遍历参数类型数组 argtypes，查找 argument<span style=color:#719e07>.</span>type 类型的参数
                2<span style=color:#719e07>.</span> 添加 ArgumentConfig 字段信息到 map 中
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>index <span style=color:#719e07>!=</span> <span style=color:#719e07>-</span>1<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>    <span style=color:#586e75>// 分支4
</span><span style=color:#586e75></span>		1<span style=color:#719e07>.</span> 添加 ArgumentConfig 字段信息到 map 中
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>在本节分析的源码中，appendParameters 这个方法出现的次数比较多，该方法用于将对象字段信息添加到 map 中。实现上则是通过反射获取目标对象的 getter 方法，并调用该方法获取属性值。然后再通过 getter 方法名解析出属性名，比如从方法名 getName 中可解析出属性 name。如果用户传入了属性名前缀，此时需要将属性名加入前缀内容。最后将 &lt;属性名，属性值> 键值对存入到 map 中就行了。限于篇幅原因，这里就不分析 appendParameters 方法的源码了，大家请自行分析。</p>
<h3 id=22-导出-dubbo-服务>2.2 导出 Dubbo 服务</h3>
<p>前置工作做完，接下来就可以进行服务导出了。服务导出分为导出到本地 (JVM)，和导出到远程。在深入分析服务导出的源码前，我们先来从宏观层面上看一下服务导出逻辑。如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doExportUrlsFor1Protocol</span><span style=color:#719e07>(</span>ProtocolConfig protocolConfig<span style=color:#719e07>,</span> List<span style=color:#719e07>&lt;</span>URL<span style=color:#719e07>&gt;</span> registryURLs<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    
    <span style=color:#586e75>// 省略无关代码
</span><span style=color:#586e75></span>    
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>ConfiguratorFactory<span style=color:#719e07>.</span>class<span style=color:#719e07>)</span>
            <span style=color:#719e07>.</span>hasExtension<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 加载 ConfiguratorFactory，并生成 Configurator 实例，然后通过实例配置 url
</span><span style=color:#586e75></span>        url <span style=color:#719e07>=</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>ConfiguratorFactory<span style=color:#719e07>.</span>class<span style=color:#719e07>)</span>
                <span style=color:#719e07>.</span>getExtension<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>()).</span>getConfigurator<span style=color:#719e07>(</span>url<span style=color:#719e07>).</span>configure<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    String scope <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>SCOPE_KEY<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 如果 scope = none，则什么都不做
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>Constants<span style=color:#719e07>.</span>SCOPE_NONE<span style=color:#719e07>.</span>toString<span style=color:#719e07>().</span>equalsIgnoreCase<span style=color:#719e07>(</span>scope<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// scope != remote，导出到本地
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>Constants<span style=color:#719e07>.</span>SCOPE_REMOTE<span style=color:#719e07>.</span>toString<span style=color:#719e07>().</span>equalsIgnoreCase<span style=color:#719e07>(</span>scope<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            exportLocal<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>

        <span style=color:#586e75>// scope != local，导出到远程
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>Constants<span style=color:#719e07>.</span>SCOPE_LOCAL<span style=color:#719e07>.</span>toString<span style=color:#719e07>().</span>equalsIgnoreCase<span style=color:#719e07>(</span>scope<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>registryURLs <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>registryURLs<span style=color:#719e07>.</span>isEmpty<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
                <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>URL registryURL <span style=color:#719e07>:</span> registryURLs<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>addParameterIfAbsent<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>DYNAMIC_KEY<span style=color:#719e07>,</span> registryURL<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>DYNAMIC_KEY<span style=color:#719e07>));</span>
                    <span style=color:#586e75>// 加载监视器链接
</span><span style=color:#586e75></span>                    URL monitorUrl <span style=color:#719e07>=</span> loadMonitor<span style=color:#719e07>(</span>registryURL<span style=color:#719e07>);</span>
                    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>monitorUrl <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                        <span style=color:#586e75>// 将监视器链接作为参数添加到 url 中
</span><span style=color:#586e75></span>                        url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>addParameterAndEncoded<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>MONITOR_KEY<span style=color:#719e07>,</span> monitorUrl<span style=color:#719e07>.</span>toFullString<span style=color:#719e07>());</span>
                    <span style=color:#719e07>}</span>

                    String proxy <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>PROXY_KEY<span style=color:#719e07>);</span>
                    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>StringUtils<span style=color:#719e07>.</span>isNotEmpty<span style=color:#719e07>(</span>proxy<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                        registryURL <span style=color:#719e07>=</span> registryURL<span style=color:#719e07>.</span>addParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>PROXY_KEY<span style=color:#719e07>,</span> proxy<span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span>

                    <span style=color:#586e75>// 为服务提供类(ref)生成 Invoker
</span><span style=color:#586e75></span>                    Invoker<span style=color:#719e07>&lt;?&gt;</span> invoker <span style=color:#719e07>=</span> proxyFactory<span style=color:#719e07>.</span>getInvoker<span style=color:#719e07>(</span>ref<span style=color:#719e07>,</span> <span style=color:#719e07>(</span>Class<span style=color:#719e07>)</span> interfaceClass<span style=color:#719e07>,</span> registryURL<span style=color:#719e07>.</span>addParameterAndEncoded<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>EXPORT_KEY<span style=color:#719e07>,</span> url<span style=color:#719e07>.</span>toFullString<span style=color:#719e07>()));</span>
                    <span style=color:#586e75>// DelegateProviderMetaDataInvoker 用于持有 Invoker 和 ServiceConfig
</span><span style=color:#586e75></span>                    DelegateProviderMetaDataInvoker wrapperInvoker <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> DelegateProviderMetaDataInvoker<span style=color:#719e07>(</span>invoker<span style=color:#719e07>,</span> <span style=color:#719e07>this</span><span style=color:#719e07>);</span>

                    <span style=color:#586e75>// 导出服务，并生成 Exporter
</span><span style=color:#586e75></span>                    Exporter<span style=color:#719e07>&lt;?&gt;</span> exporter <span style=color:#719e07>=</span> protocol<span style=color:#719e07>.</span>export<span style=color:#719e07>(</span>wrapperInvoker<span style=color:#719e07>);</span>
                    exporters<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>exporter<span style=color:#719e07>);</span>
                <span style=color:#719e07>}</span>
                
            <span style=color:#586e75>// 不存在注册中心，仅导出服务
</span><span style=color:#586e75></span>            <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
                Invoker<span style=color:#719e07>&lt;?&gt;</span> invoker <span style=color:#719e07>=</span> proxyFactory<span style=color:#719e07>.</span>getInvoker<span style=color:#719e07>(</span>ref<span style=color:#719e07>,</span> <span style=color:#719e07>(</span>Class<span style=color:#719e07>)</span> interfaceClass<span style=color:#719e07>,</span> url<span style=color:#719e07>);</span>
                DelegateProviderMetaDataInvoker wrapperInvoker <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> DelegateProviderMetaDataInvoker<span style=color:#719e07>(</span>invoker<span style=color:#719e07>,</span> <span style=color:#719e07>this</span><span style=color:#719e07>);</span>

                Exporter<span style=color:#719e07>&lt;?&gt;</span> exporter <span style=color:#719e07>=</span> protocol<span style=color:#719e07>.</span>export<span style=color:#719e07>(</span>wrapperInvoker<span style=color:#719e07>);</span>
                exporters<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>exporter<span style=color:#719e07>);</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>this</span><span style=color:#719e07>.</span>urls<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>上面代码根据 url 中的 scope 参数决定服务导出方式，分别如下：</p>
<ul>
<li>scope = none，不导出服务</li>
<li>scope != remote，导出到本地</li>
<li>scope != local，导出到远程</li>
</ul>
<p>不管是导出到本地，还是远程。进行服务导出之前，均需要先创建 Invoker，这是一个很重要的步骤。因此下面先来分析 Invoker 的创建过程。</p>
<h3 id=221-invoker-创建过程>2.2.1 Invoker 创建过程</h3>
<p>在 Dubbo 中，Invoker 是一个非常重要的模型。在服务提供端，以及服务引用端均会出现 Invoker。Dubbo 官方文档中对 Invoker 进行了说明，这里引用一下。</p>
<blockquote>
<p>Invoker 是实体域，它是 Dubbo 的核心模型，其它模型都向它靠扰，或转换成它，它代表一个可执行体，可向它发起 invoke 调用，它有可能是一个本地的实现，也可能是一个远程的实现，也可能一个集群实现。</p>
</blockquote>
<p>既然 Invoker 如此重要，那么我们很有必要搞清楚 Invoker 的用途。Invoker 是由 ProxyFactory 创建而来，Dubbo 默认的 ProxyFactory 实现类是 JavassistProxyFactory。下面我们到 JavassistProxyFactory 代码中，探索 Invoker 的创建过程。如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>getInvoker</span><span style=color:#719e07>(</span>T proxy<span style=color:#719e07>,</span> Class<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> type<span style=color:#719e07>,</span> URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
	<span style=color:#586e75>// 为目标类创建 Wrapper
</span><span style=color:#586e75></span>    <span style=color:#268bd2>final</span> Wrapper wrapper <span style=color:#719e07>=</span> Wrapper<span style=color:#719e07>.</span>getWrapper<span style=color:#719e07>(</span>proxy<span style=color:#719e07>.</span>getClass<span style=color:#719e07>().</span>getName<span style=color:#719e07>().</span>indexOf<span style=color:#719e07>(</span><span style=color:#2aa198>&#39;$&#39;</span><span style=color:#719e07>)</span> <span style=color:#719e07>&lt;</span> 0 <span style=color:#719e07>?</span> proxy<span style=color:#719e07>.</span>getClass<span style=color:#719e07>()</span> <span style=color:#719e07>:</span> type<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 创建匿名 Invoker 类对象，并实现 doInvoke 方法。
</span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> <span style=color:#719e07>new</span> AbstractProxyInvoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;(</span>proxy<span style=color:#719e07>,</span> type<span style=color:#719e07>,</span> url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>@Override</span>
        <span style=color:#268bd2>protected</span> Object <span style=color:#268bd2>doInvoke</span><span style=color:#719e07>(</span>T proxy<span style=color:#719e07>,</span> String methodName<span style=color:#719e07>,</span>
                                  Class<span style=color:#719e07>&lt;?&gt;[]</span> parameterTypes<span style=color:#719e07>,</span>
                                  Object<span style=color:#719e07>[]</span> arguments<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> Throwable <span style=color:#719e07>{</span>
			<span style=color:#586e75>// 调用 Wrapper 的 invokeMethod 方法，invokeMethod 最终会调用目标方法
</span><span style=color:#586e75></span>            <span style=color:#719e07>return</span> wrapper<span style=color:#719e07>.</span>invokeMethod<span style=color:#719e07>(</span>proxy<span style=color:#719e07>,</span> methodName<span style=color:#719e07>,</span> parameterTypes<span style=color:#719e07>,</span> arguments<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>};</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>如上，JavassistProxyFactory 创建了一个继承自 AbstractProxyInvoker 类的匿名对象，并覆写了抽象方法 doInvoke。覆写后的 doInvoke 逻辑比较简单，仅是将调用请求转发给了 Wrapper 类的 invokeMethod 方法。Wrapper 用于“包裹”目标类，Wrapper 是一个抽象类，仅可通过 getWrapper(Class) 方法创建子类。在创建 Wrapper 子类的过程中，子类代码生成逻辑会对 getWrapper 方法传入的 Class 对象进行解析，拿到诸如类方法，类成员变量等信息。以及生成 invokeMethod 方法代码和其他一些方法代码。代码生成完毕后，通过 Javassist 生成 Class 对象，最后再通过反射创建 Wrapper 实例。相关的代码如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> <span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> Wrapper <span style=color:#268bd2>getWrapper</span><span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;?&gt;</span> c<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>	
    <span style=color:#719e07>while</span> <span style=color:#719e07>(</span>ClassGenerator<span style=color:#719e07>.</span>isDynamicClass<span style=color:#719e07>(</span>c<span style=color:#719e07>))</span>
        c <span style=color:#719e07>=</span> c<span style=color:#719e07>.</span>getSuperclass<span style=color:#719e07>();</span>

    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>c <span style=color:#719e07>==</span> Object<span style=color:#719e07>.</span>class<span style=color:#719e07>)</span>
        <span style=color:#719e07>return</span> OBJECT_WRAPPER<span style=color:#719e07>;</span>

    <span style=color:#586e75>// 从缓存中获取 Wrapper 实例
</span><span style=color:#586e75></span>    Wrapper ret <span style=color:#719e07>=</span> WRAPPER_MAP<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>c<span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ret <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 缓存未命中，创建 Wrapper
</span><span style=color:#586e75></span>        ret <span style=color:#719e07>=</span> makeWrapper<span style=color:#719e07>(</span>c<span style=color:#719e07>);</span>
        <span style=color:#586e75>// 写入缓存
</span><span style=color:#586e75></span>        WRAPPER_MAP<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>c<span style=color:#719e07>,</span> ret<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>return</span> ret<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>getWrapper 方法仅包含一些缓存操作逻辑，不难理解。下面我们看一下 makeWrapper 方法。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#268bd2>static</span> Wrapper <span style=color:#268bd2>makeWrapper</span><span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;?&gt;</span> c<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 检测 c 是否为基本类型，若是则抛出异常
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>c<span style=color:#719e07>.</span>isPrimitive<span style=color:#719e07>())</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Can not create wrapper for primitive type: &#34;</span> <span style=color:#719e07>+</span> c<span style=color:#719e07>);</span>

    String name <span style=color:#719e07>=</span> c<span style=color:#719e07>.</span>getName<span style=color:#719e07>();</span>
    ClassLoader cl <span style=color:#719e07>=</span> ClassHelper<span style=color:#719e07>.</span>getClassLoader<span style=color:#719e07>(</span>c<span style=color:#719e07>);</span>

    <span style=color:#586e75>// c1 用于存储 setPropertyValue 方法代码
</span><span style=color:#586e75></span>    StringBuilder c1 <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> StringBuilder<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public void setPropertyValue(Object o, String n, Object v){ &#34;</span><span style=color:#719e07>);</span>
    <span style=color:#586e75>// c2 用于存储 getPropertyValue 方法代码
</span><span style=color:#586e75></span>    StringBuilder c2 <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> StringBuilder<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public Object getPropertyValue(Object o, String n){ &#34;</span><span style=color:#719e07>);</span>
    <span style=color:#586e75>// c3 用于存储 invokeMethod 方法代码
</span><span style=color:#586e75></span>    StringBuilder c3 <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> StringBuilder<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public Object invokeMethod(Object o, String n, Class[] p, Object[] v) throws &#34;</span> <span style=color:#719e07>+</span> InvocationTargetException<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;{ &#34;</span><span style=color:#719e07>);</span>

    <span style=color:#586e75>// 生成类型转换代码及异常捕捉代码，比如：
</span><span style=color:#586e75></span>    <span style=color:#586e75>//   DemoService w; try { w = ((DemoServcie) $1); }}catch(Throwable e){ throw new IllegalArgumentException(e); }
</span><span style=color:#586e75></span>    c1<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span>name<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; w; try{ w = ((&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>name<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;)$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }&#34;</span><span style=color:#719e07>);</span>
    c2<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span>name<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; w; try{ w = ((&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>name<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;)$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }&#34;</span><span style=color:#719e07>);</span>
    c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span>name<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; w; try{ w = ((&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>name<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;)$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }&#34;</span><span style=color:#719e07>);</span>

    <span style=color:#586e75>// pts 用于存储成员变量名和类型
</span><span style=color:#586e75></span>    Map<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Class<span style=color:#719e07>&lt;?&gt;&gt;</span> pts <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> HashMap<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Class<span style=color:#719e07>&lt;?&gt;&gt;();</span>
    <span style=color:#586e75>// ms 用于存储方法描述信息（可理解为方法签名）及 Method 实例
</span><span style=color:#586e75></span>    Map<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Method<span style=color:#719e07>&gt;</span> ms <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> LinkedHashMap<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Method<span style=color:#719e07>&gt;();</span>
    <span style=color:#586e75>// mns 为方法名列表
</span><span style=color:#586e75></span>    List<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> mns <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ArrayList<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;();</span>
    <span style=color:#586e75>// dmns 用于存储“定义在当前类中的方法”的名称
</span><span style=color:#586e75></span>    List<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> dmns <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ArrayList<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;();</span>

    <span style=color:#586e75>// --------------------------------✨ 分割线1 ✨-------------------------------------
</span><span style=color:#586e75></span>
    <span style=color:#586e75>// 获取 public 访问级别的字段，并为所有字段生成条件判断语句
</span><span style=color:#586e75></span>    <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>Field f <span style=color:#719e07>:</span> c<span style=color:#719e07>.</span>getFields<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
        String fn <span style=color:#719e07>=</span> f<span style=color:#719e07>.</span>getName<span style=color:#719e07>();</span>
        Class<span style=color:#719e07>&lt;?&gt;</span> ft <span style=color:#719e07>=</span> f<span style=color:#719e07>.</span>getType<span style=color:#719e07>();</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>Modifier<span style=color:#719e07>.</span>isStatic<span style=color:#719e07>(</span>f<span style=color:#719e07>.</span>getModifiers<span style=color:#719e07>())</span> <span style=color:#719e07>||</span> Modifier<span style=color:#719e07>.</span>isTransient<span style=color:#719e07>(</span>f<span style=color:#719e07>.</span>getModifiers<span style=color:#719e07>()))</span>
            <span style=color:#586e75>// 忽略关键字 static 或 transient 修饰的变量
</span><span style=color:#586e75></span>            <span style=color:#719e07>continue</span><span style=color:#719e07>;</span>

        <span style=color:#586e75>// 生成条件判断及赋值语句，比如：
</span><span style=color:#586e75></span>        <span style=color:#586e75>// if( $2.equals(&#34;name&#34;) ) { w.name = (java.lang.String) $3; return;}
</span><span style=color:#586e75></span>        <span style=color:#586e75>// if( $2.equals(&#34;age&#34;) ) { w.age = ((Number) $3).intValue(); return;}
</span><span style=color:#586e75></span>        c1<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; if( $2.equals(\&#34;&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>fn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;\&#34;) ){ w.&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>fn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;=&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>arg<span style=color:#719e07>(</span>ft<span style=color:#719e07>,</span> <span style=color:#2aa198>&#34;$3&#34;</span><span style=color:#719e07>)).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;; return; }&#34;</span><span style=color:#719e07>);</span>

        <span style=color:#586e75>// 生成条件判断及返回语句，比如：
</span><span style=color:#586e75></span>        <span style=color:#586e75>// if( $2.equals(&#34;name&#34;) ) { return ($w)w.name; }
</span><span style=color:#586e75></span>        c2<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; if( $2.equals(\&#34;&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>fn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;\&#34;) ){ return ($w)w.&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>fn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;; }&#34;</span><span style=color:#719e07>);</span>

        <span style=color:#586e75>// 存储 &lt;字段名, 字段类型&gt; 键值对到 pts 中
</span><span style=color:#586e75></span>        pts<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>fn<span style=color:#719e07>,</span> ft<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// --------------------------------✨ 分割线2 ✨-------------------------------------
</span><span style=color:#586e75></span>
    Method<span style=color:#719e07>[]</span> methods <span style=color:#719e07>=</span> c<span style=color:#719e07>.</span>getMethods<span style=color:#719e07>();</span>
    <span style=color:#586e75>// 检测 c 中是否包含在当前类中声明的方法
</span><span style=color:#586e75></span>    <span style=color:#dc322f>boolean</span> hasMethod <span style=color:#719e07>=</span> hasMethods<span style=color:#719e07>(</span>methods<span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>hasMethod<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; try{&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>Method m <span style=color:#719e07>:</span> methods<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>m<span style=color:#719e07>.</span>getDeclaringClass<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> Object<span style=color:#719e07>.</span>class<span style=color:#719e07>)</span>
            <span style=color:#586e75>// 忽略 Object 中定义的方法
</span><span style=color:#586e75></span>            <span style=color:#719e07>continue</span><span style=color:#719e07>;</span>

        String mn <span style=color:#719e07>=</span> m<span style=color:#719e07>.</span>getName<span style=color:#719e07>();</span>
        <span style=color:#586e75>// 生成方法名判断语句，比如：
</span><span style=color:#586e75></span>        <span style=color:#586e75>// if ( &#34;sayHello&#34;.equals( $2 )
</span><span style=color:#586e75></span>        c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; if( \&#34;&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>mn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;\&#34;.equals( $2 ) &#34;</span><span style=color:#719e07>);</span>
        <span style=color:#dc322f>int</span> len <span style=color:#719e07>=</span> m<span style=color:#719e07>.</span>getParameterTypes<span style=color:#719e07>().</span>length<span style=color:#719e07>;</span>
        <span style=color:#586e75>// 生成“运行时传入的参数数量与方法参数列表长度”判断语句，比如：
</span><span style=color:#586e75></span>        <span style=color:#586e75>// &amp;&amp; $3.length == 2
</span><span style=color:#586e75></span>        c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; &amp;&amp; &#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; $3.length == &#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>len<span style=color:#719e07>);</span>

        <span style=color:#dc322f>boolean</span> override <span style=color:#719e07>=</span> <span style=color:#cb4b16>false</span><span style=color:#719e07>;</span>
        <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>Method m2 <span style=color:#719e07>:</span> methods<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 检测方法是否存在重载情况，条件为：方法对象不同 &amp;&amp; 方法名相同
</span><span style=color:#586e75></span>            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>m <span style=color:#719e07>!=</span> m2 <span style=color:#719e07>&amp;&amp;</span> m<span style=color:#719e07>.</span>getName<span style=color:#719e07>().</span>equals<span style=color:#719e07>(</span>m2<span style=color:#719e07>.</span>getName<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
                override <span style=color:#719e07>=</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>;</span>
                <span style=color:#719e07>break</span><span style=color:#719e07>;</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
        <span style=color:#586e75>// 对重载方法进行处理，考虑下面的方法：
</span><span style=color:#586e75></span>        <span style=color:#586e75>//    1. void sayHello(Integer, String)
</span><span style=color:#586e75></span>        <span style=color:#586e75>//    2. void sayHello(Integer, Integer)
</span><span style=color:#586e75></span>        <span style=color:#586e75>// 方法名相同，参数列表长度也相同，因此不能仅通过这两项判断两个方法是否相等。
</span><span style=color:#586e75></span>        <span style=color:#586e75>// 需要进一步判断方法的参数类型
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>override<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>len <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                <span style=color:#719e07>for</span> <span style=color:#719e07>(</span><span style=color:#dc322f>int</span> l <span style=color:#719e07>=</span> 0<span style=color:#719e07>;</span> l <span style=color:#719e07>&lt;</span> len<span style=color:#719e07>;</span> l<span style=color:#719e07>++)</span> <span style=color:#719e07>{</span>
                    <span style=color:#586e75>// 生成参数类型进行检测代码，比如：
</span><span style=color:#586e75></span>                    <span style=color:#586e75>// &amp;&amp; $3[0].getName().equals(&#34;java.lang.Integer&#34;) 
</span><span style=color:#586e75></span>                    <span style=color:#586e75>//    &amp;&amp; $3[1].getName().equals(&#34;java.lang.String&#34;)
</span><span style=color:#586e75></span>                    c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; &amp;&amp; &#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; $3[&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>l<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;].getName().equals(\&#34;&#34;</span><span style=color:#719e07>)</span>
                            <span style=color:#719e07>.</span>append<span style=color:#719e07>(</span>m<span style=color:#719e07>.</span>getParameterTypes<span style=color:#719e07>()[</span>l<span style=color:#719e07>].</span>getName<span style=color:#719e07>()).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;\&#34;)&#34;</span><span style=color:#719e07>);</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>

        <span style=color:#586e75>// 添加 ) {，完成方法判断语句，此时生成的代码可能如下（已格式化）：
</span><span style=color:#586e75></span>        <span style=color:#586e75>// if (&#34;sayHello&#34;.equals($2) 
</span><span style=color:#586e75></span>        <span style=color:#586e75>//     &amp;&amp; $3.length == 2
</span><span style=color:#586e75></span>        <span style=color:#586e75>//     &amp;&amp; $3[0].getName().equals(&#34;java.lang.Integer&#34;) 
</span><span style=color:#586e75></span>        <span style=color:#586e75>//     &amp;&amp; $3[1].getName().equals(&#34;java.lang.String&#34;)) {
</span><span style=color:#586e75></span>        c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; ) { &#34;</span><span style=color:#719e07>);</span>

        <span style=color:#586e75>// 根据返回值类型生成目标方法调用语句
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>m<span style=color:#719e07>.</span>getReturnType<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> Void<span style=color:#719e07>.</span>TYPE<span style=color:#719e07>)</span>
            <span style=color:#586e75>// w.sayHello((java.lang.Integer)$4[0], (java.lang.String)$4[1]); return null;
</span><span style=color:#586e75></span>            c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; w.&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>mn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#39;(&#39;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>args<span style=color:#719e07>(</span>m<span style=color:#719e07>.</span>getParameterTypes<span style=color:#719e07>(),</span> <span style=color:#2aa198>&#34;$4&#34;</span><span style=color:#719e07>)).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;);&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; return null;&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>else</span>
            <span style=color:#586e75>// return w.sayHello((java.lang.Integer)$4[0], (java.lang.String)$4[1]);
</span><span style=color:#586e75></span>            c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; return ($w)w.&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>mn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#39;(&#39;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>args<span style=color:#719e07>(</span>m<span style=color:#719e07>.</span>getParameterTypes<span style=color:#719e07>(),</span> <span style=color:#2aa198>&#34;$4&#34;</span><span style=color:#719e07>)).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;);&#34;</span><span style=color:#719e07>);</span>

        <span style=color:#586e75>// 添加 }, 生成的代码形如（已格式化）：
</span><span style=color:#586e75></span>        <span style=color:#586e75>// if (&#34;sayHello&#34;.equals($2) 
</span><span style=color:#586e75></span>        <span style=color:#586e75>//     &amp;&amp; $3.length == 2
</span><span style=color:#586e75></span>        <span style=color:#586e75>//     &amp;&amp; $3[0].getName().equals(&#34;java.lang.Integer&#34;) 
</span><span style=color:#586e75></span>        <span style=color:#586e75>//     &amp;&amp; $3[1].getName().equals(&#34;java.lang.String&#34;)) {
</span><span style=color:#586e75></span>        <span style=color:#586e75>//
</span><span style=color:#586e75></span>        <span style=color:#586e75>//     w.sayHello((java.lang.Integer)$4[0], (java.lang.String)$4[1]); 
</span><span style=color:#586e75></span>        <span style=color:#586e75>//     return null;
</span><span style=color:#586e75></span>        <span style=color:#586e75>// }
</span><span style=color:#586e75></span>        c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; }&#34;</span><span style=color:#719e07>);</span>

        <span style=color:#586e75>// 添加方法名到 mns 集合中
</span><span style=color:#586e75></span>        mns<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>mn<span style=color:#719e07>);</span>
        <span style=color:#586e75>// 检测当前方法是否在 c 中被声明的
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>m<span style=color:#719e07>.</span>getDeclaringClass<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> c<span style=color:#719e07>)</span>
            <span style=color:#586e75>// 若是，则将当前方法名添加到 dmns 中
</span><span style=color:#586e75></span>            dmns<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>mn<span style=color:#719e07>);</span>
        ms<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>ReflectUtils<span style=color:#719e07>.</span>getDesc<span style=color:#719e07>(</span>m<span style=color:#719e07>),</span> m<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>hasMethod<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 添加异常捕捉语句
</span><span style=color:#586e75></span>        c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; } catch(Throwable e) { &#34;</span><span style=color:#719e07>);</span>
        c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;     throw new java.lang.reflect.InvocationTargetException(e); &#34;</span><span style=color:#719e07>);</span>
        c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; }&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 添加 NoSuchMethodException 异常抛出代码
</span><span style=color:#586e75></span>    c3<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; throw new &#34;</span> <span style=color:#719e07>+</span> NoSuchMethodException<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;(\&#34;Not found method \\\&#34;\&#34;+$2+\&#34;\\\&#34; in class &#34;</span> <span style=color:#719e07>+</span> c<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.\&#34;); }&#34;</span><span style=color:#719e07>);</span>

    <span style=color:#586e75>// --------------------------------✨ 分割线3 ✨-------------------------------------
</span><span style=color:#586e75></span>
    Matcher matcher<span style=color:#719e07>;</span>
    <span style=color:#586e75>// 处理 get/set 方法
</span><span style=color:#586e75></span>    <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>Map<span style=color:#719e07>.</span>Entry<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Method<span style=color:#719e07>&gt;</span> entry <span style=color:#719e07>:</span> ms<span style=color:#719e07>.</span>entrySet<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
        String md <span style=color:#719e07>=</span> entry<span style=color:#719e07>.</span>getKey<span style=color:#719e07>();</span>
        Method method <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>Method<span style=color:#719e07>)</span> entry<span style=color:#719e07>.</span>getValue<span style=color:#719e07>();</span>
        <span style=color:#586e75>// 匹配以 get 开头的方法
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>((</span>matcher <span style=color:#719e07>=</span> ReflectUtils<span style=color:#719e07>.</span>GETTER_METHOD_DESC_PATTERN<span style=color:#719e07>.</span>matcher<span style=color:#719e07>(</span>md<span style=color:#719e07>)).</span>matches<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 获取属性名
</span><span style=color:#586e75></span>            String pn <span style=color:#719e07>=</span> propertyName<span style=color:#719e07>(</span>matcher<span style=color:#719e07>.</span>group<span style=color:#719e07>(</span>1<span style=color:#719e07>));</span>
            <span style=color:#586e75>// 生成属性判断以及返回语句，示例如下：
</span><span style=color:#586e75></span>            <span style=color:#586e75>// if( $2.equals(&#34;name&#34;) ) { return ($w).w.getName(); }
</span><span style=color:#586e75></span>            c2<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; if( $2.equals(\&#34;&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>pn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;\&#34;) ){ return ($w)w.&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;(); }&#34;</span><span style=color:#719e07>);</span>
            pts<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>pn<span style=color:#719e07>,</span> method<span style=color:#719e07>.</span>getReturnType<span style=color:#719e07>());</span>

        <span style=color:#586e75>// 匹配以 is/has/can 开头的方法
</span><span style=color:#586e75></span>        <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> <span style=color:#719e07>((</span>matcher <span style=color:#719e07>=</span> ReflectUtils<span style=color:#719e07>.</span>IS_HAS_CAN_METHOD_DESC_PATTERN<span style=color:#719e07>.</span>matcher<span style=color:#719e07>(</span>md<span style=color:#719e07>)).</span>matches<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
            String pn <span style=color:#719e07>=</span> propertyName<span style=color:#719e07>(</span>matcher<span style=color:#719e07>.</span>group<span style=color:#719e07>(</span>1<span style=color:#719e07>));</span>
            <span style=color:#586e75>// 生成属性判断以及返回语句，示例如下：
</span><span style=color:#586e75></span>            <span style=color:#586e75>// if( $2.equals(&#34;dream&#34;) ) { return ($w).w.hasDream(); }
</span><span style=color:#586e75></span>            c2<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; if( $2.equals(\&#34;&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>pn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;\&#34;) ){ return ($w)w.&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;(); }&#34;</span><span style=color:#719e07>);</span>
            pts<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>pn<span style=color:#719e07>,</span> method<span style=color:#719e07>.</span>getReturnType<span style=color:#719e07>());</span>

        <span style=color:#586e75>// 匹配以 set 开头的方法
</span><span style=color:#586e75></span>        <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> <span style=color:#719e07>((</span>matcher <span style=color:#719e07>=</span> ReflectUtils<span style=color:#719e07>.</span>SETTER_METHOD_DESC_PATTERN<span style=color:#719e07>.</span>matcher<span style=color:#719e07>(</span>md<span style=color:#719e07>)).</span>matches<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
            Class<span style=color:#719e07>&lt;?&gt;</span> pt <span style=color:#719e07>=</span> method<span style=color:#719e07>.</span>getParameterTypes<span style=color:#719e07>()[</span>0<span style=color:#719e07>];</span>
            String pn <span style=color:#719e07>=</span> propertyName<span style=color:#719e07>(</span>matcher<span style=color:#719e07>.</span>group<span style=color:#719e07>(</span>1<span style=color:#719e07>));</span>
            <span style=color:#586e75>// 生成属性判断以及 setter 调用语句，示例如下：
</span><span style=color:#586e75></span>            <span style=color:#586e75>// if( $2.equals(&#34;name&#34;) ) { w.setName((java.lang.String)$3); return; }
</span><span style=color:#586e75></span>            c1<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; if( $2.equals(\&#34;&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>pn<span style=color:#719e07>).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;\&#34;) ){ w.&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>method<span style=color:#719e07>.</span>getName<span style=color:#719e07>()).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;(&#34;</span><span style=color:#719e07>).</span>append<span style=color:#719e07>(</span>arg<span style=color:#719e07>(</span>pt<span style=color:#719e07>,</span> <span style=color:#2aa198>&#34;$3&#34;</span><span style=color:#719e07>)).</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;); return; }&#34;</span><span style=color:#719e07>);</span>
            pts<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>pn<span style=color:#719e07>,</span> pt<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 添加 NoSuchPropertyException 异常抛出代码
</span><span style=color:#586e75></span>    c1<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; throw new &#34;</span> <span style=color:#719e07>+</span> NoSuchPropertyException<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;(\&#34;Not found property \\\&#34;\&#34;+$2+\&#34;\\\&#34; filed or setter method in class &#34;</span> <span style=color:#719e07>+</span> c<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.\&#34;); }&#34;</span><span style=color:#719e07>);</span>
    c2<span style=color:#719e07>.</span>append<span style=color:#719e07>(</span><span style=color:#2aa198>&#34; throw new &#34;</span> <span style=color:#719e07>+</span> NoSuchPropertyException<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;(\&#34;Not found property \\\&#34;\&#34;+$2+\&#34;\\\&#34; filed or setter method in class &#34;</span> <span style=color:#719e07>+</span> c<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.\&#34;); }&#34;</span><span style=color:#719e07>);</span>

    <span style=color:#586e75>// --------------------------------✨ 分割线4 ✨-------------------------------------
</span><span style=color:#586e75></span>
    <span style=color:#dc322f>long</span> id <span style=color:#719e07>=</span> WRAPPER_CLASS_COUNTER<span style=color:#719e07>.</span>getAndIncrement<span style=color:#719e07>();</span>
    <span style=color:#586e75>// 创建类生成器
</span><span style=color:#586e75></span>    ClassGenerator cc <span style=color:#719e07>=</span> ClassGenerator<span style=color:#719e07>.</span>newInstance<span style=color:#719e07>(</span>cl<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 设置类名及超类
</span><span style=color:#586e75></span>    cc<span style=color:#719e07>.</span>setClassName<span style=color:#719e07>((</span>Modifier<span style=color:#719e07>.</span>isPublic<span style=color:#719e07>(</span>c<span style=color:#719e07>.</span>getModifiers<span style=color:#719e07>())</span> <span style=color:#719e07>?</span> Wrapper<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>:</span> c<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;$sw&#34;</span><span style=color:#719e07>)</span> <span style=color:#719e07>+</span> id<span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>setSuperClass<span style=color:#719e07>(</span>Wrapper<span style=color:#719e07>.</span>class<span style=color:#719e07>);</span>

    <span style=color:#586e75>// 添加默认构造方法
</span><span style=color:#586e75></span>    cc<span style=color:#719e07>.</span>addDefaultConstructor<span style=color:#719e07>();</span>

    <span style=color:#586e75>// 添加字段
</span><span style=color:#586e75></span>    cc<span style=color:#719e07>.</span>addField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public static String[] pns;&#34;</span><span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>addField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public static &#34;</span> <span style=color:#719e07>+</span> Map<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>()</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34; pts;&#34;</span><span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>addField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public static String[] mns;&#34;</span><span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>addField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public static String[] dmns;&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>for</span> <span style=color:#719e07>(</span><span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> 0<span style=color:#719e07>,</span> len <span style=color:#719e07>=</span> ms<span style=color:#719e07>.</span>size<span style=color:#719e07>();</span> i <span style=color:#719e07>&lt;</span> len<span style=color:#719e07>;</span> i<span style=color:#719e07>++)</span>
        cc<span style=color:#719e07>.</span>addField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public static Class[] mts&#34;</span> <span style=color:#719e07>+</span> i <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;;&#34;</span><span style=color:#719e07>);</span>

    <span style=color:#586e75>// 添加方法代码
</span><span style=color:#586e75></span>    cc<span style=color:#719e07>.</span>addMethod<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public String[] getPropertyNames(){ return pns; }&#34;</span><span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>addMethod<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public boolean hasProperty(String n){ return pts.containsKey($1); }&#34;</span><span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>addMethod<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public Class getPropertyType(String n){ return (Class)pts.get($1); }&#34;</span><span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>addMethod<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public String[] getMethodNames(){ return mns; }&#34;</span><span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>addMethod<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;public String[] getDeclaredMethodNames(){ return dmns; }&#34;</span><span style=color:#719e07>);</span>
    cc<span style=color:#719e07>.</span>addMethod<span style=color:#719e07>(</span>c1<span style=color:#719e07>.</span>toString<span style=color:#719e07>());</span>
    cc<span style=color:#719e07>.</span>addMethod<span style=color:#719e07>(</span>c2<span style=color:#719e07>.</span>toString<span style=color:#719e07>());</span>
    cc<span style=color:#719e07>.</span>addMethod<span style=color:#719e07>(</span>c3<span style=color:#719e07>.</span>toString<span style=color:#719e07>());</span>

    <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 生成类
</span><span style=color:#586e75></span>        Class<span style=color:#719e07>&lt;?&gt;</span> wc <span style=color:#719e07>=</span> cc<span style=color:#719e07>.</span>toClass<span style=color:#719e07>();</span>
        
        <span style=color:#586e75>// 设置字段值
</span><span style=color:#586e75></span>        wc<span style=color:#719e07>.</span>getField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;pts&#34;</span><span style=color:#719e07>).</span>set<span style=color:#719e07>(</span><span style=color:#cb4b16>null</span><span style=color:#719e07>,</span> pts<span style=color:#719e07>);</span>
        wc<span style=color:#719e07>.</span>getField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;pns&#34;</span><span style=color:#719e07>).</span>set<span style=color:#719e07>(</span><span style=color:#cb4b16>null</span><span style=color:#719e07>,</span> pts<span style=color:#719e07>.</span>keySet<span style=color:#719e07>().</span>toArray<span style=color:#719e07>(</span><span style=color:#719e07>new</span> String<span style=color:#719e07>[</span>0<span style=color:#719e07>]));</span>
        wc<span style=color:#719e07>.</span>getField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;mns&#34;</span><span style=color:#719e07>).</span>set<span style=color:#719e07>(</span><span style=color:#cb4b16>null</span><span style=color:#719e07>,</span> mns<span style=color:#719e07>.</span>toArray<span style=color:#719e07>(</span><span style=color:#719e07>new</span> String<span style=color:#719e07>[</span>0<span style=color:#719e07>]));</span>
        wc<span style=color:#719e07>.</span>getField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;dmns&#34;</span><span style=color:#719e07>).</span>set<span style=color:#719e07>(</span><span style=color:#cb4b16>null</span><span style=color:#719e07>,</span> dmns<span style=color:#719e07>.</span>toArray<span style=color:#719e07>(</span><span style=color:#719e07>new</span> String<span style=color:#719e07>[</span>0<span style=color:#719e07>]));</span>
        <span style=color:#dc322f>int</span> ix <span style=color:#719e07>=</span> 0<span style=color:#719e07>;</span>
        <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>Method m <span style=color:#719e07>:</span> ms<span style=color:#719e07>.</span>values<span style=color:#719e07>())</span>
            wc<span style=color:#719e07>.</span>getField<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;mts&#34;</span> <span style=color:#719e07>+</span> ix<span style=color:#719e07>++).</span>set<span style=color:#719e07>(</span><span style=color:#cb4b16>null</span><span style=color:#719e07>,</span> m<span style=color:#719e07>.</span>getParameterTypes<span style=color:#719e07>());</span>

        <span style=color:#586e75>// 创建 Wrapper 实例
</span><span style=color:#586e75></span>        <span style=color:#719e07>return</span> <span style=color:#719e07>(</span>Wrapper<span style=color:#719e07>)</span> wc<span style=color:#719e07>.</span>newInstance<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>RuntimeException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> e<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Throwable e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> RuntimeException<span style=color:#719e07>(</span>e<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> e<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>finally</span> <span style=color:#719e07>{</span>
        cc<span style=color:#719e07>.</span>release<span style=color:#719e07>();</span>
        ms<span style=color:#719e07>.</span>clear<span style=color:#719e07>();</span>
        mns<span style=color:#719e07>.</span>clear<span style=color:#719e07>();</span>
        dmns<span style=color:#719e07>.</span>clear<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>上面代码很长，大家耐心看一下。我们在上面代码中做了大量的注释，并按功能对代码进行了分块，以帮助大家理解代码逻辑。下面对这段代码进行讲解。首先我们把目光移到分割线1之上的代码，这段代码主要用于进行一些初始化操作。比如创建 c1、c2、c3 以及 pts、ms、mns 等变量，以及向 c1、c2、c3 中添加方法定义和类型转换代码。接下来是分割线1到分割线2之间的代码，这段代码用于为 public 级别的字段生成条件判断取值与赋值代码。这段代码不是很难看懂，就不多说了。继续向下看，分割线2和分隔线3之间的代码用于为定义在当前类中的方法生成判断语句，和方法调用语句。因为需要对方法重载进行校验，因此到这这段代码看起来有点复杂。不过耐心看一下，也不是很难理解。接下来是分割线3和分隔线4之间的代码，这段代码用于处理 getter、setter 以及以 is/has/can 开头的方法。处理方式是通过正则表达式获取方法类型（get/set/is/&mldr;），以及属性名。之后为属性名生成判断语句，然后为方法生成调用语句。最后我们再来看一下分隔线4以下的代码，这段代码通过 ClassGenerator 为刚刚生成的代码构建 Class 类，并通过反射创建对象。ClassGenerator 是 Dubbo 自己封装的，该类的核心是 toClass() 的重载方法 toClass(ClassLoader, ProtectionDomain)，该方法通过 javassist 构建 Class。这里就不分析 toClass 方法了，大家请自行分析。</p>
<p>阅读 Wrapper 类代码需要对 javassist 框架有所了解。关于 javassist，大家如果不熟悉，请自行查阅资料，本节不打算介绍 javassist 相关内容。</p>
<p>好了，关于 Wrapper 类生成过程就分析到这。如果大家看的不是很明白，可以单独为 Wrapper 创建单元测试，然后单步调试。并将生成的代码拷贝出来，格式化后再进行观察和理解。</p>
<h3 id=222-导出服务到本地>2.2.2 导出服务到本地</h3>
<p>本节我们来看一下服务导出相关的代码，按照代码执行顺序，本节先来分析导出服务到本地的过程。相关代码如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>exportLocal</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 如果 URL 的协议头等于 injvm，说明已经导出到本地了，无需再次导出
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>Constants<span style=color:#719e07>.</span>LOCAL_PROTOCOL<span style=color:#719e07>.</span>equalsIgnoreCase<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
        URL local <span style=color:#719e07>=</span> URL<span style=color:#719e07>.</span>valueOf<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>toFullString<span style=color:#719e07>())</span>
            <span style=color:#719e07>.</span>setProtocol<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>LOCAL_PROTOCOL<span style=color:#719e07>)</span>    <span style=color:#586e75>// 设置协议头为 injvm
</span><span style=color:#586e75></span>            <span style=color:#719e07>.</span>setHost<span style=color:#719e07>(</span>LOCALHOST<span style=color:#719e07>)</span>
            <span style=color:#719e07>.</span>setPort<span style=color:#719e07>(</span>0<span style=color:#719e07>);</span>
        ServiceClassHolder<span style=color:#719e07>.</span>getInstance<span style=color:#719e07>().</span>pushServiceClass<span style=color:#719e07>(</span>getServiceClass<span style=color:#719e07>(</span>ref<span style=color:#719e07>));</span>
        <span style=color:#586e75>// 创建 Invoker，并导出服务，这里的 protocol 会在运行时调用 InjvmProtocol 的 export 方法
</span><span style=color:#586e75></span>        Exporter<span style=color:#719e07>&lt;?&gt;</span> exporter <span style=color:#719e07>=</span> protocol<span style=color:#719e07>.</span>export<span style=color:#719e07>(</span>
            proxyFactory<span style=color:#719e07>.</span>getInvoker<span style=color:#719e07>(</span>ref<span style=color:#719e07>,</span> <span style=color:#719e07>(</span>Class<span style=color:#719e07>)</span> interfaceClass<span style=color:#719e07>,</span> local<span style=color:#719e07>));</span>
        exporters<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>exporter<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>exportLocal 方法比较简单，首先根据 URL 协议头决定是否导出服务。若需导出，则创建一个新的 URL 并将协议头、主机名以及端口设置成新的值。然后创建 Invoker，并调用 InjvmProtocol 的 export 方法导出服务。下面我们来看一下 InjvmProtocol 的 export 方法都做了哪些事情。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Exporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>export</span><span style=color:#719e07>(</span>Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> invoker<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 创建 InjvmExporter
</span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> <span style=color:#719e07>new</span> InjvmExporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;(</span>invoker<span style=color:#719e07>,</span> invoker<span style=color:#719e07>.</span>getUrl<span style=color:#719e07>().</span>getServiceKey<span style=color:#719e07>(),</span> exporterMap<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>如上，InjvmProtocol 的 export 方法仅创建了一个 InjvmExporter，无其他逻辑。到此导出服务到本地就分析完了，接下来，我们继续分析导出服务到远程的过程。</p>
<h3 id=223-导出服务到远程>2.2.3 导出服务到远程</h3>
<p>与导出服务到本地相比，导出服务到远程的过程要复杂不少，其包含了服务导出与服务注册两个过程。这两个过程涉及到了大量的调用，比较复杂。按照代码执行顺序，本节先来分析服务导出逻辑，服务注册逻辑将在下一节进行分析。下面开始分析，我们把目光移动到 RegistryProtocol 的 export 方法上。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Exporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>export</span><span style=color:#719e07>(</span><span style=color:#268bd2>final</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> originInvoker<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 导出服务
</span><span style=color:#586e75></span>    <span style=color:#268bd2>final</span> ExporterChangeableWrapper<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> exporter <span style=color:#719e07>=</span> doLocalExport<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>);</span>

    <span style=color:#586e75>// 获取注册中心 URL，以 zookeeper 注册中心为例，得到的示例 URL 如下：
</span><span style=color:#586e75></span>    <span style=color:#586e75>// zookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-provider&amp;dubbo=2.0.2&amp;export=dubbo%3A%2F%2F172.17.48.52%3A20880%2Fcom.alibaba.dubbo.demo.DemoService%3Fanyhost%3Dtrue%26application%3Ddemo-provider
</span><span style=color:#586e75></span>    URL registryUrl <span style=color:#719e07>=</span> getRegistryUrl<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>);</span>

    <span style=color:#586e75>// 根据 URL 加载 Registry 实现类，比如 ZookeeperRegistry
</span><span style=color:#586e75></span>    <span style=color:#268bd2>final</span> Registry registry <span style=color:#719e07>=</span> getRegistry<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>);</span>
    
    <span style=color:#586e75>// 获取已注册的服务提供者 URL，比如：
</span><span style=color:#586e75></span>    <span style=color:#586e75>// dubbo://172.17.48.52:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&amp;application=demo-provider&amp;dubbo=2.0.2&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello
</span><span style=color:#586e75></span>    <span style=color:#268bd2>final</span> URL registeredProviderUrl <span style=color:#719e07>=</span> getRegisteredProviderUrl<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>);</span>

    <span style=color:#586e75>// 获取 register 参数
</span><span style=color:#586e75></span>    <span style=color:#dc322f>boolean</span> register <span style=color:#719e07>=</span> registeredProviderUrl<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;register&#34;</span><span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>);</span>

    <span style=color:#586e75>// 向服务提供者与消费者注册表中注册服务提供者
</span><span style=color:#586e75></span>    ProviderConsumerRegTable<span style=color:#719e07>.</span>registerProvider<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>,</span> registryUrl<span style=color:#719e07>,</span> registeredProviderUrl<span style=color:#719e07>);</span>

    <span style=color:#586e75>// 根据 register 的值决定是否注册服务
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>register<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 向注册中心注册服务
</span><span style=color:#586e75></span>        register<span style=color:#719e07>(</span>registryUrl<span style=color:#719e07>,</span> registeredProviderUrl<span style=color:#719e07>);</span>
        ProviderConsumerRegTable<span style=color:#719e07>.</span>getProviderWrapper<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>).</span>setReg<span style=color:#719e07>(</span><span style=color:#cb4b16>true</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 获取订阅 URL，比如：
</span><span style=color:#586e75></span>    <span style=color:#586e75>// provider://172.17.48.52:20880/com.alibaba.dubbo.demo.DemoService?category=configurators&amp;check=false&amp;anyhost=true&amp;application=demo-provider&amp;dubbo=2.0.2&amp;generic=false&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello
</span><span style=color:#586e75></span>    <span style=color:#268bd2>final</span> URL overrideSubscribeUrl <span style=color:#719e07>=</span> getSubscribedOverrideUrl<span style=color:#719e07>(</span>registeredProviderUrl<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 创建监听器
</span><span style=color:#586e75></span>    <span style=color:#268bd2>final</span> OverrideListener overrideSubscribeListener <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> OverrideListener<span style=color:#719e07>(</span>overrideSubscribeUrl<span style=color:#719e07>,</span> originInvoker<span style=color:#719e07>);</span>
    overrideListeners<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>overrideSubscribeUrl<span style=color:#719e07>,</span> overrideSubscribeListener<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 向注册中心进行订阅 override 数据
</span><span style=color:#586e75></span>    registry<span style=color:#719e07>.</span>subscribe<span style=color:#719e07>(</span>overrideSubscribeUrl<span style=color:#719e07>,</span> overrideSubscribeListener<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 创建并返回 DestroyableExporter
</span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> <span style=color:#719e07>new</span> DestroyableExporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;(</span>exporter<span style=color:#719e07>,</span> originInvoker<span style=color:#719e07>,</span> overrideSubscribeUrl<span style=color:#719e07>,</span> registeredProviderUrl<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>上面代码看起来比较复杂，主要做如下一些操作：</p>
<ol>
<li>调用 doLocalExport 导出服务</li>
<li>向注册中心注册服务</li>
<li>向注册中心进行订阅 override 数据</li>
<li>创建并返回 DestroyableExporter</li>
</ol>
<p>在以上操作中，除了创建并返回 DestroyableExporter 没什么难度外，其他几步操作都不是很简单。这其中，导出服务和注册服务是本章要重点分析的逻辑。 订阅 override 数据并非本文重点内容，后面会简单介绍一下。下面先来分析 doLocalExport 方法的逻辑，如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> ExporterChangeableWrapper<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>doLocalExport</span><span style=color:#719e07>(</span><span style=color:#268bd2>final</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> originInvoker<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    String key <span style=color:#719e07>=</span> getCacheKey<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 访问缓存
</span><span style=color:#586e75></span>    ExporterChangeableWrapper<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> exporter <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>ExporterChangeableWrapper<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;)</span> bounds<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>key<span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>exporter <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>synchronized</span> <span style=color:#719e07>(</span>bounds<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            exporter <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>ExporterChangeableWrapper<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;)</span> bounds<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>key<span style=color:#719e07>);</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>exporter <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                <span style=color:#586e75>// 创建 Invoker 为委托类对象
</span><span style=color:#586e75></span>                <span style=color:#268bd2>final</span> Invoker<span style=color:#719e07>&lt;?&gt;</span> invokerDelegete <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> InvokerDelegete<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;(</span>originInvoker<span style=color:#719e07>,</span> getProviderUrl<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>));</span>
                <span style=color:#586e75>// 调用 protocol 的 export 方法导出服务
</span><span style=color:#586e75></span>                exporter <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ExporterChangeableWrapper<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;((</span>Exporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;)</span> protocol<span style=color:#719e07>.</span>export<span style=color:#719e07>(</span>invokerDelegete<span style=color:#719e07>),</span> originInvoker<span style=color:#719e07>);</span>
                
                <span style=color:#586e75>// 写缓存
</span><span style=color:#586e75></span>                bounds<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>key<span style=color:#719e07>,</span> exporter<span style=color:#719e07>);</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>return</span> exporter<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>上面的代码是典型的双重检查锁，大家在阅读 Dubbo 的源码中，会多次见到。接下来，我们把重点放在 Protocol 的 export 方法上。假设运行时协议为 dubbo，此处的 protocol 变量会在运行时加载 DubboProtocol，并调用 DubboProtocol 的 export 方法。所以，接下来我们目光转移到 DubboProtocol 的 export 方法上，相关分析如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Exporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>export</span><span style=color:#719e07>(</span>Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> invoker<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
    URL url <span style=color:#719e07>=</span> invoker<span style=color:#719e07>.</span>getUrl<span style=color:#719e07>();</span>

    <span style=color:#586e75>// 获取服务标识，理解成服务坐标也行。由服务组名，服务名，服务版本号以及端口组成。比如：
</span><span style=color:#586e75></span>    <span style=color:#586e75>// demoGroup/com.alibaba.dubbo.demo.DemoService:1.0.1:20880
</span><span style=color:#586e75></span>    String key <span style=color:#719e07>=</span> serviceKey<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 创建 DubboExporter
</span><span style=color:#586e75></span>    DubboExporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> exporter <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> DubboExporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;(</span>invoker<span style=color:#719e07>,</span> key<span style=color:#719e07>,</span> exporterMap<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 将 &lt;key, exporter&gt; 键值对放入缓存中
</span><span style=color:#586e75></span>    exporterMap<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>key<span style=color:#719e07>,</span> exporter<span style=color:#719e07>);</span>

    <span style=color:#586e75>// 本地存根相关代码
</span><span style=color:#586e75></span>    Boolean isStubSupportEvent <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>STUB_EVENT_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>DEFAULT_STUB_EVENT<span style=color:#719e07>);</span>
    Boolean isCallbackservice <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>IS_CALLBACK_SERVICE<span style=color:#719e07>,</span> <span style=color:#cb4b16>false</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>isStubSupportEvent <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>isCallbackservice<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        String stubServiceMethods <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>STUB_EVENT_METHODS_KEY<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>stubServiceMethods <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> stubServiceMethods<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 省略日志打印代码
</span><span style=color:#586e75></span>        <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
            stubServiceMethodsMap<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getServiceKey<span style=color:#719e07>(),</span> stubServiceMethods<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>

    <span style=color:#586e75>// 启动服务器
</span><span style=color:#586e75></span>    openServer<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 优化序列化
</span><span style=color:#586e75></span>    optimizeSerialization<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#719e07>return</span> exporter<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>如上，我们重点关注 DubboExporter 的创建以及 openServer 方法，其他逻辑看不懂也没关系，不影响理解服务导出过程。另外，DubboExporter 的代码比较简单，就不分析了。下面分析 openServer 方法。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>openServer</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 获取 host:port，并将其作为服务器实例的 key，用于标识当前的服务器实例
</span><span style=color:#586e75></span>    String key <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getAddress<span style=color:#719e07>();</span>
    <span style=color:#dc322f>boolean</span> isServer <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>IS_SERVER_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>isServer<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 访问缓存
</span><span style=color:#586e75></span>        ExchangeServer server <span style=color:#719e07>=</span> serverMap<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>key<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>server <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 创建服务器实例
</span><span style=color:#586e75></span>            serverMap<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>key<span style=color:#719e07>,</span> createServer<span style=color:#719e07>(</span>url<span style=color:#719e07>));</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 服务器已创建，则根据 url 中的配置重置服务器
</span><span style=color:#586e75></span>            server<span style=color:#719e07>.</span>reset<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>如上，在同一台机器上（单网卡），同一个端口上仅允许启动一个服务器实例。若某个端口上已有服务器实例，此时则调用 reset 方法重置服务器的一些配置。考虑到篇幅问题，关于服务器实例重置的代码就不分析了。接下来分析服务器实例的创建过程。如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>private</span> ExchangeServer <span style=color:#268bd2>createServer</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>addParameterIfAbsent<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>CHANNEL_READONLYEVENT_SENT_KEY<span style=color:#719e07>,</span>
    <span style=color:#586e75>// 添加心跳检测配置到 url 中
</span><span style=color:#586e75></span>    url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>addParameterIfAbsent<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>HEARTBEAT_KEY<span style=color:#719e07>,</span> String<span style=color:#719e07>.</span>valueOf<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>DEFAULT_HEARTBEAT<span style=color:#719e07>));</span>
	<span style=color:#586e75>// 获取 server 参数，默认为 netty
</span><span style=color:#586e75></span>    String str <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>SERVER_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>DEFAULT_REMOTING_SERVER<span style=color:#719e07>);</span>

	<span style=color:#586e75>// 通过 SPI 检测是否存在 server 参数所代表的 Transporter 拓展，不存在则抛出异常
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>str <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> str<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0 <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>Transporter<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>hasExtension<span style=color:#719e07>(</span>str<span style=color:#719e07>))</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> RpcException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Unsupported server type: &#34;</span> <span style=color:#719e07>+</span> str <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;, url: &#34;</span> <span style=color:#719e07>+</span> url<span style=color:#719e07>);</span>

    <span style=color:#586e75>// 添加编码解码器参数
</span><span style=color:#586e75></span>    url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>addParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>CODEC_KEY<span style=color:#719e07>,</span> DubboCodec<span style=color:#719e07>.</span>NAME<span style=color:#719e07>);</span>
    ExchangeServer server<span style=color:#719e07>;</span>
    <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 创建 ExchangeServer
</span><span style=color:#586e75></span>        server <span style=color:#719e07>=</span> Exchangers<span style=color:#719e07>.</span>bind<span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> requestHandler<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>RemotingException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> RpcException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Fail to start server...&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
                                   
	<span style=color:#586e75>// 获取 client 参数，可指定 netty，mina
</span><span style=color:#586e75></span>    str <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>CLIENT_KEY<span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>str <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> str<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 获取所有的 Transporter 实现类名称集合，比如 supportedTypes = [netty, mina]
</span><span style=color:#586e75></span>        Set<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> supportedTypes <span style=color:#719e07>=</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>Transporter<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>getSupportedExtensions<span style=color:#719e07>();</span>
        <span style=color:#586e75>// 检测当前 Dubbo 所支持的 Transporter 实现类名称列表中，
</span><span style=color:#586e75></span>        <span style=color:#586e75>// 是否包含 client 所表示的 Transporter，若不包含，则抛出异常
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>supportedTypes<span style=color:#719e07>.</span>contains<span style=color:#719e07>(</span>str<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> RpcException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Unsupported client type...&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>return</span> server<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>如上，createServer 包含三个核心的逻辑。第一是检测是否存在 server 参数所代表的 Transporter 拓展，不存在则抛出异常。第二是创建服务器实例。第三是检测是否支持 client 参数所表示的 Transporter 拓展，不存在也是抛出异常。两次检测操作所对应的代码比较直白了，无需多说。但创建服务器的操作目前还不是很清晰，我们继续往下看。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> ExchangeServer <span style=color:#268bd2>bind</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> ExchangeHandler handler<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RemotingException <span style=color:#719e07>{</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>url <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;url == null&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>handler <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;handler == null&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>addParameterIfAbsent<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>CODEC_KEY<span style=color:#719e07>,</span> <span style=color:#2aa198>&#34;exchange&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#586e75>// 获取 Exchanger，默认为 HeaderExchanger。
</span><span style=color:#586e75></span>    <span style=color:#586e75>// 紧接着调用 HeaderExchanger 的 bind 方法创建 ExchangeServer 实例
</span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> getExchanger<span style=color:#719e07>(</span>url<span style=color:#719e07>).</span>bind<span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> handler<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>上面代码比较简单，就不多说了。下面看一下 HeaderExchanger 的 bind 方法。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> ExchangeServer <span style=color:#268bd2>bind</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> ExchangeHandler handler<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RemotingException <span style=color:#719e07>{</span>
	<span style=color:#586e75>// 创建 HeaderExchangeServer 实例，该方法包含了多个逻辑，分别如下：
</span><span style=color:#586e75></span>	<span style=color:#586e75>//   1. new HeaderExchangeHandler(handler)
</span><span style=color:#586e75></span>	<span style=color:#586e75>//	 2. new DecodeHandler(new HeaderExchangeHandler(handler))
</span><span style=color:#586e75></span>	<span style=color:#586e75>//   3. Transporters.bind(url, new DecodeHandler(new HeaderExchangeHandler(handler)))
</span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> <span style=color:#719e07>new</span> HeaderExchangeServer<span style=color:#719e07>(</span>Transporters<span style=color:#719e07>.</span>bind<span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> <span style=color:#719e07>new</span> DecodeHandler<span style=color:#719e07>(</span><span style=color:#719e07>new</span> HeaderExchangeHandler<span style=color:#719e07>(</span>handler<span style=color:#719e07>))));</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>HeaderExchanger 的 bind 方法包含的逻辑比较多，但目前我们仅需关心 Transporters 的 bind 方法逻辑即可。该方法的代码如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> Server <span style=color:#268bd2>bind</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> ChannelHandler<span style=color:#719e07>...</span> handlers<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RemotingException <span style=color:#719e07>{</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>url <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;url == null&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>handlers <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> handlers<span style=color:#719e07>.</span>length <span style=color:#719e07>==</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalArgumentException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;handlers == null&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    ChannelHandler handler<span style=color:#719e07>;</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>handlers<span style=color:#719e07>.</span>length <span style=color:#719e07>==</span> 1<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        handler <span style=color:#719e07>=</span> handlers<span style=color:#719e07>[</span>0<span style=color:#719e07>];</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
    	<span style=color:#586e75>// 如果 handlers 元素数量大于1，则创建 ChannelHandler 分发器
</span><span style=color:#586e75></span>        handler <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ChannelHandlerDispatcher<span style=color:#719e07>(</span>handlers<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    <span style=color:#586e75>// 获取自适应 Transporter 实例，并调用实例方法
</span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> getTransporter<span style=color:#719e07>().</span>bind<span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> handler<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>如上，getTransporter() 方法获取的 Transporter 是在运行时动态创建的，类名为 Transporter$Adaptive，也就是自适应拓展类。Transporter$Adaptive 会在运行时根据传入的 URL 参数决定加载什么类型的 Transporter，默认为 NettyTransporter。下面我们继续跟下去，这次分析的是 NettyTransporter 的 bind 方法。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> Server <span style=color:#268bd2>bind</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> ChannelHandler listener<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RemotingException <span style=color:#719e07>{</span>
	<span style=color:#586e75>// 创建 NettyServer
</span><span style=color:#586e75></span>	<span style=color:#719e07>return</span> <span style=color:#719e07>new</span> NettyServer<span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> listener<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>这里仅有一句创建 NettyServer 的代码，无需多说，我们继续向下看。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>NettyServer</span> <span style=color:#268bd2>extends</span> AbstractServer <span style=color:#268bd2>implements</span> Server <span style=color:#719e07>{</span>
    <span style=color:#268bd2>public</span> <span style=color:#268bd2>NettyServer</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> ChannelHandler handler<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RemotingException <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 调用父类构造方法
</span><span style=color:#586e75></span>        <span style=color:#268bd2>super</span><span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> ChannelHandlers<span style=color:#719e07>.</span>wrap<span style=color:#719e07>(</span>handler<span style=color:#719e07>,</span> ExecutorUtil<span style=color:#719e07>.</span>setThreadName<span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> SERVER_THREAD_POOL_NAME<span style=color:#719e07>)));</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>


<span style=color:#268bd2>public</span> <span style=color:#268bd2>abstract</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>AbstractServer</span> <span style=color:#268bd2>extends</span> AbstractEndpoint <span style=color:#268bd2>implements</span> Server <span style=color:#719e07>{</span>
    <span style=color:#268bd2>public</span> <span style=color:#268bd2>AbstractServer</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> ChannelHandler handler<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RemotingException <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 调用父类构造方法，这里就不用跟进去了，没什么复杂逻辑
</span><span style=color:#586e75></span>        <span style=color:#268bd2>super</span><span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> handler<span style=color:#719e07>);</span>
        localAddress <span style=color:#719e07>=</span> getUrl<span style=color:#719e07>().</span>toInetSocketAddress<span style=color:#719e07>();</span>

        <span style=color:#586e75>// 获取 ip 和端口
</span><span style=color:#586e75></span>        String bindIp <span style=color:#719e07>=</span> getUrl<span style=color:#719e07>().</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>BIND_IP_KEY<span style=color:#719e07>,</span> getUrl<span style=color:#719e07>().</span>getHost<span style=color:#719e07>());</span>
        <span style=color:#dc322f>int</span> bindPort <span style=color:#719e07>=</span> getUrl<span style=color:#719e07>().</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>BIND_PORT_KEY<span style=color:#719e07>,</span> getUrl<span style=color:#719e07>().</span>getPort<span style=color:#719e07>());</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>ANYHOST_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>false</span><span style=color:#719e07>)</span> <span style=color:#719e07>||</span> NetUtils<span style=color:#719e07>.</span>isInvalidLocalHost<span style=color:#719e07>(</span>bindIp<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 设置 ip 为 0.0.0.0
</span><span style=color:#586e75></span>            bindIp <span style=color:#719e07>=</span> NetUtils<span style=color:#719e07>.</span>ANYHOST<span style=color:#719e07>;</span>
        <span style=color:#719e07>}</span>
        bindAddress <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> InetSocketAddress<span style=color:#719e07>(</span>bindIp<span style=color:#719e07>,</span> bindPort<span style=color:#719e07>);</span>
        <span style=color:#586e75>// 获取最大可接受连接数
</span><span style=color:#586e75></span>        <span style=color:#719e07>this</span><span style=color:#719e07>.</span>accepts <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>ACCEPTS_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>DEFAULT_ACCEPTS<span style=color:#719e07>);</span>
        <span style=color:#719e07>this</span><span style=color:#719e07>.</span>idleTimeout <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>IDLE_TIMEOUT_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>DEFAULT_IDLE_TIMEOUT<span style=color:#719e07>);</span>
        <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 调用模板方法 doOpen 启动服务器
</span><span style=color:#586e75></span>            doOpen<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Throwable t<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> RemotingException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Failed to bind &#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>

        DataStore dataStore <span style=color:#719e07>=</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>DataStore<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>getDefaultExtension<span style=color:#719e07>();</span>
        executor <span style=color:#719e07>=</span> <span style=color:#719e07>(</span>ExecutorService<span style=color:#719e07>)</span> dataStore<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>EXECUTOR_SERVICE_COMPONENT_KEY<span style=color:#719e07>,</span> Integer<span style=color:#719e07>.</span>toString<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getPort<span style=color:#719e07>()));</span>
    <span style=color:#719e07>}</span>
    
    <span style=color:#268bd2>protected</span> <span style=color:#268bd2>abstract</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doOpen</span><span style=color:#719e07>()</span> <span style=color:#268bd2>throws</span> Throwable<span style=color:#719e07>;</span>

    <span style=color:#268bd2>protected</span> <span style=color:#268bd2>abstract</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doClose</span><span style=color:#719e07>()</span> <span style=color:#268bd2>throws</span> Throwable<span style=color:#719e07>;</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>上面代码多为赋值代码，不需要多讲。我们重点关注 doOpen 抽象方法，该方法需要子类实现。下面回到 NettyServer 中。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>protected</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doOpen</span><span style=color:#719e07>()</span> <span style=color:#268bd2>throws</span> Throwable <span style=color:#719e07>{</span>
    NettyHelper<span style=color:#719e07>.</span>setNettyLoggerFactory<span style=color:#719e07>();</span>
    <span style=color:#586e75>// 创建 boss 和 worker 线程池
</span><span style=color:#586e75></span>    ExecutorService boss <span style=color:#719e07>=</span> Executors<span style=color:#719e07>.</span>newCachedThreadPool<span style=color:#719e07>(</span><span style=color:#719e07>new</span> NamedThreadFactory<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;NettyServerBoss&#34;</span><span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>));</span>
    ExecutorService worker <span style=color:#719e07>=</span> Executors<span style=color:#719e07>.</span>newCachedThreadPool<span style=color:#719e07>(</span><span style=color:#719e07>new</span> NamedThreadFactory<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;NettyServerWorker&#34;</span><span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>));</span>
    ChannelFactory channelFactory <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> NioServerSocketChannelFactory<span style=color:#719e07>(</span>boss<span style=color:#719e07>,</span> worker<span style=color:#719e07>,</span> getUrl<span style=color:#719e07>().</span>getPositiveParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>IO_THREADS_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>DEFAULT_IO_THREADS<span style=color:#719e07>));</span>
    
    <span style=color:#586e75>// 创建 ServerBootstrap
</span><span style=color:#586e75></span>    bootstrap <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ServerBootstrap<span style=color:#719e07>(</span>channelFactory<span style=color:#719e07>);</span>

    <span style=color:#268bd2>final</span> NettyHandler nettyHandler <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> NettyHandler<span style=color:#719e07>(</span>getUrl<span style=color:#719e07>(),</span> <span style=color:#719e07>this</span><span style=color:#719e07>);</span>
    channels <span style=color:#719e07>=</span> nettyHandler<span style=color:#719e07>.</span>getChannels<span style=color:#719e07>();</span>
    bootstrap<span style=color:#719e07>.</span>setOption<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;child.tcpNoDelay&#34;</span><span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>);</span>
    <span style=color:#586e75>// 设置 PipelineFactory
</span><span style=color:#586e75></span>    bootstrap<span style=color:#719e07>.</span>setPipelineFactory<span style=color:#719e07>(</span><span style=color:#719e07>new</span> ChannelPipelineFactory<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>@Override</span>
        <span style=color:#268bd2>public</span> ChannelPipeline <span style=color:#268bd2>getPipeline</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
            NettyCodecAdapter adapter <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> NettyCodecAdapter<span style=color:#719e07>(</span>getCodec<span style=color:#719e07>(),</span> getUrl<span style=color:#719e07>(),</span> NettyServer<span style=color:#719e07>.</span>this<span style=color:#719e07>);</span>
            ChannelPipeline pipeline <span style=color:#719e07>=</span> Channels<span style=color:#719e07>.</span>pipeline<span style=color:#719e07>();</span>
            pipeline<span style=color:#719e07>.</span>addLast<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;decoder&#34;</span><span style=color:#719e07>,</span> adapter<span style=color:#719e07>.</span>getDecoder<span style=color:#719e07>());</span>
            pipeline<span style=color:#719e07>.</span>addLast<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;encoder&#34;</span><span style=color:#719e07>,</span> adapter<span style=color:#719e07>.</span>getEncoder<span style=color:#719e07>());</span>
            pipeline<span style=color:#719e07>.</span>addLast<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;handler&#34;</span><span style=color:#719e07>,</span> nettyHandler<span style=color:#719e07>);</span>
            <span style=color:#719e07>return</span> pipeline<span style=color:#719e07>;</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>});</span>
    <span style=color:#586e75>// 绑定到指定的 ip 和端口上
</span><span style=color:#586e75></span>    channel <span style=color:#719e07>=</span> bootstrap<span style=color:#719e07>.</span>bind<span style=color:#719e07>(</span>getBindAddress<span style=color:#719e07>());</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>以上就是 NettyServer 创建的过程，dubbo 默认使用的 NettyServer 是基于 netty 3.x 版本实现的，比较老了。因此 Dubbo 另外提供了 netty 4.x 版本的 NettyServer，大家可在使用 Dubbo 的过程中按需进行配置。</p>
<p>到此，关于服务导出的过程就分析完了。整个过程比较复杂，大家在分析的过程中耐心一些。并且多写 Demo 进行调试，以便能够更好的理解代码逻辑。</p>
<p>本节内容先到这里，接下来分析服务导出的另一块逻辑 — 服务注册。</p>
<h3 id=224-服务注册>2.2.4 服务注册</h3>
<p>本节我们来分析服务注册过程，服务注册操作对于 Dubbo 来说不是必需的，通过服务直连的方式就可以绕过注册中心。但通常我们不会这么做，直连方式不利于服务治理，仅推荐在测试服务时使用。对于 Dubbo 来说，注册中心虽不是必需，但却是必要的。因此，关于注册中心以及服务注册相关逻辑，我们也需要搞懂。</p>
<p>本节内容以 Zookeeper 注册中心作为分析目标，其他类型注册中心大家可自行分析。下面从服务注册的入口方法开始分析，我们把目光再次移到 RegistryProtocol 的 export 方法上。如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Exporter<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>export</span><span style=color:#719e07>(</span><span style=color:#268bd2>final</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> originInvoker<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
    
    <span style=color:#586e75>// ${导出服务}
</span><span style=color:#586e75></span>    
    <span style=color:#586e75>// 省略其他代码
</span><span style=color:#586e75></span>    
    <span style=color:#dc322f>boolean</span> register <span style=color:#719e07>=</span> registeredProviderUrl<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;register&#34;</span><span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>register<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 注册服务
</span><span style=color:#586e75></span>        register<span style=color:#719e07>(</span>registryUrl<span style=color:#719e07>,</span> registeredProviderUrl<span style=color:#719e07>);</span>
        ProviderConsumerRegTable<span style=color:#719e07>.</span>getProviderWrapper<span style=color:#719e07>(</span>originInvoker<span style=color:#719e07>).</span>setReg<span style=color:#719e07>(</span><span style=color:#cb4b16>true</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    
    <span style=color:#268bd2>final</span> URL overrideSubscribeUrl <span style=color:#719e07>=</span> getSubscribedOverrideUrl<span style=color:#719e07>(</span>registeredProviderUrl<span style=color:#719e07>);</span>
    <span style=color:#268bd2>final</span> OverrideListener overrideSubscribeListener <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> OverrideListener<span style=color:#719e07>(</span>overrideSubscribeUrl<span style=color:#719e07>,</span> originInvoker<span style=color:#719e07>);</span>
    overrideListeners<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>overrideSubscribeUrl<span style=color:#719e07>,</span> overrideSubscribeListener<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 订阅 override 数据
</span><span style=color:#586e75></span>    registry<span style=color:#719e07>.</span>subscribe<span style=color:#719e07>(</span>overrideSubscribeUrl<span style=color:#719e07>,</span> overrideSubscribeListener<span style=color:#719e07>);</span>

    <span style=color:#586e75>// 省略部分代码
</span><span style=color:#586e75></span><span style=color:#719e07>}</span>
</code></pre></div><p>RegistryProtocol 的 export 方法包含了服务导出，注册，以及数据订阅等逻辑。其中服务导出逻辑上一节已经分析过了，本节将分析服务注册逻辑，相关代码如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>register</span><span style=color:#719e07>(</span>URL registryUrl<span style=color:#719e07>,</span> URL registedProviderUrl<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 获取 Registry
</span><span style=color:#586e75></span>    Registry registry <span style=color:#719e07>=</span> registryFactory<span style=color:#719e07>.</span>getRegistry<span style=color:#719e07>(</span>registryUrl<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 注册服务
</span><span style=color:#586e75></span>    registry<span style=color:#719e07>.</span>register<span style=color:#719e07>(</span>registedProviderUrl<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>register 方法包含两步操作，第一步是获取注册中心实例，第二步是向注册中心注册服务。接下来分两节内容对这两步操作进行分析。</p>
<h4 id=2241-创建注册中心>2.2.4.1 创建注册中心</h4>
<p>本节内容以 Zookeeper 注册中心为例进行分析。下面先来看一下 getRegistry 方法的源码，这个方法由 AbstractRegistryFactory 实现。如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> Registry <span style=color:#268bd2>getRegistry</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    url <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>setPath<span style=color:#719e07>(</span>RegistryService<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>())</span>
            <span style=color:#719e07>.</span>addParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>INTERFACE_KEY<span style=color:#719e07>,</span> RegistryService<span style=color:#719e07>.</span>class<span style=color:#719e07>.</span>getName<span style=color:#719e07>())</span>
            <span style=color:#719e07>.</span>removeParameters<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>EXPORT_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>REFER_KEY<span style=color:#719e07>);</span>
    String key <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>toServiceString<span style=color:#719e07>();</span>
    LOCK<span style=color:#719e07>.</span>lock<span style=color:#719e07>();</span>
    <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
    	<span style=color:#586e75>// 访问缓存
</span><span style=color:#586e75></span>        Registry registry <span style=color:#719e07>=</span> REGISTRIES<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>key<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>registry <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>return</span> registry<span style=color:#719e07>;</span>
        <span style=color:#719e07>}</span>
        
        <span style=color:#586e75>// 缓存未命中，创建 Registry 实例
</span><span style=color:#586e75></span>        registry <span style=color:#719e07>=</span> createRegistry<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>registry <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span><span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Can not create registry...&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        
        <span style=color:#586e75>// 写入缓存
</span><span style=color:#586e75></span>        REGISTRIES<span style=color:#719e07>.</span>put<span style=color:#719e07>(</span>key<span style=color:#719e07>,</span> registry<span style=color:#719e07>);</span>
        <span style=color:#719e07>return</span> registry<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>finally</span> <span style=color:#719e07>{</span>
        LOCK<span style=color:#719e07>.</span>unlock<span style=color:#719e07>();</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>

<span style=color:#268bd2>protected</span> <span style=color:#268bd2>abstract</span> Registry <span style=color:#268bd2>createRegistry</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>);</span>
</code></pre></div><p>如上，getRegistry 方法先访问缓存，缓存未命中则调用 createRegistry 创建 Registry，然后写入缓存。这里的 createRegistry 是一个模板方法，由具体的子类实现。因此，下面我们到 ZookeeperRegistryFactory 中探究一番。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>ZookeeperRegistryFactory</span> <span style=color:#268bd2>extends</span> AbstractRegistryFactory <span style=color:#719e07>{</span>

    <span style=color:#586e75>// zookeeperTransporter 由 SPI 在运行时注入，类型为 ZookeeperTransporter$Adaptive
</span><span style=color:#586e75></span>    <span style=color:#268bd2>private</span> ZookeeperTransporter zookeeperTransporter<span style=color:#719e07>;</span>

    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>setZookeeperTransporter</span><span style=color:#719e07>(</span>ZookeeperTransporter zookeeperTransporter<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>this</span><span style=color:#719e07>.</span>zookeeperTransporter <span style=color:#719e07>=</span> zookeeperTransporter<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>

    <span style=color:#268bd2>@Override</span>
    <span style=color:#268bd2>public</span> Registry <span style=color:#268bd2>createRegistry</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 创建 ZookeeperRegistry
</span><span style=color:#586e75></span>        <span style=color:#719e07>return</span> <span style=color:#719e07>new</span> ZookeeperRegistry<span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> zookeeperTransporter<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>ZookeeperRegistryFactory 的 createRegistry 方法仅包含一句代码，无需解释，继续跟下去。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>ZookeeperRegistry</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> ZookeeperTransporter zookeeperTransporter<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#268bd2>super</span><span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>isAnyHost<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;registry address == null&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    
    <span style=color:#586e75>// 获取组名，默认为 dubbo
</span><span style=color:#586e75></span>    String group <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>GROUP_KEY<span style=color:#719e07>,</span> DEFAULT_ROOT<span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>group<span style=color:#719e07>.</span>startsWith<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>PATH_SEPARATOR<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// group = &#34;/&#34; + group
</span><span style=color:#586e75></span>        group <span style=color:#719e07>=</span> Constants<span style=color:#719e07>.</span>PATH_SEPARATOR <span style=color:#719e07>+</span> group<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
    <span style=color:#719e07>this</span><span style=color:#719e07>.</span>root <span style=color:#719e07>=</span> group<span style=color:#719e07>;</span>
    <span style=color:#586e75>// 创建 Zookeeper 客户端，默认为 CuratorZookeeperTransporter
</span><span style=color:#586e75></span>    zkClient <span style=color:#719e07>=</span> zookeeperTransporter<span style=color:#719e07>.</span>connect<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#586e75>// 添加状态监听器
</span><span style=color:#586e75></span>    zkClient<span style=color:#719e07>.</span>addStateListener<span style=color:#719e07>(</span><span style=color:#719e07>new</span> StateListener<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>@Override</span>
        <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>stateChanged</span><span style=color:#719e07>(</span><span style=color:#dc322f>int</span> state<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>state <span style=color:#719e07>==</span> RECONNECTED<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
                    recover<span style=color:#719e07>();</span>
                <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Exception e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    logger<span style=color:#719e07>.</span>error<span style=color:#719e07>(</span>e<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> e<span style=color:#719e07>);</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>});</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>在上面的代码代码中，我们重点关注 ZookeeperTransporter 的 connect 方法调用，这个方法用于创建 Zookeeper 客户端。创建好 Zookeeper 客户端，意味着注册中心的创建过程就结束了。接下来，再来分析一下 Zookeeper 客户端的创建过程。</p>
<p>前面说过，这里的 zookeeperTransporter 类型为自适应拓展类，因此 connect 方法会在被调用时决定加载什么类型的 ZookeeperTransporter 拓展，默认为 CuratorZookeeperTransporter。下面我们到 CuratorZookeeperTransporter 中看一看。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> ZookeeperClient <span style=color:#268bd2>connect</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#586e75>// 创建 CuratorZookeeperClient
</span><span style=color:#586e75></span>    <span style=color:#719e07>return</span> <span style=color:#719e07>new</span> CuratorZookeeperClient<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>继续向下看。</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>CuratorZookeeperClient</span> <span style=color:#268bd2>extends</span> AbstractZookeeperClient<span style=color:#719e07>&lt;</span>CuratorWatcher<span style=color:#719e07>&gt;</span> <span style=color:#719e07>{</span>

    <span style=color:#268bd2>private</span> <span style=color:#268bd2>final</span> CuratorFramework client<span style=color:#719e07>;</span>
    
    <span style=color:#268bd2>public</span> <span style=color:#268bd2>CuratorZookeeperClient</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#268bd2>super</span><span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
        <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
            <span style=color:#586e75>// 创建 CuratorFramework 构造器
</span><span style=color:#586e75></span>            CuratorFrameworkFactory<span style=color:#719e07>.</span>Builder builder <span style=color:#719e07>=</span> CuratorFrameworkFactory<span style=color:#719e07>.</span>builder<span style=color:#719e07>()</span>
                    <span style=color:#719e07>.</span>connectString<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getBackupAddress<span style=color:#719e07>())</span>
                    <span style=color:#719e07>.</span>retryPolicy<span style=color:#719e07>(</span><span style=color:#719e07>new</span> RetryNTimes<span style=color:#719e07>(</span>1<span style=color:#719e07>,</span> 1000<span style=color:#719e07>))</span>
                    <span style=color:#719e07>.</span>connectionTimeoutMs<span style=color:#719e07>(</span>5000<span style=color:#719e07>);</span>
            String authority <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getAuthority<span style=color:#719e07>();</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>authority <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>&amp;&amp;</span> authority<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                builder <span style=color:#719e07>=</span> builder<span style=color:#719e07>.</span>authorization<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;digest&#34;</span><span style=color:#719e07>,</span> authority<span style=color:#719e07>.</span>getBytes<span style=color:#719e07>());</span>
            <span style=color:#719e07>}</span>
            <span style=color:#586e75>// 构建 CuratorFramework 实例
</span><span style=color:#586e75></span>            client <span style=color:#719e07>=</span> builder<span style=color:#719e07>.</span>build<span style=color:#719e07>();</span>
            <span style=color:#586e75>// 添加监听器
</span><span style=color:#586e75></span>            client<span style=color:#719e07>.</span>getConnectionStateListenable<span style=color:#719e07>().</span>addListener<span style=color:#719e07>(</span><span style=color:#719e07>new</span> ConnectionStateListener<span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
                <span style=color:#268bd2>@Override</span>
                <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>stateChanged</span><span style=color:#719e07>(</span>CuratorFramework client<span style=color:#719e07>,</span> ConnectionState state<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>state <span style=color:#719e07>==</span> ConnectionState<span style=color:#719e07>.</span>LOST<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                        CuratorZookeeperClient<span style=color:#719e07>.</span>this<span style=color:#719e07>.</span>stateChanged<span style=color:#719e07>(</span>StateListener<span style=color:#719e07>.</span>DISCONNECTED<span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>state <span style=color:#719e07>==</span> ConnectionState<span style=color:#719e07>.</span>CONNECTED<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                        CuratorZookeeperClient<span style=color:#719e07>.</span>this<span style=color:#719e07>.</span>stateChanged<span style=color:#719e07>(</span>StateListener<span style=color:#719e07>.</span>CONNECTED<span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>state <span style=color:#719e07>==</span> ConnectionState<span style=color:#719e07>.</span>RECONNECTED<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                        CuratorZookeeperClient<span style=color:#719e07>.</span>this<span style=color:#719e07>.</span>stateChanged<span style=color:#719e07>(</span>StateListener<span style=color:#719e07>.</span>RECONNECTED<span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>});</span>
            
            <span style=color:#586e75>// 启动客户端
</span><span style=color:#586e75></span>            client<span style=color:#719e07>.</span>start<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Exception e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span>e<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> e<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>CuratorZookeeperClient 构造方法主要用于创建和启动 CuratorFramework 实例。以上基本上都是 Curator 框架的代码，大家如果对 Curator 框架不是很了解，可以参考 Curator 官方文档。</p>
<p>本节分析了 ZookeeperRegistry 实例的创建过程，整个过程并不是很复杂。大家在看完分析后，可以自行调试，以加深理解。现在注册中心实例创建好了，接下来要做的事情是向注册中心注册服务，我们继续往下看。</p>
<h4 id=2242-节点创建>2.2.4.2 节点创建</h4>
<p>以 Zookeeper 为例，所谓的服务注册，本质上是将服务配置数据写入到 Zookeeper 的某个路径的节点下。为了让大家有一个直观的了解，下面我们将 Dubbo 的 demo 跑起来，然后通过 Zookeeper 可视化客户端 <a href=https://github.com/apache/zookeeper/tree/b79af153d0f98a4f3f3516910ed47234d7b3d74e/src/contrib/zooinspector>ZooInspector</a> 查看节点数据。如下：</p>
<p><img src=/imgs/dev/service-registry.png alt></p>
<p>从上图中可以看到 com.alibaba.dubbo.demo.DemoService 这个服务对应的配置信息（存储在 URL 中）最终被注册到了 /dubbo/com.alibaba.dubbo.demo.DemoService/providers/ 节点下。搞懂了服务注册的本质，那么接下来我们就可以去阅读服务注册的代码了。服务注册的接口为 register(URL)，这个方法定义在 FailbackRegistry 抽象类中。代码如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>register</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#268bd2>super</span><span style=color:#719e07>.</span>register<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    failedRegistered<span style=color:#719e07>.</span>remove<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    failedUnregistered<span style=color:#719e07>.</span>remove<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 模板方法，由子类实现
</span><span style=color:#586e75></span>        doRegister<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Exception e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        Throwable t <span style=color:#719e07>=</span> e<span style=color:#719e07>;</span>

        <span style=color:#586e75>// 获取 check 参数，若 check = true 将会直接抛出异常
</span><span style=color:#586e75></span>        <span style=color:#dc322f>boolean</span> check <span style=color:#719e07>=</span> getUrl<span style=color:#719e07>().</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>CHECK_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>)</span>
                <span style=color:#719e07>&amp;&amp;</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>CHECK_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>)</span>
                <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span>Constants<span style=color:#719e07>.</span>CONSUMER_PROTOCOL<span style=color:#719e07>.</span>equals<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>());</span>
        <span style=color:#dc322f>boolean</span> skipFailback <span style=color:#719e07>=</span> t <span style=color:#719e07>instanceof</span> SkipFailbackWrapperException<span style=color:#719e07>;</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>check <span style=color:#719e07>||</span> skipFailback<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>skipFailback<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                t <span style=color:#719e07>=</span> t<span style=color:#719e07>.</span>getCause<span style=color:#719e07>();</span>
            <span style=color:#719e07>}</span>
            <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Failed to register&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
            logger<span style=color:#719e07>.</span>error<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Failed to register&#34;</span><span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>

        <span style=color:#586e75>// 记录注册失败的链接
</span><span style=color:#586e75></span>        failedRegistered<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>url<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>

<span style=color:#268bd2>protected</span> <span style=color:#268bd2>abstract</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doRegister</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>);</span>
</code></pre></div><p>如上，我们重点关注 doRegister 方法调用即可，其他的代码先忽略。doRegister 方法是一个模板方法，因此我们到 FailbackRegistry 子类 ZookeeperRegistry 中进行分析。如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>protected</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>doRegister</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 通过 Zookeeper 客户端创建节点，节点路径由 toUrlPath 方法生成，路径格式如下:
</span><span style=color:#586e75></span>        <span style=color:#586e75>//   /${group}/${serviceInterface}/providers/${url}
</span><span style=color:#586e75></span>        <span style=color:#586e75>// 比如
</span><span style=color:#586e75></span>        <span style=color:#586e75>//   /dubbo/org.apache.dubbo.DemoService/providers/dubbo%3A%2F%2F127.0.0.1......
</span><span style=color:#586e75></span>        zkClient<span style=color:#719e07>.</span>create<span style=color:#719e07>(</span>toUrlPath<span style=color:#719e07>(</span>url<span style=color:#719e07>),</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>DYNAMIC_KEY<span style=color:#719e07>,</span> <span style=color:#cb4b16>true</span><span style=color:#719e07>));</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Throwable e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> RpcException<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;Failed to register...&#34;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>如上，ZookeeperRegistry 在 doRegister 中调用了 Zookeeper 客户端创建服务节点。节点路径由 toUrlPath 方法生成，该方法逻辑不难理解，就不分析了。接下来分析 create 方法，如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>create</span><span style=color:#719e07>(</span>String path<span style=color:#719e07>,</span> <span style=color:#dc322f>boolean</span> ephemeral<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span>ephemeral<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 如果要创建的节点类型非临时节点，那么这里要检测节点是否存在
</span><span style=color:#586e75></span>        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>checkExists<span style=color:#719e07>(</span>path<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>return</span><span style=color:#719e07>;</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
    <span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> path<span style=color:#719e07>.</span>lastIndexOf<span style=color:#719e07>(</span><span style=color:#2aa198>&#39;/&#39;</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>i <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 递归创建上一级路径
</span><span style=color:#586e75></span>        create<span style=color:#719e07>(</span>path<span style=color:#719e07>.</span>substring<span style=color:#719e07>(</span>0<span style=color:#719e07>,</span> i<span style=color:#719e07>),</span> <span style=color:#cb4b16>false</span><span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    
    <span style=color:#586e75>// 根据 ephemeral 的值创建临时或持久节点
</span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>ephemeral<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        createEphemeral<span style=color:#719e07>(</span>path<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
        createPersistent<span style=color:#719e07>(</span>path<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>上面方法先是通过递归创建当前节点的上一级路径，然后再根据 ephemeral 的值决定创建临时还是持久节点。createEphemeral 和 createPersistent 这两个方法都比较简单，这里简单分析其中的一个。如下：</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>createEphemeral</span><span style=color:#719e07>(</span>String path<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
        <span style=color:#586e75>// 通过 Curator 框架创建节点
</span><span style=color:#586e75></span>        client<span style=color:#719e07>.</span>create<span style=color:#719e07>().</span>withMode<span style=color:#719e07>(</span>CreateMode<span style=color:#719e07>.</span>EPHEMERAL<span style=color:#719e07>).</span>forPath<span style=color:#719e07>(</span>path<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>NodeExistsException e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
    <span style=color:#719e07>}</span> <span style=color:#719e07>catch</span> <span style=color:#719e07>(</span>Exception e<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        <span style=color:#719e07>throw</span> <span style=color:#719e07>new</span> IllegalStateException<span style=color:#719e07>(</span>e<span style=color:#719e07>.</span>getMessage<span style=color:#719e07>(),</span> e<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>好了，到此关于服务注册的过程就分析完了。整个过程可简单总结为：先创建注册中心实例，之后再通过注册中心实例注册服务。本节先到这，接下来分析数据订阅过程。</p>
<h3 id=225-订阅-override-数据>2.2.5 订阅 override 数据</h3>
<p>// 待补充</p>
<h2 id=3总结>3.总结</h2>
<p>本篇文章详细分析了 Dubbo 服务导出过程，包括配置检测，URL 组装，Invoker 创建过程、导出服务以及注册服务等等。篇幅比较大，需要大家耐心阅读。本篇文章先就到这，如果文章有不妥错误之处，希望大家能够进行反馈或修正。</p>
<style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style>
<h2 class=feedback--title>Feedback</h2>
<p class=feedback--question>Was this page helpful?</p>
<button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
Glad to hear it! Please <a href=https://github.com/apache/dubbo-website/issues/new>tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
Sorry to hear that. Please <a href=https://github.com/apache/dubbo-website/issues/new>tell us how we can improve</a>.
</p>
<script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script>
<br>
<div class="text-muted mt-5 pt-3 border-top">最后修改 July 23, 2021: <a href=https://github.com/apache/dubbo-website/commit/e71a2ba1778c9c7bf3f5589082b5686042ef7cad>update metadata doc, add application level metadata info. (#876) (e71a2ba)</a>
</div>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Dubbo mailing list archive" aria-label="Dubbo mailing list archive">
<a class=text-white target=_blank rel="noopener noreferrer" href=https://lists.apache.org/list.html?dev@dubbo.apache.org>
<i class="fa fa-envelope"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://twitter.com/ApacheDubbo>
<i class="fab fa-twitter"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/apache/dubbo>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Subscribe to mailing list" aria-label="Subscribe to mailing list">
<a class=text-white target=_blank rel="noopener noreferrer" href=mailto://dev-subscribe@dubbo.apache.org>
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2021 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. All Rights Reserved</small>
</div>
</div>
</div>
</footer>
<div class="row pt-2 pb-2">
<div class="container-fluid mx-sm-5">
<div class=text-center id=my-footer>
<img style=float:left src=/imgs/apache_logo.png>
<ul>
<li><a href=http://www.apache.org>Foundation</a></li>
<li><a href=http://www.apache.org/licenses/>License</a></li>
<li><a href=https://www.apache.org/security/>Security</a></li>
<li><a href=http://www.apache.org/events/current-event>Events</a></li>
<li><a href=http://www.apache.org/foundation/sponsorship.html>Sponsorship</a></li>
<li><a href=http://www.apache.org/foundation/thanks.html>Thanks</a></li>
</ul>
</div>
</div>
</div>
</div>
<script src=/js/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.b1204cf86e8e9a67512f5a2424ceff1cf41fa3fea170a94a53582b7226e2044e.js integrity="sha256-sSBM+G6OmmdRL1okJM7/HPQfo/6hcKlKU1grcibiBE4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script>
<script>docsearch({apiKey:'38eff7758162fbf70f2b8484932e62ae',indexName:'apache_dubbo',inputSelector:'.td-search-input',debug:!1})</script>
</body>
</html>